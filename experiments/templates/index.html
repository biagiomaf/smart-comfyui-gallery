<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGallery: {{ current_folder_info.display_name }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='galleryout/favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --surface-color: #1a1a1a;
            --surface-hover: #252525;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --text-color: #f8f9fa;
            --text-muted: #adb5bd;
            --border-color: #343a40;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --favorite-color: #ffc107;
            --workflow-color: #28a745;
            --success-color: #20c997;
            
            /* AI Colors */
            --ai-color: #ff00ff; /* Fuxia */
            --ai-gradient: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%);
            --ai-surface: rgba(255, 0, 255, 0.1);
            
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.3);
            --sidebar-width: 320px;
        }

        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
            margin: 0;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        body.lightbox-open,
        body.modal-open {
            overflow: hidden;
        }

        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .notification {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border-left: 5px solid var(--primary-color);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-weight: 600;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success-color);
            color: white;
            border-color: #1a9c77;
        }

        .notification.error {
            background-color: var(--danger-color);
            color: white;
            border-color: #b32a38;
        }

        .notification.warning {
            background-color: var(--favorite-color);
            color: #000;
            border-color: #d39e00;
        }

        .notification.info {
            background-color: var(--primary-color);
            color: white;
            border-color: #0056b3;
        }

        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: sticky;
            top: 0;
            transition: min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        body.sidebar-expanded .sidebar {
            min-width: 600px;
        }

        .main-content {
            flex-grow: 1;
            padding-bottom: 80px;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #sidebar-toggle-btn {
            display: none;
            background: var(--surface-hover);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            align-items: center;
            gap: 0.5rem;
        }

        .folder-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .folder-search-input {
            width: 100%;
            background: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }

        .folder-sort-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .folder-sort-buttons button {
            flex-grow: 1;
            background: var(--surface-hover);
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .folder-sort-buttons button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center; /* Centra l'icona */
            width: 36px; /* Larghezza fissa quadrata */
            padding: 0.5rem 0; /* Reset padding orizzontale */
        }

        .sidebar-actions button {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .folder-tree-container {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .folder-tree,
        .folder-tree ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .folder-tree li {
            padding-left: 20px;
            position: relative;
        }

        .folder-tree>li:first-child {
            padding-left: 0;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            position: relative;
        }

        .folder-item:hover {
            background-color: var(--surface-hover);
        }

        .folder-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .toggle-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            user-select: none;
        }

        .toggle-btn.empty {
            visibility: hidden;
        }

        .folder-link {
            flex-grow: 1;
            text-decoration: none;
            color: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 25px;
            cursor: pointer;
        }

        .folder-actions {
            margin-left: auto;
            display: flex;
            opacity: 1;
        }

        .folder-action-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .folder-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .folder-tree li.collapsed>ul {
            display: none;
        }

        .folder-tree li.is-hidden {
            display: none;
        }

        .folder-tree li:not(.collapsed)>.folder-item>.toggle-btn::before {
            content: '▾';
        }

        .folder-tree li.collapsed>.folder-item>.toggle-btn::before {
            content: '▸';
        }

        .folder-tree li.no-children>.folder-item>.toggle-btn {
            visibility: hidden;
        }

        #create-folder-btn {
            width: 100%;
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            margin-top: 1.5rem;
            flex-shrink: 0;
        }

        #create-folder-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .breadcrumbs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .breadcrumb-links {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            overflow: hidden;
            flex-grow: 1;
        }

        .breadcrumb-links a,
        .breadcrumb-links span {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            white-space: nowrap;
        }

        .breadcrumb-links a:hover {
            color: var(--text-color);
        }

        .breadcrumb-links span:last-child {
            color: var(--text-color);
            font-weight: 700;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .gallery-sort-controls {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .gallery-sort-controls .sort-btn {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            background: var(--surface-hover);
            color: var(--text-color);
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .gallery-sort-controls .sort-btn:hover {
            background: var(--surface-color);
        }

        .gallery-sort-controls .sort-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .file-count-badge {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            background: var(--surface-hover);
            color: var(--text-muted);
            font-weight: 600;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .filter-bar {
            padding: 1.5rem 2rem;
        }

        .filter-bar form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* NEW DESKTOP SEARCH PANEL STYLES */
        .search-overlay-panel {
            display: none;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.3s ease-out;
            position: relative;
            z-index: 900;
        }

        .search-overlay-panel.visible {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        /* SEARCH SCOPE STYLES */
        .search-scope-wrapper {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.5rem;
        }
        
        .scope-options {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        /* --- SCOPE SELECTOR VISUALS --- */
        .scope-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px; /* Slightly larger for touch */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s ease;
            flex: 1; /* Distribute space evenly */
            justify-content: center;
        }

        .scope-label:hover {
            background: var(--surface-hover);
            color: var(--text-color);
        }

        .scope-label.active {
            border-color: var(--primary-color);
            background: rgba(0, 123, 255, 0.2); /* Stronger visible color */
            color: white;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }
                
        .scope-label input[type="radio"] {
            margin: 0;
            accent-color: var(--primary-color);
        }

        .filter-bar label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Regola generale per testo e bottoni */
        .filter-bar select,
        .filter-bar input[type="text"],
        .filter-bar button,
        .filter-bar a {
            background: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .filter-bar input[type="date"] {
            background: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.75rem 0.25rem; 
            font-size: 0.9rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            color-scheme: dark; 
            width: 100%; 
        }

        .filter-bar input[type="text"]:focus,
        .filter-bar input[type="date"]:focus {   
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .filter-bar button {
            background: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            color: white;
            border: 1px solid var(--primary-color);
        }

        .filter-bar button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* Styling for the new Desktop Toggle Button */
        #search-toggle-desktop {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        #search-toggle-desktop:hover {
            background: var(--surface-hover);
        }
        
        #search-toggle-desktop.active-filters {
            background: rgba(0, 123, 255, 0.15);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 10px rgba(0,123,255,0.2);
        }

        .filter-bar button.refresh-btn {
            background: var(--workflow-color);
            border-color: var(--workflow-color);
        }

        /* AI Button Style */
        .filter-bar button.ai-btn {
            background: transparent;
            border: 1px solid var(--ai-color);
            color: white;
            font-size: 1.5rem;
            padding: 0 1rem;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .filter-bar button.ai-btn:hover {
            background: var(--ai-surface);
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--ai-color);
        }

        .filter-bar a {
            text-decoration: none;
            text-align: center;
            color: var(--text-muted);
        }

        .filter-bar a:hover {
            background: var(--surface-hover);
            color: var(--text-color);
        }

        .filter-group-inline {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .filter-group-inline input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .filter-actions-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-actions-row>a,
        .filter-actions-row>button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .filter-actions-row button[type="submit"] {
            padding-left: 0.8rem;
            padding-right: 0.8rem;
        }

        .mobile-actions-row {
            display: flex;
            gap: 0.75rem;
        }

        .mobile-actions-row>* {
            flex-grow: 1;
            text-align: center;
            justify-content: center;
        }

        .mobile-actions-row button {
            padding-left: 0.8rem;
            padding-right: 0.8rem;
        }

        .ts-control {
            background: var(--glass-bg) !important;
            border: 1px solid var(--glass-border) !important;
            border-radius: 8px !important;
            backdrop-filter: blur(10px) !important;
        }

        .ts-dropdown,
        .ts-control,
        .ts-control input {
            color: var(--text-color) !important;
        }

        .ts-dropdown {
            background: var(--surface-color) !important;
            border: 1px solid var(--border-color) !important;
            z-index: 1000;
            border-radius: 8px !important;
            box-shadow: var(--shadow-lg) !important;
        }

        #gallery-anchor {
            display: block;
            position: relative;
            top: -20px;
            visibility: hidden;
        }

        /* AI Mode Banner & Standard Global Search Banner */
        .ai-banner, .global-search-banner {
            background: var(--ai-surface);
            border-bottom: 1px solid var(--ai-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--ai-color);
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.2);
            animation: glow 2s infinite alternate;
        }
        
        .global-search-banner {
            background: rgba(0, 123, 255, 0.1); /* Blue for Standard */
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
            animation: glowBlue 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(255, 0, 255, 0.1); }
            to { box-shadow: 0 0 15px rgba(255, 0, 255, 0.4); }
        }
        
        @keyframes glowBlue {
            from { box-shadow: 0 0 5px rgba(0, 123, 255, 0.1); }
            to { box-shadow: 0 0 15px rgba(0, 123, 255, 0.4); }
        }

        .ai-banner-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        /* --- RECURSIVE SEARCH TOGGLE STYLE --- */
        .recursive-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.2s;
            width: fit-content;
        }

        .recursive-wrapper:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .recursive-wrapper input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .recursive-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
            user-select: none;
            cursor: pointer;
        }

        .recursive-wrapper.active {
            border-color: var(--primary-color);
            background: rgba(0, 123, 255, 0.1);
        }

        .recursive-wrapper.active .recursive-label {
            color: white;
        }
        
        /* --- RECURSIVE UI ENHANCEMENT --- */
        .recursive-wrapper.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none; /* Prevents clicks when scope is Global */
            filter: grayscale(1);
        }
        
        /* New Styles for AI Options and Lightbox */
        .ai-search-options-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        

            /* hide native arrows (Chrome, Safari, Edge, Opera) */
            input[type=number]::-webkit-outer-spin-button,
            input[type=number]::-webkit-inner-spin-button {
              -webkit-appearance: none;
              margin: 0;
            }
            /* hide native arrows (Firefox) */
            input[type=number] {
              -moz-appearance: textfield;
            }

            .ai-limit-container {
                display: flex;
                align-items: center;
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                overflow: hidden; /* Mantiene i bordi arrotondati */
                height: 36px; /* Altezza fissa per coerenza */
            }

            .ai-limit-btn {
                background: transparent;
                border: none;
                color: var(--ai-color);
                font-size: 1.2rem;
                font-weight: bold;
                width: 30px;
                height: 100%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            }

            .ai-limit-btn:hover {
                background: rgba(255, 0, 255, 0.2);
                color: white;
            }

            .ai-limit-input {
                background: transparent;
                border: none;
                border-left: 1px solid var(--glass-border);
                border-right: 1px solid var(--glass-border);
                color: white;
                width: 50px;
                height: 100%;
                font-size: 1rem;
                text-align: center;
                font-weight: bold;
                outline: none;
            }

            .ai-limit-input:focus {
                background: rgba(255, 255, 255, 0.05);
            }

        .ai-banner-actions button {
            background: transparent;
            border: 1px solid var(--ai-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .global-search-banner .ai-banner-actions button {
            border-color: var(--primary-color);
        }
        .global-search-banner .ai-banner-actions button:hover {
            background: var(--primary-color);
        }

        .ai-banner-actions button:hover {
            background: var(--ai-color);
        }

        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
            padding: 2rem;
            min-height: 50vh;
        }

        .gallery-item {
            background: var(--glass-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .gallery-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }

        .gallery-item.focused {
            outline: 2px solid var(--text-color);
            outline-offset: 2px;
        }

        /* Disable selection in Global AI Mode */
        
        .selection-checkmark {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--text-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 11;
            transition: all 0.3s;
            color: transparent;
            cursor: pointer;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .gallery-item.selected .selection-checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .thumbnail-link {
            cursor: pointer;
        }

        .thumbnail-wrapper {
            position: relative;
            width: 100%;
            background: var(--surface-color);
            overflow: hidden;
        }

        .thumbnail-wrapper img,
        .thumbnail-wrapper video {
            display: block;
            width: 100%;
            height: auto;
            transition: transform 0.3s;
        }

        .gallery-item:hover .thumbnail-wrapper img,
        .gallery-item:hover .thumbnail-wrapper video {
            transform: scale(1.05);
        }

        .item-info {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: 48px;
        }

        .item-info p {
            margin: 0;
            word-wrap: break-word;
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .file-metadata {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem 0.75rem;
        }

        .file-metadata span {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .item-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: auto;
            flex-wrap: wrap;
        }

        .item-actions a,
        .item-actions button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background: var(--glass-bg);
            color: var(--text-color);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .item-actions .delete-btn {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }

        .favorite-btn.favorited {
            background: var(--favorite-color);
            color: #000;
            border-color: var(--favorite-color);
        }

        .duration-overlay {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .workflow-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--workflow-color);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            text-decoration: none;
            font-weight: 600;
        }
        
        .ai-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--ai-color);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10;
            text-transform: uppercase;
        }

        #selection-bar {
            position: fixed;
            bottom: 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            left: 320px;
            right: 0;
            background: var(--glass-bg);
            border-top: 1px solid var(--glass-border);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1001;
            box-sizing: border-box;
            backdrop-filter: blur(20px);
            flex-wrap: wrap;
        }

        body.sidebar-expanded #selection-bar {
            left: 600px;
        }

        #selection-bar.visible {
            transform: translateY(0);
        }

        #selection-bar button {
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            border-radius: 8px;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        #selection-bar .delete-btn {
            background: var(--danger-color);
        }

        #selection-counter {
            font-weight: 700;
            margin-right: auto;
            padding-left: 1rem;
            color: var(--primary-color);
        }

        #drag-drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1002;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }

        #drag-drop-overlay.visible {
            display: block;
            opacity: 1;
        }

        #drop-zone-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            z-index: 1003;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: none;
            flex-direction: column;
            max-height: 80vh;
        }

        #drop-zone-panel.visible {
            display: flex;
        }

        #drop-zone-panel h3 {
            margin: 0;
            padding: 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            flex-shrink: 0;
        }

        #drop-zone-folders {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 0;
            min-height: 0;
            flex-grow: 1;
        }

        #cancel-drop-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 1rem;
            cursor: pointer;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }

        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s;
        }

        .loader {
            border: 4px solid var(--surface-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        #lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #lightbox-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 2001;
        }

        #lightbox-prev {
            left: 30px;
        }

        #lightbox-next {
            right: 30px;
        }

        #lightbox-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2002;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.4) 70%, transparent 100%);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            text-align: center;
        }

        #lightbox-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            word-break: break-word;
            hyphens: auto;
            max-width: 90vw;
        }
        
        #lightbox-folder-name {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-top: 0.2rem;
            font-weight: 600;
            opacity: 0.9;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        #lightbox-toolbar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        #lightbox-toolbar button,
        #lightbox-toolbar a {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
            backdrop-filter: blur(10px);
        }

        #lightbox-toolbar button:hover,
        #lightbox-toolbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* AI Caption Icon in Lightbox */
        #lightbox-caption-icon {
            color: var(--ai-color);
            border-color: var(--ai-color);
        }

        #lightbox-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 6rem 1rem 6rem; /* Added bottom padding for caption */
        }

        #lightbox-media {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 95vw;
            max-height: 80vh;
        }

        #lightbox-media img,
        #lightbox-media video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            cursor: grab;
        }
        
        #lightbox-ai-caption {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 700px;
            max-height: 40vh; /* Altezza massima */
            
            /* Layout Flex per gestire header fisso e content scrollabile */
            display: none; 
            flex-direction: column;
            overflow: hidden; /* Il contenitore NON scrolla */
            
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid var(--ai-color);
            border-radius: 12px;
            /* Padding ridotto sul container, spostato nel contenuto */
            padding: 10px; 
            
            z-index: 2020;
            color: #eee;
            font-size: 1rem;
            line-height: 1.5;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
        }
        
        #lightbox-ai-caption.visible {
            display: flex; /* Importante: flex per il layout */
            animation: slideUpCaption 0.3s ease-out;
        }

        /* Nuovo contenitore per il testo che scrolla */
        #lightbox-ai-text-scroll {
            overflow-y: auto; /* Solo questo div scrolla */
            flex-grow: 1;
            padding: 10px 15px; /* Padding interno per il testo */
            margin-top: 5px;
            padding-right: 5px; /* Spazio per scrollbar */
        }

        /* Stile scrollbar interno */
        #lightbox-ai-text-scroll::-webkit-scrollbar {
            width: 6px;
        }
        #lightbox-ai-text-scroll::-webkit-scrollbar-thumb {
            background-color: var(--ai-color);
            border-radius: 3px;
        }

        @keyframes slideUpCaption {
            from { transform: translate(-50%, 50px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        .caption-close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(10, 10, 10, 0.5); /* Sfondo leggero per leggibilità sopra testo */
            border-radius: 50%;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10; /* Sempre sopra */
        }
        
        .caption-close-btn:hover {
            color: var(--danger-color);
            background: rgba(255, 255, 255, 0.1);
        }
        
        #backToTopBtn-Old {
            display: none;
            position: fixed;
            bottom: 110px;
            right: 30px;
            z-index: 99;
            font-size: 1.2rem;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: var(--shadow-md);
        }
        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 110px;
            right: 30px;
            z-index: 2000; 
            font-size: 1.2rem;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: var(--shadow-md);
        }
        #load-more-container {
            text-align: center;
            padding: 3rem;
        }

        #load-more-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        #node-summary-overlay,
        #upload-overlay,
        #sync-overlay,
        #ai-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #node-summary-overlay {
            z-index: 2100;
        }

        #upload-overlay {
            z-index: 2200;
        }
        
        #ai-search-overlay {
            z-index: 2250;
        }

        #sync-overlay {
            z-index: 2300;
            display: none;
            opacity: 1;
            pointer-events: all;
        }

        #node-summary-overlay.visible,
        #upload-overlay.visible,
        #ai-search-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .node-summary-panel,
        #upload-panel,
        #sync-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 90vw;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* AI Modal Styles */
        .ai-modal-panel {
            background: var(--surface-color);
            border: 1px solid var(--ai-color);
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.2);
            width: 90vw;
            max-width: 500px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: scale(0.95);
            transition: transform 0.3s;
            position: relative;
        }
        
        #ai-search-overlay.visible .ai-modal-panel {
            transform: scale(1);
        }
        
        .ai-modal-header {
            text-align: center;
            color: white;
        }
        
        .ai-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .ai-search-textarea {
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }
        
        .ai-search-textarea:focus {
            outline: none;
            border-color: var(--ai-color);
            box-shadow: 0 0 10px rgba(255,0,255,0.2);
        }
        
        .ai-scope-selector {
            display: flex;
            background: var(--glass-bg);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }
        
        .ai-scope-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.3s;
        }
        
        .ai-scope-option.active {
            background: var(--ai-color);
            color: white;
            font-weight: bold;
        }
        
        .ai-search-submit {
            background: var(--ai-gradient);
            border: none;
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(255,0,255,0.3);
        }
        
        .ai-search-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,0,255,0.5);
        }
        
        .ai-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .node-summary-panel {
            max-width: 900px;
            max-height: 85vh;
        }

        #upload-panel {
            max-width: 600px;
            max-height: 85vh;
        }

        #sync-panel {
            max-width: 500px;
            padding: 2rem;
            align-items: center;
            text-align: center;
        }

        #node-summary-overlay.visible .node-summary-panel,
        #upload-overlay.visible #upload-panel {
            transform: scale(1);
        }

        .node-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--surface-color);
        }

        .node-summary-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .node-summary-header .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        #node-summary-content {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .summary-node-item {
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .summary-node-header {
            color: white;
            padding: 0.75rem 1rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .summary-node-header small {
            opacity: 0.8;
            font-weight: normal;
            margin-left: 0.5rem;
        }

        .summary-node-params {
            list-style: none;
            margin: 0;
            padding: 1rem;
            background: var(--glass-bg);
        }

        .summary-node-params li {
            padding: 0.5rem 0;
            font-size: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .summary-node-params li:last-child {
            border-bottom: none;
        }

        .summary-node-params strong {
            color: var(--text-color);
            margin-right: 0.5rem;
        }

        .summary-node-params code {
            color: var(--text-muted);
            word-break: break-all;
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 5px;
            border-radius: 4px;
        }

        #refresh-btn {
            margin-left: auto;
        }

        .upload-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .upload-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .upload-header p {
            margin: 0.5rem 0 0;
            color: var(--text-muted);
        }

        .upload-body {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        #drop-zone.dragover {
            border-color: var(--primary-color);
            background: var(--surface-hover);
            transform: scale(1.02);
        }

        #drop-zone p {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0 0 1rem 0;
        }

        #file-upload-btn {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        #file-list {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        #file-list li {
            background: var(--glass-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .upload-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .upload-footer button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        #upload-cancel-btn {
            background: var(--surface-hover);
            color: var(--text-color);
        }

        #upload-submit-btn {
            background: var(--success-color);
            color: white;
        }

        #upload-progress-container {
            display: none;
            margin-top: 1rem;
        }

        #upload-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        #upload-progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.2s;
        }

        #upload-file-input {
            display: none;
        }

        #sync-message {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        #sync-progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        #sync-progress-fill {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        #mobile-filter-toggle {
            display: none;
            width: 100%;
            background: var(--surface-hover);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: left;
        }

        .mobile-actions-only {
            display: none;
        }

        @media (max-width: 1024px) {
            /* 1. NOTIFICATIONS: Positioned lower and centered to avoid browser URL bar overlap */
            #notification-container {
                top: 120px !important; 
                right: auto !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                align-items: center !important;
                width: 85% !important;
                z-index: 10001 !important;
            }

            .notification {
                transform: translateY(-20px);
                border-left: none;
                border-bottom: 5px solid var(--primary-color);
                text-align: center;
                box-shadow: var(--shadow-lg);
                width: 100%;
            }

            /* 2. SIDEBAR HEADER: SmartGallery title on Left, Folders Button on Right */
            .sidebar-header {
                display: flex !important;
                justify-content: space-between !important; 
                align-items: center !important;
                width: 100% !important;
                gap: 10px;
                margin-bottom: 1rem;
            }

            .sidebar-header a h1 {
                font-size: 1.4rem; /* Slightly smaller for mobile space */
                white-space: nowrap;
            }

            .sidebar-actions {
                width: auto !important; /* Override fixed desktop width */
                display: flex !important;
                justify-content: flex-end !important;
                padding: 0 !important;
                gap: 0 !important;
            }

            #sidebar-toggle-btn {
                display: flex !important;
                white-space: nowrap !important;
                font-size: 0.85rem !important;
                padding: 0.5rem 0.8rem !important;
                background: var(--surface-hover);
                border-radius: 8px;
            }

            /* 3. WIDTH CONTROLS: Strictly hide desktop expansion/minify icons on mobile */
            #sidebar-minify-btn, 
            #sidebar-expand-btn {
                display: none !important;
            }

            /* 4. MOBILE NAVIGATION LOGIC */
            body.sidebar-expanded-mobile .sidebar {
                position: fixed;
                width: 100%;
                min-width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                transform: translateX(0);
                z-index: 1005;
            }

            body.sidebar-expanded-mobile .main-content {
                display: none;
            }

            body:not(.sidebar-expanded-mobile) {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 1.2rem;
            }

            .sidebar.nav-collapsed .folder-controls,
            .sidebar.nav-collapsed .folder-tree-container,
            .sidebar.nav-collapsed #create-folder-btn {
                display: none;
            }

            #selection-bar {
                left: 0;
            }

            body.sidebar-expanded #selection-bar {
                left: 0;
            }
        }
        
@media (max-width: 768px) {
            .breadcrumbs {
                flex-direction: column;
                align-items: stretch;
                padding: 0.5rem 1rem; 
            }

            .gallery-sort-controls {
                justify-content: space-between; 
                width: 100%;
                gap: 0.3rem; 
                flex-wrap: wrap; 
            }

            .gallery-sort-controls .sort-btn,
            .gallery-sort-controls .file-count-badge {
                padding: 0.4rem 0.5rem !important;
                font-size: 0.75rem !important;
                flex-grow: 1; 
                text-align: center;
                justify-content: center;
                white-space: nowrap;
            }

            .filter-bar form {
                grid-template-columns: 1fr;
            }

            #mobile-filter-toggle {
                display: block;
                margin-bottom: 1rem;
            }

            /* --- FIX: Allow panel to be visible on mobile when toggled --- */
            .search-overlay-panel {
                display: none; /* Hidden by default, but NOT !important so JS can override */
                width: 100%;
                margin-top: 5px;
                padding: 1rem;
            }
            
            .search-overlay-panel.visible {
                display: block !important;
            }

            .filter-form-grid {
                display: grid; /* Always grid inside the panel */
                grid-template-columns: 1fr;
            }

            .desktop-actions-only {
                display: none;
            }

            .mobile-actions-only {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .gallery-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            #selection-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
                padding: 1rem;
            }

            #selection-bar .actions-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                width: 100%;
            }

            #selection-bar>#select-all-btn,
            #selection-bar>#deselect-all-btn {
                grid-column: span 2;
            }

            #selection-counter {
                text-align: center;
                padding-left: 0;
                margin-bottom: 0.5rem;
            }

            #drop-zone-panel {
                width: 90vw;
            }

            .lightbox-nav {
                width: 50px;
                height: 50px;
            }

            #lightbox-prev {
                left: 10px;
            }

            #lightbox-next {
                right: 10px;
            }

            .node-summary-panel {
                width: 95vw;
                max-height: 90vh;
            }

            .summary-node-params li {
                font-size: 0.9rem;
            }
        }

        /* --- CSS RULE: Widen move panel on desktop screens --- */
        @media (min-width: 1025px) {
            #drop-zone-panel {
                width: 650px;
                max-width: 90vw;
                /* Adds a limit for very large screens */
            }
        }

        /* Shortcuts Help Popup */
        #shortcuts-help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #shortcuts-help-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .shortcuts-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 800px;           
            max-width: 95vw;
            max-height: 85vh;       
            display: flex;          
            flex-direction: column; 
            overflow: hidden;
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-hover);
            flex-shrink: 0; 
        }
        
        .shortcuts-header .close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            padding: 0 0.5rem;
            transition: color 0.2s;
        }
        .shortcuts-header .close-btn:hover {
            color: var(--danger-color);
        }

        .shortcuts-content {
            padding: 1.5rem;
            display: grid;
            gap: 0.5rem 2rem;       
            grid-template-columns: 1fr 1fr; 
            overflow-y: auto;      
            align-content: start;
        }

        
        @media (max-width: 768px) {
            .shortcuts-panel {
                width: 95vw;
            }
            .shortcuts-content {
                grid-template-columns: 1fr;
            }
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .shortcut-item .key {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 0 var(--border-color);
            font-size: 0.9rem;
        }

        .shortcut-item .desc {
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        
        /* --- LIGHTBOX SHORTCUTS BAR --- */
        #lightbox-shortcuts {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px; /* Ridotto per far stare tutto */
            align-items: center;
            background: rgba(0, 0, 0, 0.75); /* Leggermente più scuro per contrasto */
            backdrop-filter: blur(12px);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 2005;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }

        .kb-group {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.75rem; /* Testo leggermente più piccolo */
            font-weight: 500;
        }

        /* Classe speciale per evidenziare Quick Delete */
        .kb-danger {
            color: #ff6b6b; /* Rosso chiaro */
            font-weight: 700;
        }

        .kb-key {
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 1px 5px;
            min-width: 18px;
            text-align: center;
            font-family: monospace;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 2px 0 rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
            font-size: 0.75rem;
        }

        .kb-separator {
            width: 1px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 2px;
        }

        @media (max-width: 1024px) {
            #lightbox-shortcuts { display: none !important; }
        }
        
        /* --- LIGHTBOX LOADER --- */
        .lightbox-loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-bottom-color: var(--primary-color); /* Usa il colore blu del tema */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            /* Centramento perfetto considerando la trasformazione */
            margin-top: -25px; 
            margin-left: -25px;
            z-index: 15; /* Sopra l'immagine mentre carica */
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }        

        /* --- INPUT MEDIA IN NODE SUMMARY --- */
        .input-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-media-card {
            background: var(--surface-hover);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-media-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            font-size: 0.95rem;
            word-break: break-all;
            text-align: center;
        }

        .input-media-preview {
            width: 100%;
            height: 300px; 
            object-fit: contain;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        /* Audio player styling specific */
        audio.input-media-preview {
            height: 50px;
            margin-top: auto;
            margin-bottom: auto;
        }

        .input-media-actions {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            margin-top: auto;
        }

        .input-media-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .input-media-btn:hover {
            background: var(--primary-hover);
            text-decoration: none;
        }

        .input-media-btn.secondary {
            background: var(--surface-color);
            border-color: var(--border-color);
        }
        .input-media-btn.secondary:hover {
            background: rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            .input-media-grid {
                grid-template-columns: 1fr;
            }
            .input-media-preview {
                height: 200px; /* Più piccolo su mobile */
            }
        }

        .ai-input-wrapper {
            position: relative;
            width: 100%;
        }

        #ai-search-clear-text {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: none; /* Nascosto di default */
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        #ai-search-clear-text:hover {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }
        
        /* --- STILE TESTO BOTTONE AI --- */
        .ai-btn-text {
            color: var(--ai-color);
            font-weight: bold;
            margin-left: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
            text-shadow: 0 0 5px rgba(255, 0, 255, 0.3);
        }

        /* --- LAYOUT MOBILE HEADER (Filtri + AI) --- */
        .mobile-header-row {
            display: none; /* Nascosto su desktop */
            gap: 10px;
            margin-bottom: 1rem;
            width: 100%;
        }

        /* Modifiche Media Query per Mobile */
        @media (max-width: 768px) {
            /* Mostra la riga header su mobile */
            .mobile-header-row {
                display: flex; 
            }
            
            /* Il bottone filtri prende lo spazio rimanente */
            #mobile-filter-toggle {
                display: block; /* Assicuriamoci sia visibile */
                margin-bottom: 0 !important; /* Rimuove margine vecchio */
                flex-grow: 1; 
                text-align: center;
                width: auto; /* Reset larghezza */
            }

            /* Nascondi il bottone AI "Desktop" che sta in basso */
            #ai-search-toggle-desktop {
                display: none !important;
            }
            
            /* Hide the Desktop Toggle */
            #search-toggle-desktop {
                display: none !important;
            }

            /* Stile per il bottone AI "Mobile" in alto */
            #ai-search-toggle-mobile {
                background: var(--glass-bg);
                border: 1px solid var(--ai-color);
                color: white;
                border-radius: 8px;
                padding: 0 1rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0; /* Non si rimpicciolisce */
                transition: background 0.3s;
            }
            
            #ai-search-toggle-mobile:active {
                background: var(--ai-surface);
            }
        }
        
        /* --- STILI AI BANNER (DESKTOP & MOBILE) --- */
        .ai-banner {
            background: var(--ai-surface);
            border-bottom: 1px solid var(--ai-color);
            padding: 1rem 2rem;
            /* DESKTOP DEFAULT: Flexbox su una riga */
            display: flex; 
            align-items: center;
            justify-content: space-between;
            color: var(--ai-color);
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.2);
            animation: glow 2s infinite alternate;
        }

        .ai-banner-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            overflow: hidden; /* Per desktop */
            white-space: nowrap; /* Per desktop */
            text-overflow: ellipsis; /* Per desktop */
            margin-right: 15px;
        }

        .ai-query-part {
            color: white;
            margin-left: 5px;
        }

        .ai-banner-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* --- LAYOUT MOBILE AI BANNER (GRID) --- */
        @media (max-width: 768px) {
            .ai-banner, .global-search-banner {
                padding: 12px;
                /* Passiamo a Grid per controllo posizionale preciso */
                display: grid !important; 
                grid-template-columns: 1fr auto; /* Colonna 1: Label, Colonna 2: Bottoni */
                gap: 10px 0; /* Spazio verticale tra le righe */
                height: auto;
            }

            .ai-banner-title {
                /* TRUCCO: display: contents fa sparire il div contenitore dal layout,
                   così i suoi figli (span scope e span query) diventano figli diretti della Grid .ai-banner */
                display: contents !important; 
            }

            /* RIGA 1, COLONNA 1: Label (es. "🧠 Global") */
            .ai-scope-part {
                grid-column: 1;
                grid-row: 1;
                align-self: center;
                font-size: 0.95rem;
                white-space: nowrap;
            }

            /* RIGA 1, COLONNA 2: Bottoni (Edit/Exit) */
            .ai-banner-actions {
                grid-column: 2;
                grid-row: 1;
                align-self: center;
            }
            
            /* Bottoni un po' più compatti su mobile */
            .ai-banner-actions button {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            /* RIGA 2: Query utente (Tutta larghezza) */
            .ai-query-part {
                grid-column: 1 / -1; /* Occupa tutte le colonne */
                grid-row: 2;
                margin-left: 0;
                white-space: normal; /* Permette a capo */
                word-break: break-word;
                background: rgba(0,0,0,0.3); /* Sfondo scuro per risaltare */
                padding: 8px 10px;
                border-radius: 8px;
                border-left: 3px solid var(--ai-color);
                font-weight: normal;
                font-size: 1rem;
                line-height: 1.4;
            }
        }
 
        /* --- CAPTION (Start/Middle/End) --- */
        .ai-caption-card {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--ai-color);
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            padding: 0;
            overflow: hidden;
            transition: background 0.3s;
        }
        
        .ai-caption-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .ai-card-header {
            background: rgba(255, 0, 255, 0.15);
            color: var(--ai-color);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 5px 10px;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-card-body {
            padding: 10px 12px;
            color: #ddd;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Icone decorative per i frame */
        .ai-card-header::before {
            content: '⏱️';
            font-size: 0.9rem;
        }
        /* --- MODAL INFO AI --- */
        #ai-info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #ai-info-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .ai-info-panel {
            background: #111;
            border: 2px solid var(--ai-color); /* Bordo Fuxia */
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.25); /* Bagliore */
            text-align: center;
            color: #eee;
        }

        .ai-info-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }
        
        .ai-info-close:hover { color: var(--ai-color); }

        .ai-hero-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 10px var(--ai-color));
        }

        .ai-info-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #fff 0%, var(--ai-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-info-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: #ccc;
        }

        .ai-comparison-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: left;
            border-left: 4px solid var(--ai-color);
        }

        .ai-badge-light { color: var(--success-color); font-weight: bold; }
        .ai-badge-full { color: var(--ai-color); font-weight: bold; }

        .ai-cta-btn {
            display: inline-block;
            background: linear-gradient(90deg, var(--ai-color) 0%, #a0f 100%);
            color: white;
            text-decoration: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(180, 0, 255, 0.4);
        }

        .ai-cta-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(180, 0, 255, 0.6);
        }
        
        /* ---  MORE MODAL INFO AI --- */
        .ai-status-alert {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.4);
            color: #ffcccc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            display: inline-block;
            width: 100%;
        }

        .ai-status-alert code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff;
            font-family: monospace;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ai-steps-list {
            text-align: left;
            margin: 1.5rem 0;
            padding-left: 1.5rem;
            color: #ddd;
        }
        
        .ai-steps-list li {
            margin-bottom: 0.8rem;
        }
        
        .ai-steps-list strong {
            color: var(--ai-color);
        }
        /* --- STILI PER IL BLOCCO READ MORE (ACCORDION) --- */
        .ai-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin: 1.5rem 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
            overflow: hidden;
            transition: background 0.3s;
        }

        .ai-details:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .ai-details summary {
            padding: 12px 15px;
            cursor: pointer;
            font-weight: bold;
            color: var(--ai-color);
            list-style: none; /* Nasconde triangolo default */
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        /* Rimuove marker default su Safari/Chrome */
        .ai-details summary::-webkit-details-marker {
            display: none;
        }

        /* Freccetta personalizzata animata */
        .ai-details summary::after {
            content: '▼';
            font-size: 0.7rem;
            color: #888;
            transition: transform 0.3s ease;
        }

        .ai-details[open] summary::after {
            transform: rotate(180deg);
            color: var(--ai-color);
        }

        .ai-details-content {
            padding: 0 15px 15px 15px;
            color: #ccc;
            font-size: 1.05rem;
            line-height: 1.6;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 5px;
            padding-top: 10px;
        }
        
        .ai-details-content em {
            color: #fff;
            font-style: italic;
        }
        
        .limit-warning-box {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--favorite-color);
            color: var(--text-muted);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .limit-warning-icon {
            font-size: 1.2rem;
        }
        
        /* --- QUICK RESET FILTER ICON --- */
        .filter-reset-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            margin-left: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10; /* Ensure it stays on top */
        }

        .filter-reset-icon:hover {
            background: var(--danger-color);
            transform: scale(1.1);
        }
        
        /* --- POPOVER FIXED POSITIONING --- */
        #auto-refresh-popover {
            display: none;
            position: fixed;
            background: var(--surface-color);
            border: 1px solid var(--primary-color);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.9);
            z-index: 10000 !important;
            
            /* RESPONSIVE FIXES */
            width: 260px;          
            max-width: 85vw;       
            white-space: normal;   
            
            backdrop-filter: blur(10px);
            text-align: left;
        }

        #auto-refresh-popover.visible {
            display: flex !important;
            flex-direction: column;
            gap: 10px;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Effetto rimbalzo carino */
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Container del bottone split */
        .refresh-group {
            display: inline-flex;
            align-items: center;
            background: var(--workflow-color); /* Green background base */
            border-radius: 8px;
            border: 1px solid var(--workflow-color);
            position: relative; /* Anchor for popover */
        }

        #refresh-btn {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0.5rem 0.8rem !important;
            border-radius: 8px 0 0 8px !important;
            margin: 0 !important;
        }
        
        #refresh-btn:hover {
            background: rgba(0,0,0,0.1) !important;
        }

        /* Separatore */
        .refresh-separator {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.3);
        }

        #refresh-options-btn {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0.5rem 0.6rem !important;
            border-radius: 0 8px 8px 0 !important;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #refresh-options-btn:hover {
            background: rgba(0,0,0,0.2) !important;
        }

        /* --- AUTO-REFRESH ACTIVE INDICATOR --- */
        .refresh-group.auto-active {
            /* Keep original border and shadow color for the button group */
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
            border-color: var(--workflow-color);
        }

        .refresh-group.auto-active::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            /* Only the dot is red */
            background-color: #ff0000; 
            border-radius: 50%;
            box-shadow: 0 0 6px #ff0000;
            z-index: 10;
            /* Animation for pulsing effect */
            animation: pulse-dot-red 2s infinite;
            pointer-events: none;
        }

        /* Keyframes to make the red dot pulse */
        @keyframes pulse-dot-red {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(255, 0, 0, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }

        /* ARROW e INPUTS nel popover */
        .ar-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .ar-row label { margin: 0; font-size: 0.9rem; cursor: pointer; color: var(--text-color); }
        .ar-input { width: 60px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; border-radius: 4px; padding: 4px; text-align: center; }
        
        /* --- DESKTOP SIDEBAR MINIMIZED MODE --- */
        :root {
            --sidebar-min-width: 60px;
        }

        #sidebar-minify-btn {
            display: flex; /* Flex per centrare icona */
            justify-content: center;
            width: 32px; /* Larghezza fissa */
        }

        body.sidebar-minimized .sidebar {
            width: var(--sidebar-min-width);
            min-width: var(--sidebar-min-width);
            padding: 1.5rem 0.5rem; /* Padding laterale ridotto */
            overflow: hidden; /* Nasconde il contenuto che sborda */
        }

        /* Only hide these elements inside the sidebar, not globally */
        body.sidebar-minimized .sidebar h1,
        body.sidebar-minimized .sidebar .folder-controls,
        body.sidebar-minimized .sidebar .folder-tree-container,
        body.sidebar-minimized .sidebar #create-folder-btn,
        body.sidebar-minimized .sidebar #sidebar-expand-btn {
            display: none !important;
            opacity: 0; 
            transition: opacity 0.2s;
        }

        body.sidebar-minimized .sidebar-header {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 0;
            padding: 0;
        }

        body.sidebar-minimized .sidebar-actions {
            flex-direction: column;
            width: 100%;
            align-items: center;
            gap: 0;
        }
        
        body.sidebar-minimized #sidebar-minify-btn {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1.5rem;
        }
        
        /* --- NAVIGATION CHOICE MODAL --- */
        #nav-choice-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #nav-choice-overlay.visible { display: flex; opacity: 1; }
        
        .nav-choice-panel {
            background: var(--surface-color);
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-choice-panel h3 { margin-top: 0; color: white; }
        .nav-choice-panel p { color: var(--text-muted); margin-bottom: 1.5rem; }
        
        .nav-choice-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .nav-btn {
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        /* --- Highlight the focused button for keyboard navigation --- */
        .nav-btn:focus {
            outline: 3px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
            transform: scale(1.05); /* Slightly enlarge to show it's active */
        }
        .nav-btn-primary { background: var(--primary-color); color: white; }
        .nav-btn-secondary { background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); }
        .nav-btn-cancel { background: transparent; color: var(--text-muted); }
        
        .nav-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        </style>
        
</head>

<body>
    <div id="notification-container"></div>
    <!-- AUTO REFRESH SETTINGS POPOVER -->
    <div id="auto-refresh-popover">
        <h4 style="margin:0 0 10px 0; color:var(--primary-color);">🔄 Auto-Watch Folder</h4>
        
        <div class="ar-row">
            <label for="ar-toggle">Enable Auto-Refresh</label>
            <input type="checkbox" id="ar-toggle" style="accent-color:var(--primary-color); transform:scale(1.2);">
        </div>
        
        <div class="ar-row">
            <label for="ar-interval">Interval (seconds):</label>
            <input type="number" id="ar-interval" class="ar-input" value="60" min="5" max="3600">
        </div>
        
        <p style="font-size:0.75rem; color:var(--text-muted); margin:10px 0 0 0;">
            Only refreshes if changes are detected. Paused while viewing images.
        </p>
    </div>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('gallery_view', folder_key='_root_') }}" style="text-decoration: none;">
                <h1>SmartGallery</h1>
            </a>
            <div class="sidebar-actions">
                <button id="sidebar-minify-btn" title="Minimize Sidebar">
                    <span>◀</span>
                </button>
                <button id="sidebar-expand-btn" title="Expand Sidebar">
                    <span>↔️</span>
                </button>
                <button id="sidebar-toggle-btn">
                    <span>☰</span><span id="sidebar-toggle-text">Show Folders</span>
                </button>
            </div>
        </div>
        <div class="folder-controls">
            <input type="search" class="folder-search-input" id="folder-search-nav" placeholder="🔍 Search folders...">
            <div class="folder-sort-buttons" id="folder-sort-nav">
                <button data-sort="name" class="active" title="Sort by name">A-Z</button>
                <button data-sort="mtime" title="Sort by date">🗓️</button>
            </div>
        </div>
        <div class="folder-tree-container">
            <ul class="folder-tree" id="folder-tree-nav"></ul>
        </div>
        <button id="create-folder-btn">➕ Create New Folder</button>
    </aside>
    <div class="main-content">
        <header class="breadcrumbs">
            <div class="breadcrumb-links" style="{% if (is_ai_search and ' ||| ' not in ai_query) or is_global_search %}display:none;{% endif %}">
                {% for crumb in breadcrumbs %}
                <a href="{{ url_for('gallery_view', folder_key=crumb.key) }}">{{ crumb.display_name }}</a>
                {% if not loop.last %}<span>/</span>{% endif %}
                {% endfor %}
            </div>
            <div class="gallery-sort-controls">
                <!-- MODIFIED: Show count for Global/AI searches too -->
                <span class="file-count-badge">
                    {% if is_ai_search or is_global_search or is_recursive %}
                        🔍 Found {{ total_files }} Result{% if total_files != 1 %}s{% endif %}
                    {% else %}
                        📂 {{ total_files }} Files {% if total_files != total_folder_files %}({{ total_folder_files }} Total){% endif %}
                    {% endif %}
                </span>
                        
                {% if not is_ai_search %}
                    {% set current_sort_by = request.args.get('sort_by', 'date') %}
                    {% set current_sort_order = request.args.get('sort_order', 'desc') %}
                    {% set date_is_active = current_sort_by == 'date' %}
                    {% set date_next_order = 'asc' if date_is_active and current_sort_order == 'desc' else 'desc' %}
                    {% set date_query_params = dict(request.args.to_dict(flat=False), sort_by='date',
                    sort_order=date_next_order) %}
                    <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **date_query_params) }}"
                        class="sort-btn {{ 'active' if date_is_active else '' }}">
                        Sort by Date {% if date_is_active %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                    </a>
                    {% set name_is_active = current_sort_by == 'name' %}
                    {% set name_next_order = 'desc' if name_is_active and current_sort_order == 'asc' else 'asc' %}
                    {% set name_query_params = dict(request.args.to_dict(flat=False), sort_by='name',
                    sort_order=name_next_order) %}
                    <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **name_query_params) }}"
                        class="sort-btn {{ 'active' if name_is_active else '' }}">
                        Sort by Name {% if name_is_active %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                    </a>
                {% endif %}
            </div>
        </header>

        {% if is_ai_search %}
        <div class="ai-banner">
            <div class="ai-banner-title" id="ai-banner-text" data-raw-query="{{ ai_query }}">
                <span>🧠</span> Loading AI Results...
            </div>
            <div class="ai-banner-actions">
                <button onclick="openAiSearchModal()" title="Edit Search Parameters" style="margin-right: 8px;">
                    ✏️ Edit
                </button>
                <button onclick="window.location.href='{{ url_for('gallery_view', folder_key=current_folder_key) }}'">
                    Exit AI Mode
                </button>
            </div>
        </div>
        {% endif %}
        
        <!-- NEW GLOBAL STANDARD SEARCH BANNER -->
        {% if is_global_search and not is_ai_search %}
        <div class="global-search-banner">
            <div class="ai-banner-title">
                <span class="ai-scope-part"><span>🌐</span> Global Search Results</span>
                <span class="ai-query-part">Showing all matches</span>
            </div>
            <div class="ai-banner-actions">
                <button onclick="window.location.href='{{ url_for('gallery_view', folder_key=current_folder_key) }}'">
                    Exit Global Search
                </button>
            </div>
        </div>
        {% endif %}

        {% if not is_ai_search %}
        <div class="filter-bar">
            <!-- WRAPPER FOR TOGGLE FORM -->
            <form method="GET" action="{{ url_for('gallery_view', folder_key=current_folder_key) }}" id="filter-form">
                <input type="hidden" name="sort_by" value="{{ request.args.get('sort_by', 'date') }}">
                <input type="hidden" name="sort_order" value="{{ request.args.get('sort_order', 'desc') }}">
                
                <!-- MOBILE HEADER: Filters + AI -->
                <div class="mobile-header-row">
                    <!-- Updated Button with Quick Reset X -->
                    <button type="button" id="mobile-filter-toggle">
                        ⚙️ Filters {% if active_filters_count > 0 %}({{ active_filters_count }}){% endif %}
                        {% if active_filters_count > 0 %}
                            <span class="filter-reset-icon" title="Clear all filters">✕</span>
                        {% endif %}
                    </button>
                    
                    {% if enable_ai_search %}
                    <button type="button" id="ai-search-toggle-mobile" title="Semantic AI Search">
                        🧠 <span class="ai-btn-text">AI Search</span>
                    </button>
                    {% endif %}
                </div>
                
                <!-- DESKTOP ACTIONS ROW (BUTTONS) -->
                <div class="filter-actions-row">
                    <!-- Standard Filter Toggle Desktop with Quick Reset X -->
                    <button type="button" id="search-toggle-desktop" class="desktop-actions-only {% if active_filters_count > 0 %}active-filters{% endif %}">
                        🔍 Search & Filters {% if active_filters_count > 0 %}({{ active_filters_count }}){% endif %}
                        {% if active_filters_count > 0 %}
                            <span class="filter-reset-icon" title="Clear all filters">✕</span>
                        {% endif %}
                    </button>

                    <!-- AI Search Button (DESKTOP) - Hidden if AI is not enabled -->
                    {% if enable_ai_search %}
                    <button type="button" class="ai-btn" id="ai-search-toggle-desktop" title="Semantic AI Search">
                        🧠 <span class="ai-btn-text">AI Search</span>
                    </button>
                    {% endif %}
                    
                    <!-- Select All (Always visible) -->
                    <button type="button" id="main-select-all-btn">✅ Select All</button>

                    <!-- Folder Actions: Hide during Global Search (Standard or AI Global) -->
                    {% if not is_global_search and not (is_ai_search and ' ||| ' not in ai_query) %}
                        <button type="button" id="show-upload-modal-btn">☁️ Upload</button>
                        <button type="button" id="rescan-folder-btn" style="background:var(--workflow-color);border-color:var(--workflow-color);">♻️ Rescan</button>
                        <!-- SPLIT REFRESH BUTTON -->
                        <div class="refresh-group" id="refresh-container">
                            <button type="button" id="refresh-btn" title="Manual Refresh">♻️ Refresh</button>
                            <div class="refresh-separator"></div>
                            <button type="button" id="refresh-options-btn" title="Auto-Refresh Options">⋮</button>
                            
                            <!-- POPOVER INSIDE THE CONTAINER FOR POSITIONING -->
                            <div id="auto-refresh-popover">
                                <h4 style="margin:0 0 10px 0; color:var(--success-color); font-size:1rem;">⏱️ Auto-Watch</h4>
                                
                                <div class="ar-row">
                                    <label for="ar-toggle">Enable Watch</label>
                                    <input type="checkbox" id="ar-toggle" style="accent-color:var(--success-color); transform:scale(1.2);">
                                </div>
                                
                                <div class="ar-row" style="margin-top:8px;">
                                    <label for="ar-interval">Seconds:</label>
                                    <input type="number" id="ar-interval" class="ar-input" value="10" min="5" max="3600">
                                </div>
                                
                                <p style="font-size:0.75rem; color:var(--text-muted); margin:10px 0 0 0; line-height:1.3;">
                                    Silent refresh: updates only if new files are found.
                                </p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- COLLAPSIBLE FILTER PANEL (DESKTOP & MOBILE INTEGRATED) -->
                <!-- On desktop this is handled by search-toggle-desktop via JS. On mobile by mobile-filter-toggle via JS. -->
                <div class="search-overlay-panel" id="desktop-search-panel">
                    <div class="filter-form-grid" id="filter-form-grid">
                        
                        <!-- NEW SCOPE SELECTOR (No auto-submit) -->
                        <div class="filter-group">
                            <label>Search Scope</label>
                            <div class="scope-options">
                                <label class="scope-label {% if current_scope == 'local' %}active{% endif %}">
                                    <input type="radio" name="scope" value="local" {% if current_scope == 'local' %}checked{% endif %}>
                                    📂 Current Folder
                                </label>
                                <label class="scope-label {% if current_scope == 'global' %}active{% endif %}">
                                    <input type="radio" name="scope" value="global" {% if current_scope == 'global' %}checked{% endif %}>
                                    🌐 Global (All)
                                </label>
                            </div>
                            <!-- Inside Search Scope filter-group -->
                            <label class="recursive-wrapper {% if request.args.get('recursive') == 'true' %}active{% endif %}" id="recursive-standard-ui">
                                <input type="checkbox" name="recursive" value="true" {% if request.args.get('recursive') == 'true' %}checked{% endif %} onchange="this.parentElement.classList.toggle('active', this.checked)">
                                <span class="recursive-label">📂 Include Subfolders</span>
                            </label>
                        </div>
                        
                        <div class="filter-group"><label for="search-input">🔍 Search by Name</label><input type="text"
                                name="search" id="search-input" placeholder="Search files..."
                                value="{{ request.args.get('search', '') }}"></div>
                        <div class="filter-group">
                            <label for="workflow-files-input">⚙️ Workflow Files</label>
                            <input type="text" 
                                   name="workflow_files" 
                                   id="workflow-files-input" 
                                   placeholder="e.g. wan2.2, lorax, ab.png" 
                                   value="{{ request.args.get('workflow_files', '') }}"
                                   title="Search for filenames used inside the workflow (e.g. models, loras, inputs). Separate multiple terms with commas.">
                        </div>
                        <!-- PROMPT FILTER -->
                        <div class="filter-group">
                            <label for="workflow-prompt-input">🎨 Prompt Keywords</label>
                            <input type="text" 
                                   name="workflow_prompt" 
                                   id="workflow-prompt-input" 
                                   placeholder="e.g. woman, kimono..." 
                                   value="{{ request.args.get('workflow_prompt', '') }}"
                                   title="Search for keywords inside the workflow positive prompt. Separate multiple terms with commas.">
                        </div>
                        <div class="filter-group"><label for="extension-select">📄 Extensions</label><select
                                name="extension" id="extension-select" multiple>{% for ext in available_extensions %}<option
                                    value="{{ ext }}" {% if ext in selected_extensions %}selected{% endif %}>{{ ext }}
                                </option>{% endfor %}</select></div>
                        <div class="filter-group">
                            <label for="prefix-select">🏷️ Prefixes</label>
                            
                            <!-- 1. Warning Container (Hidden/Shown by JS/CSS) -->
                            <div id="prefix-warning-container" class="limit-warning-box" style="display: {% if prefix_limit_reached %}flex{% else %}none{% endif %};" title="To ensure good performance, the list is hidden.">
                                <span class="limit-warning-icon">⚠️</span>
                                <span>
                                    Too many prefixes found.<br>
                                    Please use <strong>Search by Name</strong> instead.
                                </span>
                            </div>

                            <!-- 2. Dropdown Container (Hidden/Shown by JS/CSS) -->
                            <div id="prefix-select-container" style="display: {% if prefix_limit_reached %}none{% else %}block{% endif %};">
                                <select name="prefix" id="prefix-select" multiple>
                                    {% for pfx in available_prefixes %}
                                        {% if pfx != '.gallery ' %}
                                            <option value="{{ pfx }}" {% if pfx in selected_prefixes %}selected{% endif %}>{{ pfx }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- NEW: Date Range Group -->
                        <div class="filter-group">
                            <label>📅 Date Range</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 160px;">
                                    <label for="start-date" style="font-size: 0.75rem; margin-bottom: 2px; display:block;">From:</label>
                                    <input type="date" name="start_date" id="start-date" 
                                           value="{{ request.args.get('start_date', '') }}" 
                                           style="width: 100%;">
                                </div>
                                <div style="flex: 1; min-width: 160px;">
                                    <label for="end-date" style="font-size: 0.75rem; margin-bottom: 2px; display:block;">To:</label>
                                    <input type="date" name="end_date" id="end-date" 
                                           value="{{ request.args.get('end_date', '') }}" 
                                           style="width: 100%;">
                                </div>
                            </div>
                        </div>

                        <!-- MODIFIED: Options Group -->
                        <div class="filter-group">
                            <label>Options</label>
                            
                            <!-- Favorites -->
                            <div class="filter-group-inline">
                                <input type="checkbox" name="favorites" id="favorites-check" value="true" 
                                       {% if request.args.get('favorites') == 'true' %}checked{% endif %}>
                                <label for="favorites-check">⭐ Favorites Only</label>
                            </div>

                            <!-- No Workflow -->
                            <div class="filter-group-inline">
                                <input type="checkbox" name="no_workflow" id="no-workflow-check" value="true" 
                                       {% if request.args.get('no_workflow') == 'true' %}checked{% endif %}>
                                <label for="no-workflow-check">🚫 No Workflow</label>
                            </div>

                            <!-- No AI Caption (Conditional) -->
                            {% if enable_ai_search %}
                            <div class="filter-group-inline">
                                <input type="checkbox" name="no_ai_caption" id="no-ai-caption-check" value="true" 
                                       {% if request.args.get('no_ai_caption') == 'true' %}checked{% endif %}>
                                <label for="no-ai-caption-check">😶 No AI Caption</label>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="filter-group">
                            <label>Actions</label>
                             <div class="filter-actions-row"><button type="submit">🔍 Filter</button><a
                                    href="{{ url_for('gallery_view', folder_key=current_folder_key) }}">🔄 Reset</a></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
        
        <div id="gallery-anchor"></div>
        <main class="gallery-container" id="gallery-container"></main>
        
        <div id="load-more-container"><button id="load-more-btn">📂 Load More</button></div>
    </div>
    <button onclick="scrollToTop()" id="backToTopBtn" title="Go to Top" style="display: none;"><svg width="20"
            height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="18 15 12 9 6 15"></polyline>
        </svg></button>
    <div id="drag-drop-overlay"></div>
    <div id="drop-zone-panel">
        <h3>📁 Move to Folder:</h3>
        <div class="folder-controls" style="padding: 0 1rem; margin-top: 1rem;">
            <input type="search" class="folder-search-input" id="folder-search-move" placeholder="🔍 Search folders...">
            <div class="folder-sort-buttons" id="folder-sort-move"><button data-sort="name"
                    class="active">A-Z</button><button data-sort="mtime">🗓️</button></div>
        </div>
        <div id="drop-zone-folders">
            <div class="folder-tree-container" style="padding: 1rem;">
                <ul class="folder-tree" id="move-folder-tree"></ul>
            </div>
        </div>
        <button id="cancel-drop-btn">❌ Cancel</button>
    </div>
    <div id="selection-bar">
        <span id="selection-counter">0 files selected</span>
        <div class="actions-grid"><button id="move-selected-btn">📁 Move</button><button id="favorite-selected-btn">⭐
                Add</button><button id="unfavorite-selected-btn">☆ Remove</button><button id="download-zip-btn">📦
                Zip</button><button id="delete-selected-btn" class="delete-btn">🗑️ Delete</button><button
                id="range-select-btn" style="display:none;">↔️ Range</button><button id="select-all-btn">✅
                All</button><button id="deselect-all-btn">❌ None</button></div>
    </div>
    <div id="lightbox-overlay">
        <div id="lightbox-header">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <div id="lightbox-title"></div>
                <div id="lightbox-folder-name"></div>
            </div>
            
            <div id="lightbox-toolbar">
                <button id="lightbox-zoom-out" title="Zoom Out">-</button>
                <button id="lightbox-zoom-in" title="Zoom In">+</button>
                <a id="lightbox-download" href="#" title="Download File">💾</a>
                <button id="lightbox-rename-btn" title="Rename File">✏️</button>
                <button id="lightbox-summary-btn" title="Node Summary">📝</button>
                <button id="lightbox-caption-icon" title="View AI Caption" style="display:none;">🧠</button>
                <a id="lightbox-workflow" href="#" class="workflow-btn" title="Download Workflow">⚙️</a>
                <button id="lightbox-copy-json" title="Copy Workflow to Clipboard" style="display:none;">📋</button>
                <button id="lightbox-delete-btn" title="Delete File">🗑️</button>
                <a id="lightbox-new-tab" href="#" target="_blank" title="Open in New Tab">↗️</a>
                <button class="close-btn" onclick="closeLightbox()" title="Close">×</button>
            </div>
        </div>
        <div id="lightbox-content">
            <div id="lightbox-media"></div>
            <div id="lightbox-ai-caption"></div>
        </div>
        <button id="lightbox-prev" class="lightbox-nav">‹</button><button id="lightbox-next"
            class="lightbox-nav">›</button>

        <!-- Keyboard Shortcuts Bar (Desktop Only) -->
        <div id="lightbox-shortcuts">
            <!-- Nav -->
            <div class="kb-group">
                <span class="kb-key">←</span>
                <span class="kb-key">→</span>
                <span>Nav</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Zoom -->
            <div class="kb-group">
                <span class="kb-key">+</span>
                <span class="kb-key">-</span>
                <span>Zoom</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Node Summary -->
            <div class="kb-group">
                <span class="kb-key">N</span>
                <span>Nodes</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Workflow -->
            <div class="kb-group">
                <span class="kb-key">W</span>
                <span>Workflow</span>
            </div>
            <div class="kb-separator"></div>
            
            <div class="kb-group">
                <span class="kb-key">C</span>
                <span>Copy JSON</span>
            </div>
            <div class="kb-separator"></div>
            
            <!-- Open New Tab -->
            <div class="kb-group">
                <span class="kb-key">O</span>
                <span>New Tab</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Rename -->
            <div class="kb-group">
                <span class="kb-key">R</span>
                <span>Rename</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Quick Delete -->
            <div class="kb-group">
                <span class="kb-key">D</span>
                <span class="kb-key">Del</span>
                <span class="kb-danger">Quick Delete</span>
            </div>
            <div class="kb-separator"></div>

            <!-- Esc -->
            <div class="kb-group">
                <span class="kb-key">Esc</span>
                <span>Close</span>
            </div>
        </div>
        
    </div>
    <div id="node-summary-overlay">
        <div class="node-summary-panel">
            <div class="node-summary-header">
                <h2>📝 Node Summary</h2><button class="close-btn" id="close-summary-btn">×</button>
            </div>
            <div id="node-summary-content"></div>
        </div>
    </div>
    <div id="upload-overlay">
        <div id="upload-panel">
            <div class="upload-header">
                <h2>Upload Files</h2>
                <p id="upload-destination-text">Upload to: <strong></strong></p>
            </div>
            <div class="upload-body"><input type="file" id="upload-file-input" multiple>
                <div id="drop-zone">
                    <p>Drag & Drop files here</p><button type="button" id="file-upload-btn">Or select files...</button>
                </div>
                <ul id="file-list"></ul>
                <div id="upload-progress-container">
                    <div id="upload-progress-bar">
                        <div id="upload-progress-fill"></div>
                    </div>
                </div>
            </div>
            <div class="upload-footer"><button type="button" id="upload-cancel-btn">Cancel</button><button type="button"
                    id="upload-submit-btn">Upload</button></div>
        </div>
    </div>
    <div id="sync-overlay">
        <div id="sync-panel">
            <h3 id="sync-message">Scanning...</h3>
            <div id="sync-progress-bar">
                <div id="sync-progress-fill"></div>
            </div>
        </div>
    </div>
    
    <!-- AI Search Modal -->
    <div id="ai-search-overlay">
        <div class="ai-modal-panel">
            <button class="ai-modal-close" id="ai-modal-close">×</button>
            <div class="ai-modal-header">
                <h2>🧠 Semantic Search</h2>
                <p style="color: #ccc; margin-top: 5px;">Powered by SmartGallery AI</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div class="ai-search-options-row">
                    <div style="flex:1;">
                        <label style="color: #fff; font-weight: bold; display:block; margin-bottom:5px;">Search Scope:</label>
                        <div class="ai-scope-selector">
                            <div class="ai-scope-option active" data-scope="global" onclick="selectAiScope('global')">Global (All)</div>
                            <div class="ai-scope-option" data-scope="local" onclick="selectAiScope('local')">Current Folder</div>
                        </div>
                        <!-- NEW: Recursive Toggle for AI (hidden by default, shown by JS when local is selected) -->
                        <label class="recursive-wrapper" id="ai-recursive-toggle" style="display:none; margin-top:10px; width:100%; justify-content:center;">
                            <input type="checkbox" id="ai-search-recursive" value="true">
                            <span class="recursive-label">📂 Include Subfolders</span>
                        </label>
                        
                    </div>
                    <div>
                        <label style="color: #fff; font-weight: bold; display:block; margin-bottom:5px;">Max Results:</label>
                        <div class="ai-limit-container">
                            <!-- Minus Button -->
                            <button class="ai-limit-btn" onclick="adjustAiLimit(-50)">-</button>
                            
                            <!-- Input (native arrows hidden via CSS) -->
                            <input type="number" id="ai-search-limit" class="ai-limit-input" value="100" min="10" max="1000" step="10">
                            
                            <!-- Plus Button -->
                            <button class="ai-limit-btn" onclick="adjustAiLimit(50)">+</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="ai-input-wrapper">
                    <textarea id="ai-search-input" class="ai-search-textarea" placeholder="Describe what you are looking for in English..."></textarea>
                    <button id="ai-search-clear-text" title="Clear Query">×</button>
                </div>
            </div>
            
            <button id="ai-search-submit" class="ai-search-submit">Search</button>
        </div>
    </div>

    <!-- AI INFO / PROMO MODAL -->
    <div id="ai-info-overlay">
        <div class="ai-info-panel">
            <button class="ai-info-close" onclick="closeAiInfoModal()">×</button>
            
            <div class="ai-hero-icon">🧠✨</div>
            <h2 class="ai-info-title">Enable Semantic AI <span style="font-size:0.6em; color:#fff; font-weight:normal;">(Free & Local)</span></h2>
            
            <!-- STATUS ALERT BOX -->
            <div class="ai-status-alert">
                ⚠️ <strong>AI is currently disabled.</strong><br>
                Your environment variable is detected as: <code>ENABLE_AI_SEARCH=False</code>
                <p class="ai-info-text">
                    To unlock the AI features, you need to set the variable to <code>true</code>. 
                    Depending on your current installation, follow the steps below:
                </p>

            </div>

            <div class="ai-comparison-box">
                <h3 style="margin-top:0; color:white;">Activation Guide:</h3>
                
                <!-- SCENARIO A: GIÀ INSTALLATO -->
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <strong>🔹 Case A: You already have the AI files</strong><br>
                    <span style="font-size: 0.9rem; color: #bbb;">(You previously downloaded the full AI version)</span><br>
                    <p style="margin: 5px 0 0 0;">
                        You just need to set <code>ENABLE_AI_SEARCH=true</code> in your startup script or environment and restart. No new downloads required.
                    </p>
                </div>

                <!-- SCENARIO B: NUOVA INSTALLAZIONE -->
                <div>
                    <strong>🔹 Case B: You are on the Light Version</strong><br>
                    <span style="font-size: 0.9rem; color: #bbb;">(First time enabling AI)</span><br>
                    <ol class="ai-steps-list" style="margin-top: 5px; margin-bottom: 0;">
                        <li>
                            <strong>Upgrade:</strong> Read the instructions & Install the Full AI Configuration from our GitHub repo ->  
                            <a href="https://github.com/biagiomaf/smart-comfyui-gallery" target="_blank" style="color:var(--ai-color); word-break: break-all;">*here*</a> 
                        </li>
                        <li><strong>Activate:</strong> Set ENABLE_AI_SEARCH=true and restart.</li>
                    </ol>
                </div>
            </div>

            <!-- SEMANTIC SEARCH EXPLANATION (COLLAPSIBLE) -->
            <details class="ai-details">
                <summary>🤔 What is Semantic Search? (Read More)</summary>
                <div class="ai-details-content">
                    <p>Standard search only looks for exact filenames (e.g., <code>img_001.png</code>). Semantic Search is different: it <strong>understands</strong> the content of your image.</p>
                    <p>Using <strong>Florence-2</strong> (Vision) and <strong>Nomic</strong> (Embeddings), the system scans your images and creates a mathematical map of their meaning.</p>
                    <p>This allows you to search for concepts like <em>"a cyberpunk city in the rain"</em> or <em>"red flowers on a table"</em>, even if those words are not in the filename. We are thrilled to bring this advanced technology to your local machine!</p>
                </div>
            </details>
                
            <p style="font-size: 1.2rem; color: #aaa; margin-bottom: 1.5rem;">
                🛡️ <strong>Privacy Guaranteed:</strong> Our AI models run <strong>100% locally</strong>. 
                No external API calls. Your images never leave your computer.
            </p>

            <a href="https://github.com/biagiomaf/smart-comfyui-gallery" target="_blank" class="ai-cta-btn">
                🚀 View Installation Guide
            </a>
        </div>
    </div>
    
    <div id="rescan-modal-overlay"
        style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:2400;display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:opacity 0.3s;">
        <div
            style="background:var(--surface-color);border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--shadow-lg);padding:2rem;max-width:400px;text-align:center;">
            <h3 style="margin-top:0;">♻️ Rescan Folder</h3>
            <p style="color:var(--text-muted);margin-bottom:1.5rem;">Choose how you want to rescan files in this folder.
            </p>
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <button id="rescan-recent-btn"
                    style="background:var(--primary-color);color:white;border:none;padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Rescan
                    Outdated (> 1h)</button>
                <button id="rescan-all-btn"
                    style="background:var(--danger-color);color:white;border:none;padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Rescan
                    All Files</button>
                <button id="rescan-cancel-btn"
                    style="background:var(--surface-hover);color:var(--text-color);border:1px solid var(--border-color);padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Cancel</button>
            </div>
        </div>
    </div>
    <div id="loader-overlay">
        <div class="loader"></div>
    </div>
    <div id="shortcuts-help-overlay">
        <div class="shortcuts-panel">
            <div class="shortcuts-header">
                <h2>⌨️ Keyboard Shortcuts</h2>
                <button class="close-btn" id="close-shortcuts-btn">×</button>
            </div>
            <div class="shortcuts-content">
                <div class="shortcut-item"><span class="key">?</span> <span class="desc">Show this help</span></div>
                <div class="shortcut-item"><span class="key">←</span> <span class="key">→</span> <span
                        class="key">↑</span> <span class="key">↓</span> <span class="desc">Navigate images</span></div>
                <div class="shortcut-item"><span class="key">V</span> <span class="desc">View image (Lightbox)</span>
                </div>
                <div class="shortcut-item"><span class="key">X</span> <span class="desc">Select / Deselect image</span>
                </div>
                <div class="shortcut-item"><span class="key">F</span> <span class="desc">Favorite / Unfavorite</span>
                </div>
                <div class="shortcut-item"><span class="key">S</span> <span class="desc">Download Image</span></div>
                <div class="shortcut-item"><span class="key">W</span> <span class="desc">Download Workflow (if
                        available)</span></div>
                <div class="shortcut-item"><span class="key">C</span> <span class="desc">Copy Workflow to Clipboard</span></div>
                <div class="shortcut-item"><span class="key">L</span> <span class="desc">Refresh View</span></div>
                <div class="shortcut-item"><span class="key">K</span> <span class="desc">Rescan Folder</span></div>
                <div class="shortcut-item"><span class="key">R</span> <span class="desc">Rename File</span></div>
                <div class="shortcut-item"><span class="key">Z</span> <span class="desc">Download Zip (Selected)</span>
                </div>
                <div class="shortcut-item"><span class="key">D</span> <span class="desc">Delete (Selected)
                        File(s)</span></div>
                <div class="shortcut-item"><span class="key">Esc</span> <span class="desc">Close Lightbox / Deselect
                        All</span></div>
                <div class="shortcut-item"><span class="key">M</span> <span class="desc">Move Selected Files</span>
                </div>
                <div class="shortcut-item"><span class="desc">Lightbox view:</span></div>
                <div class="shortcut-item"><span class="key">O</span> <span class="desc">Open in New Tab</span></div>
                <div class="shortcut-item"><span class="key">N</span> <span class="desc">Node Summary</span></div>
                <div class="shortcut-item"><span class="key">+</span> <span class="key">-</span> <span class="desc">Zoom
                        In/Out</span></div>
                <div class="shortcut-item"><span class="key">Keypad (Num 789/456/123)</span> <span class="desc">Pan
                        Diagonally/Up/Down/Left/Right</span></div>
                <div class="shortcut-item"><span class="key">0</span> <span class="desc">Reset Zoom/Pan</span></div>
                <div class="shortcut-item"><span class="key">.</span> <span class="desc">Cycle Pan Step</span></div>
                <div class="shortcut-item"><span class="key">H</span> <span class="desc">Hide Toolbar (5s)</span></div>
            </div>
        </div>
    </div>
    <!-- NAVIGATION CHOICE MODAL -->
    <div id="nav-choice-overlay">
        <div class="nav-choice-panel">
            <h3>🔍 Filters are Active</h3>
            <p>You are moving to a new folder. How would you like to proceed with your current search settings?</p>
            <div class="nav-choice-actions">
                <button id="nav-keep-filters" class="nav-btn nav-btn-primary">✨ Keep Filters & Navigate</button>
                <button id="nav-reset-filters" class="nav-btn nav-btn-secondary">📁 Reset & Browse Folder</button>
                <button id="nav-cancel" class="nav-btn nav-btn-cancel">Cancel</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
    <script>
        // --- DATA INITIALIZATION AND GLOBAL STATE ---
        const foldersData = {{ folders | tojson }};
        const currentFolderInfo = {{ current_folder_info | tojson }};
        const protectedFolderKeys = {{ protected_folder_keys | tojson }};
        const initialFiles = {{ files | tojson }};
        let totalFiles = {{ total_files }};
        let totalFolderFiles = {{ total_folder_files }};
        const currentFolderKey = '{{ current_folder_key }}';
        const ancestorKeys = {{ ancestor_keys | tojson }};
        
         // --- AI SEARCH VARIABLES ---
        const enableAiSearch = {{ enable_ai_search | tojson }};
        const isAiSearch = {{ is_ai_search | tojson }};
        const isGlobalSearch = {{ is_global_search | tojson }};
        const activeFiltersCount = {{ active_filters_count }};
        const rawAiQuery = {{ ai_query | tojson }};
        const isAiGlobal = isAiSearch && (rawAiQuery && rawAiQuery.indexOf(" ||| ") === -1);
        let currentAiScope = 'global'; 

        const galleryContainer = document.getElementById('gallery-container');
        const selectionBar = document.getElementById('selection-bar');
        const selectionCounter = document.getElementById('selection-counter');
        const loaderOverlay = document.getElementById('loader-overlay');
        const backToTopBtn = document.getElementById('backToTopBtn');
        let currentItemCount = 0;
        let galleryItems = [];
        let allFilesData = [];
        const selectedFiles = new Set();
        let lastSelectedItem = null;
        let currentSearch = { nav: '', move: '' };
        let focusedItemIndex = -1;

        // --- UI STATE PERSISTENCE MANAGEMENT ---
        const savedSort = localStorage.getItem('gallerySortPreference');
        let currentSort = savedSort
            ? JSON.parse(savedSort)
            : { nav: { key: 'name', dir: 'asc' }, move: { key: 'name', dir: 'asc' } };

        const savedFolderState = localStorage.getItem('galleryFolderState');
        const expandedFolderKeys = savedFolderState ? new Set(JSON.parse(savedFolderState)) : new Set();

        // --- FOLDER TREE MANAGEMENT FUNCTIONS ---
        function showNotification(message, type = 'info') { const container = document.getElementById('notification-container'); if (!container) return; const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.textContent = message; container.appendChild(notification); setTimeout(() => { notification.classList.add('show'); }, 10); setTimeout(() => { notification.classList.remove('show'); notification.addEventListener('transitionend', () => notification.remove()); }, 3000); }
        function handleError(error) { console.error('API Error:', error); showNotification(error.message || 'An unexpected network error occurred.', 'error'); }
        function handleGenericResponse(response) { return response.json().then(data => { if (!response.ok) { throw new Error(data.message || `HTTP error! status: ${response.status}`); } if (data.status === 'success' || data.status === 'partial_success') { showNotification(data.message || 'Action completed successfully!', 'success'); setTimeout(() => window.location.reload(), 1200); } else { throw new Error(data.message || 'An unspecified error occurred.'); } }).catch(handleError); }

        function sortChildren(folder, sortKey, direction) {
            if (!folder.children || folder.children.length === 0) return [];
            const dirMultiplier = direction === 'asc' ? 1 : -1;
            return [...folder.children].sort((keyA, keyB) => {
                const folderA = foldersData[keyA];
                const folderB = foldersData[keyB];
                if (!folderA || !folderB) return 0;
                let comparison = 0;
                if (sortKey === 'mtime') {
                    comparison = (folderA.mtime || 0) - (folderB.mtime || 0);
                } else {
                    const nameA = folderA.display_name || '';
                    const nameB = folderB.display_name || '';
                    comparison = nameA.localeCompare(nameB, undefined, { numeric: true, sensitivity: 'base' });
                }
                return comparison * dirMultiplier;
            });
        }

        function buildFolderTreeHTML(folderKey, isMovePanel = false) {
            const folder = foldersData[folderKey];
            if (!folder) return '';
            const hasChildren = folder.children && folder.children.length > 0;
            const isManuallyExpanded = expandedFolderKeys.has(folderKey);
            const isAncestor = ancestorKeys.includes(folderKey);
            const isCollapsed = folderKey !== '_root_' && !isAncestor && !isManuallyExpanded;
            const isActive = !isMovePanel && folderKey === currentFolderKey;

            let childrenHTML = '';
            if (hasChildren) {
                const sortSettings = isMovePanel ? currentSort.move : currentSort.nav;
                const sortedChildren = sortChildren(folder, sortSettings.key, sortSettings.dir);
                childrenHTML = sortedChildren.map(childKey => buildFolderTreeHTML(childKey, isMovePanel)).join('');
            }

            const folderDisplayName = folder.display_name;
            const folderIcon = '📁';
            let itemHTML;
            
            if (isMovePanel) {
                const isRecursive = document.querySelector('input[name="recursive"]')?.checked || false;
                const shouldDisable = (folderKey === currentFolderKey && !isAiGlobal && !isGlobalSearch && !isRecursive);
                const disabledAttr = shouldDisable ? 'disabled' : '';
                itemHTML = ` <div class="folder-item"> <span class="toggle-btn ${!hasChildren ? 'empty' : ''}"></span> <span class="folder-link" title="${folderDisplayName}">${folderIcon} ${folderDisplayName}</span> <button class="move-here-btn" data-folder-key="${folderKey}" title="Move here" ${disabledAttr}>➜</button> </div>`;
            } else {
                itemHTML = ` <div class="folder-item ${isActive ? 'active' : ''}"> <span class="toggle-btn ${!hasChildren ? 'empty' : ''}"></span> <span class="folder-link navigation-link" data-folder-url="/galleryout/view/${folderKey}" title="${folderDisplayName}">${folderIcon} ${folderDisplayName}</span> ${(folderKey !== '_root_' && !protectedFolderKeys.includes(folderKey)) ? `<div class="folder-actions"> <button class="folder-action-btn" title="Rename" data-action="rename" data-name="${folderDisplayName}">✏️</button> <button class="folder-action-btn" title="Delete" data-action="delete" data-name="${folderDisplayName}">🗑️</button> </div>` : ''} </div>`;
            }
            return `<li data-folder-key="${folderKey}" data-folder-name="${folderDisplayName.toLowerCase()}" class="${isCollapsed ? 'collapsed' : ''} ${!hasChildren ? 'no-children' : ''}">${itemHTML}${hasChildren ? `<ul>${childrenHTML}</ul>` : ''}</li>`;
        }

        function renderAllTrees() {
            document.getElementById('folder-tree-nav').innerHTML = buildFolderTreeHTML('_root_', false);
            filterTree('folder-tree-nav', currentSearch.nav, false);
        }

        function filterTree(treeId, searchTerm, saveState = true) {
            const term = searchTerm.toLowerCase().trim();
            const tree = document.getElementById(treeId);
            if (!tree) return;
            const allItems = Array.from(tree.getElementsByTagName('li'));

            allItems.forEach(li => li.classList.remove('is-hidden'));

            if (!term) return;

            let stateChanged = false;
            allItems.forEach(li => li.classList.add('is-hidden'));
            allItems.forEach(li => {
                if (li.dataset.folderName.includes(term)) {
                    li.classList.remove('is-hidden');
                    let parent = li.parentElement.closest('li');
                    while (parent) {
                        parent.classList.remove('is-hidden');
                        if (parent.classList.contains('collapsed')) {
                            parent.classList.remove('collapsed');
                            expandedFolderKeys.add(parent.dataset.folderKey);
                            stateChanged = true;
                        }
                        parent = parent.parentElement.closest('li');
                    }
                }
            });

            if (saveState && stateChanged) {
                localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));
            }
        }

        function setupFolderControls(navId, treeId) {
            document.getElementById(`folder-search-${navId}`).addEventListener('input', (e) => {
                currentSearch[navId] = e.target.value;
                filterTree(treeId, currentSearch[navId], true);
            });
            const sortContainer = document.getElementById(`folder-sort-${navId}`);
            sortContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const newSortKey = button.dataset.sort;
                const sortTarget = (navId === 'nav') ? currentSort.nav : currentSort.move;

                if (sortTarget.key === newSortKey) {
                    sortTarget.dir = sortTarget.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortTarget.key = newSortKey;
                    sortTarget.dir = newSortKey === 'name' ? 'asc' : 'desc';
                }

                updateSortButtonsUI(navId);
                const isMovePanel = navId === 'move';
                document.getElementById(treeId).innerHTML = buildFolderTreeHTML('_root_', isMovePanel);
                filterTree(treeId, currentSearch[navId], false);

                localStorage.setItem('gallerySortPreference', JSON.stringify(currentSort));
            });
            updateSortButtonsUI(navId);
        }

        function updateSortButtonsUI(navId) {
            const sortContainer = document.getElementById(`folder-sort-${navId}`);
            const sortTarget = (navId === 'nav') ? currentSort.nav : currentSort.move;
            sortContainer.querySelectorAll('button').forEach(btn => {
                const sortType = btn.dataset.sort;
                let text = sortType === 'name' ? 'A-Z' : '🗓️';
                btn.classList.remove('active');
                if (sortType === sortTarget.key) {
                    btn.classList.add('active');
                    const arrow = sortTarget.dir === 'asc' ? '↑' : '↓';
                    text += ` ${arrow}`;
                }
                btn.innerHTML = text;
            });
        }
        // --- SIDEBAR MINIFY LOGIC ---
        function setupSidebarMinify() {
            const btn = document.getElementById('sidebar-minify-btn');
            const body = document.body;
            
            if (!btn) return;
            
             // Hide automatically if on mobile/small tablet
            if (window.innerWidth <= 1024) {
                btn.style.display = 'none';
                return;
            }

            // Helper to update icon
            const updateUI = () => {
                const isMin = body.classList.contains('sidebar-minimized');
                
                // UX FIX: Directional arrows
                // If minimized: Show Right Arrow (▶) to indicate "Open/Expand to Right"
                // If open: Show Left Arrow (◀) to indicate "Collapse/Minimize to Left"
                btn.innerHTML = isMin ? '<span>▶</span>' : '<span>◀</span>';
                
                // Tooltip text
                btn.title = isMin ? 'Show Sidebar' : 'Minimize Sidebar';
                
                // When minimized, hide the other "Expand Width" button to avoid confusion
                const expandBtn = document.getElementById('sidebar-expand-btn');
                if(expandBtn) expandBtn.style.display = isMin ? 'none' : 'flex';
            };

            // Restore State
            const savedState = localStorage.getItem('sidebarMinimizedState');
            if (savedState === 'true') {
                body.classList.add('sidebar-minimized');
            }
            // Always run UI update to set initial icon
            updateUI();

            // Click Handler
            btn.addEventListener('click', () => {
                body.classList.toggle('sidebar-minimized');
                
                // If minimizing, remove the "Expanded" (extra wide) state to reset layout
                if (body.classList.contains('sidebar-minimized')) {
                    body.classList.remove('sidebar-expanded');
                    localStorage.removeItem('sidebarExpandedState');
                    
                    // Reset the expander icon too
                    const expandBtn = document.getElementById('sidebar-expand-btn');
                    if(expandBtn) {
                        expandBtn.querySelector('span').innerHTML = '↔️';
                        expandBtn.title = 'Expand Sidebar Width';
                    }
                }
                
                const isNowMin = body.classList.contains('sidebar-minimized');
                localStorage.setItem('sidebarMinimizedState', isNowMin);
                updateUI();
            });
        }
        function setupSidebarExpansion() {
            const btn = document.getElementById('sidebar-expand-btn');
            const body = document.body;
            
            if (!btn) return;

            function updateButtonUI() {
                const iconSpan = btn.querySelector('span');
                if (body.classList.contains('sidebar-expanded')) {
                    // Stato Espanso (Largo) -> Icona per tornare indietro
                    iconSpan.innerHTML = '➡️'; 
                    btn.title = 'Reset Sidebar Width'; // Tooltip in inglese
                } else {
                    // Stato Normale -> Icona per allargare
                    iconSpan.innerHTML = '↔️'; 
                    btn.title = 'Expand Sidebar Width'; // Tooltip in inglese
                }
            }

            // Restore saved state
            if (localStorage.getItem('sidebarExpandedState') === 'true') {
                body.classList.add('sidebar-expanded');
            }
            updateButtonUI();

            btn.addEventListener('click', () => {
                body.classList.toggle('sidebar-expanded');

                if (body.classList.contains('sidebar-expanded')) {
                    localStorage.setItem('sidebarExpandedState', 'true');
                    // Se espando, assicuro che non sia minimizzato
                    body.classList.remove('sidebar-minimized');
                    localStorage.setItem('sidebarMinimizedState', 'false');
                    
                    // Aggiorna anche l'icona del minify se presente
                    const minBtn = document.getElementById('sidebar-minify-btn');
                    if(minBtn) {
                        minBtn.innerHTML = '<span>◀</span>';
                        minBtn.title = 'Minimize Sidebar';
                    }
                } else {
                    localStorage.removeItem('sidebarExpandedState');
                }

                updateButtonUI();
            });
        }

        // --- MODIFIED SYNC PROCESS (Supports Silent Mode) ---
        function startSyncProcess(isManualRefresh = false, isSilent = false) { 
            const syncOverlay = document.getElementById('sync-overlay'); 
            const syncMessage = document.getElementById('sync-message'); 
            const syncProgressFill = document.getElementById('sync-progress-fill'); 
            const eventSource = new EventSource(`/galleryout/sync_status/${currentFolderKey}`); 
            let hasChanges = false; 
            
            // SHOW OVERLAY ONLY IF NOT SILENT
            if (isManualRefresh && !isSilent) { 
                syncOverlay.style.display = 'flex'; 
                syncMessage.textContent = 'Checking for changes...'; 
                syncProgressFill.style.width = '0%'; 
                syncProgressFill.style.backgroundColor = 'var(--primary-color)'; 
            } 
            
            const cleanupAndClose = (shouldReload = false) => { 
                eventSource.close(); 
                if (shouldReload) { 
                    // If silent, just reload without fanfare
                    if (isSilent) {
                        console.log("Auto-Refresh: Changes detected, reloading...");
                        window.location.reload();
                    } else {
                        setTimeout(() => window.location.reload(), 1200); 
                    }
                } else { 
                    if (!isSilent) {
                        setTimeout(() => { syncOverlay.style.display = 'none'; }, isManualRefresh ? 1200 : 0); 
                    }
                } 
            }; 
            
            eventSource.onmessage = function (event) { 
                try { 
                    const data = JSON.parse(event.data); 
                    
                    if (!hasChanges && data.status !== 'no_changes') { 
                        // Found changes! If silent, show overlay NOW because it might take time
                        if (isSilent) {
                            // Optional: You can choose to show a small toast instead of full overlay
                            // For now, we show nothing until reload, or we could show a notification
                            // showNotification("Auto-Refresh: Processing new files...", "info");
                        } else {
                            syncOverlay.style.display = 'flex'; 
                        }
                        hasChanges = true; 
                    } 
                    
                    if (syncOverlay.style.display === 'flex') { 
                        syncMessage.textContent = data.message; 
                        if (data.total > 0) { 
                            syncProgressFill.style.width = `${(data.current / data.total) * 100}%`; 
                        } 
                    } 
                    
                    if (data.status === 'no_changes') { 
                        if (isManualRefresh && !isSilent) { 
                            syncProgressFill.style.width = '100%'; 
                            cleanupAndClose(true); // Manual refresh always reloads to be sure
                        } else {
                            // Silent mode and no changes? Do nothing, just close.
                            cleanupAndClose(false); 
                        }
                    } else if (data.status === 'reloading') { 
                        cleanupAndClose(true); 
                    } else if (data.error) { 
                        if(!isSilent) syncProgressFill.style.backgroundColor = 'var(--danger-color)'; 
                        cleanupAndClose(false); 
                    } 
                } catch (e) { 
                    console.error("Error parsing SSE data:", e); 
                    cleanupAndClose(false); 
                } 
            }; 
            
            eventSource.onerror = function () { eventSource.close(); }; 
        }
        // --- AUTO REFRESH LOGIC (Body Append Version) ---
        let autoRefreshTimer = null;
        let isAutoRefreshActive = false;

        function toggleAutoRefreshMenu(e) {
            e.stopPropagation();
            const popover = document.getElementById('auto-refresh-popover');
            const btn = document.getElementById('refresh-options-btn');
            
            if (!popover || !btn) return;

            if (popover.classList.contains('visible')) {
                popover.classList.remove('visible');
            } else {
                const rect = btn.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // Set a fixed preferred width for calculation
                const preferredWidth = 260; 
                const margin = 15; // Safe distance from screen edges
                
                // 1. Calculate Horizontal Position (Left)
                // Default: align the right edge of the popover with the right edge of the button
                let left = rect.right - preferredWidth;
                
                // MOBILE SAFETY: Check if it overflows on the right
                if (left + preferredWidth > screenWidth - margin) {
                    left = screenWidth - preferredWidth - margin;
                }
                
                // MOBILE SAFETY: Check if it overflows on the left
                if (left < margin) {
                    left = margin;
                }

                // 2. Calculate Vertical Position (Top)
                let top = rect.bottom + 5;
                
                // FLIP LOGIC: If the button is near the bottom, show the menu ABOVE it
                // Estimated height of popover is ~160px
                const estimatedHeight = 160;
                if (top + estimatedHeight > screenHeight && rect.top > estimatedHeight) {
                    top = rect.top - estimatedHeight - 5;
                }

                // 3. Apply styles and show
                popover.style.top = top + 'px';
                popover.style.left = left + 'px';
                popover.classList.add('visible');
            }
        }
        
        // --- FUNCTION: EXECUTE AUTO-REFRESH CYCLE ---
        function runAutoRefreshCycle() {
            // SAFETY CHECKS: Skip refresh if user is performing operations
            
            // 1. Check if files are selected (Selection Bar is visible)
            // This prevents losing the user's current selection work
            if (selectedFiles && selectedFiles.size > 0) {
                return;
            }

            // 2. Check if user is busy with UI elements (Lightbox, Modals, Upload)
            if (document.body.classList.contains('lightbox-open') || 
                document.body.classList.contains('modal-open') ||
                (document.getElementById('upload-overlay') && document.getElementById('upload-overlay').classList.contains('visible'))) {
                // Skip this cycle to avoid disturbing the user
                return;
            }
            
            // Run Silent Sync (isManual=false, isSilent=true)
            startSyncProcess(false, true);
        }
        function updateAutoRefreshState() {
            const toggle = document.getElementById('ar-toggle');
            const intervalInput = document.getElementById('ar-interval');
            const container = document.getElementById('refresh-container');
            
            isAutoRefreshActive = toggle.checked;
            
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            
            if (isAutoRefreshActive) {
                if(container) container.classList.add('auto-active');
                let seconds = parseInt(intervalInput.value);
                if (seconds < 5) seconds = 5; // Enforce minimum interval
                
                autoRefreshTimer = setInterval(runAutoRefreshCycle, seconds * 1000);
                
                // Save preference to localStorage
                localStorage.setItem('galleryAutoRefresh', JSON.stringify({active: true, interval: seconds}));
            } else {
                if(container) container.classList.remove('auto-active');
                localStorage.setItem('galleryAutoRefresh', JSON.stringify({active: false, interval: parseInt(intervalInput.value)}));
            }
        }

        function initAutoRefresh() {
            // Debug log to confirm initialization
            console.log("AutoRefresh: Initializing...");
            
            const optionsBtn = document.getElementById('refresh-options-btn');
            const toggle = document.getElementById('ar-toggle');
            const intervalInput = document.getElementById('ar-interval');
            const popover = document.getElementById('auto-refresh-popover');
            
            if (!optionsBtn || !popover) {
                console.warn("AutoRefresh: Elements not found in DOM.");
                return;
            }

            // CRITICAL: Move the popover to the document body.
            // This solves clipping issues (overflow:hidden) caused by parent containers
            // on both Desktop and Mobile layouts.
            if (popover.parentNode !== document.body) {
                document.body.appendChild(popover);
            }

            // 1. Handle Click (Works for Touch on Mobile too)
            optionsBtn.addEventListener('click', toggleAutoRefreshMenu);
            
            // 2. Listen for Settings Changes
            if(toggle) toggle.addEventListener('change', updateAutoRefreshState);
            if(intervalInput) intervalInput.addEventListener('change', updateAutoRefreshState);
            
            // 3. Close popover when clicking outside
            document.addEventListener('click', (e) => {
                if (popover.classList.contains('visible')) {
                    // Close if click is NOT inside popover AND NOT on the trigger button
                    if (!popover.contains(e.target) && !optionsBtn.contains(e.target)) {
                        popover.classList.remove('visible');
                    }
                }
            });
            
            // 4. Restore State from Storage
            const saved = localStorage.getItem('galleryAutoRefresh');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if(intervalInput) intervalInput.value = settings.interval || 60;
                    if (settings.active && toggle) {
                        toggle.checked = true;
                        updateAutoRefreshState();
                    }
                } catch (e) {
                    console.error("Error restoring AutoRefresh settings:", e);
                }
            }
        }
        
        function formatBytes(bytes, decimals = 1) { if (!bytes) return '0 B'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['B', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }
        function appendFiles(files) { if (!files || files.length === 0) { if (currentItemCount === 0) showEmptyState(); updateLoadMoreVisibility(); return; } const fragment = document.createDocumentFragment(); const newLazyElements = []; files.forEach(file => { allFilesData.push(file); const item = createGalleryItem(file); fragment.appendChild(item); galleryItems.push(item); const lazyEl = item.querySelector('.lazy'); if (lazyEl) newLazyElements.push(lazyEl); }); galleryContainer.appendChild(fragment); initializeLazyLoading(newLazyElements); currentItemCount += files.length; updateLoadMoreVisibility(); }
        function createGalleryItem(file) {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            if (isGlobalSearch) item.classList.add('ai-global'); // reuse global style
            item.dataset.fileId = file.id;
            item.dataset.fileType = file.type;
            item.dataset.aiCaption = file.ai_caption || '';
            item.setAttribute('draggable', 'true');
            item.addEventListener('dragstart', (event) => dragStart(event, file.id));
            let mediaHTML = '';
            if (file.type === 'audio') {
                mediaHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:4rem;color:#1ed760;">🎵</div>`;
            } else if (['image', 'animated_image'].includes(file.type)) {
                mediaHTML = `<img class="lazy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" data-src="/galleryout/thumbnail/${file.id}" alt="${file.name}" loading="lazy">`;
            } else if (file.type === 'video') {
               // Check if it's a MOV/ProRes file to decide whether to use direct file or stream
                const isMov = file.name.toLowerCase().endsWith('.mov');
                const videoSource = isMov ? `/galleryout/stream/${file.id}` : `/galleryout/file/${file.id}`;
                
                // We replace the transparent SVG poster with the real static thumbnail generated by the backend.
                // This ensures that even if the video stream takes a second to start, the user sees an image immediately.
                mediaHTML = `<video autoplay muted loop playsinline class="lazy" 
                                data-src="${videoSource}" 
                                poster="/galleryout/thumbnail/${file.id}"></video>`;
            } else {
                mediaHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:3rem;color:var(--text-muted);">📄</div>`;
            }
            const summaryButtonHTML = file.has_workflow ? `<button title="Node Summary" onclick="showNodeSummary(event, '${file.id}')">📝</button>` : '';
            let metadataHTML = '';
            if (file.dimensions || file.mtime || file.size) {
                const date = new Date(file.mtime * 1000);
                const formattedDate = date.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                const dimensionsPart = file.dimensions ? `<span>📐 ${file.dimensions}</span>` : '';
                const datePart = file.mtime ? `<span>📅 ${formattedDate}</span>` : '';
                const sizePart = file.size ? `<span>💾 ${formatBytes(file.size)}</span>` : '';
                metadataHTML = `<div class="file-metadata">${dimensionsPart}${sizePart}${datePart}</div>`;
            }

            let scannedHTML = '';
            if (file.last_scanned) {
                const scannedDate = new Date(file.last_scanned * 1000);
                const formattedScannedDate = scannedDate.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                scannedHTML = `<div class="file-scanned-time" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; opacity: 0.8;">🔍 Scanned: ${formattedScannedDate}</div>`;
            }
            
            // AI Score Badge
            let aiBadgeHTML = '';
            if (isAiSearch && file.score) {
                const percentage = Math.round(file.score * 100);
                aiBadgeHTML = `<div class="ai-badge">score ${percentage}%</div>`;
            }

            item.innerHTML = `
                <div class="selection-checkmark" onclick="toggleSelection(event, '${file.id}', this.closest('.gallery-item'))">✓</div>
                <div class="thumbnail-link" onclick="openLightbox(event, '${file.id}'); event.stopPropagation();" draggable="false">
                    <div class="thumbnail-wrapper">
                        ${mediaHTML}
                        ${file.has_workflow ? `<a href="/galleryout/workflow/${file.id}" class="workflow-badge" onclick="event.stopPropagation()">⚙️ Workflow</a>` : ''}
                        ${aiBadgeHTML}
                        ${file.duration ? `<span class="duration-overlay">⏱️ ${file.duration}</span>` : ''}
                    </div>
                </div>
                <div class="item-info">
                    <div>
                        <p title="${file.name}"><strong>${file.name}</strong></p>
                        ${metadataHTML}
                        ${scannedHTML}
                    </div>
                    <div class="item-actions">
                        ${summaryButtonHTML}
                        <button class="favorite-btn ${file.is_favorite ? 'favorited' : ''}" title="Favorite" onclick="toggleFavorite(event, '${file.id}', this)">
                            ${file.is_favorite ? '⭐' : '☆'}
                        </button>
                        <a href="/galleryout/download/${file.id}" onclick="event.stopPropagation()" title="Download">💾</a>
                        <button class="delete-btn" onclick="deleteFile(event, '${file.id}', this)">🗑️</button>
                    </div>
                </div>
            `;
            return item;
        }
        function updateLoadMoreVisibility() { const loadMoreContainer = document.getElementById('load-more-container'); if (!loadMoreContainer) return; const shouldHide = currentItemCount >= totalFiles || totalFiles === 0; loadMoreContainer.style.display = shouldHide ? 'none' : 'block'; }
        function updateFileCountBadge() { const fileCountBadge = document.querySelector('.file-count-badge'); if (!fileCountBadge) return; const displayCount = galleryItems.length; totalFiles = displayCount; totalFolderFiles--; const showTotal = totalFiles !== totalFolderFiles; fileCountBadge.textContent = `📂 ${displayCount} File${displayCount !== 1 ? 's' : ''}${showTotal ? ` (${totalFolderFiles} Total)` : ''}`; }
        function showEmptyState() { galleryContainer.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><h3>📭 No files found</h3><p>There are no files matching your criteria.</p></div>`; }
        function initializeLazyLoading(elements) { const observer = new IntersectionObserver((entries, obs) => { entries.forEach(entry => { if (entry.isIntersecting) { const el = entry.target; if (el.dataset.src) { el.src = el.dataset.src; if (el.tagName === "VIDEO") el.load(); } el.classList.remove("lazy"); obs.unobserve(el); } }); }, { rootMargin: '50px' }); elements.forEach(el => observer.observe(el)); }
        function createFolder() { const folderName = prompt("📁 Enter a name for the new folder:"); if (folderName && folderName.trim()) { fetch('/galleryout/create_folder', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ folder_name: folderName.trim(), parent_key: currentFolderKey }) }).then(handleGenericResponse).catch(handleError); } }
        function renameFolder(event, folderKey, oldName) { event.stopPropagation(); const newName = prompt("✏️ Enter the new name for the folder:", oldName); if (newName && newName.trim() && newName.trim() !== oldName) { fetch(`/galleryout/rename_folder/${folderKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ new_name: newName.trim() }) }).then(handleGenericResponse).catch(handleError); } }
        function deleteFolder(event, folderKey, folderName) { event.stopPropagation(); if (confirm(`🗑️ Delete the folder "${folderName}" and all its contents? This cannot be undone.`)) { fetch(`/galleryout/delete_folder/${folderKey}`, { method: 'POST' }).then(handleGenericResponse).catch(handleError); } }

        // --- START MODIFICATION: Sync sort on "Move" panel opening ---
        function populateAndShowDropPanel() {
            // Sync the 'move' panel's sort state with the 'nav' panel's state
            currentSort.move = { ...currentSort.nav };

            document.getElementById('drag-drop-overlay').classList.add('visible');
            document.getElementById('drop-zone-panel').classList.add('visible');

            // Update the move panel's sort buttons UI to reflect the synced state
            updateSortButtonsUI('move');

            document.getElementById('move-folder-tree').innerHTML = buildFolderTreeHTML('_root_', true);
            filterTree('move-folder-tree', currentSearch.move, false);
        }
        // --- END MODIFICATION ---

        function confirmMoveToFolder(folderKey) { if (!selectedFiles || selectedFiles.size === 0) { showNotification('No files selected.', 'warning'); return; } performBatchAction('/galleryout/move_batch', { file_ids: [...selectedFiles], destination_folder: folderKey }); hideDropZone(); }
        function hideDropZone() { document.getElementById('drag-drop-overlay').classList.remove('visible'); document.getElementById('drop-zone-panel').classList.remove('visible'); }
        function dragStart(event, fileId) { event.stopPropagation(); if (!selectedFiles.has(fileId)) { deselectAll(); selectedFiles.add(fileId); updateSelectionUI(); } const dragImage = document.createElement('div'); dragImage.style.cssText = `position:absolute;top:-100px;background:var(--primary-color);color:white;padding:8px 16px;border-radius:8px;font-weight:600;`; dragImage.textContent = `📦 ${selectedFiles.size} file${selectedFiles.size !== 1 ? 's' : ''}`; document.body.appendChild(dragImage); event.dataTransfer.setDragImage(dragImage, 0, 0); setTimeout(() => document.body.removeChild(dragImage), 0); event.dataTransfer.setData('text/plain', [...selectedFiles].join(',')); populateAndShowDropPanel(); }
        function toggleSelection(event, fileId, item) {
            event.stopPropagation();
                        
            // Sync keyboard focus with mouse selection
            const newIndex = galleryItems.indexOf(item);
            if (newIndex !== -1) {
                if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                    galleryItems[focusedItemIndex].classList.remove('focused');
                }
                focusedItemIndex = newIndex;
                galleryItems[focusedItemIndex].classList.add('focused');
            }

            const isShift = event.shiftKey;
            if (isShift && lastSelectedItem) {
                const lastIndex = galleryItems.findIndex(i => i.dataset.fileId === lastSelectedItem.dataset.fileId);
                const currentIndex = galleryItems.findIndex(i => i.dataset.fileId === fileId);
                const [start, end] = [lastIndex, currentIndex].sort((a, b) => a - b);
                for (let i = start; i <= end; i++) {
                    selectedFiles.add(galleryItems[i].dataset.fileId);
                }
            } else {
                selectedFiles.has(fileId) ? selectedFiles.delete(fileId) : selectedFiles.add(fileId);
                lastSelectedItem = item;
            }
            updateSelectionUI();
        }
        function updateSelectionUI() {
            galleryItems.forEach(item => { item.classList.toggle('selected', selectedFiles.has(item.dataset.fileId)); });
            const count = selectedFiles.size;
            selectionCounter.textContent = `📊 ${count} file${count !== 1 ? 's' : ''} selected`;
            selectionBar.classList.toggle('visible', count > 0);

            // Range button logic
            const rangeBtn = document.getElementById('range-select-btn');
            if (count === 2) {
                const selectedIds = Array.from(selectedFiles);
                const index1 = galleryItems.findIndex(item => item.dataset.fileId === selectedIds[0]);
                const index2 = galleryItems.findIndex(item => item.dataset.fileId === selectedIds[1]);
                if (index1 !== -1 && index2 !== -1 && Math.abs(index1 - index2) > 1) {
                    rangeBtn.style.display = 'inline-block';
                    rangeBtn.onclick = () => selectRange(index1, index2);
                } else {
                    rangeBtn.style.display = 'none';
                }
            } else {
                rangeBtn.style.display = 'none';
            }
        }
        function selectRange(index1, index2) {
            const start = Math.min(index1, index2);
            const end = Math.max(index1, index2);
            for (let i = start + 1; i < end; i++) {
                if (galleryItems[i]) {
                    selectedFiles.add(galleryItems[i].dataset.fileId);
                }
            }
            updateSelectionUI();
        }
        function selectAll() { galleryItems.forEach(item => selectedFiles.add(item.dataset.fileId)); lastSelectedItem = galleryItems.length > 0 ? galleryItems[galleryItems.length - 1] : null; updateSelectionUI(); }
        function deselectAll() { selectedFiles.clear(); lastSelectedItem = null; updateSelectionUI(); }
        function toggleFavorite(event, fileId, element) { event.stopPropagation(); const originalContent = element.innerHTML; element.innerHTML = '⏳'; element.disabled = true; fetch(`/galleryout/toggle_favorite/${fileId}`, { method: 'POST' }).then(res => res.json()).then(data => { if (data.status === 'success') { element.classList.toggle('favorited', data.is_favorite); element.innerHTML = data.is_favorite ? '⭐' : '☆'; showNotification(data.is_favorite ? 'Added to favorites!' : 'Removed from favorites!', 'success'); } else { element.innerHTML = originalContent; showNotification('Error toggling favorite', 'error'); } }).catch(error => { element.innerHTML = originalContent; handleError(error); }).finally(() => element.disabled = false); }
        
        function deleteFile(event, fileId, element) { 
            event.stopPropagation(); 
            
            if (!confirm('🗑️ Delete this file? This cannot be undone.')) return; 
            
            const item = element.closest('.gallery-item'); element.disabled = true; fetch(`/galleryout/delete/${fileId}`, { method: 'POST' }).then(res => res.json()).then(data => { if (data.status === 'success') { item.style.transition = 'all 0.4s ease'; item.style.opacity = '0'; item.style.transform = 'scale(0.8)'; showNotification('File deleted!', 'success'); setTimeout(() => { item.remove(); galleryItems = galleryItems.filter(gi => gi !== item); allFilesData = allFilesData.filter(f => f.id !== fileId); selectedFiles.delete(fileId); updateSelectionUI(); currentItemCount--; updateFileCountBadge(); updateLoadMoreVisibility(); }, 400); } else { showNotification(`Error: ${data.message || 'Deletion failed'}`, 'error'); element.disabled = false; } }).catch(error => { handleError(error); element.disabled = false; }); 
        }
        
        function moveSelected() { if (selectedFiles.size > 0) populateAndShowDropPanel(); }
        function deleteSelected() { 
            
            const count = selectedFiles.size; if (count > 0 && confirm(`🗑️ Delete ${count} files? This cannot be undone.`)) { performBatchAction('/galleryout/delete_batch', { file_ids: [...selectedFiles] }); } 
        }
        function favoriteSelected(status) { if (selectedFiles.size === 0) return; performBatchAction('/galleryout/favorite_batch', { file_ids: [...selectedFiles], status: status }); }
        function performBatchAction(url, body) { fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }).then(handleGenericResponse).catch(handleError); }
        function downloadSelectedZip() {
            if (selectedFiles.size === 0) return;
            const fileIds = [...selectedFiles];
            
            showNotification('Generating zip file in background...', 'info');

            fetch('/galleryout/prepare_batch_zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_ids: fileIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    pollZipStatus(data.job_id);
                } else {
                    showNotification('Error starting zip: ' + data.message, 'error');
                }
            })
            .catch(handleError);
        }

        function pollZipStatus(jobId) {
            const interval = setInterval(() => {
                fetch(`/galleryout/check_zip_status/${jobId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'ready') {
                            clearInterval(interval);
                            // Creiamo una notifica speciale persistente con il link
                            showDownloadNotification(data.download_url, data.filename);
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            showNotification('Zip generation failed: ' + data.message, 'error');
                        }
                        // if 'processing', keep waiting
                    })
                    .catch(err => {
                        clearInterval(interval);
                        console.error(err);
                    });
            }, 2000); // Check every 2 secs
        }

        function showDownloadNotification(url, filename) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.style.display = 'flex';
            notification.style.flexDirection = 'column';
            notification.style.gap = '10px';
            
            const text = document.createElement('span');
            text.textContent = '📦 Zip archive is ready!';
            
            const btn = document.createElement('a');
            btn.href = url;
            btn.textContent = 'Download Now';
            btn.style.backgroundColor = 'white';
            btn.style.color = 'var(--success-color)';
            btn.style.padding = '5px 10px';
            btn.style.borderRadius = '4px';
            btn.style.textDecoration = 'none';
            btn.style.fontWeight = 'bold';
            btn.style.textAlign = 'center';
            btn.style.cursor = 'pointer';
            
            // By clicking onload and close the notification after a bit
            btn.onclick = (e) => {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }, 1000);
            };

            notification.appendChild(text);
            notification.appendChild(btn);
            
            container.appendChild(notification);
            
            // Animation entry
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Does not disappear automaticly after 3 seconds, 
            // stays till the user downloads or closes it
            setTimeout(() => {
                if(document.body.contains(notification)) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }
            }, 60000); // Disappear after 60 secs if ignored
        }
        const lightboxOverlay = document.getElementById('lightbox-overlay'); const lightboxMedia = document.getElementById('lightbox-media'); const lightboxTitle = document.getElementById('lightbox-title'); const lightboxDownload = document.getElementById('lightbox-download'); const lightboxWorkflow = document.getElementById('lightbox-workflow'); const lightboxNewTab = document.getElementById('lightbox-new-tab'); const lightboxAiCaption = document.getElementById('lightbox-ai-caption'); let currentLightboxIndex = -1; let currentLightboxFile = null; let currentZoom = 1; let currentTranslateX = 0; let currentTranslateY = 0; let panStep = 50;
        function updateLightboxTitle() { if (!currentLightboxFile) return; const zoomPercentage = Math.round(currentZoom * 100); lightboxTitle.textContent = `${currentLightboxFile.name} (Zoom: ${zoomPercentage}%)`; }
        function updateMediaTransform() { const mediaEl = lightboxMedia.querySelector('img, video'); if (!mediaEl) return; mediaEl.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`; updateLightboxTitle(); }
        function openLightbox(event, fileId) { if (event.target.closest('a, button')) return; event.stopPropagation(); currentLightboxIndex = galleryItems.findIndex(item => item.dataset.fileId === fileId); if (currentLightboxIndex === -1) return; currentZoom = 1; currentTranslateX = 0; currentTranslateY = 0; panStep = 50; document.body.classList.add('lightbox-open'); lightboxOverlay.classList.add('visible'); showItemAtIndex(currentLightboxIndex); }
        function closeLightbox() {
            const mediaElement = lightboxMedia.querySelector('video, audio');
            if (mediaElement) mediaElement.pause();
            
            // Close AI Caption if open
            toggleAiCaption(false);

            // Sync grid focus with lightbox position
            if (currentLightboxIndex !== -1 && galleryItems.length > 0) {
                if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                    galleryItems[focusedItemIndex].classList.remove('focused');
                }
                focusedItemIndex = currentLightboxIndex;
                const newItem = galleryItems[focusedItemIndex];
                if (newItem) {
                    newItem.classList.add('focused');
                    newItem.scrollIntoView({ behavior: 'auto', block: 'center' });
                }
            }

            document.body.classList.remove('lightbox-open');
            lightboxOverlay.classList.remove('visible');
            lightboxMedia.innerHTML = '';
            currentLightboxIndex = -1;
            currentLightboxFile = null;
        }

        function showItemAtIndex(index) {
            const item = galleryItems[index];
            if (!item) return;
            
            const file = allFilesData.find(f => f.id === item.dataset.fileId);
            if (!file) return;
            
            currentLightboxFile = file;
            updateLightboxTitle();
            
            // Set Folder Name in Lightbox
            const lightboxFolderEl = document.getElementById('lightbox-folder-name');
            if (file.path) {
                const parts = file.path.split(/[/\\]/);
                if (parts.length > 1) {
                    let folderName = parts[parts.length - 2];
                    if (folderName.toLowerCase() === 'output') folderName = 'Main';
                    lightboxFolderEl.textContent = `📂 ${folderName}`;
                } else {
                    lightboxFolderEl.textContent = '';
                }
            } else {
                lightboxFolderEl.textContent = '';
            }
            
            // Clear the container
            lightboxMedia.innerHTML = '';
            // Hide caption by default when changing images
            toggleAiCaption(false);
            
            let mediaEl;
            const isImage = ['image', 'animated_image'].includes(file.type);

            // Create element based on type
            if (file.type === 'audio') {
                mediaEl = document.createElement('audio');
                mediaEl.src = `/galleryout/file/${file.id}`;
                mediaEl.controls = true;
                mediaEl.autoplay = true;
            } else if (isImage) {
                mediaEl = document.createElement('img');
                mediaEl.src = `/galleryout/file/${file.id}`;
                mediaEl.alt = file.name;
            } else if (file.type === 'video') {
                mediaEl = document.createElement('video');
                
                // If it's a .mov or professional format, use the streaming route
                const isProResCandidate = file.name.toLowerCase().endsWith('.mov');
                if (isProResCandidate) {
                    mediaEl.src = `/galleryout/stream/${file.id}`;
                } else {
                    mediaEl.src = `/galleryout/file/${file.id}`;
                }
                
                mediaEl.controls = true;
                mediaEl.autoplay = true;
                mediaEl.loop = true;
            }
            
            if (mediaEl) {
                const showMedia = () => {
                    const loader = lightboxMedia.querySelector('.lightbox-loader');
                    if (loader) loader.remove();
                    mediaEl.style.opacity = '1';
                    updateMediaTransform();
                };

                if (isImage && mediaEl.complete) {
                    mediaEl.style.opacity = '1'; 
                    lightboxMedia.appendChild(mediaEl);
                    updateMediaTransform();
                } 
                else {
                    const loader = document.createElement('div');
                    loader.className = 'lightbox-loader';
                    lightboxMedia.appendChild(loader);

                    mediaEl.style.opacity = '0';
                    mediaEl.style.transition = 'opacity 0.15s ease-out'; 

                    if (isImage) {
                        mediaEl.onload = showMedia;
                    } else {
                        mediaEl.onloadeddata = showMedia;
                        mediaEl.onerror = () => {
                            if (loader) loader.remove();
                            lightboxMedia.innerHTML = `<div style="color:var(--danger-color);">Error loading media</div>`;
                        };
                    }
                    
                    lightboxMedia.appendChild(mediaEl);
                }
                requestAnimationFrame(() => updateMediaTransform());

            } else {
                lightboxMedia.innerHTML = `<div style="color:white;font-size:1.2rem;text-align:center;">📄<br>Preview not available</div>`;
            }
            
            // Update toolbar (Initial rendering from Cache)
            lightboxDownload.href = `/galleryout/download/${file.id}`;
            lightboxNewTab.href = `/galleryout/file/${file.id}`;
            
            updateLightboxButtonsUI(file.has_workflow, file.ai_caption, file.id);

            // --- NEW: Perform a background check for fresh metadata ---
            verifyMetadataRealtime(file.id);
        }

        // Helper to update buttons state
        function updateLightboxButtonsUI(hasWorkflow, aiCaption, fileId) {
            const summaryBtn = document.getElementById('lightbox-summary-btn');
            const workflowBtn = document.getElementById('lightbox-workflow');
            const copyBtn = document.getElementById('lightbox-copy-json'); // NEW
            const captionBtn = document.getElementById('lightbox-caption-icon');

            if (hasWorkflow) {
                workflowBtn.href = `/galleryout/workflow/${fileId}`;
                workflowBtn.style.display = 'flex';
                
                // Show Copy Button
                if(copyBtn) copyBtn.style.display = 'flex';
                
                summaryBtn.style.display = 'flex';
                summaryBtn.onclick = (event) => {
                    event.stopPropagation();
                    showNodeSummary(event, fileId);
                };
            } else {
                workflowBtn.style.display = 'none';
                if(copyBtn) copyBtn.style.display = 'none'; // Hide Copy Button
                summaryBtn.style.display = 'none';
                summaryBtn.onclick = null;
            }
            
            if (aiCaption) {
                captionBtn.style.display = 'flex';
                captionBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleAiCaption(true, aiCaption);
                };
            } else {
                captionBtn.style.display = 'none';
            }
        }

        // New Function: Fetches real status from server and updates UI
        function verifyMetadataRealtime(fileId) {
            fetch(`/galleryout/check_metadata/${fileId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 1. Update the cached data object so navigation remembers it
                        const fileIndex = allFilesData.findIndex(f => f.id === fileId);
                        if (fileIndex !== -1) {
                            allFilesData[fileIndex].has_workflow = data.has_workflow;
                            allFilesData[fileIndex].ai_caption = data.ai_caption;
                        }

                        // 2. If we are still looking at the same file, update the UI
                        if (currentLightboxFile && currentLightboxFile.id === fileId) {
                            updateLightboxButtonsUI(data.has_workflow, data.ai_caption, fileId);
                        }
                    }
                })
                .catch(err => console.error("Metadata check failed:", err));
        }
        
        function toggleAiCaption(show, text='') {
            const captionBox = document.getElementById('lightbox-ai-caption');
            
            if (show && text) {
                const formattedText = formatAiCaptionText(text);

                captionBox.innerHTML = `
                    <button class="caption-close-btn" title="Close" onclick="toggleAiCaption(false)">×</button>
                    <div id="lightbox-ai-text-scroll">
                        <strong style="color:var(--ai-color); display:block; margin-bottom:10px; font-size:1.1rem;">🧠 AI Caption:</strong>
                        ${formattedText}
                    </div>
                `;
                captionBox.classList.add('visible');
            } else {
                captionBox.classList.remove('visible');
            }
        }
        
        function navigateLightbox(direction) { if (galleryItems.length === 0) return; currentLightboxIndex = (currentLightboxIndex + direction + galleryItems.length) % galleryItems.length; showItemAtIndex(currentLightboxIndex); }
        function zoomLightbox(amount) { const mediaEl = lightboxMedia.querySelector('img, video'); if (!mediaEl) return; currentZoom = Math.max(0.1, Math.min(10, currentZoom + amount)); panLightbox(0, 0); }
        function panLightbox(dx, dy) {
            const mediaEl = lightboxMedia.querySelector('img, video');
            if (!mediaEl) return;

            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const iw = mediaEl.offsetWidth * currentZoom;
            const ih = mediaEl.offsetHeight * currentZoom;

            const maxTx = Math.max(0, (iw - vw) / 2);
            const maxTy = Math.max(0, (ih - vh) / 2);

            let newTx = currentTranslateX + dx;
            let newTy = currentTranslateY + dy;

            currentTranslateX = Math.max(-maxTx, Math.min(maxTx, newTx));
            currentTranslateY = Math.max(-maxTy, Math.min(maxTy, newTy));

            updateMediaTransform();
        }
        function cyclePanStep() { panStep += 50; if (panStep > 200) panStep = 50; showNotification(`Pan step: ${panStep}px`, 'info'); }
        let toolbarTimeout;
        function hideToolbarTemporary() {
            const header = document.getElementById('lightbox-header');
            if (!header) return;
            header.style.transition = 'opacity 0.3s';
            header.style.opacity = '0';
            header.style.pointerEvents = 'none';
            if (toolbarTimeout) clearTimeout(toolbarTimeout);
            toolbarTimeout = setTimeout(() => {
                header.style.opacity = '1';
                header.style.pointerEvents = 'auto';
            }, 5000);
        }
        function deleteFromLightbox(noConfirm = false) { 
            if (currentLightboxIndex < 0 || currentLightboxIndex >= galleryItems.length) return; 
            
            // Safety: in AI/Global mode confirm always
            if ((isAiSearch || isGlobalSearch) && noConfirm) noConfirm = false;
            
            const itemToDelete = galleryItems[currentLightboxIndex]; 
            const fileId = itemToDelete.dataset.fileId; 
            const deleteBtn = document.getElementById('lightbox-delete-btn'); 
            
            const proceedWithDelete = () => { deleteBtn.disabled = true; fetch(`/galleryout/delete/${fileId}`, { method: 'POST' }).then(res => res.json().then(data => ({ ok: res.ok, data }))).then(({ ok, data }) => { if (ok && data.status === 'success') { showNotification(data.message || 'File deleted!', 'success'); itemToDelete.remove(); galleryItems.splice(currentLightboxIndex, 1); allFilesData = allFilesData.filter(f => f.id !== fileId); currentItemCount--; updateFileCountBadge(); if (galleryItems.length === 0) { closeLightbox(); showEmptyState(); } else { if (currentLightboxIndex >= galleryItems.length) { currentLightboxIndex = galleryItems.length - 1; } showItemAtIndex(currentLightboxIndex); } } else { throw new Error(data.message || 'Deletion failed on the server.'); } }).catch(handleError).finally(() => { if (deleteBtn) { deleteBtn.disabled = false; } }); }; 
            
            let message = '🗑️ Are you sure you want to delete this file? This cannot be undone.';
            if(isAiSearch || isGlobalSearch) message = '🗑️ Global Mode: Are you sure you want to delete this file from its original folder?';
            
            if (noConfirm || confirm(message)) { proceedWithDelete(); } 
        }

        // --- NEW FEATURE: RENAME FILE FROM LIGHTBOX ---

        function renameFile(fileId, currentName) {
            const lastDotIndex = currentName.lastIndexOf('.');
            const baseName = lastDotIndex > -1 ? currentName.substring(0, lastDotIndex) : currentName;
            const extension = lastDotIndex > -1 ? currentName.substring(lastDotIndex) : '';

            const newBaseName = prompt("Enter the new file name (extension will be preserved):", baseName);

            if (newBaseName === null || newBaseName.trim() === '' || newBaseName.trim() === baseName) {
                return;
            }

            const newName = newBaseName.trim() + extension;

            fetch(`/galleryout/rename_file/${fileId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_name: newName })
            })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (ok && data.status === 'success') {
                        showNotification(data.message, 'success');

                        const newId = data.new_id;

                        // 1. Update the main data array
                        const fileIndexInData = allFilesData.findIndex(f => f.id === fileId);
                        if (fileIndexInData !== -1) {
                            allFilesData[fileIndexInData].name = data.new_name;
                            allFilesData[fileIndexInData].id = newId;

                            // If this file is currently in lightbox, update it
                            if (currentLightboxFile && currentLightboxFile.id === fileId) {
                                currentLightboxFile.name = data.new_name;
                                currentLightboxFile.id = newId;
                                updateLightboxTitle();
                            }
                        }

                        // 2. Update the gallery item in the DOM
                        const galleryItem = document.querySelector(`.gallery-item[data-file-id="${fileId}"]`);
                        if (galleryItem) {
                            galleryItem.dataset.fileId = newId;
                            galleryItem.querySelector('.item-info p strong').textContent = data.new_name;
                            galleryItem.querySelector('.item-info p').title = data.new_name;

                            // Update all handlers
                            galleryItem.querySelector('.thumbnail-link').setAttribute('onclick', `openLightbox(event, '${newId}'); event.stopPropagation();`);
                            galleryItem.querySelector('.selection-checkmark').setAttribute('onclick', `toggleSelection(event, '${newId}', this.closest('.gallery-item'))`);
                            galleryItem.querySelector('.favorite-btn').setAttribute('onclick', `toggleFavorite(event, '${newId}', this)`);
                            galleryItem.querySelector('.delete-btn').setAttribute('onclick', `deleteFile(event, '${newId}', this)`);
                            galleryItem.querySelector('a[title="Download"]').href = `/galleryout/download/${newId}`;
                            const summaryBtn = galleryItem.querySelector('button[title="Node Summary"]');
                            if (summaryBtn) summaryBtn.setAttribute('onclick', `showNodeSummary(event, '${newId}')`);
                            const workflowBadge = galleryItem.querySelector('.workflow-badge');
                            if (workflowBadge) workflowBadge.href = `/galleryout/workflow/${newId}`;
                        }

                        // 3. If lightbox is open for this file, refresh links
                        if (currentLightboxFile && currentLightboxFile.id === newId) {
                            showItemAtIndex(currentLightboxIndex);
                        }

                    } else {
                        throw new Error(data.message || 'Failed to rename file.');
                    }
                })
                .catch(error => {
                    showNotification(error.message, 'error');
                });
        }

        function renameFileFromLightbox() {
            if (!currentLightboxFile) return;
            renameFile(currentLightboxFile.id, currentLightboxFile.name);
        }

        const summaryOverlay = document.getElementById('node-summary-overlay'); const summaryContent = document.getElementById('node-summary-content');
        function escapeHTML(value) { if (value === null || typeof value === 'undefined') { return '<em>null</em>'; } if (typeof value === 'object') { try { const jsonString = JSON.stringify(value, null, 2); return jsonString.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]); } catch (e) { return '[Unserializable Object]'; } } return value.toString().replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '&quot;': '&quot;', "'": '&#39;' })[m]); }
async function showNodeSummary(event, fileId) {
            event.stopPropagation();
            const summaryContent = document.getElementById('node-summary-content');
            const summaryOverlay = document.getElementById('node-summary-overlay');
            
            summaryContent.innerHTML = '<div class="loader" style="margin:2rem auto;"></div>';
            document.body.classList.add('modal-open');
            summaryOverlay.classList.add('visible');

            try {
                const response = await fetch(`/galleryout/node_summary/${fileId}`);
                const data = await response.json();

                if (data.status === 'success' && data.summary) {
                    if (data.summary.length > 0) {
                        let contentHTML = '';
                        let mediaCardsHTML = ''; 

                        data.summary.forEach(node => {
                            let paramsHTML = '<ul class="summary-node-params">';
                            
                            if (node.params && node.params.length > 0) {
                                node.params.forEach(p => {
                                    paramsHTML += `<li><strong>${escapeHTML(p.name)}:</strong> <code>${escapeHTML(p.value)}</code>`;
                                    if (p.is_input_file) {
                                        paramsHTML += ` <span style="color:var(--success-color); font-size:0.8rem;">(Found in Inputs)</span>`;
                                        const fileExt = p.value.toString().split('.').pop().toLowerCase();
                                        const isVideo = ['mp4', 'mov', 'webm', 'mkv', 'avi'].includes(fileExt);
                                        const isAudio = ['mp3', 'wav', 'ogg', 'flac', 'm4a', 'aac'].includes(fileExt);
                                        let mediaTag = '';
                                        if (isAudio) {
                                            mediaTag = `<div style="height:200px; display:flex; align-items:center; justify-content:center; width:100%; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:1rem; flex-direction:column; gap:10px;">
                                                <span style="font-size:3rem;">🎵</span>
                                                <audio controls src="${p.input_url}" style="width:90%;"></audio>
                                            </div>`;
                                        } else if (isVideo) {
                                            mediaTag = `<video src="${p.input_url}" controls class="input-media-preview"></video>`;
                                        } else {
                                            mediaTag = `<img src="${p.input_url}" class="input-media-preview">`;
                                        }
                                        mediaCardsHTML += `
                                            <div class="input-media-card">
                                                <div class="input-media-title">📥 ${escapeHTML(p.value)}</div>
                                                ${mediaTag}
                                                <div class="input-media-actions">
                                                    <a href="${p.input_url}" download class="input-media-btn">
                                                        💾 Download
                                                    </a>
                                                    <a href="${p.input_url}" target="_blank" class="input-media-btn secondary">
                                                        ↗️ Open Tab
                                                    </a>
                                                </div>
                                            </div>`;
                                    }
                                    paramsHTML += `</li>`;
                                });
                            } else {
                                paramsHTML += `<li>No parameters</li>`;
                            }
                            paramsHTML += '</ul>';

                            contentHTML += `<div class="summary-node-item">
                                <div class="summary-node-header" style="background-color:${node.color};">
                                    ${escapeHTML(node.type)} <small>(ID: ${node.id})</small>
                                </div>
                                ${paramsHTML}
                            </div>`;
                        });
                        
                        let finalInputsSection = '';
                        if (mediaCardsHTML) {
                            finalInputsSection = `
                                <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                                    🎨 Source Media (Inputs)
                                </h3>
                                <div class="input-media-grid">
                                    ${mediaCardsHTML}
                                </div>
                                <hr style="border:0; border-top:1px solid var(--border-color); margin: 2rem 0;">
                            `;
                        }

                        summaryContent.innerHTML = finalInputsSection + contentHTML;
                    } else {
                        summaryContent.innerHTML = '<p>No active nodes found in this workflow.</p>';
                    }
                } else {
                    summaryContent.innerHTML = `<p style="color:var(--danger-color);">Error: ${data.message || 'Could not load summary.'}</p>`;
                }
            } catch (error) {
                console.error(error);
                summaryContent.innerHTML = `<p style="color:var(--danger-color);">A network error occurred.</p>`;
            }
        }
        function closeNodeSummary() { document.body.classList.remove('modal-open'); summaryOverlay.classList.remove('visible'); summaryContent.innerHTML = ''; }
        const uploadOverlay = document.getElementById('upload-overlay'); const showUploadModalBtn = document.getElementById('show-upload-modal-btn'); const uploadCancelBtn = document.getElementById('upload-cancel-btn'); const uploadSubmitBtn = document.getElementById('upload-submit-btn'); const dropZone = document.getElementById('drop-zone'); const fileInput = document.getElementById('upload-file-input'); const fileBrowseBtn = document.getElementById('file-upload-btn'); const fileList = document.getElementById('file-list'); const uploadProgressContainer = document.getElementById('upload-progress-container'); const uploadProgressFill = document.getElementById('upload-progress-fill'); const uploadDestinationText = document.getElementById('upload-destination-text').querySelector('strong'); let filesToUpload = [];
        function resetUploadModal() { filesToUpload = []; fileList.innerHTML = ''; uploadProgressContainer.style.display = 'none'; uploadProgressFill.style.width = '0%'; fileInput.value = ''; uploadSubmitBtn.disabled = false; }
        function showUploadModal() { resetUploadModal(); uploadDestinationText.textContent = currentFolderInfo.display_name; document.body.classList.add('modal-open'); uploadOverlay.classList.add('visible'); }
        function closeUploadModal() { document.body.classList.remove('modal-open'); uploadOverlay.classList.remove('visible'); }
        function handleFiles(files) { filesToUpload = [...filesToUpload, ...Array.from(files)]; renderFileList(); }
        function renderFileList() { fileList.innerHTML = ''; filesToUpload.forEach(file => { const li = document.createElement('li'); const sizeKB = (file.size / 1024).toFixed(1); li.innerHTML = `<span>${file.name}</span> <span class="file-size">${sizeKB} KB</span>`; fileList.appendChild(li); }); }
        function performUpload() { if (filesToUpload.length === 0) { showNotification('Please select files to upload.', 'warning'); return; } const formData = new FormData(); formData.append('folder_key', currentFolderKey); filesToUpload.forEach(file => { formData.append('files', file); }); const xhr = new XMLHttpRequest(); xhr.open('POST', '/galleryout/upload', true); uploadProgressContainer.style.display = 'block'; uploadSubmitBtn.disabled = true; uploadSubmitBtn.textContent = 'Uploading...'; xhr.upload.onprogress = function (event) { if (event.lengthComputable) { const percentComplete = (event.loaded / event.total) * 100; uploadProgressFill.style.width = percentComplete + '%'; } }; xhr.onload = function () { if (xhr.status >= 200 && xhr.status < 300) { const response = JSON.parse(xhr.responseText); showNotification(response.message || 'Upload successful!', 'success'); setTimeout(() => window.location.reload(), 1000); } else { try { const response = JSON.parse(xhr.responseText); showNotification(`Upload failed: ${response.message}`, 'error'); } catch (e) { showNotification(`Upload failed with status: ${xhr.status}`, 'error'); } uploadSubmitBtn.disabled = false; uploadSubmitBtn.textContent = 'Upload'; } }; xhr.onerror = function () { showNotification('An error occurred during the upload.', 'error'); uploadSubmitBtn.disabled = false; uploadSubmitBtn.textContent = 'Upload'; }; xhr.send(formData); }
        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        // --- RESCAN FOLDER LOGIC ---
        const rescanModalOverlay = document.getElementById('rescan-modal-overlay');
        const rescanRecentBtn = document.getElementById('rescan-recent-btn');
        const rescanAllBtn = document.getElementById('rescan-all-btn');
        const rescanCancelBtn = document.getElementById('rescan-cancel-btn');

        function showRescanModal() {
            rescanModalOverlay.style.opacity = '1';
            rescanModalOverlay.style.pointerEvents = 'auto';
        }

        function hideRescanModal() {
            rescanModalOverlay.style.opacity = '0';
            rescanModalOverlay.style.pointerEvents = 'none';
        }

        function performRescan(mode) {
            hideRescanModal();
            showNotification('Starting rescan...', 'info');

            // Show sync overlay
            const syncOverlay = document.getElementById('sync-overlay');
            const syncMessage = document.getElementById('sync-message');
            const syncProgressFill = document.getElementById('sync-progress-fill');
            syncOverlay.style.display = 'flex';
            syncMessage.textContent = 'Rescanning files...';
            syncProgressFill.style.width = '100%';
            syncProgressFill.style.backgroundColor = 'var(--primary-color)';
            
            fetch('/galleryout/rescan_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_key: currentFolderKey, mode: mode })
            })
                .then(handleGenericResponse)
                .catch(error => {
                    handleError(error);
                    syncOverlay.style.display = 'none';
                });
        }
        
        // --- AI SEARCH FUNCTIONS ---
        function selectAiScope(scope) {
            currentAiScope = scope;
            document.querySelectorAll('.ai-scope-option').forEach(el => {
                el.classList.toggle('active', el.dataset.scope === scope);
            });
            
            // Show recursive toggle ONLY if scope is local AND folder has subfolders
            const recursiveToggle = document.getElementById('ai-recursive-toggle');
            if (recursiveToggle) {
                recursiveToggle.style.display = (scope === 'local') ? 'flex' : 'none';
            }
        }
        
        // --- MODAL AI ---
        function closeAiInfoModal() {
            document.getElementById('ai-info-overlay').classList.remove('visible');
        }

        function openAiSearchModal() {
            if (!enableAiSearch) {
                const infoOverlay = document.getElementById('ai-info-overlay');
                infoOverlay.classList.add('visible');
                
                infoOverlay.addEventListener('click', (e) => {
                    if (e.target === infoOverlay) closeAiInfoModal();
                }, { once: true }); // once per non accumulare listener
                
                return;
            }
            
            // AI Enabled 
            const overlay = document.getElementById('ai-search-overlay');
            const inputEl = document.getElementById('ai-search-input');
            const clearBtn = document.getElementById('ai-search-clear-text');
            const limitInput = document.getElementById('ai-search-limit');
            
            // 1. RIPRISTINA LA QUERY
            const lastQuery = localStorage.getItem('lastAiQuery');
            if (lastQuery) {
                inputEl.value = lastQuery;
                clearBtn.style.display = 'flex';
            } else {
                inputEl.value = '';
                clearBtn.style.display = 'none';
            }

            // 2. RIPRISTINA IL LIMITE
            const lastLimit = localStorage.getItem('lastAiLimit');
            if (lastLimit && limitInput) {
                limitInput.value = lastLimit;
            } else if (limitInput) {
                limitInput.value = 100;
            }

            // 3. RIPRISTINA LO SCOPE
            const lastScope = localStorage.getItem('lastAiScope');
            if (lastScope && (lastScope === 'global' || lastScope === 'local')) {
                selectAiScope(lastScope);
            } else {
                selectAiScope('global');
            }
            
            overlay.classList.add('visible');
            document.body.classList.add('modal-open');
            inputEl.focus();
        }
        
        function closeAiSearchModal() {
            const overlay = document.getElementById('ai-search-overlay');
            overlay.classList.remove('visible');
            document.body.classList.remove('modal-open');
        }
        
        function submitAiSearch() {
            const inputEl = document.getElementById('ai-search-input');
            const query = inputEl.value.trim();
            const limit = document.getElementById('ai-search-limit').value || 100;
            
            if (!query) return;
            
            // --- SALVATAGGIO STATO ---
            localStorage.setItem('lastAiQuery', query);
            localStorage.setItem('lastAiLimit', limit);        // Salva il limite
            localStorage.setItem('lastAiScope', currentAiScope); // Salva lo scope (global/local)
            
            closeAiSearchModal();
            
            // Show Loader
            const loader = document.getElementById('loader-overlay');
            loader.style.display = 'flex';
            loader.style.opacity = '1';
            
            let finalQuery = query;
            const isRecursive = document.getElementById('ai-search-recursive')?.checked;
        
            if (currentAiScope === 'local') {
                // We append a special flag if recursive is enabled
                const pathSuffix = isRecursive ? " [RECURSIVE]" : "";
                finalQuery += " ||| " + currentFolderInfo.path + pathSuffix;
            }
            
            const searchPayload = { 
                query: finalQuery, 
                limit: parseInt(limit),
                scope: currentAiScope
            };

            fetch('/galleryout/ai_queue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchPayload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'queued') {
                    pollAiStatus(data.session_id);
                } else {
                    showNotification("Error starting AI search: " + data.message, 'error');
                    loader.style.display = 'none';
                }
            })
            .catch(err => {
                console.error(err);
                showNotification("Network error starting AI search", 'error');
                loader.style.display = 'none';
            });
        }
        
        function pollAiStatus(sessionId) {
            let attempts = 0;
            const maxAttempts = 15; // Timeout dopo 15 secondi
            
            const interval = setInterval(() => {
                attempts++;
                
                fetch(`/galleryout/ai_check/${sessionId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            clearInterval(interval);
                            window.location.href = `{{ url_for('gallery_view', folder_key=current_folder_key) }}?ai_session_id=${sessionId}`;
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            showNotification("AI Search failed (Worker Error).", 'error');
                            document.getElementById('loader-overlay').style.display = 'none';
                        } else {
                            // Status is 'pending' or 'processing'
                            // Controlla timeout
                            if (attempts >= maxAttempts) {
                                clearInterval(interval);
                                document.getElementById('loader-overlay').style.display = 'none';
                                
                                const repoUrl = "https://github.com/biagiomaf/smart-comfyui-gallery";
                                const msg = "⚠️ AI Service Timeout (Worker not responding)\n" +
                                            "The search request was sent, but the AI service did not respond in time.\n" +
                                            "Please ensure that the 'gallery_ai_service.py' script is running in your backend terminal.\n" +
                                            "If you haven't installed the AI dependencies yet, please consult the installation guide at:\n" +
                                            repoUrl;
                                
                                alert(msg);
                            }
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        // do not stop for temporarly network errors
                    });
            }, 1000);
        }
        
        
        // --- SCOPE SELECTOR & RECURSIVE LOGIC (Integrated Dynamic Fetch) ---
        const scopeRadios = document.querySelectorAll('input[name="scope"]');
        const recursiveCheckbox = document.querySelector('input[name="recursive"]');
        const recursiveWrapper = document.getElementById('recursive-standard-ui');
        
        let extSelectInst = null;
        let pfxSelectInst = null;
        
        // Initialize TomSelects
        if (!isAiSearch) {
            const extEl = document.getElementById('extension-select');
            const pfxEl = document.getElementById('prefix-select');
            if (extEl) extSelectInst = new TomSelect('#extension-select', { plugins: ['checkbox_options', 'clear_button'], placeholder: '📄 Select extensions...' });
            if (pfxEl) pfxSelectInst = new TomSelect('#prefix-select', { plugins: ['checkbox_options', 'clear_button'], placeholder: '🏷️ Select prefixes...' });
        }

        // Logic to disable/enable Recursive checkbox based on Global Scope
        function updateRecursiveUIState() {
            const isGlobal = document.querySelector('input[name="scope"][value="global"]')?.checked;
            if (recursiveWrapper && recursiveCheckbox) {
                if (isGlobal) {
                    recursiveWrapper.classList.add('disabled');
                    recursiveCheckbox.checked = false; // Forced off when global
                    recursiveWrapper.classList.remove('active');
                } else {
                    recursiveWrapper.classList.remove('disabled');
                    // Ensure the 'active' class matches the checkbox state (for blue styling)
                    recursiveWrapper.classList.toggle('active', recursiveCheckbox.checked);
                }
            }
        }

        // Main function to refresh dropdowns (Extensions/Prefixes) via AJAX
        function triggerOptionsRefresh() {
            const scope = document.querySelector('input[name="scope"]:checked')?.value || 'local';
            const isRec = recursiveCheckbox?.checked || false;
            const folderKey = '{{ current_folder_key }}';
            
            // Visual feedback: dim the controls during fetch
            if(extSelectInst) extSelectInst.wrapper.style.opacity = '0.5';
            if(pfxSelectInst) pfxSelectInst.wrapper.style.opacity = '0.5';

            fetch(`/galleryout/api/search_options?scope=${scope}&folder_key=${folderKey}&recursive=${isRec}`)
                .then(response => response.json())
                .then(data => {
                    // Update Extensions
                    if (extSelectInst) {
                        extSelectInst.clearOptions();
                        data.extensions.forEach(ext => extSelectInst.addOption({value: ext, text: ext}));
                        extSelectInst.refreshOptions(false);
                        extSelectInst.wrapper.style.opacity = '1';
                    }

                    // Update Prefixes & Handle Limit
                    const warningBox = document.getElementById('prefix-warning-container');
                    const selectContainer = document.getElementById('prefix-select-container');

                    if (data.prefix_limit_reached) {
                        if(warningBox) warningBox.style.display = 'flex';
                        if(selectContainer) selectContainer.style.display = 'none';
                    } else {
                        if(warningBox) warningBox.style.display = 'none';
                        if(selectContainer) selectContainer.style.display = 'block';
                        if (pfxSelectInst) {
                            pfxSelectInst.clearOptions();
                            data.prefixes.forEach(pfx => pfxSelectInst.addOption({value: pfx, text: pfx}));
                            pfxSelectInst.refreshOptions(false);
                            pfxSelectInst.wrapper.style.opacity = '1';
                        }
                    }
                })
                .catch(err => {
                    console.error("Search options refresh failed:", err);
                    if(extSelectInst) extSelectInst.wrapper.style.opacity = '1';
                    if(pfxSelectInst) pfxSelectInst.wrapper.style.opacity = '1';
                });
        }

        // Event Listeners for UI Changes
        scopeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Visual update for the radio buttons labels (Blue box)
                document.querySelectorAll('.scope-label').forEach(label => label.classList.remove('active'));
                if (this.checked) this.closest('.scope-label').classList.add('active');
                
                updateRecursiveUIState();
                triggerOptionsRefresh();
            });
        });

        if (recursiveCheckbox) {
            recursiveCheckbox.addEventListener('change', function() {
                // Toggle 'active' class on the wrapper for styling
                if (recursiveWrapper) recursiveWrapper.classList.toggle('active', this.checked);
                triggerOptionsRefresh();
            });
        }

        // Initialize UI on page load
        updateRecursiveUIState();
        
        // --- MAIN INITIALIZATION FUNCTION ---
        document.addEventListener('DOMContentLoaded', () => {
            loaderOverlay.style.opacity = '0';
            setTimeout(() => { loaderOverlay.style.display = 'none'; }, 400);

            setupFolderControls('nav', 'folder-tree-nav');
            setupFolderControls('move', 'move-folder-tree');
            renderAllTrees();
            setupSidebarExpansion();
            setupSidebarMinify();
            appendFiles(initialFiles);
            
            // --- DATE VALIDATION LOGIC ---
            const filterForm = document.getElementById('filter-form');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            if (filterForm && startDateInput && endDateInput) {
                
                // Helper: Update 'min' attribute of end date based on start date
                startDateInput.addEventListener('change', () => {
                    endDateInput.min = startDateInput.value;
                });

                // Helper: Auto-fill end date if empty when start is selected (UX improvement)
                startDateInput.addEventListener('blur', () => {
                     if (startDateInput.value && !endDateInput.value) {
                         // Optional: set to today or same as start. 
                         // Let's enforce validation instead as requested.
                     }
                });

                // Form Submit Validation
                filterForm.addEventListener('submit', (e) => {
                    const start = startDateInput.value;
                    const end = endDateInput.value;

                    if (start && !end) {
                        e.preventDefault();
                        showNotification('⚠️ Please select an End Date.', 'warning');
                        endDateInput.focus();
                        return;
                    }

                    if (start && end && start > end) {
                        e.preventDefault();
                        showNotification('⚠️ Start Date cannot be after End Date.', 'error');
                        return;
                    }
                });
            }
            
            // Initialize Auto-Refresh Logic
            initAutoRefresh();

            // Only run regular sync if not in AI mode
            if(!isAiSearch) {
                // startSyncProcess(false); // OLD
                startSyncProcess(false, false); // NEW Signature
            }
            
            // --- JS: AI BANNER TEXT FORMATTING ---
            const aiBannerText = document.getElementById('ai-banner-text');
            if (aiBannerText) {
                const rawQuery = aiBannerText.dataset.rawQuery || "";
                const separator = " ||| ";
                
                let labelHtml = "";
                let queryText = "";

                if (rawQuery.includes(separator)) {
                    // Local
                    const parts = rawQuery.split(separator);
                    queryText = parts[0];
                    labelHtml = `<span>🧠</span> Current Folder`;
                } else {
                    //  Global
                    queryText = rawQuery;
                    labelHtml = `<span>🧠</span> All Folders`;
                }

                // Inseriamo DUE span separati per permettere al CSS Mobile di spostarli
                aiBannerText.innerHTML = `
                    <span class="ai-scope-part">${labelHtml}</span>
                    <span class="ai-query-part">"${escapeHTML(queryText)}"</span>
                `;
            }
            
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const sidebarToggleText = document.getElementById('sidebar-toggle-text');
            const galleryAnchor = document.getElementById('gallery-anchor');
            const isMobile = window.innerWidth <= 1024;
            if (sidebar && sidebarToggleBtn && isMobile) {
                sidebar.classList.add('nav-collapsed');
                sidebarToggleText.textContent = 'Show Folders';
                sidebarToggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('nav-collapsed');
                    sidebarToggleText.textContent = sidebar.classList.contains('nav-collapsed') ? 'Show Folders' : 'Hide Folders';
                });
            }
            if (isMobile && sessionStorage.getItem('galleryMobileNav') === 'true' && galleryAnchor) {
                setTimeout(() => galleryAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                sessionStorage.removeItem('galleryMobileNav');
            }
            // --- MOBILE FILTER TOGGLE LOGIC ---
            const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
            // We use the same panel ID for both desktop and mobile
            const searchPanel = document.getElementById('desktop-search-panel'); 

            if (mobileFilterToggle && searchPanel) { 
                mobileFilterToggle.addEventListener('click', (e) => { 
                    if (e.target.classList.contains('filter-reset-icon')) return;

                    e.stopPropagation();
                    searchPanel.classList.toggle('visible'); 
                    
                    // Update button text maintaining the X icon structure
                    const isVisible = searchPanel.classList.contains('visible');
                    const activeCount = {{ active_filters_count }};
                    
                    let baseText = isVisible ? '✕  Hide Filters' : '⚙️ Filters';
                    if (!isVisible && activeCount > 0) baseText += ` (${activeCount})`;
                    
                    let iconHtml = '';
                    if (activeCount > 0) {
                        iconHtml = ' <span class="filter-reset-icon" title="Clear all filters">✕</span>';
                    }
                    
                    mobileFilterToggle.innerHTML = baseText + iconHtml;
                }); 
            }
            
            // --- NEW: DESKTOP SEARCH PANEL TOGGLE ---
            const searchToggleDesktop = document.getElementById('search-toggle-desktop');
            const desktopSearchPanel = document.getElementById('desktop-search-panel');
            
            if (searchToggleDesktop && desktopSearchPanel) {
                searchToggleDesktop.addEventListener('click', (e) => {
                    // FIX: Se l'utente ha cliccato sulla X di reset, fermati qui!
                    // Non eseguire lo stopPropagation (così sale al body per il reset)
                    // e non aprire il pannello.
                    if (e.target.classList.contains('filter-reset-icon')) return;

                    e.stopPropagation();
                    desktopSearchPanel.classList.toggle('visible');
                });
                
                // Close when clicking outside
                document.addEventListener('click', (e) => {
                    if (desktopSearchPanel.classList.contains('visible')) {
                        // Check if click is outside panel AND outside button
                        if (!desktopSearchPanel.contains(e.target) && e.target !== searchToggleDesktop) {
                            desktopSearchPanel.classList.remove('visible');
                        }
                    }
                });
                
                // Prevent closing when clicking inside the panel
                desktopSearchPanel.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // --- SMART NAVIGATION LOGIC (Filter Persistence) ---
            const navOverlay = document.getElementById('nav-choice-overlay');
            let pendingNavUrl = null;

            /**
             * Handles folder navigation by checking for active filters.
             * Focuses the primary action button to allow immediate keyboard confirmation.
             */
            function handleFolderNavigation(targetBaseUrl) {
                // Determine if filters are actually active using the backend count
                if (activeFiltersCount > 0) {
                    pendingNavUrl = targetBaseUrl;
                    navOverlay.classList.add('visible');
                    document.body.classList.add('modal-open');

                    // UX IMPROVEMENT: Auto-focus the "Keep Filters" button.
                    // This highlights the button and allows the user to simply press "Enter"
                    // instead of moving the mouse across large screens.
                    setTimeout(() => {
                        const keepBtn = document.getElementById('nav-keep-filters');
                        if (keepBtn) keepBtn.focus();
                    }, 50); // Small delay to ensure modal visibility animation is starting
                } else {
                    window.location.href = targetBaseUrl;
                }
            }

            // Modal Button: Keep current filters and apply them to the new folder
            document.getElementById('nav-keep-filters').onclick = () => {
                const currentParams = new URLSearchParams(window.location.search);
                
                // If we were in Global Search, we switch to Local for the specific folder clicked
                // but we keep all other keywords, extensions, and date filters.
                if (currentParams.get('scope') === 'global') {
                    currentParams.set('scope', 'local');
                }
                
                window.location.href = pendingNavUrl + "?" + currentParams.toString();
            };

            // Modal Button: Discard filters and browse the folder normally
            document.getElementById('nav-reset-filters').onclick = () => {
                window.location.href = pendingNavUrl;
            };

            // Modal Button: Close modal and stay on the current page
            document.getElementById('nav-cancel').onclick = () => {
                navOverlay.classList.remove('visible');
                document.body.classList.remove('modal-open');
                pendingNavUrl = null;
            };

            // Updated Tree Listener: Handles Toggles, Actions, and Smart Navigation
            document.getElementById('folder-tree-nav').addEventListener('click', (e) => {
                const link = e.target.closest('.navigation-link');
                const toggle = e.target.closest('.toggle-btn');
                const actionBtn = e.target.closest('.folder-action-btn');

                if (toggle) {
                    // Standard folder expand/collapse logic
                    const li = toggle.closest('li');
                    const key = li.dataset.folderKey;
                    const isNowCollapsed = li.classList.toggle('collapsed');
                    if (isNowCollapsed) {
                        expandedFolderKeys.delete(key);
                    } else {
                        expandedFolderKeys.add(key);
                    }
                    localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));

                } else if (actionBtn) {
                    // Folder actions (Rename/Delete)
                    const li = actionBtn.closest('li');
                    const key = li.dataset.folderKey;
                    const name = actionBtn.dataset.name;
                    if (actionBtn.dataset.action === 'rename') renameFolder(e, key, name);
                    if (actionBtn.dataset.action === 'delete') deleteFolder(e, key, name);

                } else if (link) {
                    // Navigation click: use the Smart Navigation logic
                    e.preventDefault();
                    handleFolderNavigation(link.dataset.folderUrl);
                }
            });
            
            // Updated Breadcrumbs Listener: Uses Smart Navigation
            const breadcrumbContainer = document.querySelector('.breadcrumb-links');
            if (breadcrumbContainer) {
                breadcrumbContainer.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (link) {
                        e.preventDefault();
                        handleFolderNavigation(link.getAttribute('href'));
                    }
                });
            }
            
            document.getElementById('move-folder-tree').addEventListener('click', (e) => {
                const toggle = e.target.closest('.toggle-btn');
                const moveBtn = e.target.closest('.move-here-btn');

                if (toggle) {
                    const li = toggle.closest('li');
                    const key = li.dataset.folderKey;
                    const isNowCollapsed = li.classList.toggle('collapsed');
                    if (isNowCollapsed) {
                        expandedFolderKeys.delete(key);
                    } else {
                        expandedFolderKeys.add(key);
                    }
                    localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));
                }

                if (moveBtn) {
                    confirmMoveToFolder(moveBtn.dataset.folderKey);
                }
            });
            
            // AI Listeners
            // Bottone Desktop
            const aiToggleDesktop = document.getElementById('ai-search-toggle-desktop');
            if (aiToggleDesktop) {
                aiToggleDesktop.addEventListener('click', openAiSearchModal);
            }
            
            // Bottone Mobile
            const aiToggleMobile = document.getElementById('ai-search-toggle-mobile');
            if (aiToggleMobile) {
                aiToggleMobile.addEventListener('click', openAiSearchModal);
            }
            
            document.getElementById('ai-modal-close').addEventListener('click', closeAiSearchModal);
            
            document.getElementById('ai-search-submit').addEventListener('click', submitAiSearch);
            
            const refreshBtn = document.getElementById('refresh-btn');
            if(refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); startSyncProcess(true); });
            
            const rescanBtn = document.getElementById('rescan-folder-btn');
            if(rescanBtn) rescanBtn.addEventListener('click', showRescanModal);
            
            rescanRecentBtn.addEventListener('click', () => performRescan('recent'));
            rescanAllBtn.addEventListener('click', () => performRescan('all'));
            rescanCancelBtn.addEventListener('click', hideRescanModal);
            
            const mainSelectAll = document.getElementById('main-select-all-btn');
            if(mainSelectAll) mainSelectAll.addEventListener('click', selectAll);
            
            const showUpload = document.getElementById('show-upload-modal-btn');
            if(showUpload) showUpload.addEventListener('click', showUploadModal);
            
            document.getElementById('create-folder-btn').addEventListener('click', createFolder);
            document.getElementById('cancel-drop-btn').addEventListener('click', hideDropZone);
            document.getElementById('select-all-btn').addEventListener('click', selectAll);
            document.getElementById('deselect-all-btn').addEventListener('click', deselectAll);
            document.getElementById('move-selected-btn').addEventListener('click', moveSelected);
            document.getElementById('download-zip-btn').addEventListener('click', downloadSelectedZip);
            document.getElementById('delete-selected-btn').addEventListener('click', deleteSelected);
            document.getElementById('favorite-selected-btn').addEventListener('click', () => favoriteSelected(true));
            document.getElementById('unfavorite-selected-btn').addEventListener('click', () => favoriteSelected(false));
            document.querySelector('#lightbox-overlay .close-btn').addEventListener('click', closeLightbox);
            document.getElementById('lightbox-prev').addEventListener('click', () => navigateLightbox(-1));
            document.getElementById('lightbox-next').addEventListener('click', () => navigateLightbox(1));
            document.getElementById('lightbox-zoom-in').addEventListener('click', () => zoomLightbox(0.2));
            document.getElementById('lightbox-zoom-out').addEventListener('click', () => zoomLightbox(-0.2));
            document.getElementById('lightbox-delete-btn').addEventListener('click', () => deleteFromLightbox(false));
            document.getElementById('lightbox-rename-btn').addEventListener('click', renameFileFromLightbox);
            // --- COPY WORKFLOW TO CLIPBOARD (Button Click) ---
            const copyJsonBtn = document.getElementById('lightbox-copy-json');
            if (copyJsonBtn) {
                copyJsonBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentLightboxFile) {
                        // Visual feedback on button
                        const originalText = copyJsonBtn.innerHTML;
                        copyJsonBtn.innerHTML = '⏳';
                        
                        copyWorkflowToClipboard(currentLightboxFile.id);
                        
                        // Restore button icon quickly
                        setTimeout(() => { copyJsonBtn.innerHTML = originalText; }, 500);
                    }
                });
            }
            document.getElementById('lightbox-content').addEventListener('wheel', (event) => { if (lightboxOverlay.classList.contains('visible')) { event.preventDefault(); zoomLightbox(event.deltaY < 0 ? 0.1 : -0.1); } });
            // --- ZOOM IMAGE (existing) ---
            document.getElementById('lightbox-content').addEventListener('wheel', (event) => { 
                if (lightboxOverlay.classList.contains('visible')) { 
                    event.preventDefault(); // Blocca lo scroll pagina, fa lo zoom
                    zoomLightbox(event.deltaY < 0 ? 0.1 : -0.1); 
                } 
            });

            // --- FIX SCROLL CAPTION ---
            const captionBoxElement = document.getElementById('lightbox-ai-caption');
            if (captionBoxElement) {
                captionBoxElement.addEventListener('wheel', (event) => {
                    event.stopPropagation();
                }, { passive: true });
            }
            document.getElementById('close-summary-btn').addEventListener('click', closeNodeSummary);
            summaryOverlay.addEventListener('click', (event) => { if (event.target === summaryOverlay) closeNodeSummary(); });
            if(showUpload) showUploadModalBtn.addEventListener('click', showUploadModal);
            uploadCancelBtn.addEventListener('click', closeUploadModal);
            uploadOverlay.addEventListener('click', (event) => { if (event.target === uploadOverlay) closeUploadModal(); });
            fileBrowseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));

            // --- KEYBOARD SHORTCUTS ---
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

                if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
                    e.preventDefault();
                    selectAll();
                    return;
                }

                if (e.key === 'Escape') {
                    const shortcutsHelp = document.getElementById('shortcuts-help-overlay');
                    if (shortcutsHelp.classList.contains('visible')) {
                        closeShortcutsHelp();
                        return;
                    }
                    if (uploadOverlay.classList.contains('visible')) {
                        closeUploadModal();
                        return;
                    }
                    if (summaryOverlay.classList.contains('visible')) {
                        closeNodeSummary();
                        return;
                    }
                    if (document.getElementById('ai-search-overlay').classList.contains('visible')) {
                        closeAiSearchModal();
                        return;
                    }
                    // Close the new desktop search panel on ESC
                    const panel = document.getElementById('desktop-search-panel');
                    if (panel && panel.classList.contains('visible')) {
                        panel.classList.remove('visible');
                        return;
                    }
                    
                    if (selectedFiles.size > 0 && !document.body.classList.contains('lightbox-open')) {
                         deselectAll();
                    }
                    hideDropZone();
                }

                if (document.body.classList.contains('modal-open')) return;

                const isLightboxOpen = document.body.classList.contains('lightbox-open');
                
                if (isLightboxOpen) {
                    switch (e.key) {
                        case 'ArrowLeft':
                            navigateLightbox(-1);
                            break;
                        case 'ArrowRight':
                            navigateLightbox(1);
                            break;
                        case 'v':
                        case 'V':
                        case 'Escape':
                            closeLightbox();
                            break;
                        case 'd':
                        case 'D':
                        case 'Delete':
                             deleteFromLightbox(true); 
                            break;
                        case 'f':
                        case 'F':
                            if (currentLightboxFile) {
                                const item = galleryItems[currentLightboxIndex];
                                if (item) {
                                    const favBtn = item.querySelector('.favorite-btn');
                                    if (favBtn) toggleFavorite(e, currentLightboxFile.id, favBtn);
                                }
                            }
                            break;
                        case 's':
                        case 'S':
                            if (currentLightboxFile) {
                                const link = document.createElement('a');
                                link.href = `/galleryout/download/${currentLightboxFile.id}`;
                                link.download = '';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                            break;
                        case 'r':
                        case 'R':
                            renameFileFromLightbox();
                            break;
                        case 'w':
                        case 'W':
                            if (currentLightboxFile && currentLightboxFile.has_workflow) {
                                const link = document.createElement('a');
                                link.href = `/galleryout/workflow/${currentLightboxFile.id}`;
                                link.download = '';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            } else {
                                showNotification('No workflow available for this file.', 'info');
                            }
                            break;
                        case 'c':
                        case 'C':
                            // Copy Workflow
                            if (currentLightboxFile) {
                                copyWorkflowToClipboard(currentLightboxFile.id);
                            }
                            break;
                        case 'o':
                        case 'O':
                            if (currentLightboxFile) {
                                window.open(`/galleryout/file/${currentLightboxFile.id}`, '_blank');
                            }
                            break;
                        case 'n':
                        case 'N':
                            if (currentLightboxFile && currentLightboxFile.has_workflow) {
                                const summaryBtn = document.getElementById('lightbox-summary-btn');
                                if (summaryBtn && summaryBtn.style.display !== 'none') {
                                    summaryBtn.click();
                                }
                            } else {
                                showNotification('No node summary available for this file.', 'info');
                            }
                            break;
                        case '+':
                        case '=':
                            zoomLightbox(0.1);
                            break;
                        case '-':
                        case '_':
                            zoomLightbox(-0.1);
                            break;
                        case '0':
                            currentZoom = 1;
                            currentTranslateX = 0;
                            currentTranslateY = 0;
                            updateMediaTransform();
                            break;
                        case '.':
                            cyclePanStep();
                            break;
                        case '8': 
                            panLightbox(0, panStep);
                            break;
                        case '2': 
                            panLightbox(0, -panStep);
                            break;
                        case '4': 
                            panLightbox(panStep, 0);
                            break;
                        case '6': 
                            panLightbox(-panStep, 0);
                            break;
                        case '7': 
                            panLightbox(panStep, panStep);
                            break;
                        case '9': 
                            panLightbox(-panStep, panStep);
                            break;
                        case '1': 
                            panLightbox(panStep, -panStep);
                            break;
                        case '3': 
                            panLightbox(-panStep, -panStep);
                            break;
                        case 'h':
                        case 'H':
                            hideToolbarTemporary();
                            break;
                        case '?':
                            showShortcutsHelp();
                            break;
                    }
                } else {
                    if (e.key === 'z' || e.key === 'Z') {
                        downloadSelectedZip();
                    }
                    if (e.key === 'l' || e.key === 'L') {
                        startSyncProcess(true);
                    }

                    if (e.key === 'k' || e.key === 'K') {
                        showRescanModal();
                    }
                    if (e.key === '?') {
                        showShortcutsHelp();
                        return;
                    }

                    if (galleryItems.length === 0) return;

                    const getColumns = () => {
                        const gridStyle = window.getComputedStyle(galleryContainer);
                        const gridTemplateColumns = gridStyle.getPropertyValue('grid-template-columns');
                        return gridTemplateColumns.split(' ').length;
                    };

                    switch (e.key) {
                        case 'ArrowRight':
                            e.preventDefault();
                            updateFocus(1);
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            updateFocus(-1);
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            updateFocus(getColumns());
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            updateFocus(-getColumns());
                            break;
                        case 'v':
                        case 'V':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                openLightbox(e, item.dataset.fileId);
                            }
                            break;
                        case 'd':
                        case 'D':
                            if (selectedFiles.size > 0) {
                                deleteSelected();
                            } else if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                deleteFile(e, item.dataset.fileId, item.querySelector('.delete-btn'));
                            }
                            break;
                        case 'f':
                        case 'F':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                const favBtn = item.querySelector('.favorite-btn');
                                if (favBtn) toggleFavorite(e, item.dataset.fileId, favBtn);
                            }
                            break;
                        case 'x':
                        case 'X':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                toggleSelection(e, item.dataset.fileId, item);
                            }
                            break;
                        case 's':
                        case 'S':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                const fileId = item.dataset.fileId;
                                const link = document.createElement('a');
                                link.href = `/galleryout/download/${fileId}`;
                                link.download = '';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                            break;
                        case 'r':
                        case 'R':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                const fileId = item.dataset.fileId;
                                const file = allFilesData.find(f => f.id === fileId);
                                if (file) renameFile(fileId, file.name);
                            }
                            break;
                        case 'w':
                        case 'W':
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                const fileId = item.dataset.fileId;
                                const file = allFilesData.find(f => f.id === fileId);
                                if (file && file.has_workflow) {
                                    const link = document.createElement('a');
                                    link.href = `/galleryout/workflow/${fileId}`;
                                    link.download = '';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                } else {
                                    showNotification('No workflow available for this file.', 'info');
                                }
                            }
                            break;
                        case 'c':
                        case 'C':
                            // Copy Workflow (Grid View)
                            if (focusedItemIndex !== -1) {
                                const item = galleryItems[focusedItemIndex];
                                if (item) {
                                    copyWorkflowToClipboard(item.dataset.fileId);
                                }
                            }
                            break;
                        case 'm':
                        case 'M':
                            moveSelected();
                            break;
                    }
                }
            });

            function updateFocus(delta) {
                if (galleryItems.length === 0) return;

                let newIndex = focusedItemIndex + delta;

                if (newIndex < 0) newIndex = 0;
                if (newIndex >= galleryItems.length) newIndex = galleryItems.length - 1;

                if (newIndex !== focusedItemIndex) {
                    if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                        galleryItems[focusedItemIndex].classList.remove('focused');
                    }
                    focusedItemIndex = newIndex;
                    const newItem = galleryItems[focusedItemIndex];
                    newItem.classList.add('focused');
                    newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else if (focusedItemIndex === -1) {
                    focusedItemIndex = 0;
                    galleryItems[0].classList.add('focused');
                }
            }

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
            uploadSubmitBtn.addEventListener('click', performUpload);

            // --- FIX LOAD MORE BUTTON ---
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', async function () {
                    this.disabled = true;
                    this.innerHTML = '📂 Loading...';
                    try {
                        let fetchUrl = `/galleryout/load_more?offset=${currentItemCount}&folder_key=${currentFolderKey}`;
                        
                        // Controllo esistenza form filtri (assente in AI mode)
                        const filterForm = document.querySelector('#filter-form');
                        if (filterForm) {
                            fetchUrl += `&${new URLSearchParams(new FormData(filterForm))}`;
                        }
                        
                        const response = await fetch(fetchUrl);
                        const data = await response.json();
                        
                        if (data.files && data.files.length > 0) {
                            appendFiles(data.files);
                        } else {
                            showNotification('No more files to load.', 'info');
                            this.style.display = 'none';
                        }
                    } catch (error) {
                        handleError(error);
                    }
                    
                    if (currentItemCount < totalFiles) {
                        this.disabled = false;
                        this.innerHTML = '📂 Load More';
                    } else {
                        this.style.display = 'none';
                    }
                });
            }

            function showShortcutsHelp() { document.getElementById('shortcuts-help-overlay').classList.add('visible'); }
            function closeShortcutsHelp() { document.getElementById('shortcuts-help-overlay').classList.remove('visible'); }
            document.getElementById('shortcuts-help-overlay').addEventListener('click', (e) => { if (e.target.id === 'shortcuts-help-overlay') closeShortcutsHelp(); });
            const closeShortcutsBtn = document.getElementById('close-shortcuts-btn');
            if (closeShortcutsBtn) {
                closeShortcutsBtn.addEventListener('click', closeShortcutsHelp);
            }

            // --- CLEAR BUTTON ---
            const aiInput = document.getElementById('ai-search-input');
            const aiClearBtn = document.getElementById('ai-search-clear-text');
            
            if (aiInput && aiClearBtn) {
                // Mostra/Nascondi X mentre scrivi
                aiInput.addEventListener('input', () => {
                    aiClearBtn.style.display = aiInput.value.trim().length > 0 ? 'flex' : 'none';
                });
                
                // Click on X
                aiClearBtn.addEventListener('click', () => {
                    aiInput.value = ''; // Pulisce
                    aiClearBtn.style.display = 'none'; 
                    localStorage.removeItem('lastAiQuery'); 
                    aiInput.focus(); // Rimette il focus
                });
            }

            // --- BACK TO TOP ---
            const backToTopBtn = document.getElementById('backToTopBtn');
            window.addEventListener('scroll', () => {
                if (backToTopBtn) {
                    backToTopBtn.style.display = (window.scrollY > 300) ? 'block' : 'none';
                }
            });
            
            // --- QUICK FILTER RESET LOGIC (Event Delegation) ---
            // Using delegation ensures it works even after the mobile button 
            // rewrites its own HTML (Hide/Show toggle).
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-reset-icon')) {
                    e.stopPropagation(); 
                    e.preventDefault();
                    
                    // Redirect to clear filters
                    window.location.href = "{{ url_for('gallery_view', folder_key=current_folder_key) }}";
                }
            });
            
        });
        // --- BUTTONS + - LIMIT MAX RESULTS ---
        window.adjustAiLimit = function(delta) {
            const input = document.getElementById('ai-search-limit');
            if (input) {
                let val = parseInt(input.value) || 100;
                val += delta;
                
                // Limiti di sicurezza (Minimo 10, Massimo 2000)
                if (val < 10) val = 10;
                if (val > 2000) val = 2000;
                
                input.value = val;
            }
        };
        // --- FORMATTING CAPTION TEXT ---
        function formatAiCaptionText(text) {
            if (!text) return "";
            const frameRegex = /\[(Start|Middle|End):\s*([\s\S]*?)\]/gi;
            if (text.match(frameRegex)) {
                return text.replace(frameRegex, (match, label, content) => {
                    return `
                        <div class="ai-caption-card">
                            <div class="ai-card-header">${label.toUpperCase()} FRAME</div>
                            <div class="ai-card-body">${content.trim()}</div>
                        </div>
                    `;
                });
            }
            
            return text;
        }
        // --- COPY WORKFLOW HELPER FUNCTION ---
        function copyWorkflowToClipboard(fileId) {
            const file = allFilesData.find(f => f.id === fileId);
            
            if (!file) return;
            
            if (!file.has_workflow) {
                showNotification('No workflow data available for this file.', 'warning');
                return;
            }

            showNotification('Fetching workflow data...', 'info');

            fetch(`/galleryout/workflow/${fileId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Workflow not found');
                    return response.json();
                })
                .then(json => {
                    const jsonStr = JSON.stringify(json, null, 2);
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(jsonStr)
                            .then(() => {
                                showNotification('📋 Workflow copied! Press Ctrl+V (or system equivalent) in ComfyUI.', 'success');
                            })
                            .catch(err => {
                                console.error('Clipboard write failed:', err);
                                showNotification('Failed to copy (Browser restriction).', 'error');
                            });
                    } else {
                        const textArea = document.createElement("textarea");
                        textArea.value = jsonStr;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        textArea.style.top = "0";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                showNotification('📋 Workflow copied! Press Ctrl+V (or system equivalent) in ComfyUI.', 'success');
                            } else {
                                showNotification('Clipboard API not supported in this context.', 'error');
                            }
                        } catch (err) {
                            showNotification('Clipboard API not supported in this context.', 'error');
                        }
                        document.body.removeChild(textArea);
                    }
                })
                .catch(err => {
                    showNotification('Error fetching workflow: ' + err.message, 'error');
                });
        }
    </script>
</body>
</html>