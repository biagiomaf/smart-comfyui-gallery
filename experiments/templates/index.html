{% set app_logo_b64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAGHaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49J++7vycgaWQ9J1c1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCc/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj48dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPjwvcmRmOkRlc2NyaXB0aW9uPjwvcmRmOlJERj48L3g6eG1wbWV0YT4NCjw/eHBhY2tldCBlbmQ9J3cnPz4slJgLAAA3X0lEQVR4Xu2dd7gmR3Xmf6equvtLN86dPMoBUDKgAAogi2SCCTYIMMb2YmNwJBowGJAwXlhgMRmbaK8xSeRgkS0Jg4QAIQkFJCEhaTRRM3Pjl7ornP2jv5GHe6+wJNg12vX7PP3cme7T4au3u+rUSQX/hf9UyPId/xnQC9R96ItXFtVc1yyIycKe1KgGsShDP8+jNS5rRCtJre9YKbMsiaobL/x4u+VNlpLviwj77MRBxa6nvvu47vLr/zLjHhPwvId9fX1n34aNrZg2V9XtGxaXqrVRzJQYGsnIQNU7TzlVpUGnTKWrQjSRQKRnEimLqqJJlCQNTWnCYNomGVvYvMhNo2nVFQaTFWRiydRJQ5umYwrTsS1tqtUsWOOCwShJsVhnxvOfLB5ZPeFVXzv05uXP+8uKu03AG46/+IGDHROv6JfhjKBpRiTZEIdUfoDXQFQlmkjUCr9/wxM0kSSQtE80AxKgKKSEAUAwOBwOS0aGIyOnoIklJ6dFh0la0qGlDTIKMnIMFoNgKMjaEywdtvWPX3L1YX+//Ll/WVH/9ruINx533TN7t2y4IM3OPFm7xfrUS3bY69MfDgmhIsWSkIZUoUcZe3jt4+ni6RKkh6dLxRIhBVIKJPUkAokIMGpIg0WwCA6LlQwnBZkUOLEYVSIBtQHJwGYW6yzOKFaXcLHctfy5f5lxlwhQPce868jr/rve2vxQ6ObjXZ0lsIgywCoUKlgxGBwWh5Ws3jQj1ya5FjjNcJphyTAIggEsiEOl/otYwGJwGDJk9G/L6Dyt3/acBnlsY3yB8QUutmkxje9kS3rfxqXLn/+XGXb5juW4+OOp+bEnbfhQ2NH540GvAgJCQgkoBkUQKYE4atT6ovURUCCSSChKQog46m5HEMDUpJFjaeDI6wamQUGLMaZoyThNmaBlxmi6JkXWxGZNxGWoS3hJuAYMJvd+9IXfOeSfl/+GX2b8zDHg42++uPnDd/PJfNvmx1ZlH0FxklMRGBBQjRgqhCFJAhEhKCQBlUhMFSUlSiKYgJqKaEpirEjiUedRSaiapFEWRcxco7BLuXGlsw3foOFbqTUnNHZlWXtvbprd3OT7Cte+PanYmLKg2XY/6Km1Y91qfu3nLn3Hd9+xuPx3/DLjZxLw0qMueI3etvbVaSgYEioBIzk+GQzQweKsUJlI0opkAlVWMqDq+aSzPlWLpXb3+VTdmrXizsYk3SRhz1Lf7wmpnO1MZ3NTkzP9NExhT7x1/pPXvHgOQZc/x//LuFMC3vbo74z/5NvVj2RpfBNGiBqwCE1yOs0m0jCzWWFv1UyuWJTqqir5odDvpc7CYs/tXRoGP1uFQYJBw0rlYmZ1EAb4yreyhca4T6ZTpdBRyduZbReZk/EQyxmT7EQmWcMFI1ZsMJmtLBlNM94uwlhmUse4GFJO01srYsjVmLyyRawsRchy01OjPoWhDQxMZjNv8zxYJ8HrMPlQShDjTJZVfb+wp2RhX3QLA9OmL5mdH/Tj7DB1B1FDSA3TdzZU4+Mw3nTp0PsfOnzWa84aLm+rnwd3SsDfHHnlg/fd6i8JPmCMQdVQaM5k1mLNoeO61Cyv3La067vV4lIlPe/U2k3BlFPDND9exWFLxDV80o7XasyKcUYU1JM0EKMQNBI0ogJWMhTFpwqjoxFADLlYCjtGFlt0ZIaWTmNTA4fHsabWioiIFBjJyYxFLCRVhrHE08eJ4DIDNjL0Pco4IGpATaJPj4EsMjRLYD2iHh8HsSKUSVJMIkMVrZSEMZKsyfuZZnsKm+/Jm8Vss9ncR+Zuy5vu1rFDJ77/ys+cvHN5O/5HuFMCzjniB88ub2u8r6r62Lr3x2BwonRlQJ8+4GmkHEtOIuEZ4hngqUgoCQhElDgatCsSJUokklBJCIqojJRRj0MoJKPBGDkNGtKioVO0dQ0NmjhAJMPKGBY7GvxzcAlnCiyBFIRKBS9pRFAiUuHjgJgqPH1KugwZMKSPZ4Di63kJEFA8sVYwgIgnkbCS0aBJIW1y06bIcpzNyZwjy/X2sen2+zvHZB/4k0/f5yfL2/POcKcEvO6QK9443D75kir0sSMtBkmgadSoHqUkkUhkWBEg4PFESqJUoIqqQ0VQEaKWeO0TqUgkGGlCtX5kUJRczGiS1aCQNoVrUdChmcZp0qwVUlvgsKA5RgqMCNEGsAZHJHpPjNyheSFKSBVRK1IaUGpFX0uG9BhIl4o+iRIhAEoQpUqRKCNNTiOYiIqQaZM8tXGSk1lopCZZysnEUTTHKdv9hcZYeOcZN1XnniVnheXtuhx3SsDfbr7mI8OdU7/V09sRtSQKMAFSJJhY/zQVBI8wwKpDsQT8SN2sGz1IQCWSEJJ6vPYIGkgjNVXEYMRgsYhSz4JNgTWOzOY0TYuGHaOgQ5ZynAq5tWS2geBwDkTBK9gCnIFYQVUmSFp3c0ZQUWL0hKqkDBVDhpQM6bNAT5cIlBhirbERqKiIBEQUqwYd7XXkFHQQKXDGkacmVkPdQ4hBNWM8b6EbF79w5FOGv/W7b/613vK2PRCrEnCenm13bfnvl1TbZ07uyk4CGUqOSA9JGZAIVCiJVqNBZhsQApEBIa9/mKpLSVwZ83KYZCkGQrKZ88aJT1rGqhyIwhCkL0YGVk3UQPSBQZ7lVZZnVdYw3tlMnSmskyI6KQaZuH5m6DrNB1neEOOyseC9T1VcyqxYhIZq1FgFVZJEDa1kQkfENMq+NocDaaQYm1jvong71L70q64L4jvWZmMhlM3KDxspVU0j2sxcE6ctJFiieiRFci2wqYUkN+pqBaTA6YAoGZk0WF9spNqy9xWv+PEDX7+8fQ/EqgR8/M/PX7vnE/e7yu+aWb/EAoFAZgYYVUQ3gCvpNnZCq/rRWKf5wyJzO5d0MNfThZ3tMdmRNcxsmaS0ptmLWa+X20VPPkyb1h/tDz10UxjbFNK+xatl82M2+2OPPTaISN0f/SdCVe17z72smP3+9cW2HYOm+DguuUzmyU5lg8Y0odWOYp36NCXJbUjDfD0xbTHIkflw/Vr68wykj6FDZhp0Uodqerh905PTsc9970kLy++3H6sS8IGHXX1M74eTl/u9Wd6nj0oi04CYDtX4YKsbr/45TlZfav1V/7IXP+20wfLz/3/CW59+yfrBNWNP8bcN39Cbj+1EIBcDIjTytdhDy9e94rpj/mr5efuxKgEfOu3Wh8zf0P5m2Guo8HjpY7VgMNHbMXb69ae95Pxfv3X5Of+/4w0nX/vr4QY+1V1IuZM+lmZt3V1PLzt54fiXfOHBq5rIVzXGxWinCm1SkJNLE5WC3Oa4xvD9/9X4q+Nl3zvmi7qpfGe7GMeR4YBCE+MLa9tyzdjZy+X3Y1UC/NCuyWMDKwCKxeGzMjUnJr64XPa/8O+wRw/fEZoLXas5mRbkMkaepvCLzVOXy+7HqgQw1GnxprZ2aonTBilLe/xBO+/yBOP/R7z8c6feYhpyeYMxHBlGHAaPDeVBI617BVYlIJWprQlwBrUepw4xcc/lX3/Q/HLZnwfbL5p94s5vLD11+f57M1qtxlWNfGLkWkqIVBQUa//kqe9sL5flzghAo4mS8OJRBAto7O/6hIxcV78AfPsrV6xrzrf/17rY+fjuL+87bfnxeyumOsVt7XYTVzRw0sJKkzybmNq47QFrlstyZwSUMpyoUgUpErW24njC3HK5nwdbZg9/8lTIJ0wFOmi+avnxeysajbQjy5XcNjDW1maM1BibqO67Zbksd0aAj2G9VcGliCiICWDinU4m7gnEF2f7ISwtgS3to277yOwJy2XujfCU/USJVcGa2gLsYkFY6m5eLsudEZAqt84lwWqqfbmScIXvL5e7p7jxI/se18Q9dKmnlGViyuXGpuJpy+XujajCMJZhQEoVRsFIbULzXT+9XJY7I0BS1raiiLE4GoCgxlbL5e4Jfvyp7Q9sDzrvsz1jyzISh0pvAVyVPfeaD99+1HL5ext8RKvgiTFAGgUf+IRWqbFcltUIeM57vp8Za1tiFbUOMRFIONf4ub6Acy64wO39zODPJ5dmvtqq8o39HqivzXGDHhRka6b91Od+/JH5Ry8/994EMQ2bohBiImFRLAZDIaZYLstqBJxyY7thjOlEATUQ6JHEk0T3LJe9q9j7ld6DXlo+9BuTqfH2op+v6fVTPbZEg0YhJmW+F2l4d7+J/viXbvnI0ntuvuDmyeXXuau49kO3bLzhn2d/ffn+/xtwkiUVi1dIUdBoIULUMLFcltUIqG6cbRK1BYpqolRPjx597d7jgKfMmd9sTZuHdudhsR9JClZBsASjaFJMMHQHSssIGyc6z7Fx6ujl17mrmKg2PnddmvrCjz+x89jlx/5Po90e9mPmRxEiQ9RXBFW8MWPLZVmNgIUdi63gB+1EqCMh1DN080ixeI/V0Pm8/B9L28O7nKsj2TSACNT+RZAgWC+MNYUyTzo/qF57k534wfLr3BVcfcHuTor2mQ2g8J2HLT9+T3HOOZ9v/f1JtzzzHUff/uq3n3TNI87T81aNqZpZ2+zmRR07lZTa76dKxN+1idhwkPJYqYs+oUlQMrzz6qbzexxvc8hDJufGfyP7s/nW8A9cK4axjkEdSKZYJ4gVxsdgmPvrZhuDx6x/SvHqs86S/9Cdtxomd088dyKzR8zPQpptPlPvxARwd/Das244ov3Bky5IN099yNzWfI27YcPXlo566CUfOHXpxX/3tJ2HHihri7XeW4NnESsJSx1wECXkB8rtxwoCbJkVKSSXIkRNQIamLKQYyuWydxdbzm5+cJgNnxDHqz2tCcgyIWsYJtZBrxW/25ssf/Wop3S+svy8u4pdXy9PaKbs5X4A/T401Z5ywwe7r1gud3fwzgde8qA1V49/Y3L79CnduZJu6BOXmpTb15ycrm38z/Lr5ntvPOym17ztz88fB5if35lVMVECQQKJWnnMs8aqTqcVBDiXN6yog4i4iBGLTTbk/hejhh703zpf6jbLP/SZT9ZClgNjwJR/1RFPHNu9XP6uYuEbC/dpLMk3Gsms6ffBmEivB2u1/Tdbz1v8k+XydwVvPPF7p6etR/2L2zd9SDfNkVTQkOPtHP0wz9zCPGFfc0a3T7167mNHXvqXR/zoCa1+JtZXGsUxTBAIdT+bdEVbsxoB6ydnirF8SlQNYpQ8z+g0s15nDb+wxIeDnzL2ed+X67MWNDrgNW2bne5eslzu7sCr7/oy/CAlajO6CLkFZ8EvF74LePuJF58+fvOhnynm1qxZ1FkiTVQy0IREi4l1tEVFn361RNzTvm++XT63e3v7jT7GFLVHokKkDsMf+n5r+T1YjYDWlBRZq8AYh9VahxWlNC78wlyPIqJZwVdaTSgmgSx8/H5nrF1aLnd3MPOIme1rn976tYW49JasUcdYZw3Y5edfeMRTx9+9XP5n4R9Pvuah9uZDPz+cb67txkUiOYYe46Zgan2bVnscTaDaQxiSoxQMKCrL9lv3nbpvcd4GSoxRrNSh9uKlufw+rEYAbZtroTibkWuBBqHy/uceyJbDN4cfXLChOzcMl/bae//H8uP3FBf/ty+/ZMn76zatgV4+/NujnzP11uUyPwtfeNyNRy1t7ZzXncume2mBZOpovTEzgW4c/mj8gYuPN4cM32Cn7aDIJkZJIkIyOdEZlvwSZazACEkTkjwuGZoyftcGYYnNTm2AFiRmSDKEqCaVfoXsz4MNTxu7alc+f/IN3PyozWdt3rv8+D3FU+WpURvlJ7bHwfX9oxfPWX78Z+GzT9+z6bYfdj6xsLe5fo4udUrVEpNZTvsI+8PGyfqY3/rSui/+4TXTf8mJ/hQO776+uZkdnWYblyIExYgDDAqjMH6tg9pSftdmwsNFpkJfiFFRL2TkOFzqlcNVR/GfB/d99NrrHvzYo++xentn2Om2vem2mR0PPe6s9Xd53Hr9M/5t6iffXPj0/C79lUHs0lIlEQnJ0T6i3HvS78jTn/3p6Tv84S/42sarX3D9wa84/ClTp2eHhW+vbW2imVqjbtuiKiiGCFQEqhQa5+g5K9p7xQ6psrUu5hgMXhIWizUm7JTb7slY9p+CM559v6XTn3zk7cv3/yzk39z4XvZMPKjnZ7GUqHSxlKxZY9nyIL53n1c3frT8HIDHvK15y9Qf/OQJ9r7dz06OTyI4khQYtSABLwYvkaRJzl1+8moEOMu4tRmoUpmAKOSSh/zo6hfmDftlw5uPufrF2b6pp1S+T0ETKECbCHDcyTMc/YDmz5wUPu3Fp82ectnOp4VNe78x7mZwCmIMmeaI1r713NhK5DUrepEVBDQbDWNGe4U6Ic7YzBw2fsgvfCC+O7j66qs7u6/e3Vm+/+fFpx6095HNnRtf3x0GglTkGJpYDA0OOmKG4x+SU0z4FQ23HMfJcZWc2P0du27hyik7Q0ZBoXU0t8WRm2LVxJMVBBiLxBhQTRgxJCJJ1LV7R7nlsv+3sHXr1ubm2SO+2pid/tLWrVtXVefuCT706L1bdt2s/xDmG5loxNDAiSUn47Aj2zzocTMUG8BLvEuT0D/68DE7Ww/a/pjOTH75etkAxiAiiDpEbFMvuGBFG64gwFlxkEiaQE0dmG5DZpuyqhr1fwPtazb87qQ0Th3P3BnZ9dPPX378nmLnNfN/392bbV5gFkfEaYGqYWyN4eRHTzFxpDIAQrCblp97Z/ijz5y5c80G96GZxgSONrLfoaWSXXjhof8xASFWjRBDHV6uQiJhsuTaMV/V+vd/Gtu/vziTdeXlYQcsblfsHvfC2z/V3bhc7u7i7cfe9AfsG3tcPy1hKUEMFsWYBoc9YJyJg6DKlDIByR13+T/uXdWnuxoWkb6XIe2UYSmwgBNrq+7CijZcQYCKyYIaRGyd2IDQaJr2offZtEl1fqraWp2yeFP/IYvbdWb5ub9o3P617gMmt7U/08IdsrgEvT1KsVis08XiU7eeP3/EHXJXDI/ed2359Lkry7f3ropvHl6bXt69Ljx76+WrN9rrHnDxkYvb9A2hn8glgTZG6qOy5T5tDn9QE595xBuqqIznbqLRt89Zfp07g5FkSlPn17iRX8xItANTrGjvFTswxoo1WGtw1pAI5GSNw44ce6ruHHu57+nnTWkvtIvVRd0fl89W1RWf1X587pm3HPbpR86ffd6Zt7/gU4/sPfczT9pz4nKZO8PCt/qnNob5hY1ozlici6gHgmGhm2gad2ojtr4x933/jsXvhX9t+OwH4+QfnWzmf95qmRcVbXlde8a+b1LG/2D5dd959nkdu3Xiw83FqTUiCTEKVvAkOhOOEx6R0VivJHGYCFkQlpLSKRovuer9O89afr3VkIk0VAUxgphEoiTqINfbG//xF2AtwWQGnMWYOvV6sNSDYXx83JH+IB/m6zOfm5bJjzFD+5L+1v665df4u4fdcMzfHXXbh7f+q/xgz2V63r7LW2/Z9/3872+7WC55+8G7vvzmE659+nl63p2OKdUPq5NaeeNvx6az8V5IiNTRBdaBawuxpUxNZodMZu7PxnJ7VsOY9rAf6c4r/XmghMGuUGoMXzvwuv/jZedNVN++z8fH5recEjVirWCtxSXL5HjGiY+ZZOpIKEfhDFYikqAaKm0azWmmP3L1P2098sBrroaq8hNWHdYJNlPEeIKWsRjfvUKbWkGAy+w8RgmqqNSZ7ohRreS+ZuCmq74SBgoBomf3vJv/qXDFj59y8281rpz6VvrJzDPKHfnkvtl5di7OsW3uNhZvn8/KrfJr8cbxj27dcP9vv/bYix514LkAF1xwgcPbc9yUPHiQRxprDa6t4BLkkXxckTGhH2BpDhYXoF8qIQheI60MfE971VB+Z+LE1h0W1n84++YN4SPHfU33bnhsP/bw4kkSydTRyoUH/uoUW060lCJoMhiTSFJXssgqQ68H03m+YayaectPP/FKaNIJKw4xgrGKs4JVWepOb12R4rqCAOOySg2EGIkaiUDRaZFnVuqyA0LmhN4whoh/7ebNm++IlvjEg3f80eD6mQ8v7LNT++IuSgKVGIwtyUWxWIYyT9UfYndPnGRumT7/nMPPf/qB9z/rrLNCFf27/Xy8qdm2mA7YjkUKwRQGaRhUgQpipYSQkBLc0DCeOXpVnF8oy8dPnuQ+ceB193x78IHWjs0nL1SeUgZ1PQrNSR42HNVi88mWqlHnvWXisSokcSB1fplRmF1Sctf89es/sPSIA6+9HJJMu1ZiIjHFmlBx5dnnnr3CmrCCgKRaJB9JDoLLsWIZ6zgxhVBJnQRnHQyGPH/ygc07PvF/Ou7G5/nr1//d/ILKrOkTJeFNicXRSeO0dKwOVzUJTKIvA1q9cbt250H/8Lb7XPrbBz5D55TGl8qFwenVXHprIlXNGSHLBWvqzMfolVhBjAoxokHpFOCHsZqfD7+79sHNCw683mvve8WrdXbssb24AOJJ5BhyUshpThUcfXobmRoFC1Ang6YEqGCSjHoCJSQlB4rUeO0Fq+j0+2HRhk2j7MoghBjxEuoSGsuwYocoSkxgwDjFFYaAJZYgqjTHYX4weOva090dNvZ3H3/bY/q3rn3r7XM9+tyOTQpqyFKbqeYUa9a0F/IJG1qNGdppiizliFZ4SspybaPauemf33TwDz9yzlPed0f02NgjxnYXp9sXlrH6NU+6pn0wlG0lKcSkBKnnKU4zJiYM/RBvnx36J2x5ROMLd/wY4PUnXPXH7Bh/jR96wii1Fc2oVJjYmPOQs8fZdLyQpK7EIqqk5IgKOnKqK0IytZOn34fJlnvwzK0nvvTA+xwIMeJIkHyCIIDiU2hceO6F2XLZFQQ0rMTcGlxM5CkiktGtBC2h0Ra681y0c6z5sv3y73jw947Pb53+YFzqSJc9qEQsOS3bpr3O72wd3P/ztQ+VX8lPKU72B+99ezFRlh3pjG5sGEqCbmBy1+bfal50+pf/+kEX/lR03NipzQv3af9h3UH6h6nCMD0tuIaQW8N0B4omzA78F27v9c/c/LDmHf7k88+/ofjbo294LTePvztfLHBkCAmhJBGZ2Wg58+ktDn2wIWT/bjaOdzR6/TcBdYyUoEaIAmUJ49p6xQ8+uHoknxETxGrdvAJGHJqQW5YLrkZAlmOcMZAU4w0mRox6mhn05tJ1+7r6rOOOkwrgzQ++8Hi9cf2/6JJsGMg2MlPn9bZNwcShsuuwhy098vevm3nnr3+6detzvta54kU3HPL8cJ8dZ/Y37b14srGBjBZZXCRqlz3VPrK9UyfLtWsvfOORVz7jwGfaePrY7WMPs79fleHJgyr9KyZ614SlGL4365eesubM/AmHPXr8uv3yb73vDx559TMX/62/VV5ZLnmCeJI1ODvEIczMjHH64zusPzqxWEEZDEl1ZEKuTV4qo+7AjNrxAEtYWSkbm7Y9abPn/fvef4faMiT1IAlrwJoMI6469FdZYdRbQUAMpoxa93eVBpxEfOh1r9/TfcH1u2cffuivmZsB3nTqNw4pb5j+vO6bPmiP7KUSjzMOlxpsOtxx8GmtNzzxY8des/z6L7z01Eu7//zRh4ctu96VdSaJtCjV4VEW2E3su026bfzDb978w2+96wGXPf7Ac8efmH16/NH24QupPHlPnDvzK3uuP2PTw8Y/daDMB4+94U+4rf3l4dzYyYNyUPf5VsCWOITJzjQPOHOM9UdC6YXgFY0JDabu90Vr+80BDV67H+uMxhEfdIdgknnMxR+/eIVtSpJXvMFpnXwuGJx1/qyzVmbOryCg2yP4JCSBYBJCg243Xn/8C8beduIz1u4AeMfvXLumf+PMJ2Vu/NBZ3U5FIKoQQ0XWVLacKsMTHu8uXH7t/XjNWa8Z/tmNR/9ZOnjXf58Ya2BwBDyZQp4iYTik2p2d3r954vNvP+KqT7z5KV/4qRnt4Y/uXHn4w6e/+dSnHneHkew952xvffhBu/8y7Rh7V7cnZkm6GDzoEBigMZIVBSc/fJwjT07ETNEINkVMgv2FDYA6WMyMvoSkkOoBQbTOylcVKoWMYtPM3DEr7EQOmxutPWOSDCklok9mtRillQQsxqgYjDFIyInRo3FU2AF404uvaG/92u3n+Vk5aU73MJA+mjxJ6/oRR57e5LBHNWy/0Vs1FvJAPO/aw19pD5k/pzFpaZoC6tIaJAlUcchwYQG9LXvK4gWb/+1VR1/5xOXn78f7nn7ZCcUnuSpdO/P6vXMDPB6bHGFUsKPSkorEnJ9laOYpWrUqm7yg3o3e8NoRa/fX/RpxYVQQre1iqjUZBiUXyIxxaayxYmBttfJmsoF4RxcmJI1JVqmFtIKAyg8XRerSGTKqz0HSsf2dY+8ju95v9uUPm4s7WZQ5+lLXWcibDY57zFqOf1qHiQ0my8WvXX7t1fDcq4/+63DY3ie4DcMfdMbatNRiJGBsxCDs9bPk+9xhbpv57Es3XfHhl57+byviPZMs7nCi715q7p6XbAzFkRHrjtsKGA9SEXzioq/fyGUXzJMWhaQRnwKqgqR/fzlVtXaoiyCGett/UEAQWjmkBru0vbT9jhNHsE0zFqQuW+JNqqfxLq4aXb6SgNhfVPWo1gnaSQXjOxZBX3HEBS/3s9nTF/xu+jJP38wzSPMoA37lzBkecPY4YRMkB9Zkq8bBrIaXX37KF4r333aaPWj+RW4qLI3Z9RhtEiWh4hiaRXy/IttVPCNekX3nZRu/9fevOOWrD95//nM/etbeZ1695c3mpNsf3doUblzXXE8m0NKcjBwxEKWHdRW9pQFf/dw1XPKVXYSuJTMZksCMPnJVrSd6+99VOXAArjUhayFrQ2ykv73fk1aG05hcMp88aoXoBGMtrsGqRTtWEOD9Qj/4ITFWVGnAULs4Z1qvO+aHr53dNvu6HeU++vSoGBBTSUWXQ4+d5tiHN4ntyLCqPxWnnbsVXv78xz62fN61J76lf8ziQ3Rd/+tTxSROW7ikmJSTqBikWWJPOuxtP5dr137rrw+7+rXnHGAM/KPz739peuDSWe7gwUfbEzM4m4MGTDKoBKL0EFcR05DvXvITvv7JnSxsS+RGII1m2LW6j9k/BlDPPXQ0OUuqtMZhlx98cvMTG6uGvDhjokptysFYsgSZcSuIYjUCXK7dpJ6UPARPX/ZSVkub57b5V/arLtF4jBgyMlQTmzev48QnH0qYhqprMMOR1mDtf2i0Wg0v//aDr3zetiMfNTxs/gX5dL5notgAo8qLBouViI9dYjdYdsZXpg2XXPSqo7/58P3nP/8zR2/7o+s3PsPeJz6uOJjr1rTXIUlQtXXNxiQkY0iUXPujG/nSx37M9usDWQ7G1gzUjT/q80eEAKBKboUFH+dn7eBF+++5HJpSoUmJqZ7T2ghWV4y/sBoBZRSfYl3RKlCBRnqDeRYWt2Ekw2ld3dapYaI1zkOfeDJjGxzlIBEroBQGA0guPvRnmap/FkTQF11z7NvaJy2dwqHdt+Qz4jtmCiMKEhCtgCH94TxpltOGW/n6Sya/dt5fnPaNO3wEL7j0sPO3nHTkWXaD/kunPYGJTaJmCGATd1TwumXXdj710e9x2QVz2MqQZ0I0ShJFkmJj7RtXUYzxjLWgVP++439jzW0//dQ1VK/Oh2WYCFHwySJR6sphGu9aipJYJ3akC6SRNVTxQKgrfIrFqsHR5PQzT+LQ+41TeVBvCL4ultRbAhftCbd/s3rm8uvfHfzxVx5wywuvP/ZFzUPcWbpm+IPJfD3tNI5RRzAViazWYkqDLK05u3lN61vnHH3ps/ere0/9hOz6+Hue8aTu2OK72kWD8TSG0sSL4EWocIgIc0uzfO2z1/PNz+1huE9pZ0KmUnc7oqOiTcJ4I2dPiDcvFHNvWv6s+3Hdt+eLauBbOoqMMGIIBkqJK3wBrEZA02XBmrpq7cgWje5XBbTWLxwN7nv0ERx3/y2UZaQKCR+VGGsLZRyAdo1oaf/21m/1H7L8HncXL7rsAd+Ov7HtIbpxz6saa9PujcVGWpoRzIAgJZaExC4s5BvSNve+l2+85KKXH/ndZ77s7PMmLjrronDO9vv/WdqSntxe19i2MV+DVYNhgJMBisGaRGKO73zras57zw/53hd3E+YjzYYhWcWooZPB0MV+N1981gOftulO07UWL5/O/VCbMaW6dqoqXiDV1W1XYAUBZRl9QgE7quNWfw2CQVUwWnDwpsM48SFHoxn4niVVSgyRECIhJFIJwy7kpZ1yvewf91zWWzFZubt4zXuf0P+rWx70N/lpSyfrhuHbGmMNP0kb1YhqgUqga+ao+iVut3tI2uo/NDi/ffkLN37+eeep2r/68TGfHpywcFpYF/6x1ZqhqTM0ZIDVPkkL6vKBA27dsYPPfuF7fPDvvsmebX3WTFuKdqKYgAXmXnPCb09ftPzZDkRz8SBnQ57XlbQ8KY3yLJLeNS1oMCx9SEoaTUtqEYfgUAwzMzMcf9LRSDunX9WNnXqGUFpisERv8B6qCubmlIZ3h/f3FP/0ox/tWTVH6u7iLz535m0vvvWEF6TD/a+mNdllE/nM/uA/nCaUkj67Kas9uH48LO21b7tk5l8uesNDLnrgq756ym0v23rss8KW/pNksjHb0kOwBBiFEVZEPAsESm7eOcvH3v9dZm+rmN4iac5Ul35l8XtvW/48y2EWO0UopahH0YQzQmYESbJqdPkKAnIj89ba0pgMJB99AQ6jjtw2OPS+B5NNWAaDhB+AH0T8EEIl+LLeqhLKIVQDmNurNKN9+NiO6Y/efPnc3VJNfxZedcXpF+971LUPK9ctvcWOM2jZMVCLZ55AScAwYEA/LKKz1el7frh40UsPueCtf/3AL574uhtO/lyxwT7Sj8nWppkkZwjSI0qFR0hSkZvALXt287/edQXXXFrtXXtQ/kfPf/5jV+1GDoTx2gghFoGAjhK1cyc0smyFN4zVCBjbFPdZ5+ZzU1dCB8Fo3QVt3rKJifXj9MshsQzoUPFVpAyJUNUDcPCp3kql6sOwr8zthbwyjzOzrU/efPlP51T9PHjHh39n8bXbTn1R8/7x9Pwg9w9mSqvCTeM0x9JDCVgMA+0xv7DUmdu29Pzbbhh85yWHfvmdPO3fbth3yldPGIz3PlAUk7SYIMOAWJKNRCosyg1bf8JH3nP5mrece82dmkIOxGDBNxRxEHEqGAfGgcvMqkHIKwiYfHToOmuWbNKR9lPr4LnN2bJpE2akHYQyUA0rfJlIHlKA5JXoIfhIqEL978pQDWFhHxRV/nDdu+brN33LP3n5fX8evPqbv3r5q29+0O+PHZc9ZPqwqS+uG9tEk3EKbWLUUmHp02WBm1jo7nV7dsz96dZ3TF+R33DfM946/5hn55vT40w73z3BRnLN0GRqNVwGeCm5fts19oqLv3/uUw/+wD++8CkXr1pyYD/mZ/szTjNbF6QNpKQEB7ER9y2XZTUCHv+cEwdRylmjiTQqsJpQ2o0OraKNhoQEQ/JCKJXkQUP9N3jwZaw1Ia+E0d/kI3GgdPdA0c+OKJbcJ2/5yvBjN164ukPjnuKV/3bmd19yw/FPKA7RVzSnxnY3iqlRbGYfFU9MFi9D9lW30Z8tjxjsTl/8wy2f/PjsIduuWX964wFhPHy5mW2gnTo4HVKawND0SDJPr387S9vL37vu29/9xp/85vsPWX7v/dixc9dRVVdGdYMV0UQUqKS6a7YgEVFc2JMMRAkoETA4U0B04B0aDRqEFOroiBQMwUeSj2iU+pi3pCAkrwSvhCHEAfTnlTQP41o8zQ6mv3PTRf2X33z5Pc+KXw4R0RdefdLr1z3cnTh+uL62s35yLiuma3u+1jNiJWdgFthX7qK/e/GpS1f0r73y6mtftPeorX9aTupfmsZ4GtNDGYsN8ugICp5IiHupbl+6/7ZL+5995W9+ddWXp1eGTbEEQ10x2Ar4MjEcpBUOeVYjAEDtcJCkto7XTNYp96kyaLRoqLPbiYYYFD/0dZcTIilEQpnwZSKWELwQSzsaoJVqGOkOEvtmE0W00xOp+bp8bst3tn2z/6I9vyBNCeCPP3na9r/60cNePX365GmNwxqfbY/NkCNYeuR4jCa86bPgF+nOxVZ1u/2L6nq9MOTX36Trs0eUreYPrbRwBBIwNJ5oEiY6dJe9/67vzX/rT0/63IpoOR/V2CxHnCWJ1A7+MpJituoAvioBeeFuz5zWpcpGi2yEqq5sokFIsXZup+BIpUGHCS0NqbKkStAAeEOohFBC7AtxCH4opIEhlkI1EHqL0J2HLLn7NKX55uHtY9/Y+f3yqTt37lw1q/ye4C8+fdJ1b7nusb/R2ex+r7O2c/nM+EYatlUvvTJ6S0sGLMVdDPvdg7p74idm9137+2yce/PEljVXWTdRL6uiFtRhKAgxMrujt27pNt7zB8e/7/cOvF8wMiW2ibMOjMWKpZkZprLxVbN1ViWgyJu3OmcxWlc+MxhSUsrSE4LWXUslxEpJlYI3iLdQWWJl8JUhREOISlVGqkopK6iqiC+VOFBCX/GjbXFfZGkvFGVxcpw3H0+3TJ+/67LymWln+oUR8bbrnvxPT/pfv3vqxmMP+f0tGzf+eCZfDynDMEClh0fp6xzz1W4W+kvPvH7r1e+7Pd66cWLNtI5lMzS0HtRlVAm+ivMs3T7H7Pbq1c985IvveE43HDs4VBmWHDJLaEDRsky0OnedAJPbfcnUqmed8WSxagkeQpC6axmClgb1tt7K+lPTUkkBYojEoCRfdz3e191R8EIqBR0KaSDEnhB6Bt9VenOQlhxuKX9onMs+tONH8YLbvjN4zvzW+Z+pedxVPPaxpjz3krP+4Vcee/Bp04eOv2l6YrxsyjRGMxqpAg14Iotplp5fyH+049qZ6/ZeI3nLsWZ8BmNyPIHSeIZEhrqHcjA8fPbHkydS+xJEy+yggR8gCTIVUg7BeVK2dNcJ0Ga14F0gjd7+nLyujl6CDSCVIQ2FWApUDvEO4wUpBbwgFVAp4hVCPWDHStHKIFX9f41CrMAPlNQX/BDK0dyhOwthUSgqd3Kz33hP/+bWd3ZcuvSihW0Lqxa+u7v47feetPf1Nzz+pUcdfdgZG9Zv+PRUaw3G1LkB1aiIPShJYCHt5SeL17Iv7KY0JUMCA5bomQV6VAx9xC8VBwOc+/gL18wu7j2o1DlirMuWOQveDkLIdt81LQhAxpdu7MneNLKG4zDkZAzneoRuJAyUVNUW0FRBLGstJ5WWNHDEnpB6QuorqUxoqCdpcaikUokhEYLihwlfKsFTmzQGQhpCGkLsK/15ZbAARZUd1YqdNw9ubl2y71J/7tzNg1/IZO5l3zvj+2/f+YQnTx4y9hut8fymtpsYKY+jiKDRCh9DSnb1d7IYZokMMSkQCQzxVCpk0AboXxt/23dlTRX7DClZlC4hBSr6MejsiogI7oyA/L9deVXMy+90GKOgUSeq4hj2hsxuW6DqxzpaKQkpQvL/3riprK2hvgtVT+o3fJiQYUSrRFUq1ajRfaqtqH5kxk6lEkpGpAqhqlW47hL09kFWuqMawZ3jb8sumL88/dniDeku+Z3/I7zzR0//7Majxs5oT+u7J1tFaMsEBkGlXikK1XoNBClJlLXzMlmEEtE+zdxu/JuTv3X/4Z783LIMqHpKSsowqBetM0H7jYUVDnlqj+fqeNdJP35a9uNDPjZYqqf0KfWpTEmVChpNR3u8TbNTUDQcWWbJstG0OwfJRoFNOdg25HkdTyo5kIFzkLfBNrWuaCdaL8ZgDSarp+4mAzGKcxHXdNgMMLVxq9ESSqloTLpPujXypvYR5rvLn/+e4reOfucZw33Z63pLvTOWqlkJo1VCFK0L8I3MMjIqRiYY1k9smZ0ym6zMTUw0KGiZFrk0aEnBpsn1VOMLgz2Hfef+r/jGb96w/H53SsB5ep6dPea081vbNzxqadhlEEsq7YJ6Sg14EsY4sqyo11LJLGpG/jcH1lmMNZjC0GxZmh2LbRlMYWllOe1xR9YBk+2P/7cUuSC2JtFl9Za5mjAEbJ22QMrBNCAbSz/prJfzQ+KLxdH8gA6LxphV9e27gxc96n8epNtPef3crp2/fdO+qxhS1bPa0dp+RmrbsCPDSkFDpxjTdTSYoEWLlumQkdOWgo2T6/BjS91dR111wqu+9msrKqjfKQEA//i712+uvtv5Wmfr2vvtrvbQjQanS/SlS9R6TT3FAEKs88pJo6U/6oq7rl6aZLTmTHSeZCMY0AzEKa5wuMxRiIxW37PkRYtG1qQoGjjJEQWThIbLyJ2lmWU0C4fLSV5TOYyx6i0xF4MuZk0zT0o701CX+gvDsUEox0LVqIKmbpLF0idjQmAyyqARtR/6cdENw2Kr1EGqnDSNxnXRh5aKbXRDNTk/3EVgOHrja7W8dkplODFYsTRo007TdNhAW8ZpaAtHQdtmTLWn6U/M7h2ceemxL/nnJ69IHv+ZBAD83W/+4Ch71bpP5vvWnbB3fh/9NEsgkATiKIwDqNeIqb2fo0Gsno5bHCqKqieaijL1mWcfQ4YjI4cdLQKSan8tOQUtDBmGDEubDEuTBo3RXNbSIKNDzlhdd44KIeFwtIucRiao1lrVMNYz2brwYJ+gHq8Jj8fTp888fZ3HM2BARcWQkpJIHxhQUX/tkO5Y5bJe8bWoV7sUoSFtOmmKCTbTYIK2mWR8bJo0HNLMx1icuPWHNzz2TSe9973vXWGOWNVPeSD+5UfvmT39Dx/z0ebs5CBTf1LDTxUxxnrVU7FYa7CSkWlGIRm5ycilINeCXHKcg8wYrLFYU79DUcPoTXK1y0fAYnHSoEFBgSPH0Njf1FLQphgda9YrLNGgGBnM8zomH5GEDYFUeSpfMUzD2m3JLEG6BBJJS5L08PQY6iJDWWJIj0AJDOr8JvHUwWkZURiNUXX3U3dBFjt6+w2OTFu0mKRhJli3ZoZNmzax2BsQQ6SVtxg29l3w+n991nnL25a78gUciA884epj4i1Tf+oX4tktP7U2DaEKJaSstoiO1geLGtDgaw3CKWoCXutvo0x9FnWJkgGJIT5VREC07rDc6AN3WDKTY02TLBYU6uqIDGmRSYO2KyhsRtScGCOS6vsZVRBLqVBJQADPgEBFGFm3Qu2qoac9+vTwMsBrHQESCMRRqbF6wa5A1DDKDWLUsdYrHVvqROymjrGhvYUTfuV43+403bVX3i57di+wsdjAutYke6dvesWLb7rPqov53C0C9uNTf37DloVrJh/tF+wZWdU/OvPZRp9ia1BVLnjbMJq1pFJiTOBcvQSUT8SohFTSlR5eSwRPkkQaxc+gYNVg1ZJJRmYdzhbkaYzMO1yA3BRY06blChoOgoEYan9E0AQxAoKPkMRSOUXTkBR9vfaZLSmlx0CHDCjp64AhVa3pSUVQf0fjCxExtfZlpX6+OmUpoiIDp40lFbOwdmpm22kPPHVzNb902JVXbM0WuzlNyZmUtYyvt8Hcd99Jz7vgPlcub0fuKQHL8f43vH9Mto01+nuKrJo9qFVUU2sGi6mtGnKTqoYh5lUZmqEKE0HKtUFCK2rlRFSEpCmpiUlNEowRMVZdZkQyUfWZuH4uEw7vxtSrMZJrgxw7bDRzOzlNXrRjCmUI3T3DtBTFt8etKSaSBqMp7vHFUjcG70Lp2tFGTc3F2SjdXtTgI5Ehpa18N4bkS5+hKrEqw6Anqn2J0uu0m7NFI6ucMcYgYtUuuk57acGJ9Oajs5Ktn2h1HpEvydOXtvbHYYymtGggTNvDMQft/ZeX3nz0nRaR/YUQ8P8Kfu/3zmnsubY9Wc0PpxYWFifx+Xie2m3nXVusToVhtRbM2ixnvXHhIPpufUFrQyt1XBEtOW0sHVqS09YZWtPrGT988fTnf/9+Fy+/137cawl42/lvKzqfeNY4Sx0G62QwNb+Qua6s6y/4qWFZWjFVisPWmJTlwf1ydrMXHQ+VjPuB75Sh7JQMxwO+VTJsDKpe0a96WS/1msFU4yqxGZKiyYzCVUaTLgVRhwFyItlIicglo02bhowhWpCnNlOdI0hbBm/86+uOuSOdazXcqwg458zLJzs3T70kqzjVV2GzlfEJUSeJNNCUrMOsMVI0Y4KER1JGCpHSL+Hx9WKEaYkyLdFnyJA+w/2BxgwIdEehKbU9SImUeJLoaN3vWjlwWHJ19Vr3CIXJaNkOY2YcVzXoZBthffVPr916yk/5ClbDqragX1aEm7NzW3sOeYXsWn+WnZ0+2uwr1stsvs7Ntg8x8+0t1bw0h3OBciFSLQiDpSGDwQLDsEgV5vFhgZjqhTuhAiqECktF7YbPUfLR5BJAcaKjELX9ORM60rQSlopCAo0YyHxFRmKiM4Gun3+PedZLVpRJWA33mi/gzU+5eLr71bFrWotbNgxtF03UFQs1Q2RUWkpKooIgJKnf4KSeoH2ieCIQ1VNJvd6lZ0hJj0oGBC3xVARKPENU64lhlDiyBNn63ddaTc4RnIAjx2mbTraWmbVjOrF2/HmvuPLkdy5//jvDveYL2H2tP9JXdkOfHiEqSQ1Ja+NFVEHVYFNRxwSpI0v1ZhSEUdKvav2T1WDU4NSRaU6WcqwWZJrhtMBpc7QSXgOjGUYdTvP6GEUdJSgOkYLcTdKeGGdqS35p41D7pLvT+NybvoA/POJTD8x3b7psMh5BC4NRqRtD3KjGdcKqQcTU1Wo1kJKnYpEgS0RTEoBkIIinTCUpDanoM9S6dkQk1UGOUqYgSzGZfsxUoiUPRkwCM5AoC4jpW5G+tcVCqzN97fSG9jeeeNnUv96V9YOX415DwNlnn23X/eA5D5k06w7p0FJVsYIVsZkmNUFANYVMRDJrkCqWEkKMqmW0Jgyzhu2p0ZiwErNk+uUAn3paxuFgmAb9EIZYE6w3kjx+mNg9DK19oZM3vSsmQzvPY7fZLQ92Ve/cL5w7/GVYAfa/8F+49+N/A15aDc0sAre5AAAAAElFTkSuQmCC" %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGallery: {{ current_folder_info.display_name }}</title>
    <link rel="icon" type="image/png" href="{{ app_logo_b64 }}">
        
<style>
        :root {
            --bg-color: #0a0a0a;
            --surface-color: #1a1a1a;
            --surface-hover: #252525;
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --text-color: #f8f9fa;
            --text-muted: #adb5bd;
            --border-color: #343a40;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --favorite-color: #ffc107;
            --workflow-color: #28a745;
            --success-color: #20c997;
            
            /* AI Colors */
            --ai-color: #ff00ff; /* Fuxia */
            --ai-gradient: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%);
            --ai-surface: rgba(255, 0, 255, 0.1);
            
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.3);
            --sidebar-width: 360px;
        }

        * {
            box-sizing: border-box;
        }
        /* --- GLOBAL SCROLLBAR STYLING (Dark & Glass) --- */
        
        /* Firefox Configuration */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.15) transparent;
        }

        /* Chrome, Edge, Safari Configuration */
        ::-webkit-scrollbar {
            width: 8px;  /* Vertical scrollbar width */
            height: 8px; /* Horizontal scrollbar height */
        }

        /* Track (Background) - Transparent/Invisible */
        ::-webkit-scrollbar-track {
            background: transparent; 
            margin: 4px 0; /* Safe margin at the ends */
        }

        /* Thumb (The moving handle) */
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.15); /* Subtle translucent white */
            border-radius: 20px; /* Fully rounded capsule */
            border: 2px solid transparent; /* Trick to create padding/spacing around the thumb */
            background-clip: content-box;
        }

        /* Thumb Hover State */
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.3); /* Brighter and more visible on interaction */
        }

        /* Corner (Intersection between vertical and horizontal) */
        ::-webkit-scrollbar-corner {
            background: transparent;
        }
        
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
            margin: 0;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        body.lightbox-open,
        body.modal-open {
            overflow: hidden;
        }

        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .notification {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border-left: 5px solid var(--primary-color);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-weight: 600;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success-color);
            color: white;
            border-color: #1a9c77;
        }

        .notification.error {
            background-color: var(--danger-color);
            color: white;
            border-color: #b32a38;
        }

        .notification.warning {
            background-color: var(--favorite-color);
            color: #000;
            border-color: #d39e00;
        }

        .notification.info {
            background-color: var(--primary-color);
            color: white;
            border-color: #0056b3;
        }
        
        .notification.path-msg {
            word-break: break-all !important;  
            white-space: pre-wrap !important;  
            text-align: left !important;       
            font-family: monospace;            
            font-size: 0.85rem;                
            line-height: 1.4;
            max-width: 95vw;                   
        }
        .notification.multiline-msg {
            white-space: pre-wrap !important; /* Forces the \n character to break line */
            text-align: left !important;      /* Aligns multiple lines to the left */
        }
        
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: sticky;
            top: 0;
            transition: min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        body.sidebar-expanded .sidebar {
            min-width: 600px;
        }

        .main-content {
            flex-grow: 1;
            padding-bottom: 80px;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

/* ### inizio */
/* ========================================= */
/* === SIDEBAR HEADER (WRAPPER STRATEGY) === */
/* ========================================= */

.sidebar-header {
    display: flex;
    align-items: center;
    /* ABSOLUTE START: Everything starts from the left */
    justify-content: flex-start !important; 
    width: 100%;
    margin-bottom: 1.5rem;
    flex-shrink: 0;
    padding: 0 4px;
    box-sizing: border-box;
    min-height: 44px;
    /* Allow text to overflow if needed, no more dots/truncation */
    overflow: visible; 
}

/* --- LEFT BLOCK (LOGO + TEXTS) --- */
.brand-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    
    /* DIMENSIONS BLOCK */
    flex-grow: 0 !important;
    flex-shrink: 0 !important;
    /* Width: content only. No extra pixels. */
    width: fit-content !important; 
    max-width: 80%; /* Mobile safety */
    
    /* SPACING */
    gap: 10px !important;
    margin-right: 0 !important; /* No push from here */
}



.brand-logo {
    width: 38px;
    height: 38px;
    min-width: 38px !important;
    object-fit: contain;
    flex-shrink: 0;
    
    background-color: #ffcccc;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
    margin: 0 !important;
}

.brand-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start !important; /* Text aligned to the left */
    text-align: left !important;
    
    line-height: 1.1;
    /* REMOVED OVERFLOW HIDDEN: No more truncation dots */
    overflow: visible !important; 
    white-space: nowrap;
    margin: 0 !important;
}
.brand-link h1 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    font-family: system-ui, -apple-system, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
    letter-spacing: -0.02em; /* Tracking modern */
    white-space: nowrap;
    overflow: visible !important; 
    text-overflow: clip !important; 
    
    background: linear-gradient(135deg, #f0a0ff 0%, #9b30ff 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    
    /* Glow modern */
    filter: drop-shadow(0 0 8px rgba(155, 48, 255, 0.4))
            drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    
    margin-bottom: 2px !important;
}
.version-row-header {
    display: flex;
    align-items: center;
    justify-content: flex-start !important;
    gap: 8px; 
    margin: 0 !important;
    width: 100%;
}

.v-num {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5); 
    font-family: monospace;
    font-weight: 500;
    line-height: 1;
}

.header-update-badge {
    background: var(--primary-color);
    color: white !important;
    font-size: 0.6rem;
    padding: 2px 6px;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
    animation: pulse-update 2s infinite;
    display: inline-flex;
    align-items: center;
    line-height: 1;
}

/* --- RIGHT BLOCK (BUTTONS) - CRITICAL MODIFICATION BELOW --- */
.sidebar-actions {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
    
    /* THIS IS THE KEY: */
    /* Push this element all the way to the right. This keeps the logo on the left. */
    margin-left: auto !important; 
}

/* 1. Bring Update Badge closer to version number */
.version-row-header {
    gap: 4px !important; /* Was 8px, reduced to tighten spacing */
}

/* 2. Remove ghost margins from badge to stick it to the left */
.header-update-badge {
    margin-left: 0 !important;
}

/* 3. Force text closer to the logo (eliminating dead space) */
.brand-link {
    gap: 4px !important; /* Reduced gap between logo and title */
}

.brand-logo {
    margin-right: 5px !important; /* Fixed space to the right of the logo */
}


        #sidebar-minify-btn, #sidebar-expand-btn {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted);
            padding: 0; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        #sidebar-minify-btn:hover, #sidebar-expand-btn:hover {
            background: var(--surface-hover); color: white; border-color: var(--text-muted);
        }

        /* --- MOBILE FOLDERS BUTTON --- */
        #sidebar-toggle-btn {
            display: none; 
            background: rgba(255, 255, 255, 0.08); 
            border: 1px solid var(--glass-border);
            color: var(--text-color); 
            
            /* Increased dimensions for better mobile touch target */
            padding: 0 10px; 
            height: 40px; 
            border-radius: 10px;
            font-size: 0.95rem; 
            
            font-weight: 600; 
            cursor: pointer; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        /* Slightly larger icon to match the new button size */
        #sidebar-toggle-btn svg { 
            flex-shrink: 0; 
            stroke: var(--favorite-color) !important; 
            width: 20px; 
            height: 20px; 
        }

        @media (max-width: 1024px) {
            #sidebar-minify-btn, #sidebar-expand-btn { display: none !important; }
            #sidebar-toggle-btn { display: flex !important; }
            .brand-link h1 { font-size: 1.3rem; }
            .brand-logo { width: 34px; height: 34px; }
        }

        /* MINIMIZED STATE */
        body.sidebar-minimized .brand-info { display: none !important; }
        body.sidebar-minimized .sidebar-header { flex-direction: column; gap: 10px; margin-bottom: 0; }
        
        /* Quando minimizzato, togliamo il margine auto per centrare il logo */
        body.sidebar-minimized .brand-link { margin-right: 0 !important; justify-content: center; gap: 0 !important; width: 100% !important; }
        
        body.sidebar-minimized .brand-logo { margin: 0 !important; width: 30px; height: 30px; }
        body.sidebar-minimized .sidebar-actions { flex-direction: column; width: 100%; }
        body.sidebar-minimized #sidebar-expand-btn { display: none !important; }
        body.sidebar-minimized #sidebar-minify-btn { width: 100%; border: none; }
/* ########## fine */
        .folder-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .folder-search-input {
            width: 100%;
            background: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }

        .folder-sort-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .folder-sort-buttons button {
            flex-grow: 1;
            background: var(--surface-hover);
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .folder-sort-buttons button.active {
            background: rgba(0, 123, 255, 0.15) !important;
            border-color: var(--primary-color) !important;
            color: white !important;
        }
        .folder-sort-buttons button:hover {
            background: var(--surface-hover);
            border-color: var(--text-muted);
        }

        .sidebar-actions {
            display: flex;
            gap: 5px; 
            align-items: center;
            flex-shrink: 0; 
            margin-left: 5px;
        }

        .sidebar-actions button {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .folder-tree-container {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .folder-tree,
        .folder-tree ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .folder-tree li {
            padding-left: 20px;
            position: relative;
        }

        .folder-tree>li:first-child {
            padding-left: 0;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            position: relative;
        }

        .folder-item:hover {
            background-color: var(--surface-hover);
        }

        .folder-item.active {
            background: rgba(0, 123, 255, 0.15) !important; /* Low opacity blue */
            border: 1px solid var(--primary-color) !important;
            color: #ffffff !important;
            font-weight: 600;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.1); /* Subtle glow */
        }

        .toggle-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            user-select: none;
        }

        .toggle-btn.empty {
            visibility: hidden;
        }

        .folder-link {
            flex-grow: 1;
            text-decoration: none;
            color: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 25px;
            cursor: pointer;
        }

        .folder-actions {
            margin-left: auto;
            display: flex;
            opacity: 1;
        }

        .folder-action-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .folder-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .folder-tree li.collapsed>ul {
            display: none;
        }

        .folder-tree li.is-hidden {
            display: none;
        }

        .folder-tree li:not(.collapsed)>.folder-item>.toggle-btn::before {
            content: '▾';
        }

        .folder-tree li.collapsed>.folder-item>.toggle-btn::before {
            content: '▸';
        }

        .folder-tree li.no-children>.folder-item>.toggle-btn {
            visibility: hidden;
        }

        /* --- CREATE FOLDER BUTTON (Redesigned: Glass Style) --- */
        #create-folder-btn {
            width: 100%;
            /* Base State: Glass / Transparent */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            
            /* Typography & Layout */
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Flex for centering icon and text */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            
            margin-top: 1rem;
            flex-shrink: 0;
        }

        /* Hover State: Standard Blue (Consistent with File Operations) */
        #create-folder-btn:hover {
            background: rgba(0, 123, 255, 0.15); /* Light Blue Tint */
            border-color: var(--primary-color);   /* Blue Border */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Active/Click State */
        #create-folder-btn:active {
            transform: translateY(0);
            background: rgba(0, 123, 255, 0.25);
        }
        
        /* --- MOUNT BUTTON (Unified Style) --- */
        #mount-folder-btn {
            width: 100%;
            /* Base Style: Identical to Create Folder (Glass) */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 0.5rem; /* Gap from create button */
            flex-shrink: 0;
        }
        
        /* Hover: Green Tint to distinguish functionality */
        #mount-folder-btn:hover {
            background: rgba(40, 167, 69, 0.15);
            border-color: var(--workflow-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        
        /* Mobile/Sidebar Hide Logic */
        .sidebar.nav-collapsed #mount-folder-btn { display: none; }
        body.sidebar-minimized .sidebar #mount-folder-btn { display: none !important; }
        
        /* --- MOUNT MODAL & BROWSER STYLES --- */
        
        /* Info Box - Increased Font */
        .mount-info-box {
            background: rgba(0, 123, 255, 0.1);
            border-left: 3px solid var(--primary-color);
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 0.95rem; /* Bigger font */
            color: #ddd;
            line-height: 1.5;
            text-align: left;
        }
        .mount-info-box strong { color: white; }
        .mount-info-box code { 
            background: rgba(0,0,0,0.3); 
            padding: 2px 5px; 
            border-radius: 4px; 
            font-family: monospace; 
            color: var(--favorite-color);
        }

        /* Filesystem Browser Container */
        .fs-browser-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            height: 250px; /* Default height for Desktop */
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        /* Browser Header */
        .fs-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        /* Path Display */
        .fs-path-display {
            flex-grow: 1;
            font-family: monospace;
            font-size: 0.95rem; /* Bigger font */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--primary-color);
            direction: rtl; /* Show end of long paths */
            text-align: left;
        }

        /* List Area */
        .fs-list {
            flex-grow: 1;
            overflow-y: auto;
            list-style: none;
            padding: 5px;
            margin: 0;
        }

        /* List Items */
        .fs-item {
            padding: 10px 12px; /* Taller touch targets */
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.1s;
            font-size: 1rem; /* Much readable font */
            color: var(--text-color);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .fs-item:last-child { border-bottom: none; }

        .fs-item:hover { background: var(--surface-hover); }
        
        .fs-item.is-selected {
            background: rgba(0, 123, 255, 0.2);
            color: white;
            font-weight: bold;
        }

        .fs-icon { color: var(--favorite-color); font-size: 1.2rem; }
        .fs-drive-icon { color: var(--ai-color); font-size: 1.2rem; }
        
        /* --- MOBILE LAYOUT OVERRIDES (Mount Modal Fix) --- */
        @media (max-width: 768px) {
            #mount-folder-overlay {
                align-items: flex-start !important;
                padding-top: 5px !important; 
            }
            
            #mount-folder-overlay .smart-dialog-panel {
                /* Let it scroll if screen is small */
                max-height: 98vh; 
                overflow-y: auto; 
                display: block; /* Changed from flex to block to fix overflow issues */
                
                /* HUGE bottom padding to ensure buttons are inside the background */
                padding: 15px 15px 100px 15px !important; 
                
                border-radius: 0 0 16px 16px;
            }

            /* Header adjustments */
            .smart-dialog-panel h3 {
                font-size: 1.1rem;
                margin-bottom: 5px !important; 
                margin-top: 5px !important;
            }
            
            /* Info Box */
            .mount-info-box {
                margin-top: 0 !important;
                margin-bottom: 10px !important;
                font-size: 0.95rem !important;
                line-height: 1.3 !important;
                padding: 10px !important;
            }
            
            /* Browser List height */
            .fs-browser-container {
                height: auto !important; 
                min-height: 200px !important; 
                max-height: 35vh !important;
                margin-bottom: 15px;
            }

            /* Push the bottom boundary further down explicitly */
            .sd-actions {
                margin-bottom: 20px !important;
                padding-bottom: 10px !important;
            }
        }
        
        .breadcrumbs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .breadcrumb-links {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            overflow: hidden;
            flex-grow: 1;
        }

        .breadcrumb-links a,
        .breadcrumb-links span {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            white-space: nowrap;
        }

        .breadcrumb-links a:hover {
            color: var(--text-color);
        }

        .breadcrumb-links span:last-child {
            color: var(--text-color);
            font-weight: 700;
            text-overflow: ellipsis;
            overflow: hidden;
        }
/* COPIATO DA QUI */
        .gallery-sort-controls {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .gallery-sort-controls .sort-btn {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            background: var(--surface-hover);
            color: var(--text-color);
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .gallery-sort-controls .sort-btn:hover {
            background: var(--surface-color);
        }

        .gallery-sort-controls .sort-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* --- INFO BADGE (Refined: Active Blue Glass Style) --- */
        .file-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            
            /* Matches the .folder-sort-buttons button.active style */
            background: rgba(0, 123, 255, 0.15) !important;
            border: 1px solid var(--primary-color) !important;
            color: white !important;
            
            /* Glass blur effect for depth */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            
            padding: 4px 14px;
            border-radius: 50px; 
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            
            /* Non-interactive state */
            cursor: default; 
            user-select: none;
            white-space: nowrap;
            
            /* Subtle depth styling */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); 
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Mobile specific positioning for the badge and conditional filter button */
        .mobile-meta-row {
            display: none; /* Hidden on desktop */
            width: 100%;
            margin-bottom: 12px;
            padding-left: 2px;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Aligns content to the left */
            gap: 10px; /* Space between button and badge */
        }
        
        @media (max-width: 768px) {
            .mobile-meta-row { display: flex; }
            
            /* If the filter button is inside meta-row, make it more compact */
            .mobile-meta-row .filter-main-btn {
                flex-grow: 1; /* Allows the button to take available space */
                max-width: 200px; /* Prevents it from being too wide */
            }
        }

        .filter-bar {
            padding: 1.5rem 2rem;
        }

        .filter-bar form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* NEW DESKTOP SEARCH PANEL STYLES */
        .search-overlay-panel {
            display: none;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.3s ease-out;
            position: relative;
            z-index: 900;
            
            max-width: calc(100% - 4rem) !important; /* Ensures it stays within main-content padding */
            box-sizing: border-box !important;
            overflow-x: hidden !important; /* Prevents horizontal scroll of the panel itself */
        }

        .search-overlay-panel.visible {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-form-grid {
            display: grid;
            /* Adaptive columns: they will shrink and wrap automatically */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 1.5rem;
            align-items: start;
            width: 100% !important;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        /* SEARCH SCOPE STYLES */
        .search-scope-wrapper {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.5rem;
        }
        
        .scope-options {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        /* --- SCOPE SELECTOR VISUALS --- */
        .scope-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px; /* Slightly larger for touch */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s ease;
            flex: 1; /* Distribute space evenly */
            justify-content: center;
        }

        .scope-label:hover {
            background: var(--surface-hover);
            color: var(--text-color);
        }

        .scope-label.active {
            border-color: var(--primary-color);
            background: rgba(0, 123, 255, 0.2); /* Stronger visible color */
            color: white;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }
                
        .scope-label input[type="radio"] {
            margin: 0;
            accent-color: var(--primary-color);
        }

        /* --- MODERN FILTER PANEL INTERIORS --- */

        /* 1. Labels */
        .filter-group label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 8px;
            display: block;
        }

        /* 2. Text & Date Inputs (Glass Style) */
        .filter-group input[type="text"],
        .filter-group input[type="date"] {
            width: 100%;
            background: rgba(0, 0, 0, 0.2); /* Darker than global glass for contrast */
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 0 12px;
            height: 42px; /* Fixed height matches buttons */
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            color-scheme: dark; /* Forces dark calendar picker */
        }

        .filter-group input[type="text"]:focus,
        .filter-group input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* 3. Scope Selectors (Segmented Control Look) */
        .scope-options {
            display: flex;
            background: rgba(0,0,0,0.3);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            gap: 5px;
        }

        .scope-label {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Hide default radio circle */
        .scope-label input[type="radio"] {
            display: none; 
        }

        /* Active State for Scope */
        .scope-label.active {
            background: var(--surface-hover);
            color: white;
            border-color: var(--glass-border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Special style for Global active */
        .scope-label.active {
             background: rgba(0, 123, 255, 0.15);
             border-color: var(--primary-color);
             color: var(--primary-color);
             box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
             font-weight: bold;
        }

        /* 4. Recursive Toggle (Chip Style) */
        .recursive-wrapper {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .recursive-wrapper:hover { background: rgba(255, 255, 255, 0.08); }
        
        .recursive-wrapper.active {
            background: rgba(0, 123, 255, 0.15);
            border-color: var(--primary-color);
        }
        
        .recursive-wrapper.active .recursive-label {
            color: white;
            font-weight: bold;
        }
        
        .recursive-wrapper.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        /* 5. Checkboxes (Options Group) */
        .filter-group-inline {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.03);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-group-inline:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--glass-border);
        }

        /* Custom Checkbox Size */
        .filter-group-inline input[type="checkbox"] {
            width: 18px; 
            height: 18px;
            margin-right: 10px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }
        
        .filter-group-inline label {
            margin: 0; /* Reset default label margin */
            font-size: 0.9rem;
            color: var(--text-color);
            text-transform: none; /* Normal case for options */
            cursor: pointer;
            font-weight: 500;
        }
        
        /* --- ACTION BUTTONS (Apply/Reset) DYNAMIC LAYOUT --- */
        .filter-actions-row {
            display: flex !important;
            flex-direction: row !important; /* Always row on desktop */
            justify-content: flex-end !important; /* Align buttons to the right on desktop */
            gap: 12px !important;
            margin-top: 20px !important;
            padding-top: 20px !important;
            border-top: 1px solid var(--glass-border) !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }


        .filter-actions-row .glass-btn {
            flex: 0 1 auto !important;    /* Buttons take only the space they need */
            min-width: 140px !important;  /* Minimum width to keep them clickable */
            height: 42px !important;      /* Matches the top toolbar height exactly */
            min-height: 42px !important;
            border-radius: 10px !important;
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            padding: 0 20px !important;
            margin: 0 !important;
            text-transform: none !important;
            box-shadow: var(--shadow-sm) !important;
        }

        /* Adjustment for the "Actions" group to take more space if needed */
        .filter-group:last-child {
            grid-column: 1 / -1; /* Makes the Actions row take the full width of the grid */
            width: 100% !important;
        }
        
        /* Red Reset Button Style */
        .filter-actions-row .btn-reset {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid var(--danger-color) !important;
            color: var(--danger-color) !important;
        }
        .filter-actions-row .btn-reset:hover {
            background: var(--danger-color) !important;
            color: white !important;
            transform: translateY(-1px);
        }

        /* Blue Submit Button Style */
         .filter-actions-row button[type="submit"] {
            background: var(--primary-color) !important; /* Solid but themed */
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }
        .filter-actions-row button[type="submit"]:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        
        /* Styling for the new Desktop Toggle Button */
        #search-toggle-desktop {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        #search-toggle-desktop:hover {
            background: var(--surface-hover);
        }
        
        #search-toggle-desktop.active-filters {
            background: rgba(0, 123, 255, 0.15);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 10px rgba(0,123,255,0.2);
        }

        .mobile-actions-row {
            display: flex;
            gap: 0.75rem;
        }

        .mobile-actions-row>* {
            flex-grow: 1;
            text-align: center;
            justify-content: center;
        }

        .mobile-actions-row button {
            padding-left: 0.8rem;
            padding-right: 0.8rem;
        }

        /* --- CUSTOM MULTI-SELECT DROPDOWN (No External Libs) --- */
        /* --- CUSTOM MULTI-SELECT DROPDOWN (Responsive: Floating Desktop / Push-down Mobile) --- */
        .c-multi-select {
            position: relative;
            width: 100%;
        }

        .c-select-trigger {
            width: 100%;
            background: var(--glass-bg);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            white-space: nowrap;
            overflow: hidden;
        }

        .c-select-trigger:hover {
            border-color: var(--primary-color);
            background: var(--surface-hover);
        }

        .c-select-trigger::after {
            content: '▼';
            font-size: 0.7rem;
            margin-left: 10px;
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }

        /* Rotate arrow when open */
        .c-multi-select.open .c-select-trigger::after {
            transform: rotate(180deg);
            color: var(--primary-color);
        }

        .c-dropdown-menu {
            /* DESKTOP DEFAULT: Absolute (Floating over content) */
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 1000; /* High Z-Index to float above other inputs on desktop */
            margin-top: 5px;
            box-shadow: var(--shadow-lg);
            display: none;
            flex-direction: column;
            padding: 5px;
        }

        /* --- MOBILE SPECIFIC: Accordion Style (Push content down) --- */
        @media (max-width: 768px) {
            .c-dropdown-menu {
                position: relative; /* Not floating anymore */
                top: 0;
                z-index: 1; /* Normal flow */
                box-shadow: none; /* Flat look */
                background: rgba(0, 0, 0, 0.2); /* Slightly darker bg to distinguish area */
                border: 1px solid var(--glass-border);
                border-top: none; /* Connect visually to trigger */
                margin-top: 0;
                border-radius: 0 0 8px 8px; /* Rounded bottom only */
            }
            
            /* Remove bottom radius from trigger when open on mobile to look connected */
            .c-multi-select.open .c-select-trigger {
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                border-bottom-color: transparent; 
            }
        }

        .c-dropdown-menu.show {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .c-option-label {
            display: flex;
            align-items: center;
            padding: 10px 12px; /* Larger touch target for mobile */
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            color: var(--text-color);
            font-size: 0.9rem;
            user-select: none;
            border-bottom: 1px solid rgba(255,255,255,0.05); /* Separator lines */
        }
        .c-option-label:last-child { border-bottom: none; }

        .c-option-label:hover {
            background: var(--surface-hover);
        }

        .c-option-label input[type="checkbox"] {
            margin-right: 12px;
            width: 18px; /* Bigger checkbox for touch */
            height: 18px;
            accent-color: var(--primary-color);
        }
        
        .c-select-counter {
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            margin-left: 8px;
            display: none;
        }
        .c-select-counter.visible {
            display: inline-block;
        }
        
        .c-option-label {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            color: var(--text-color);
            font-size: 0.9rem;
            user-select: none;
        }

        .c-option-label:hover {
            background: var(--surface-hover);
        }

        .c-option-label input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }
        
        .c-select-counter {
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            margin-left: 8px;
            display: none;
        }
        .c-select-counter.visible {
            display: inline-block;
        }

        #gallery-anchor {
            display: block;
            position: relative;
            top: -20px;
            visibility: hidden;
        }

        /* Modified: .ai-banner removed from here as it is fully redefined later. Keeping global-search-banner */
        .global-search-banner {
            background: var(--ai-surface);
            border-bottom: 1px solid var(--ai-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--ai-color);
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.2);
            animation: glow 2s infinite alternate;
        }
        
        .global-search-banner {
            background: rgba(0, 123, 255, 0.1); /* Blue for Standard */
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
            animation: glowBlue 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(255, 0, 255, 0.1); }
            to { box-shadow: 0 0 15px rgba(255, 0, 255, 0.4); }
        }
        
        @keyframes glowBlue {
            from { box-shadow: 0 0 5px rgba(0, 123, 255, 0.1); }
            to { box-shadow: 0 0 15px rgba(0, 123, 255, 0.4); }
        }

        /* Deleted: .ai-banner-title - Overwritten by "STILI AI BANNER" block later */
        
        /* --- RECURSIVE SEARCH TOGGLE STYLE --- */
        .recursive-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.2s;
            width: fit-content;
        }

        .recursive-wrapper:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .recursive-wrapper input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .recursive-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
            user-select: none;
            cursor: pointer;
        }

        .recursive-wrapper.active {
            border-color: var(--primary-color);
            background: rgba(0, 123, 255, 0.1);
        }

        .recursive-wrapper.active .recursive-label {
            color: white;
        }
        
        /* --- RECURSIVE UI ENHANCEMENT --- */
        .recursive-wrapper.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none; /* Prevents clicks when scope is Global */
            filter: grayscale(1);
        }
        
        /* New Styles for AI Options and Lightbox */
        .ai-search-options-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        

            /* hide native arrows (Chrome, Safari, Edge, Opera) */
            input[type=number]::-webkit-outer-spin-button,
            input[type=number]::-webkit-inner-spin-button {
              -webkit-appearance: none;
              margin: 0;
            }
            /* hide native arrows (Firefox) */
            input[type=number] {
              -moz-appearance: textfield;
            }

            .ai-limit-container {
                display: flex;
                align-items: center;
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: 8px;
                overflow: hidden; /* Mantiene i bordi arrotondati */
                height: 36px; /* Altezza fissa per coerenza */
            }

            .ai-limit-btn {
                background: transparent;
                border: none;
                color: var(--ai-color);
                font-size: 1.2rem;
                font-weight: bold;
                width: 30px;
                height: 100%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            }

            .ai-limit-btn:hover {
                background: rgba(255, 0, 255, 0.2);
                color: white;
            }

            .ai-limit-input {
                background: transparent;
                border: none;
                border-left: 1px solid var(--glass-border);
                border-right: 1px solid var(--glass-border);
                color: white;
                width: 50px;
                height: 100%;
                font-size: 1rem;
                text-align: center;
                font-weight: bold;
                outline: none;
            }

            .ai-limit-input:focus {
                background: rgba(255, 255, 255, 0.05);
            }

        .ai-banner-actions button {
            background: transparent;
            border: 1px solid var(--ai-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .global-search-banner .ai-banner-actions button {
            border-color: var(--primary-color);
        }
        .global-search-banner .ai-banner-actions button:hover {
            background: var(--primary-color);
        }

        .ai-banner-actions button:hover {
            background: var(--ai-color);
        }

        .gallery-container {
            display: grid;
            /* Use variable with 320px fallback */
            grid-template-columns: repeat(auto-fill, minmax(var(--grid-item-size, 320px), 1fr));
            gap: 2rem;
            padding: 2rem;
            min-height: 50vh;
        }

        .gallery-item {
            background: var(--glass-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .gallery-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }

        .gallery-item.focused {
            outline: 4px solid var(--text-color)!important;
            outline-offset: 4px!important;
        }

        /* Disable selection in Global AI Mode */
        
        .selection-checkmark {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--text-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 11;
            transition: all 0.3s;
            color: transparent;
            cursor: pointer;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .gallery-item.selected .selection-checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .thumbnail-link {
            cursor: pointer;
        }

        .thumbnail-wrapper {
            position: relative;
            width: 100%;
            background: var(--surface-color);
            overflow: hidden;
        }

        .thumbnail-wrapper img,
        .thumbnail-wrapper video {
            display: block;
            width: 100%;
            height: auto;
            transition: transform 0.3s;
        }

        .gallery-item:hover .thumbnail-wrapper img,
        .gallery-item:hover .thumbnail-wrapper video {
            transform: scale(1.05);
        }

        .item-info {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: 48px;
        }

        .item-info p {
            margin: 0;
            word-wrap: break-word;
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .file-metadata {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.25rem 0.75rem;
        }

        .file-metadata span {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* --- GALLERY ITEM ACTIONS (Refined: Ghost/Glass Style) --- */
        
        .item-actions a,
        .item-actions button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            
            /* Base State: Transparent/Dark Glass */
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: var(--text-muted); /* Grey icon by default */
            
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem; /* Slightly bigger icons */
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
        }

        /* Hover: Light up background */
        .item-actions a:hover,
        .item-actions button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Specific: Delete Button (Red only on Hover) */
        .item-actions .delete-btn {
            /* Reset old solid styles */
            background: rgba(255, 255, 255, 0.03); 
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .item-actions .delete-btn:hover {
            background: var(--danger-color) !important;
            border-color: var(--danger-color) !important;
            color: white !important;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }

        /* Specific: Favorite Button (Gold when active) */
        .favorite-btn.favorited {
            color: var(--favorite-color); /* Gold Icon */
            border-color: var(--favorite-color);
            background: rgba(255, 193, 7, 0.1); /* Subtle Gold Tint */
        }
        @media (hover: hover) {
            .favorite-btn:hover {
                color: var(--favorite-color) !important;
                border-color: var(--favorite-color) !important;
                background: rgba(255, 193, 7, 0.1);
            }
        }

        .duration-overlay {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .workflow-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--workflow-color);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            text-decoration: none;
            font-weight: 600;
        }
        
        .ai-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--ai-color);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10;
            text-transform: uppercase;
        }


        #drag-drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1002;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }

        #drag-drop-overlay.visible {
            display: block;
            opacity: 1;
        }

        #drop-zone-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            z-index: 1003;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: none;
            flex-direction: column;
            max-height: 80vh;
        }

        #drop-zone-panel.visible {
            display: flex;
        }

        #drop-zone-panel h3 {
            margin: 0;
            padding: 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            flex-shrink: 0;
        }

        #drop-zone-folders {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 0;
            min-height: 0;
            flex-grow: 1;
        }

        #cancel-drop-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 1rem;
            cursor: pointer;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }

        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s;
        }

        .loader {
            border: 4px solid var(--surface-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        #lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #lightbox-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 2001;
        }

        #lightbox-prev {
            left: 30px;
        }

        #lightbox-next {
            right: 30px;
        }

        #lightbox-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2002;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.4) 70%, transparent 100%);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            text-align: center;
        }

        #lightbox-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            word-break: break-word;
            hyphens: auto;
            max-width: 90vw;
        }
        
        #lightbox-folder-name {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-top: 0.2rem;
            font-weight: 600;
            opacity: 0.9;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        #lightbox-toolbar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        #lightbox-toolbar button,
        #lightbox-toolbar a {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            height: 44px;
            backdrop-filter: blur(10px);
        }

        #lightbox-toolbar button:hover,
        #lightbox-toolbar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* AI Caption Icon in Lightbox */
        #lightbox-caption-icon {
            color: var(--ai-color);
            border-color: var(--ai-color);
        }

        #lightbox-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 6rem 1rem 6rem; /* Added bottom padding for caption */
        }

        #lightbox-media {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 95vw;
            max-height: 80vh;
        }

        #lightbox-media img,
        #lightbox-media video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            cursor: grab;
        }
        
        #lightbox-ai-caption {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 700px;
            max-height: 40vh; /* Altezza massima */
            
            /* Layout Flex per gestire header fisso e content scrollabile */
            display: none; 
            flex-direction: column;
            overflow: hidden; /* Il contenitore NON scrolla */
            
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid var(--ai-color);
            border-radius: 12px;
            /* Padding ridotto sul container, spostato nel contenuto */
            padding: 10px; 
            
            z-index: 2020;
            color: #eee;
            font-size: 1rem;
            line-height: 1.5;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
        }
        
        #lightbox-ai-caption.visible {
            display: flex; /* Importante: flex per il layout */
            animation: slideUpCaption 0.3s ease-out;
        }

        /* Nuovo contenitore per il testo che scrolla */
        #lightbox-ai-text-scroll {
            overflow-y: auto; /* Solo questo div scrolla */
            flex-grow: 1;
            padding: 10px 15px; /* Padding interno per il testo */
            margin-top: 5px;
            padding-right: 5px; /* Spazio per scrollbar */
        }

        /* Stile scrollbar interno */
        #lightbox-ai-text-scroll::-webkit-scrollbar {
            width: 6px;
        }
        #lightbox-ai-text-scroll::-webkit-scrollbar-thumb {
            background-color: var(--ai-color);
            border-radius: 3px;
        }

        @keyframes slideUpCaption {
            from { transform: translate(-50%, 50px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        .caption-close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(10, 10, 10, 0.5); /* Sfondo leggero per leggibilità sopra testo */
            border-radius: 50%;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10; /* Sempre sopra */
        }
        
        .caption-close-btn:hover {
            color: var(--danger-color);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* --- PREMIUM GO TO TOP BUTTON (Fixed Contrast & Mobile) --- */
        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 40px;
            right: 30px;
            z-index: 1900;
            
            /* Sfera Base: Più scura e opaca per contrasto su immagini chiare */
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(10, 10, 10, 0.9); /* Quasi nero, molto leggibile */
            border: 1px solid rgba(255, 255, 255, 0.15); /* Bordo per stacco su sfondo scuro */
            color: var(--primary-color); /* Freccia Blu */
            
            /* Effetti Vetro */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            
            /* Ombra profonda per stacco su sfondo chiaro */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            /* No tap highlight su mobile */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- DESKTOP HOVER ONLY --- */
        /* Questo blocco si attiva SOLO se hai un mouse. 
           Su mobile viene ignorato, risolvendo il problema del "blu bloccato". */
        @media (hover: hover) {
            #backToTopBtn:hover {
                background: var(--primary-color); /* Diventa Blu */
                border-color: var(--primary-color);
                color: white; /* Freccia Bianca */
                transform: translateY(-5px) scale(1.1);
                box-shadow: 0 10px 25px rgba(0, 123, 255, 0.5); /* Bagliore Blu */
            }
        }

        /* --- ACTIVE STATE (Click/Tap) --- */
        /* Feedback tattile per mobile e desktop al click */
        #backToTopBtn:active {
            transform: scale(0.9);
            background: rgba(30, 30, 30, 1); /* Leggermente più chiaro al tocco */
        }

        /* Mobile Positioning Override */
        @media (max-width: 768px) {
            #backToTopBtn {
                bottom: 25px;
                right: 20px;
                width: 45px;
                height: 45px;
            }
        }
        
        /* --- STYLISH LOAD MORE BUTTON --- */
        /* --- STYLISH LOAD MORE BUTTON (Robust Centering) --- */
        #load-more-container {
            /* Supporta sia Flex che Block (se JS lo cambia) */
            display: flex; 
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important; /* Fallback se diventa display:block */
            
            width: 100% !important;
            padding: 2rem 20px 8rem 20px !important;
            box-sizing: border-box !important;
            margin: 0 auto !important;
            clear: both;
        }

        #load-more-btn {
            /* Glass Base */
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-muted);
            /* Shape & Size */
            padding: 12px 40px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto !important; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            white-space: nowrap; 
            max-width: 100%;
        }
        /* Hover Effect */
        #load-more-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(0, 123, 255, 0.2);
        }
        /* Active/Loading Effect */
        #load-more-btn:active,
        #load-more-btn:disabled {
            transform: scale(0.98);
            background: rgba(0, 0, 0, 0.2);
            border-color: transparent;
            color: var(--text-muted);
            box-shadow: none;
            cursor: wait;
        }
        /* Arrow Animation on Hover */
        #load-more-btn .arrow-icon {
            transition: transform 0.3s ease;
        }
        #load-more-btn:hover .arrow-icon {
            transform: translateY(3px);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        #node-summary-overlay,
        #upload-overlay,
        #sync-overlay,
        #ai-search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #node-summary-overlay {
            z-index: 2100;
        }

        #upload-overlay {
            z-index: 2200;
        }
        
        #ai-search-overlay {
            z-index: 2250;
        }

        #sync-overlay {
            z-index: 2300;
            display: none;
            opacity: 1;
            pointer-events: all;
        }

        #node-summary-overlay.visible,
        #upload-overlay.visible,
        #ai-search-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .node-summary-panel,
        #upload-panel,
        #sync-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 90vw;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* AI Modal Styles */
        .ai-modal-panel {
            background: var(--surface-color);
            border: 1px solid var(--ai-color);
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.2);
            width: 90vw;
            max-width: 500px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: scale(0.95);
            transition: transform 0.3s;
            position: relative;
        }
        
        #ai-search-overlay.visible .ai-modal-panel {
            transform: scale(1);
        }
        
        .ai-modal-header {
            text-align: center;
            color: white;
        }
        
        .ai-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .ai-search-textarea {
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }
        
        .ai-search-textarea:focus {
            outline: none;
            border-color: var(--ai-color);
            box-shadow: 0 0 10px rgba(255,0,255,0.2);
        }
        
        .ai-scope-selector {
            display: flex;
            background: var(--glass-bg);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }
        
        .ai-scope-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.3s;
        }
        
        .ai-scope-option.active {
            background: var(--ai-color);
            color: white;
            font-weight: bold;
        }
        
        .ai-search-submit {
            background: var(--ai-gradient);
            border: none;
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(255,0,255,0.3);
        }
        
        .ai-search-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,0,255,0.5);
        }
        
        .ai-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .node-summary-panel {
            max-width: 900px;
            max-height: 85vh;
        }

        #upload-panel {
            max-width: 600px;
            max-height: 85vh;
        }

        #sync-panel {
            max-width: 500px;
            padding: 2rem;
            align-items: center;
            text-align: center;
        }

        #node-summary-overlay.visible .node-summary-panel,
        #upload-overlay.visible #upload-panel {
            transform: scale(1);
        }

        .node-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--surface-color);
        }

        .node-summary-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .node-summary-header .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        #node-summary-content {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .summary-node-item {
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .summary-node-header {
            color: white;
            padding: 0.75rem 1rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .summary-node-header small {
            opacity: 0.8;
            font-weight: normal;
            margin-left: 0.5rem;
        }

        .summary-node-params {
            list-style: none;
            margin: 0;
            padding: 1rem;
            background: var(--glass-bg);
        }

        .summary-node-params li {
            padding: 0.5rem 0;
            font-size: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .summary-node-params li:last-child {
            border-bottom: none;
        }

        .summary-node-params strong {
            color: var(--text-color);
            margin-right: 0.5rem;
        }

        .summary-node-params code {
            color: var(--text-muted);
            word-break: break-all;
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 5px;
            border-radius: 4px;
        }

        #refresh-btn {
            margin-left: auto;
        }

        .upload-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .upload-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .upload-header p {
            margin: 0.5rem 0 0;
            color: var(--text-muted);
        }

        .upload-body {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        #drop-zone.dragover {
            border-color: var(--primary-color);
            background: var(--surface-hover);
            transform: scale(1.02);
        }

        #drop-zone p {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0 0 1rem 0;
        }

        #file-upload-btn {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        #file-list {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        #file-list li {
            background: var(--glass-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .upload-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .upload-footer button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        #upload-cancel-btn {
            background: var(--surface-hover);
            color: var(--text-color);
        }

        #upload-submit-btn {
            background: var(--success-color);
            color: white;
        }

        #upload-progress-container {
            display: none;
            margin-top: 1rem;
        }

        #upload-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        #upload-progress-fill {
            width: 0%;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.2s;
        }

        #upload-file-input {
            display: none;
        }

        #sync-message {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        #sync-progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        #sync-progress-fill {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        #mobile-filter-toggle {
            display: none;
            width: 100%;
            background: var(--surface-hover);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: left;
        }

        .mobile-actions-only {
            display: none;
        }

        /* --- WHITESPACE PRESERVATION FIX --- */
        /* Sidebar Folders */
        .folder-link {
            white-space: pre-wrap !important;
            word-break: break-word;
        }
        /* Gallery Item Titles */
        .item-info p {
            white-space: pre-wrap !important;
            word-break: break-word;
        }
        /* Lightbox Title */
        #lightbox-title {
            white-space: pre-wrap !important;
            word-break: break-word;
        }
        /* Upload file list */
        #file-list li span:first-child {
            white-space: pre-wrap !important;
        }

        /* --- MODERN FLOATING SELECTION BAR --- */
        #selection-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            /* Default hidden state: Spostato giù e non scalato */
            transform: translateX(-50%) translateY(150%) scale(1);
            width: 90%;
            max-width: 600px;
            
            /* ... (tutto il resto delle proprietà estetiche background, border, ecc. lasciale uguali) ... */
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid var(--primary-color);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1001;
            
            /* MODIFICA: Aggiunto transform-origin per scalare dal basso/centro */
            transform-origin: bottom center; 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Active State: Usa la variabile --ui-zoom-scale calcolata via JS */
        #selection-bar.visible {
            transform: translateX(-50%) translateY(0) scale(var(--ui-zoom-scale, 1));
        }

        /* Left Side: Close & Counter */
        .sel-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #selection-counter {
            font-weight: 700;
            font-size: 0.95rem;
            color: #fff;
            margin: 0;
            padding: 0;
        }

        /* Right Side: Actions */
        .sel-bar-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Icon Buttons Style */
        .sel-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sel-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-2px);
        }

        .sel-btn.danger {
            color: #ff6b6b;
        }
        .sel-btn.danger:hover {
            background: var(--danger-color);
            color: white;
        }

        .sel-btn.close-x {
            border: 1px solid rgba(255,255,255,0.2);
            width: 32px;
            height: 32px;
            font-size: 1rem;
        }

        /* --- DROP-UP MENU ("More" Actions) --- */
        .sel-more-menu {
            position: absolute;
            bottom: 100%; /* Sits on top of the bar */
            right: 0;
            margin-bottom: 10px;
            width: 200px;
            background: #252525;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden;
            padding: 5px;
            animation: slideUpMenu 0.2s ease-out;
        }

        .sel-more-menu.show {
            display: flex;
        }

        @keyframes slideUpMenu {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Menu Items */
        .sel-more-menu button {
            background: transparent;
            border: none;
            color: #eee;
            padding: 12px 15px;
            text-align: left;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .sel-more-menu button:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .sel-separator {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 4px 0;
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            #selection-bar {
                width: 95%;
                bottom: 20px;
                padding: 8px 12px;
            }
            .sel-more-menu {
                right: 10px; /* Slight offset on mobile */
            }
        }

        @media (max-width: 1024px) {
            /* 1. NOTIFICATIONS: Positioned lower and centered to avoid browser URL bar overlap */
            #notification-container {
                top: 120px !important; 
                right: auto !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                align-items: center !important;
                width: 85% !important;
                z-index: 10001 !important;
            }

            .notification {
                transform: translateY(-20px);
                border-left: none;
                border-bottom: 5px solid var(--primary-color);
                text-align: center;
                box-shadow: var(--shadow-lg);
                width: 100%;
            }

            /* 2. SIDEBAR HEADER: SmartGallery title on Left, Folders Button on Right */

            .sidebar-actions {
                width: auto !important; /* Override fixed desktop width */
                display: flex !important;
                justify-content: flex-end !important;
                padding: 0 !important;
                gap: 0 !important;
            }

            /* 3. WIDTH CONTROLS: Strictly hide desktop expansion/minify icons on mobile */
            #sidebar-minify-btn, 
            #sidebar-expand-btn {
                display: none !important;
            }

            /* 4. MOBILE NAVIGATION LOGIC */
            body.sidebar-expanded-mobile .sidebar {
                position: fixed;
                width: 100%;
                min-width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                transform: translateX(0);
                z-index: 1005;
            }

            body.sidebar-expanded-mobile .main-content {
                display: none;
            }

            body:not(.sidebar-expanded-mobile) {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: static;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 1.2rem;
            }

            .sidebar.nav-collapsed .folder-controls,
            .sidebar.nav-collapsed .folder-tree-container,
            .sidebar.nav-collapsed #create-folder-btn,
            .sidebar.nav-collapsed .sidebar-footer { /* Added footer here to hide it */
                display: none;
            }
            
        }
        
        @media (max-width: 768px) {
            .breadcrumbs {
                flex-direction: column;
                align-items: stretch;
                padding: 0.5rem 1rem; 
            }

            .gallery-sort-controls {
                justify-content: space-between; 
                width: 100%;
                gap: 0.3rem; 
                flex-wrap: wrap; 
            }

            .gallery-sort-controls .sort-btn,
            .gallery-sort-controls .file-count-badge {
                padding: 0.4rem 0.5rem !important;
                font-size: 0.75rem !important;
                flex-grow: 1; 
                text-align: center;
                justify-content: center;
                white-space: nowrap;
            }

            .filter-bar form {
                grid-template-columns: 1fr;
            }

            #mobile-filter-toggle {
                display: block;
                margin-bottom: 1rem;
            }

            /* --- FIX: Allow panel to be visible on mobile when toggled --- */
            .search-overlay-panel {
                margin: 10px !important;
                width: auto !important;
                padding: 1rem !important;
                box-sizing: border-box !important;
                max-width: calc(100vw - 20px) !important;
            }
            .search-overlay-panel.visible {
                display: block !important;
            }
            .date-row {
                flex-direction: column !important; /* Stack them */
                gap: 10px !important;
            }
            .date-row > div {
                min-width: 100% !important; /* Full width */
            }
            .filter-actions-row {
                flex-direction: column-reverse !important; /* Apply on top, Reset below */
                gap: 10px !important;
            }

            .filter-actions-row .glass-btn {
                width: 100% !important;      /* Full width only on mobile for easy thumb access */
                flex: 1 1 auto !important;
                height: 48px !important;     /* Slightly taller on mobile for touch accuracy */
                min-height: 48px !important;
                font-size: 1rem !important;
            }
                        
            .filter-group input[type="date"] {
                font-size: 0.85rem !important; 
                padding: 0 8px !important;     
            }
            .filter-form-grid {
                display: grid; /* Always grid inside the panel */
                grid-template-columns: 1fr;
            }

            .desktop-actions-only {
                display: none;
            }

            .mobile-actions-only {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .gallery-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            #drop-zone-panel {
                width: 90vw;
            }

            .lightbox-nav {
                width: 50px;
                height: 50px;
            }

            #lightbox-prev {
                left: 10px;
            }

            #lightbox-next {
                right: 10px;
            }

            .node-summary-panel {
                width: 95vw;
                max-height: 90vh;
            }

            .summary-node-params li {
                font-size: 0.9rem;
            }
            
            /* --- LIGHTBOX MOBILE OPTIMIZATION --- */
            #lightbox-header {
                padding: 0.5rem !important; /* Reduce vertical padding */
                gap: 5px !important;
            }

            #lightbox-title {
                font-size: 0.9rem !important;
                max-width: 80vw !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis; /* Keep title on one line */
            }

            #lightbox-folder-name {
                font-size: 0.8rem !important;
                margin-top: 0 !important;
            }

            #lightbox-toolbar {
                display: flex !important;
                flex-wrap: wrap !important; /* Allow icons to wrap to the next line */
                justify-content: center !important; /* Center icons on the lines */
                padding: 5px !important;
                gap: 5px !important; /* Tight spacing for wrapped icons */
                overflow-x: hidden !important; /* Disable horizontal scroll */
            }

            #lightbox-toolbar button,
            #lightbox-toolbar a {
                min-width: 38px !important; 
                height: 38px !important;
                padding: 0 !important;
                font-size: 1rem !important;
                flex-shrink: 0 !important;
                border-radius: 8px !important;
            }
            
            #lightbox-toolbar::-webkit-scrollbar {
                display: none; /* Hide scrollbar for Chrome/Safari */
            }

            
            /* Adjust content area to account for smaller header */
            #lightbox-content {
                padding: 4rem 0.5rem 5rem !important; 
            }
            
        }

        /* --- CSS RULE: Widen move panel on desktop screens --- */
        @media (min-width: 1025px) {
            #drop-zone-panel {
                width: 650px;
                max-width: 90vw;
                /* Adds a limit for very large screens */
            }
        }

        /* Shortcuts Help Popup */
        #shortcuts-help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #shortcuts-help-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .shortcuts-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 800px;           
            max-width: 95vw;
            max-height: 85vh;       
            display: flex;          
            flex-direction: column; 
            overflow: hidden;
        }

        .shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-hover);
            flex-shrink: 0; 
        }
        
        .shortcuts-header .close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            padding: 0 0.5rem;
            transition: color 0.2s;
        }
        .shortcuts-header .close-btn:hover {
            color: var(--danger-color);
        }

        
        /* --- SHORTCUTS HELP LAYOUT --- */
        .shortcuts-content {
            padding: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            overflow-y: auto;
            align-content: flex-start;
        }
        .sc-column {
            flex: 1 1 220px;
            min-width: 220px;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        .sc-header {
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            padding-bottom: 4px;
            font-size: 0.95rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .sc-sub {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: none;
            font-weight: normal;
            margin-top: 2px;
        }
        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 2px;
        }
        
        @media (max-width: 768px) {
            .shortcuts-panel {
                width: 95vw;
            }
            .shortcuts-content {
                grid-template-columns: 1fr;
            }
        }

        .shortcut-item .key {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 0 var(--border-color);
            font-size: 0.9rem;
        }

        .shortcut-item .desc {
            color: var(--text-muted);
            font-size: 0.95rem;
        }
        
        /* standard UI (Navigating/Selecting from  OS) */
        .shortcut-item .key.std {
            background: rgba(0, 123, 255, 0.15); /* Tint Blu */
            border-color: rgba(0, 123, 255, 0.4);
            color: #89CFF0; /* Azzurro chiaro */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* --- SMART DIALOG (Custom Alert/Confirm/Prompt) --- */
        #smart-dialog-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.7); /* Dark dimming */
            backdrop-filter: blur(8px);      /* Heavy blur behind */
            z-index: 10000; /* Highest priority */
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #smart-dialog-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .smart-dialog-panel {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--primary-color); /* Blue accent on top */
            border-radius: 16px;
            padding: 2rem;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Nice bounce effect */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        #smart-dialog-overlay.visible .smart-dialog-panel {
            transform: scale(1);
        }

        #sd-title {
            margin: 0;
            font-size: 1.4rem;
            color: white;
            font-weight: 700;
        }

        #sd-message {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.5;
        }

        .sd-text-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .sd-text-input:focus {
            border-color: var(--primary-color);
            background: rgba(0,0,0,0.5);
        }

        .sd-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        .sd-actions button {
            min-width: 80px;
        }
        
        /* --- LIGHTBOX SHORTCUTS BAR --- */
        #lightbox-shortcuts {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(12px);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 2005;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            
            /* NEW: Transizione fluida per nascondere/mostrare */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
        }

        /* NEW: Stato Nascosto (Svanisce e scende giù) */
        #lightbox-shortcuts.ui-hidden {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }

        .kb-group {
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.75rem; 
            font-weight: 500;
        }

        /* Classe speciale per evidenziare Quick Delete */
        .kb-danger {
            color: #ff6b6b;
            font-weight: 700;
        }

        .kb-key {
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 1px 5px;
            min-width: 18px;
            text-align: center;
            font-family: monospace;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 2px 0 rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2);
            font-size: 0.75rem;
        }

        .kb-separator {
            width: 1px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 2px;
        }

        /* IMPORTANTE: Nascondere su Mobile */
        @media (max-width: 1024px) {
            #lightbox-shortcuts { display: none !important; }
        }
        
        /* --- LIGHTBOX LOADER --- */
        .lightbox-loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-bottom-color: var(--primary-color); /* Usa il colore blu del tema */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            /* Centramento perfetto considerando la trasformazione */
            margin-top: -25px; 
            margin-left: -25px;
            z-index: 15; /* Sopra l'immagine mentre carica */
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }        

        /* --- GENERATION DATA DASHBOARD --- */
        .gen-dashboard {
            background: var(--surface-hover);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .gen-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Prompts */
        .gen-prompt-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #eee;
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .gen-prompt-box.positive {
            border-left: 3px solid var(--success-color);
        }

        .gen-prompt-box.negative {
            border-left: 3px solid var(--danger-color);
            color: #ffcccc;
        }

        .copy-prompt-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-muted);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .copy-prompt-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Tech Grid - Updated Layout */
        .gen-stats-grid {
            display: grid;
            /* Wider columns to accommodate long seeds */
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 10px;
        }

        .gen-stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            /* Relative positioning needed for absolute elements if any */
            position: relative; 
        }

        .gen-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
            /* Flexbox to align Label text and Copy button */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gen-stat-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-color);
            
            /* CRITICAL FIX: Allow long strings (like Seeds) to wrap to the next line */
            white-space: normal; 
            word-break: break-all; 
            line-height: 1.2;
        }
        
        .gen-stat-value.seed { color: var(--favorite-color); font-family: monospace; }
        .gen-stat-value.model { color: var(--primary-color); word-break: break-word; }
        
        /* Mini Copy Button for Stats (Seed, etc.) */
        .stat-copy-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0 4px;
            transition: color 0.2s;
        }
        
        .stat-copy-btn:hover {
            color: white;
            transform: scale(1.1);
        }

        /* LoRA Chips */
        .gen-lora-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .gen-lora-chip {
            background: rgba(155, 48, 255, 0.15);
            border: 1px solid var(--ai-color);
            color: #f0a0ff;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .gen-lora-val {
            background: rgba(0,0,0,0.3);
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: white;
        }

        /* --- INPUT MEDIA IN NODE SUMMARY --- */
        .input-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-media-card {
            background: var(--surface-hover);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-media-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            font-size: 0.95rem;
            word-break: break-all;
            text-align: center;
        }

        .input-media-preview {
            width: 100%;
            height: 300px; 
            object-fit: contain;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        /* Audio player styling specific */
        audio.input-media-preview {
            height: 50px;
            margin-top: auto;
            margin-bottom: auto;
        }

        .input-media-actions {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            margin-top: auto;
        }

        .input-media-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .input-media-btn:hover {
            background: var(--primary-hover);
            text-decoration: none;
        }

        .input-media-btn.secondary {
            background: var(--surface-color);
            border-color: var(--border-color);
        }
        .input-media-btn.secondary:hover {
            background: rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            .input-media-grid {
                grid-template-columns: 1fr;
            }
            .input-media-preview {
                height: 200px; /* Più piccolo su mobile */
            }
        }

        .ai-input-wrapper {
            position: relative;
            width: 100%;
        }

        #ai-search-clear-text {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: none; /* Nascosto di default */
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        #ai-search-clear-text:hover {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }
        
        /* Deleted: .ai-btn-text - Overwritten by "UNIFIED AI BUTTONS" block later */

        /* --- LAYOUT MOBILE HEADER (Filtri + AI) --- */
        .mobile-header-row {
            display: none; /* Nascosto su desktop */
            gap: 10px;
            margin-bottom: 1rem;
            width: 100%;
        }

        
        
        /* --- STILI AI BANNER (DESKTOP & MOBILE) --- */
        .ai-banner {
            background: var(--ai-surface);
            border-bottom: 1px solid var(--ai-color);
            padding: 1rem 2rem;
            /* DESKTOP DEFAULT: Flexbox su una riga */
            display: flex; 
            align-items: center;
            justify-content: space-between;
            color: var(--ai-color);
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.2);
            animation: glow 2s infinite alternate;
        }

        .ai-banner-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            overflow: hidden; /* Per desktop */
            white-space: nowrap; /* Per desktop */
            text-overflow: ellipsis; /* Per desktop */
            margin-right: 15px;
        }

        .ai-query-part {
            color: white;
            margin-left: 5px;
        }

        .ai-banner-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* --- LAYOUT MOBILE AI BANNER (GRID) --- */
        @media (max-width: 768px) {
            .ai-banner, .global-search-banner {
                padding: 12px;
                /* Passiamo a Grid per controllo posizionale preciso */
                display: grid !important; 
                grid-template-columns: 1fr auto; /* Colonna 1: Label, Colonna 2: Bottoni */
                gap: 10px 0; /* Spazio verticale tra le righe */
                height: auto;
            }

            .ai-banner-title {
                /* TRUCCO: display: contents fa sparire il div contenitore dal layout,
                   così i suoi figli (span scope e span query) diventano figli diretti della Grid .ai-banner */
                display: contents !important; 
            }

            /* RIGA 1, COLONNA 1: Label (es. "🧠 Global") */
            .ai-scope-part {
                grid-column: 1;
                grid-row: 1;
                align-self: center;
                font-size: 0.95rem;
                white-space: nowrap;
            }

            /* RIGA 1, COLONNA 2: Bottoni (Edit/Exit) */
            .ai-banner-actions {
                grid-column: 2;
                grid-row: 1;
                align-self: center;
            }
            
            /* Bottoni un po' più compatti su mobile */
            .ai-banner-actions button {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }

            /* RIGA 2: Query utente (Tutta larghezza) */
            .ai-query-part {
                grid-column: 1 / -1; /* Occupa tutte le colonne */
                grid-row: 2;
                margin-left: 0;
                white-space: normal; /* Permette a capo */
                word-break: break-word;
                background: rgba(0,0,0,0.3); /* Sfondo scuro per risaltare */
                padding: 8px 10px;
                border-radius: 8px;
                border-left: 3px solid var(--ai-color);
                font-weight: normal;
                font-size: 1rem;
                line-height: 1.4;
            }
        }
 
        /* --- CAPTION (Start/Middle/End) --- */
        .ai-caption-card {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--ai-color);
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            padding: 0;
            overflow: hidden;
            transition: background 0.3s;
        }
        
        .ai-caption-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .ai-card-header {
            background: rgba(255, 0, 255, 0.15);
            color: var(--ai-color);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 5px 10px;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-card-body {
            padding: 10px 12px;
            color: #ddd;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Icone decorative per i frame */
        .ai-card-header::before {
            content: '⏱️';
            font-size: 0.9rem;
        }
        /* --- MODAL INFO AI --- */
        #ai-info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #ai-info-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .ai-info-panel {
            background: #111;
            border: 2px solid var(--ai-color); /* Bordo Fuxia */
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.25); /* Bagliore */
            text-align: center;
            color: #eee;
        }

        .ai-info-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }
        
        .ai-info-close:hover { color: var(--ai-color); }

        .ai-hero-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 10px var(--ai-color));
        }

        .ai-info-title {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #fff 0%, var(--ai-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-info-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            color: #ccc;
        }

        .ai-comparison-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: left;
            border-left: 4px solid var(--ai-color);
        }

        .ai-badge-light { color: var(--success-color); font-weight: bold; }
        .ai-badge-full { color: var(--ai-color); font-weight: bold; }

        .ai-cta-btn {
            display: inline-block;
            background: linear-gradient(90deg, var(--ai-color) 0%, #a0f 100%);
            color: white;
            text-decoration: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(180, 0, 255, 0.4);
        }

        .ai-cta-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(180, 0, 255, 0.6);
        }
        
        /* ---  MORE MODAL INFO AI --- */
        .ai-status-alert {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.4);
            color: #ffcccc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            display: inline-block;
            width: 100%;
        }

        .ai-status-alert code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff;
            font-family: monospace;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ai-steps-list {
            text-align: left;
            margin: 1.5rem 0;
            padding-left: 1.5rem;
            color: #ddd;
        }
        
        .ai-steps-list li {
            margin-bottom: 0.8rem;
        }
        
        .ai-steps-list strong {
            color: var(--ai-color);
        }
        /* --- STILI PER IL BLOCCO READ MORE (ACCORDION) --- */
        .ai-details {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin: 1.5rem 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
            overflow: hidden;
            transition: background 0.3s;
        }

        .ai-details:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .ai-details summary {
            padding: 12px 15px;
            cursor: pointer;
            font-weight: bold;
            color: var(--ai-color);
            list-style: none; /* Nasconde triangolo default */
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        /* Rimuove marker default su Safari/Chrome */
        .ai-details summary::-webkit-details-marker {
            display: none;
        }

        /* Freccetta personalizzata animata */
        .ai-details summary::after {
            content: '▼';
            font-size: 0.7rem;
            color: #888;
            transition: transform 0.3s ease;
        }

        .ai-details[open] summary::after {
            transform: rotate(180deg);
            color: var(--ai-color);
        }

        .ai-details-content {
            padding: 0 15px 15px 15px;
            color: #ccc;
            font-size: 1.05rem;
            line-height: 1.6;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 5px;
            padding-top: 10px;
        }
        
        .ai-details-content em {
            color: #fff;
            font-style: italic;
        }
        
        .limit-warning-box {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--favorite-color);
            color: var(--text-muted);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .limit-warning-icon {
            font-size: 1.2rem;
        }
        
        /* --- QUICK RESET FILTER ICON --- */
        .filter-reset-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            margin-left: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10; /* Ensure it stays on top */
        }

        .filter-reset-icon:hover {
            background: var(--danger-color);
            transform: scale(1.1);
        }
        
        /* --- POPOVER FIXED POSITIONING --- */
        #options-popover,
        #auto-refresh-popover {
            display: none;
            position: fixed;
            background: var(--surface-color);
            border: 1px solid var(--primary-color);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.9);
            z-index: 10000 !important;
            
            /* RESPONSIVE FIXES */
            width: 260px;          
            max-width: 85vw;       
            white-space: normal;   
            
            backdrop-filter: blur(10px);
            text-align: left;
        }

        #options-popover.visible,
        #auto-refresh-popover.visible {
            display: flex !important;
            flex-direction: column;
            gap: 10px;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Effetto rimbalzo carino */
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Container del bottone split */
        .refresh-group {
            display: inline-flex;
            align-items: center;
            background: var(--workflow-color); /* Green background base */
            border-radius: 8px;
            border: 1px solid var(--workflow-color);
            position: relative; /* Anchor for popover */
        }

        #refresh-btn {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0.5rem 0.8rem !important;
            border-radius: 8px 0 0 8px !important;
            margin: 0 !important;
        }
        
        #refresh-btn:hover {
            background: rgba(0,0,0,0.1) !important;
        }

        /* Separatore */
        .refresh-separator {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.3);
        }

        #refresh-options-btn {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0.5rem 0.6rem !important;
            border-radius: 0 8px 8px 0 !important;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #refresh-options-btn:hover {
            background: rgba(0,0,0,0.2) !important;
        }

        /* --- AUTO-REFRESH ACTIVE INDICATOR --- */
        .refresh-group.auto-active {
            /* Keep original border and shadow color for the button group */
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
            border-color: var(--workflow-color);
        }

        .refresh-group.auto-active::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            /* Only the dot is red */
            background-color: #ff0000; 
            border-radius: 50%;
            box-shadow: 0 0 6px #ff0000;
            z-index: 10;
            /* Animation for pulsing effect */
            animation: pulse-dot-red 2s infinite;
            pointer-events: none;
        }

        /* Keyframes to make the red dot pulse */
        @keyframes pulse-dot-red {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(255, 0, 0, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }

        /* ARROW and INPUTS on popover */
        .ar-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .ar-row label { margin: 0; font-size: 0.9rem; cursor: pointer; color: var(--text-color); }
        .ar-input { width: 60px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; border-radius: 4px; padding: 4px; text-align: center; }
        
        /* OPTIONS MENU STYLES */
        .opt-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; cursor: pointer; border-radius: 6px;
            background: rgba(255,255,255,0.05); border: 1px solid transparent;
            transition: all 0.2s;
        }
        .opt-item:hover { background: rgba(255,255,255,0.1); border-color: var(--primary-color); }
        .opt-item.active { border-left: 3px solid var(--success-color); }
        .opt-item.inactive { border-left: 3px solid var(--text-muted); opacity: 0.8; }
        .opt-label { font-weight: 600; font-size: 0.9rem; color: var(--text-color); }
        .opt-status { font-size: 0.75rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .opt-status.on { background: var(--success-color); color: white; }
        .opt-status.off { background: var(--surface-hover); color: var(--text-muted); border: 1px solid var(--glass-border); }
        
        .opt-shortcut-hint { font-size: 0.7rem; color: var(--text-muted); margin: 10px 0 0 0; text-align: right; }
        
        /* Video Overlay Icon */
        .video-play-overlay {
            /* MOBILE DEFAULT: Centered, Big, Pass-through (Visual only) */
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.4rem;
            padding-left: 4px;
            z-index: 12; /* Above duration/badges */
            backdrop-filter: blur(2px);
            pointer-events: none; /* Mobile: Tap goes through to Lightbox */
            transition: all 0.2s;
        }

        /* DESKTOP OVERRIDE: Corner, Small, Clickable */
        @media (min-width: 1025px) {
            .video-play-overlay {
                top: auto; 
                left: 10px; 
                bottom: 10px;
                transform: none; /* Reset center transform */
                
                width: 32px; height: 32px; /* Smaller */
                font-size: 0.9rem;
                padding-left: 2px;
                
                background: rgba(0, 0, 0, 0.6);
                border: 1px solid rgba(255, 255, 255, 0.4);
                
                pointer-events: auto; /* Desktop: Clickable */
                cursor: pointer;
            }

            .video-play-overlay:hover {
                background: var(--primary-color);
                border-color: white;
                transform: scale(1.1);
            }
            
            /* Adjustment for Focus Mode to avoid overlapping the Checkmark (which moves to bottom-left) */
            body.focus-mode .gallery-item.selected .video-play-overlay {
                bottom: 40px; /* Move up slightly if selected in focus mode */
            }
        }
        
        @media (max-width: 768px) {
            .opt-shortcut-hint { display: none; }
        }
        
        /* --- SIDEBAR FOOTER (Version & Links) --- */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0; 
            transition: all 0.3s ease;
        }


        /* GitHub Promo Box Style */
        .github-promo-link {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 10px 12px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .github-promo-link:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 193, 7, 0.3); /* Subtle Gold Border */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .gh-icon {
            width: 28px;
            height: 28px;
            fill: var(--text-muted);
            transition: fill 0.3s;
            flex-shrink: 0;
        }

        .github-promo-link:hover .gh-icon {
            fill: #fff; /* Bright white on hover */
        }

        .promo-text {
            font-size: 0.85rem;
            line-height: 1.3;
            color: var(--text-muted);
            font-style: italic; /* Persuasive style */
        }

        .gold-highlight {
            color: var(--favorite-color); /* Gold */
            font-weight: 600;
            font-style: normal; /* Stand out from italic */
        }

        /* Minimized Sidebar Handling */
        body.sidebar-minimized .sidebar-footer {
            align-items: center;
            padding-top: 10px;
            gap: 10px;
        }
        
        body.sidebar-minimized .github-promo-link {
            padding: 10px;
            justify-content: center;
            border-color: transparent;
            background: transparent;
        }
        body.sidebar-minimized .promo-text {
            display: none; /* Hide text, show only icon */
        }
        body.sidebar-minimized .github-promo-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        body.sidebar-minimized .github-promo-link:hover .gh-icon {
            fill: var(--favorite-color); /* Gold icon when minimized */
        }
        
        /* --- DESKTOP SIDEBAR MINIMIZED MODE --- */
        :root {
            --sidebar-min-width: 60px;
        }

        #sidebar-minify-btn {
            display: flex; /* Flex per centrare icona */
            justify-content: center;
            width: 32px; /* Larghezza fissa */
        }

        body.sidebar-minimized .sidebar {
            width: var(--sidebar-min-width);
            min-width: var(--sidebar-min-width);
            padding: 1.5rem 0.5rem; /* Padding laterale ridotto */
            overflow: hidden; /* Nasconde il contenuto che sborda */
        }

        /* Only hide these elements inside the sidebar, not globally */
        body.sidebar-minimized .sidebar h1,
        body.sidebar-minimized .sidebar .folder-controls,
        body.sidebar-minimized .sidebar .folder-tree-container,
        body.sidebar-minimized .sidebar #create-folder-btn,
        body.sidebar-minimized .sidebar #sidebar-expand-btn {
            display: none !important;
            opacity: 0; 
            transition: opacity 0.2s;
        }

        body.sidebar-minimized .sidebar-actions {
            flex-direction: column;
            width: 100%;
            align-items: center;
            gap: 0;
        }
        
        body.sidebar-minimized #sidebar-minify-btn {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1.5rem;
        }
        
        /* --- NAVIGATION CHOICE MODAL --- */
        #nav-choice-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #nav-choice-overlay.visible { display: flex; opacity: 1; }
        
        .nav-choice-panel {
            background: var(--surface-color);
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-choice-panel h3 { margin-top: 0; color: white; }
        .nav-choice-panel p { color: var(--text-muted); margin-bottom: 1.5rem; }
        
        .nav-choice-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .nav-btn {
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        /* --- Highlight the focused button for keyboard navigation --- */
        .nav-btn:focus {
            outline: 3px solid rgba(255, 255, 255, 0.5);
            outline-offset: 2px;
            transform: scale(1.05); /* Slightly enlarge to show it's active */
        }
        .nav-btn-primary { background: var(--primary-color); color: white; }
        .nav-btn-secondary { background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); }
        .nav-btn-cancel { background: transparent; color: var(--text-muted); }
        
        .nav-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        /* --- AI MANAGER STYLES (Nuovi) --- */
        /* Deleted: #ai-manager-btn and hover - Overwritten by "UNIFIED AI BUTTONS" block later */

        #ai-manager-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 5000; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #ai-manager-overlay.visible { opacity: 1; pointer-events: auto; }

        .ai-manager-panel {
            background: var(--surface-color); border: 1px solid var(--ai-color); border-radius: 16px;
            width: 800px; max-width: 95vw; 
            max-height: 85vh; 
            display: flex; flex-direction: column;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.15); 
            position: relative;
        }

        .ai-manager-header {
            padding: 1rem 1.5rem; background: var(--ai-surface); border-bottom: 1px solid var(--ai-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .ai-manager-header h2 { margin: 0; color: white; display: flex; align-items: center; gap: 10px; font-size:1.4rem; }
        .ai-manager-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        .ai-manager-tabs { display: flex; border-bottom: 1px solid var(--border-color); background: var(--surface-hover); }
        .ai-tab-btn {
            flex: 1; padding: 1rem; background: none; border: none; color: var(--text-muted);
            cursor: pointer; font-weight: 600; transition: all 0.2s; border-bottom: 2px solid transparent;
        }
        .ai-tab-btn.active { color: var(--ai-color); border-bottom-color: var(--ai-color); background: rgba(255,0,255,0.05); }

        .ai-manager-content { 
            padding: 1.5rem; 
            overflow-y: auto; 
            flex: 1; 
            min-height: 0; /* Fix Firefox flexbox */
        }
        
        #ai-manager-btn-desk {
            height: 42px !important; 
            margin-top: 0 !important;
        }
        
        .ai-tab-content { display: none; }
        .ai-tab-content.active { display: block; }

        .ai-queue-list-container {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            max-height: 150px;
            overflow-y: auto;
        }
        .ai-queue-item {
            padding: 6px 10px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex; justify-content: space-between;
        }
        .ai-queue-item:last-child { border-bottom: none; }
        /* AI Priority Item Style */
        .ai-queue-item.priority {
            background: rgba(220, 53, 69, 0.15); /* Red tint */
            border-left: 3px solid var(--danger-color);
        }
        .ai-queue-item.priority span {
            color: #ffcccc;
            font-weight: 600;
        }
        .ai-status-bar {
            display: flex; gap: 20px; margin-bottom: 20px; background: var(--glass-bg);
            padding: 15px; border-radius: 8px; border: 1px solid var(--glass-border); flex-wrap: wrap;
        }
        .ai-stat-item { flex: 1; text-align: center; min-width: 120px; }
        .ai-stat-val { font-size: 1.2rem; font-weight: bold; color: white; display: block; }
        .ai-stat-lbl { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }

        .ai-progress-wrapper { margin-bottom: 20px; }
        .ai-progress-track { height: 12px; background: #333; border-radius: 6px; overflow: hidden; position: relative; }
        .ai-progress-fill { height: 100%; background: var(--ai-gradient); width: 0%; transition: width 0.3s; }
        .ai-progress-text { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); margin-top: 5px; }

        .ai-controls-row { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 15px; }
        .ai-btn-action {
            padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-color);
            background: var(--surface-hover); color: white; cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
        }
        .ai-btn-action:hover { filter: brightness(1.2); }
        .ai-btn-pause { border-color: var(--favorite-color); color: var(--favorite-color); }
        .ai-btn-danger { border-color: var(--danger-color); color: var(--danger-color); }

        .watched-folder-item {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            /* Increased padding for better touch targets on mobile */
            padding: 12px 10px; 
            border-bottom: 1px solid var(--border-color);
        }

        .watched-folder-path { 
            font-family: monospace; 
            color: var(--text-color);
            /* FIX FOR LONG PATHS ON MOBILE: */
            word-break: break-all; /* Breaks long path strings */
            
            /* PRESERVE SPACES FIX: */
            white-space: pre-wrap;   /* Allows text wrapping AND preserves multiple spaces */
            
            line-height: 1.3;
            margin-right: 10px;    /* Space between text and Stop button */
        }
        .gpu-warning {
            background: rgba(220, 53, 69, 0.2); border: 1px solid var(--danger-color);
            color: #ffcccc; padding: 10px; border-radius: 6px; margin-bottom: 15px;
            display: none; align-items: center; gap: 10px;
        }
        .gpu-warning.visible { display: flex; }
        .folder-action-btn.ai-index-btn { color: var(--ai-color); font-weight: bold; }
        
        /* --- AI INDEX OPTIONS MODAL --- */
        #ai-options-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.6); z-index: 6000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        #ai-options-modal.visible { display: flex; }
        
        .ai-options-panel {
            background: var(--surface-color); border: 1px solid var(--ai-color);
            border-radius: 12px; padding: 20px; width: 400px; max-width: 90vw;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .ai-opt-header { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; color: white; display: flex; gap: 10px; align-items: center; }
        .ai-opt-row { margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .ai-opt-desc { font-size: 0.85rem; color: var(--text-muted); margin-top: -5px; margin-bottom: 10px; display: block; line-height: 1.3;}
        .ai-opt-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .ai-path-preview { font-family: monospace; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 15px; word-break: break-all; color: var(--ai-color); }
        
        /* --- AI MANAGER SETTINGS IMPROVEMENTS --- */
        .ai-settings-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ai-setting-card {
            background: var(--surface-hover);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-setting-card label {
            color: var(--ai-color);
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-setting-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        /* Fix for dark mode dropdowns (especially on mobile) */
        .ai-setting-card select {
            background-color: var(--glass-bg);
            color: white;
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
        }
        
        .ai-setting-card select option {
            background-color: var(--surface-color);
            color: white; /* Ensure text is visible in options */
        }

        .ai-setting-card input[type="checkbox"] {
            width: 20px; 
            height: 20px; 
            accent-color: var(--ai-color);
        }
        
        /* Modal Erase Button */
        .nav-btn-danger-outline {
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        .nav-btn-danger-outline:hover {
            background: var(--danger-color);
            color: white;
        }
        
        /* --- FOLDER ACTION MENU (Restyled) --- */
        .folder-menu-container {
            position: relative;
            margin-left: auto;
        }

        .folder-menu-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1.1rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .folder-menu-btn:hover {
            color: var(--text-color);
            background: rgba(255,255,255,0.15);
            transform: scale(1.1);
        }

        .folder-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 6px; /* Little gap from the dots */
            
            /* High Visibility Style */
            background: #2b2b2b; /* Lighter grey than sidebar to pop out */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Sharper border */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); /* Deep shadow for 3D effect */
            
            z-index: 1000; /* Ensure strictly on top */
            min-width: 160px;
            padding: 6px; /* Internal padding for aesthetic */
            flex-direction: column;
            gap: 2px; /* Space between buttons */
        }

        .folder-dropdown.show {
            display: flex;
            animation: fadeIn 0.2s ease-out; /* Smooth entry */
        }

        .folder-dropdown button {
            background: transparent;
            border: none;
            color: #eeeeee; /* Bright white text */
            padding: 10px 12px;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px; /* Rounded buttons inside */
            transition: background 0.2s, transform 0.2s;
            font-weight: 500;
        }

        .folder-dropdown button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px); /* Little visual feedback */
        }
        
        /* Specific style for AI Index button inside menu */
        .folder-dropdown button[onclick*="indexFolder"] {
            color: var(--ai-color); /* Fuchsia text */
        }
        .folder-dropdown button[onclick*="indexFolder"]:hover {
            background: rgba(255, 0, 255, 0.15);
        }

        /* Specific style for Delete button inside menu */
        .folder-dropdown button[onclick*="deleteFolder"] {
            color: #ff6b6b; /* Soft Red */
        }
        .folder-dropdown button[onclick*="deleteFolder"]:hover {
            background: rgba(220, 53, 69, 0.15);
        }
        
        /* Watched Folder Indicator */
        .folder-link.ai-watched::before {
            /* This targets the emoji inside the text if we wrap it, 
               but simpler is to handle it in JS by changing the string */
        }

        /* --- LIGHTBOX MOBILE FIX --- */
        /* Add padding at the bottom to ensure last line is not cut off by borders/screen edge */
        #lightbox-ai-text-scroll {
            padding-bottom: 40px !important; 
        }

        /* --- AI MANAGER TOGGLE BUTTON --- */
        #ai-toggle-pause {
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        /* State: Running (Button shows Pause option) */
        #ai-toggle-pause.state-running {
            background: var(--surface-hover);
            border-color: var(--favorite-color);
            color: var(--favorite-color);
        }
        
        /* State: Paused (Button shows Resume option - GREEN) */
        #ai-toggle-pause.state-paused {
            background: var(--success-color); /* Green Background */
            border-color: #1a9c77;
            color: white; /* White text */
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.4);
        }
        
        /* Text Color for Status Label */
        .ai-stat-val.status-paused {
            color: var(--favorite-color) !important; /* Yellow */
        }
        
        /* ========================================= */
        /* === UNIFIED AI BUTTONS STYLE (CLEAN) === */
        /* ========================================= */

        /* Target: AI Manager (Top), AI Search (Desktop & Mobile) */
        #ai-manager-btn,
        #ai-search-toggle-desktop,
        #ai-search-toggle-mobile,
        .filter-bar button.ai-btn {
            background: var(--glass-bg) !important;           /* Match Filters Button */
            border: 1px solid var(--glass-border) !important; /* Match Filters Button */
            color: var(--ai-color) !important;                /* Text remains Fuchsia */
            border-radius: 8px !important;
            padding: 0.75rem 1rem !important;                 /* Uniform padding */
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none !important;                      /* Remove old glow */
            text-shadow: none !important;
            
            /* Flex layout for icons */
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: auto !important;                          /* Remove fixed height */
            margin-right: 5px;
        }

        /* Hover State: Standard Surface change + Subtle Fuchsia Border */
        #ai-manager-btn:hover,
        #ai-search-toggle-desktop:hover,
        #ai-search-toggle-mobile:hover,
        .filter-bar button.ai-btn:hover {
            background: var(--surface-hover) !important;
            border-color: var(--ai-color) !important;         /* Only border lights up */
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
        }

        /* Active/Pressed State */
        #ai-search-toggle-desktop:active,
        #ai-search-toggle-mobile:active {
            background: var(--surface-color) !important;
            transform: translateY(0);
        }

        /* Reset Internal Text Spans */
        .ai-btn-text {
            color: var(--ai-color) !important;
            text-shadow: none !important;
            font-weight: 600 !important;
            text-transform: none !important; /* Optional: Remove UPPERCASE if present */
            margin: 0 !important;
        }
        
        /* Remove the old specific glow animation from the Manager button if present */
        #ai-manager-btn:hover {
            box-shadow: none;
        }
        
        /* Modifiche Media Query per Mobile */
        @media (max-width: 768px) {
            /* Mostra la riga header su mobile */
            .mobile-header-row {
                display: flex; 
            }
            
            /* Il bottone filtri prende lo spazio rimanente */
            #mobile-filter-toggle {
                display: block; /* Assicuriamoci sia visibile */
                margin-bottom: 0 !important; /* Rimuove margine vecchio */
                flex-grow: 1; 
                text-align: center;
                width: auto; /* Reset larghezza */
            }

            /* Nascondi il bottone AI "Desktop" che sta in basso */
            #ai-search-toggle-desktop {
                display: none !important;
            }
            
            /* Hide the Desktop Toggle */
            #search-toggle-desktop {
                display: none !important;
            }

            /* Stile per il bottone AI "Mobile" in alto */
            #ai-search-toggle-mobile {
                background: var(--glass-bg);
                border: 1px solid var(--ai-color);
                color: white;
                border-radius: 8px;
                padding: 0 1rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0; /* Non si rimpicciolisce */
                transition: background 0.3s;
            }
            
            #ai-search-toggle-mobile:active {
                background: var(--ai-surface);
            }
        }
        
        /* --- LIGHTBOX BOTTOM CONTROLS --- */
        #lightbox-bottom-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            z-index: 2010;
            width: 100%;
            pointer-events: none; /* Let clicks pass through empty space */
        }

        #lightbox-ui-toggle {
            pointer-events: auto; /* Re-enable clicking for the button */
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-muted);
            border-radius: 50px; /* Pill shape */
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            width: auto; /* Let it grow with text */
            height: auto;
        }
        
        #lightbox-ui-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        /* Hidden state for toolbar logic remains same */
        #lightbox-toolbar.ui-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }
        #lightbox-toolbar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Clean View for Header (No background) */
        #lightbox-header.clean-view {
            background: transparent !important;
            backdrop-filter: none !important;
            pointer-events: none;
        }
        /* Hide text when Clean View (Hidden Toolbar) is active */
        #lightbox-header.clean-view #lightbox-title,
        #lightbox-header.clean-view #lightbox-folder-name {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* Hidden state for toolbar (opacity allows transition, pointer-events prevents clicking) */
        #lightbox-toolbar.ui-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }
        
        /* Smooth transition for toolbar */
        #lightbox-toolbar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* --- CLEAN VIEW STATE (No Blur/Background) --- */
        #lightbox-header.clean-view {
            background: transparent !important;
            backdrop-filter: none !important;
            pointer-events: none; /* Allows clicking through the empty header area */
        }

        /* Ensure the Toggle Button remains interactive even in clean view */
        #lightbox-header.clean-view .lightbox-info-row {
            pointer-events: auto;
        }
        
        /* Optional: Hide title in clean view to free up more space, 
           remove this part if you want to keep the title floating */
        #lightbox-header.clean-view #lightbox-title,
        #lightbox-header.clean-view #lightbox-folder-name {
            text-shadow: 0 0 2px black; /* Add shadow to read text without background */
        }
        
        /* --- HIDE AVG TIME STAT (Requested) --- */
        .ai-status-bar .ai-stat-item:nth-child(3) {
            display: none !important;
        }
        
        /* New Styles for Modal Toggle */
        #ai-opt-watched-controls {
            display: none;
            background: rgba(255, 193, 7, 0.1); /* Yellow tint */
            border: 1px solid var(--favorite-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* --- AI INDEXING DOTS ANIMATION --- */
        .ai-working-dots {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            height: 10px;
        }
        
        .ai-dot {
            width: 6px;
            height: 6px;
            margin: 0 2px;
            background-color: var(--success-color); /* Green to match Indexing status */
            border-radius: 50%;
            opacity: 0.2;
            animation: dotFade 1.4s infinite ease-in-out both;
        }
        
        .ai-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-dot:nth-child(2) { animation-delay: -0.16s; }
        .ai-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes dotFade {
            0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1.2); }
        }
        
        /* --- AI SETTINGS MODERN UI --- */
        .ai-options-group {
            margin-bottom: 25px;
        }
        
        .ai-group-title {
            color: var(--ai-color);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-group-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .ai-radio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        /* Hide the actual radio input */
        .ai-radio-input {
            display: none;
        }

        /* The Visual Card */
        .ai-radio-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            overflow: hidden;
        }

        .ai-radio-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* Selected State */
        .ai-radio-input:checked + .ai-radio-card {
            border-color: var(--ai-color);
            background: rgba(255, 0, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.2);
        }

        .ai-opt-name {
            font-weight: bold;
            color: white;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .ai-opt-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Checkmark Icon for selected item */
        .ai-check-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            background: var(--ai-color);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .ai-radio-input:checked + .ai-radio-card .ai-check-icon {
            display: flex;
        }

        /* --- LIGHTBOX TOGGLE BUTTON POSITIONING --- */
        
        /* 1. Base Style & MOBILE Position (Bottom Center) */
        #lightbox-ui-toggle {
            position: fixed;             
            bottom: 60px;                
            left: 50%;                   
            transform: translateX(-50%); 
            z-index: 2020;               
            
            visibility: hidden;
            pointer-events: none;
            opacity: 0;

            /* Visual Style */
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-muted);
            border-radius: 50px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            white-space: nowrap;
        }

        #lightbox-overlay.visible #lightbox-ui-toggle {
            visibility: visible;
            pointer-events: auto;
            opacity: 1;
        }

        #lightbox-ui-toggle:hover {
            background: rgba(0, 0, 0, 0.8);
            border-color: var(--ai-color);
            color: var(--ai-color);
            transform: translateX(-50%) translateY(-2px); 
        }

        /* Hide the old container */
        #lightbox-bottom-controls {
            pointer-events: none;
            height: 0;
            margin: 0;
            padding: 0;
        }

        /* 2. DESKTOP Override (Top Left Corner) */
        @media (min-width: 1025px) {
            #lightbox-ui-toggle {
                top: 30px;       
                left: 30px;      
                bottom: auto;    
                transform: none; 
            }
            
            #lightbox-ui-toggle:hover {
                transform: translateY(-2px); 
            }
        }
        
        /* --- NEW GLASS TOOLBAR SYSTEM --- */

        /* 1. LAYOUT CONTAINER (Desktop) */
        .toolbar-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 0.6rem 2rem 1rem 2rem; 
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Pushes elements to the right (e.g. AI Manager) */
        .push-right { margin-left: auto; }

        /* 2. BASE GLASS BUTTON STYLE (Updated for alignment) */
        .glass-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 0 1rem; /* Horizontal padding only, height handles vertical */
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            height: 42px; /* Increased slightly and Fixed for perfect alignment */
            line-height: 1; /* Reset line height */
            white-space: nowrap;
            text-decoration: none;
            box-sizing: border-box; /* Includes border in height calculation */
        }

        .glass-btn:hover {
            background: var(--surface-hover);
            border-color: var(--text-muted);
            transform: translateY(-1px);
        }

        .glass-btn:active { transform: translateY(0); }

        /* Active Styles (when pressed or selected) */
        .glass-btn.active-blue {
            background: rgba(0, 123, 255, 0.2);
            border-color: var(--primary-color);
            color: white;
        }
        .glass-btn.active-fuxia {
            background: rgba(255, 0, 255, 0.15);
            border-color: var(--ai-color);
            color: var(--ai-color);
        }

        /* 3. BUTTON GROUPS (Merged buttons: Sort, Refresh) */
        .btn-group {
            display: inline-flex;
            border-radius: 8px;
            overflow: hidden; /* Clips internal corners */
            border: 1px solid var(--glass-border); /* Single border around the group */
        }

        .btn-group .glass-btn {
            border: none; /* Removes individual borders */
            border-radius: 0; /* Removes radius */
            border-right: 1px solid var(--glass-border); /* Separator */
            height: 36px; /* Compensate for group border */
            margin: 0;
        }
        .btn-group .glass-btn:last-child { border-right: none; }
        .btn-group:hover { border-color: var(--text-muted); }

        /* 4. REFRESH GROUP SPECIFIC (Red Dot) */
        .refresh-group-wrapper {
            position: relative; /* Anchor for the dot */
            display: inline-flex;
        }
        
        .refresh-group-wrapper.auto-active::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            background-color: #ff0000;
            border-radius: 50%;
            box-shadow: 0 0 6px #ff0000;
            z-index: 10;
            animation: pulse-dot-red 2s infinite;
            pointer-events: none;
        }

       /* 5. FILTER BUTTON SPECIFIC (Merged Fix: Style + Alignment) */
        .filter-main-btn {
            min-width: 120px; 
            position: relative;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .filter-reset-badge {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            flex-shrink: 0 !important; 
            position: static !important; 
            transform: none !important; 
        }
        .filter-reset-badge:hover { 
            background: var(--danger-color); 
            color: white; 
        }
        
        /* --- FOCUS MODE STYLES --- */

        /* Hide UI clutter */
        body.focus-mode .item-info,
        body.focus-mode .selection-checkmark,
        body.focus-mode .file-metadata,
        body.focus-mode .file-scanned-time,
        body.focus-mode .workflow-badge { 
            display: none !important;   
        }

        /* BASE STATE: 100% Scale, 100% Opacity, No filters */
        body.focus-mode .gallery-item {
            border-radius: 4px; /* Sharper corners for pro look */
            border: none;
            transition: none; /* Instant feedback, no lag */
            opacity: 1 !important;
            filter: none !important;
            transform: none !important; /* NO SHRINKING */
            overflow: visible !important; /* Allow border to bleed out */
        }

        /* Hover: Only Z-index change to bring it to top, no movement */
        body.focus-mode .gallery-item:hover {
            z-index: 50;
            outline: 1px solid rgba(255,255,255,0.3); /* Subtle hint */
        }

        /* SELECTED STATE: MASSIVE HIGH-CONTRAST FRAME */
        body.focus-mode .gallery-item.selected {
            /* 
               LAYERED SHADOW TRICK FOR THICK BORDERS:
               1. 0px - 4px:  SOLID WHITE (Contrast layer against dark images/bg)
               2. 4px - 10px: SOLID PRIMARY COLOR (The actual selection indicator)
               3. 10px+:      Drop Shadow (Lift effect)
            */
            box-shadow: 
                0 0 0 4px #ffffff, 
                0 0 0 10px #FF00FF,
                0 10px 40px rgba(0,0,0,0.8);
            
            z-index: 100; /* Must be on top of everything to show the border overlap */
            transform: none !important;
        }
        
        /* Ensure thumbnail fills the card perfectly */
        body.focus-mode .thumbnail-wrapper {
            border-bottom: none;
            height: 100%;
            border-radius: 4px;
        }
        
        /* Active Focus Button Style */
        #focus-mode-btn.active-focus {
            background: rgba(255, 193, 7, 0.2) !important;
            border-color: var(--favorite-color) !important;
            color: var(--favorite-color) !important;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
        }
        
        /* --- FOCUS MODE CHECKMARK (Bottom-Left) --- */
        
        /* 1. Force visibility ONLY when selected */
        body.focus-mode .gallery-item.selected .selection-checkmark {
            display: flex !important;
            
            /* 2. Positioning: Bottom Left */
            left: 8px;
            bottom: 8px;
            right: auto; /* Reset default right position */
            top: auto;
            
            /* 3. Style: White Circle with Fuchsia Icon & Border */
            background-color: #ffffff;
            color: #FF00FF;           /* The Checkmark Color */
            border: 2px solid #FF00FF; /* The Ring Color */
            
            /* 4. Size & Shape */
            width: 28px;
            height: 28px;
            font-size: 16px;
            font-weight: 900; /* Extra Bold Checkmark */
            border-radius: 50%;
            
            /* 5. Polish */
            box-shadow: 0 4px 10px rgba(0,0,0,0.6); /* Drop shadow to pop from image */
            z-index: 101; /* Stay on top of the massive border */
            transform: scale(1);
        }
        
        /* Optional: Hover effect on the checkmark itself */
        body.focus-mode .gallery-item.selected .selection-checkmark:hover {
            transform: scale(1.1);
            cursor: pointer;
        }
        
        /* --- MOBILE LAYOUT OVERRIDES --- */
        .mobile-only { display: none !important; }
        
        @media (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-only { display: flex !important; }

            .toolbar-container {
                padding: 0.5rem 1rem;
                gap: 10px;
            }

            /* ROW 1: Mobile Header (Breadcrumbs + AI Icon) */
            .mobile-header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }
            
            /* ROW 2: Big Actions (Filters | AI Search) */
            .mobile-big-actions {
                display: grid;
                grid-template-columns: 1fr 1fr; /* 50% 50% */
                gap: 10px;
                width: 100%;
            }
            .mobile-big-actions .glass-btn {
                width: 100%;
                justify-content: center;
            }

            /* ROW 3: Icon Toolbar (Scrollable or Grid) */
            .mobile-icon-toolbar {
                display: flex;
                gap: 8px;
                overflow-x: auto;
                /* Increased top padding to 8px to allow the red dot to float without being cut */
                padding: 8px 4px 5px 4px; 
                width: 100%;
                justify-content: space-between;
                /* Ensure overflow doesn't clip the shadow/dot */
                overflow-y: visible; 
            }

            /* Square buttons for mobile toolbar */
            .mobile-icon-toolbar .glass-btn, 
            .mobile-icon-toolbar .btn-group .glass-btn {
                padding: 0;
                width: 40px;
                height: 40px;
                font-size: 1.2rem; /* Larger icons */
            }
            
            /* Exception: Refresh group must contain two small buttons */
            /* Exception: Button Groups (Sort/Refresh) need flexibility */
            .mobile-icon-toolbar .btn-group {
                width: auto;
                flex-shrink: 0;
            }
            
            .mobile-icon-toolbar .btn-group .glass-btn {
                /* CHANGED: Removed fixed width (35px) to allow arrows to fit */
                width: auto !important; 
                min-width: 44px !important; /* Minimum touch target size */
                padding: 0 8px !important;  /* Add padding so arrow isn't glued to edge */
                flex-grow: 0 !important;
            }
            
        }
        
        /* --- LIGHTBOX HELP OVERLAY --- */
        #lightbox-help-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 5000; /* Above Lightbox */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #lightbox-help-overlay.visible {
            display: flex;
            opacity: 1;
        }
        
        /* Ensure keys in help match icon style */
        #lightbox-help-overlay .key {
            font-size: 1.2rem;
            min-width: 40px;
            background: rgba(255,255,255,0.05);
        }
        
        /* --- FIX MOBILE FOLDER SCROLL --- */
        @media (max-width: 1024px) {
            .folder-tree-container {
                /* Limit 40% screen to see the footer */
                max-height: 40vh !important; 
                min-height: 150px !important;
                
                /* enable scroll */
                overflow-y: auto !important; 
                
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid var(--glass-border);
                border-radius: 12px;
                padding: 10px;
                margin-bottom: 20px; 
                
                box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            }
        }
        /* Auto-expand AI button on mobile when Filters are hidden */
        .mobile-big-actions button:only-child {
            grid-column: 1 / -1; /* Span full width */
        }
        
        /* --- COMPARE MODE STYLES --- */
        #compare-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: #050505;
            z-index: 5000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        #compare-overlay.visible { display: flex; }

        .compare-header {
            padding: 10px 20px;
            background: rgba(20, 20, 20, 0.9);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
        }
        
        .compare-stage {
            flex-grow: 1;
            position: relative;
            background-color: #111;
            overflow: hidden;
            cursor: grab;
            user-select: none;
        }
        .compare-stage:active { cursor: grabbing; }

        .cmp-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            pointer-events: none;
        }
        
        .cmp-media-container {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }

        .cmp-content {
            max-width: 90%; max-height: 90%;
            object-fit: contain;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            will-change: transform; /* Performance for sync zoom */
        }

        /* The Slider Mechanism */
        #cmp-after-wrapper {
            clip-path: inset(0 50% 0 0); /* Dynamic via JS */
            z-index: 10;
        }

        /* The Handle */
        .cmp-handle {
            position: absolute;
            top: 0; bottom: 0; left: 50%;
            width: 4px;
            background: var(--primary-color);
            cursor: col-resize;
            z-index: 20;
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            transform: translateX(-50%);
            pointer-events: auto;
        }
        
        .cmp-handle::after {
            content: '↔';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            background: white;
            border: 4px solid var(--primary-color);
            border-radius: 50%;
            color: var(--primary-color);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* Data Panel */
        .compare-info-panel {
            height: 30%;
            min-height: 40px;
            background: var(--surface-color);
            border-top: 2px solid var(--ai-color);
            display: flex; flex-direction: column;
            transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; z-index: 30;
        }
        .compare-info-panel.collapsed { height: 40px; }

        .cmp-info-toggle {
            height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            font-size: 0.9rem; color: var(--text-muted); font-weight: bold; gap: 10px;
        }
        .cmp-info-toggle:hover { color: white; background: rgba(255,255,255,0.1); }

        .cmp-table-container { flex-grow: 1; overflow-y: auto; padding: 0 20px 20px 20px; }

        .cmp-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; color: #ccc; }
        .cmp-table th {
            text-align: left; padding: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
            position: sticky; top: 0; background: var(--surface-color);
        }
        .cmp-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: top; font-family: monospace; word-break: break-all;
        }
        
        .cmp-row-diff { background: rgba(255, 193, 7, 0.05); }
        .cmp-row-diff td { color: #fff; }
        .cmp-row-diff td:first-child { 
            color: var(--favorite-color); font-weight: bold; 
            border-left: 3px solid var(--favorite-color);
        }

        @media (max-width: 768px) {
            .compare-info-panel { height: 40%; }
            .cmp-table { font-size: 0.8rem; }
            .cmp-handle::after { width: 30px; height: 30px; font-size: 16px; }
            /* Hide the word "Mode" on mobile to save space */
            .cmp-mode-text {
                display: none;
            }
            
            /* Reduce padding in compare header */
            .compare-header {
                padding: 5px 10px;
            }
        }
 
        /* Labels over images in Compare Mode */
        .cmp-floating-label {
            position: absolute;
            top: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85rem;
            pointer-events: auto;
            cursor: help; /* Indicates clickable info */
            transition: all 0.2s ease;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 50;
            user-select: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            
            /* Max width constraints */
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cmp-floating-label:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.05);
            border-color: var(--primary-color);
        }
        
        .cmp-floating-label:active {
            transform: scale(0.95);
        }

        /* --- STORYBOARD FULL SCREEN STYLES --- */
        #storyboard-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.95); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.2s;
        }
        #storyboard-overlay.visible { display: flex; opacity: 1; }

        .sb-panel {
            background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px;
            /* FULL SCREEN GRID as requested */
            width: 98vw; height: 95vh; max-width: none; max-height: none;
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.98); transition: transform 0.2s;
        }
        #storyboard-overlay.visible .sb-panel { transform: scale(1); }

        .sb-header {
            padding: 10px 20px; background: var(--surface-hover); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sb-header h3 { margin: 0; font-size: 1.2rem; color: #fff; }

        .sb-body {
            padding: 20px; overflow-y: auto; flex-grow: 1; background: #050505;
            display: flex; flex-direction: column; align-items: center;
        }

        .sb-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 cols */
            gap: 20px; width: 100%; height: 100%;
            /* Auto rows to fit content */
            align-content: start; 
        }

        .sb-frame {
            background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden;
            cursor: zoom-in; position: relative; width: 100%; aspect-ratio: 16/9;
            transition: all 0.2s;
        }
        .sb-frame:hover { border-color: var(--primary-color); transform: scale(1.02); z-index: 5; }
        .sb-frame img { width: 100%; height: 100%; object-fit: contain; display: block; }

        .sb-footer {
            padding: 8px; text-align: center; border-top: 1px solid var(--border-color);
            color: #777; font-size: 0.8rem; background: var(--surface-hover);
        }

        #sb-loader { margin-top: 50px; text-align: center; }

        /* --- ZOOM OVERLAY STYLES --- */
        #sb-zoom-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95); z-index: 4000; /* Above Storyboard */
            display: none; justify-content: center; align-items: center; cursor: zoom-out;
        }
        #sb-zoom-img {
            /* Force image to take up space */
            width: auto;
            height: auto;
            min-width: 50vw;  /* Minimum half screen width */
            max-width: 95vw;
            max-height: 95vh;
            
            /* Clean look */
            object-fit: contain;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            border: 2px solid var(--primary-color);
            background: #000;
        }

        @media (max-width: 768px) {
            .sb-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        }

        /* --- STORYBOARD ZOOM NAVIGATION --- */
        .sb-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4005; /* Must be above the image */
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
            user-select: none;
            /* Safe area for mobile touches */
            padding: 0;
            line-height: 1;
        }

        .sb-nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: white;
            transform: translateY(-50%) scale(1.1);
        }

        .sb-nav-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        #sb-nav-prev { left: 20px; }
        #sb-nav-next { right: 20px; }

        /* Hide nav buttons on very small screens if image covers them, 
           or adjust position. Here we keep them visible as requested. */
        @media (max-width: 768px) {
            .sb-nav-btn {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
                background: rgba(0, 0, 0, 0.7); /* Darker for better visibility on mobile */
            }
            #sb-nav-prev { left: 10px; }
            #sb-nav-next { right: 10px; }
        }
        
        /* --- ZOOM STATUS BADGE --- */
        #sb-zoom-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4005;
            
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 6px 16px;
            
            color: #ddd;
            font-family: monospace;
            font-weight: bold;
            font-size: 1rem;
            letter-spacing: 1px;
            pointer-events: none;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }

        /* Highlight Styles */
        #sb-zoom-status.is-first {
            border-color: var(--success-color);
            color: var(--success-color);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        #sb-zoom-status.is-last {
            border-color: var(--danger-color);
            color: var(--danger-color);
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
        }
        
        /* --- ZOOM QUALITY WARNING --- */
        #sb-zoom-quality-msg {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4005;
            
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 6px 14px;
            
            color: var(--text-muted); /* Grey text to be subtle */
            font-size: 0.8rem;
            font-weight: 500;
            pointer-events: none;
            backdrop-filter: blur(4px);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Hide warning on very small screens if needed, or adjust pos */
        @media (max-width: 768px) {
            #sb-zoom-quality-msg {
                bottom: 80px; /* Move up to avoid overlapping native home bars on mobile */
                font-size: 0.7rem;
            }
        }
        
        /* --- TEMPORARY HIDE COMPARE FEATURE --- */
        
        #compare-selected-btn, /* The Scale Icon in Selection Bar */
        #compare-menu-btn,     /* The Menu Item in the dropdown */
        #compare-menu-sep      /* The Separator line in the menu */
        { 
            /* display: none !important; */
        }
        
        /* --- FORCE HIDE OPTIONS ON MOBILE (Bulletproof) --- */
        @media (max-width: 1024px) {
            .opt-desktop-only {
                display: none !important;
            }
        }
        
        </style>
        
</head>

<body>
    <div id="notification-container"></div>
    <!-- GENERAL OPTIONS POPOVER -->
    <div id="options-popover">
        <!-- Header with Title and Close Button -->
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); margin-bottom: 10px; padding-bottom: 5px;">
            <h4 style="margin: 0; color: var(--text-color);">⚙️ Gallery Options</h4>
            <button onclick="toggleOptionsMenu(event)" title="Close Menu" style="background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 0 5px; transition: color 0.2s;">
                &times;
            </button>
        </div>
        
        <!-- Autoplay Option (Visible Everyone) -->
        <div class="opt-item" id="opt-btn-autoplay" onclick="toggleVideoAutoplay()">
            <div>
                <div class="opt-label" style="display: flex; align-items: center; gap: 8px;">
                    ▶️ Video Autoplay 
                    <span style="font-size: 0.65rem; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); padding: 1px 5px; border-radius: 4px; color: var(--primary-color);">Key: P</span>
                </div>
                <div style="font-size:0.75rem; color:var(--text-muted); line-height: 1.3; margin-top: 4px;">
                    When enabled, videos play automatically on hover (Desktop) or load instantly.<br>
                    <strong>Disable</strong> to save bandwidth/CPU or if scrolling feels choppy.
                </div>
            </div>
            <span class="opt-status" id="opt-status-autoplay" style="align-self: center;">ON</span>
        </div>

        <!-- Separator (Desktop Only via Class) -->
        <div class="opt-desktop-only" style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>

        <!-- Thumbnail Size Option (Desktop Only via Class) -->
        <div class="opt-item opt-desktop-only" id="opt-btn-size" onclick="toggleGridSize()">
            <div>
                <div class="opt-label">🖼️ Thumbnail Size</div>
                <div style="font-size:0.75rem; color:var(--text-muted); line-height: 1.3; margin-top: 4px;">
                    Toggle between <strong>Normal</strong> (320px) and <strong>Compact</strong> (220px) view.<br>
                    Useful for viewing more items at once on smaller screens.
                </div>
            </div>
            <span class="opt-status" id="opt-status-size" style="align-self: center;">NORMAL</span>
        </div>
    </div>
    <!-- AUTO REFRESH SETTINGS POPOVER -->
    <div id="auto-refresh-popover">
        <h4 style="margin:0 0 10px 0; color:var(--primary-color);">🔄 Auto-Watch Folder</h4>
        
        <div class="ar-row">
            <label for="ar-toggle">Enable Auto-Refresh</label>
            <input type="checkbox" id="ar-toggle" style="accent-color:var(--primary-color); transform:scale(1.2);">
        </div>
        
        <div class="ar-row">
            <label for="ar-interval">Interval (seconds):</label>
            <input type="number" id="ar-interval" class="ar-input" value="60" min="5" max="3600">
        </div>
        
        <p style="font-size:0.75rem; color:var(--text-muted); margin:10px 0 0 0;">
            Only refreshes if changes are detected. Paused while viewing images.
        </p>
    </div>
    <aside class="sidebar">
        <div class="sidebar-header">
            <!-- Brand Link (Blocco Unico a Sinistra) -->
            <a href="{{ url_for('gallery_view', folder_key='_root_') }}" class="brand-link">
                <img src="{{ app_logo_b64 }}" alt="Logo" class="brand-logo">
                <div class="brand-info">
                    <h1>SmartGallery</h1>
                    <div class="version-row-header">
                        <span class="v-num">v{{ app_version }}</span>
                        {% if update_available %}
                        <a href="{{ github_url }}" target="_blank" class="header-update-badge" title="Update available">
                            🚀 UPDATE v{{ remote_version }}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </a>

            <!-- Right Actions (Blocco Unico a Destra) -->
            <div class="sidebar-actions">
                <button id="sidebar-minify-btn" title="Minimize Sidebar"><span>◀</span></button>
                <button id="sidebar-expand-btn" title="Expand Sidebar"><span>↔️</span></button>
                <button id="sidebar-toggle-btn" title="Toggle Folders">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span id="sidebar-toggle-text">Folders</span>
                </button>
            </div>
        </div>
        <div class="folder-controls">
            <input type="search" class="folder-search-input" id="folder-search-nav" placeholder="🔍 Search folders...">
            <div class="folder-sort-buttons" id="folder-sort-nav">
                <button data-sort="name" class="active" title="Sort by name">A-Z</button>
                <button data-sort="mtime" title="Sort by date">🗓️</button>
            </div>
        </div>
        <div class="folder-tree-container">
            <ul class="folder-tree" id="folder-tree-nav"></ul>
        </div>
        <button id="create-folder-btn">➕ Create New Folder</button>
        <button id="mount-folder-btn" onclick="openMountModal()">🔗 Link External Folder</button>
        <!-- VERSION & GITHUB FOOTER -->
        <div class="sidebar-footer">
            <!-- Persuasive GitHub Link -->
            <a href="{{ github_url }}" target="_blank" class="github-promo-link" title="Support SmartGallery on GitHub">
                <svg class="gh-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <div class="promo-text">
                    Find this tool useful?<br>
                    <span class="gold-highlight">Support us with a star! ⭐</span>
                </div>
            </a>
        </div>
    </aside>
    
    <div class="main-content">
    <!-- === GLOBAL SORT VARIABLES === -->
    {% set current_sort_by = request.args.get('sort_by', 'date') %}
    {% set current_sort_order = request.args.get('sort_order', 'desc') %}

    <!-- === ROW 1: NAVIGATION & AI MANAGER === -->
    <div class="toolbar-container" style="padding-bottom: 0;">
        <div class="toolbar-row mobile-header-row">
            <!-- Left: Breadcrumbs -->
            <div class="breadcrumbs" style="padding:0; border:none; background:transparent;">
                <div class="breadcrumb-links" style="{% if (is_ai_search and ' ||| ' not in ai_query) or is_global_search %}display:none;{% endif %}">
                    {% for crumb in breadcrumbs %}
                    <a href="{{ url_for('gallery_view', folder_key=crumb.key) }}">{{ crumb.display_name }}</a>
                    {% if not loop.last %}<span>/</span>{% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Right: Desktop Tools Group (Options -> Shortcuts -> Focus -> AI) -->
            <div class="push-right desktop-only" style="display:flex; align-items:center; gap:8px;">
                
                <!-- 0. Options Menu -->
                <button type="button" id="options-btn-desk" onclick="toggleOptionsMenu(event)" class="glass-btn" title="Configuration" style="height: 42px; display: inline-flex; align-items: center; justify-content: center;">
                    <span style="font-size:1.1rem;">⚙️</span>
                </button>

                <!-- 1. Shortcuts Help -->
                <button type="button" onclick="showShortcutsHelp()" class="glass-btn" title="View Keyboard Shortcuts" style="height: 42px; display: inline-flex; align-items: center; justify-content: center;">
                    <span style="font-weight:900; margin-right:5px;">?</span> Shortcuts
                </button>

                <!-- 2. Focus Mode -->
                <button type="button" id="focus-mode-btn" class="glass-btn" onclick="toggleFocusMode()" title="Minimal UI, maximum density. Keyboard-first workflow." style="height: 42px; display: inline-flex; align-items: center; justify-content: center;">
                    <span style="margin-right:5px;">⚡</span> Focus Mode
                </button>

                <!-- 3. AI Manager (If enabled) -->
                {% if enable_ai_search %}
                <button class="glass-btn active-fuxia" id="ai-manager-btn-desk" onclick="toggleAiManager(true)" style="height: 42px; display: inline-flex; align-items: center; justify-content: center;">
                    <span style="margin-right:5px;">🧠</span> AI Manager
                </button>
                {% endif %}
            </div>

            <!-- Mobile Only: Small AI Button (Keep existing) -->
            {% if enable_ai_search %}
            <button class="glass-btn active-fuxia mobile-only push-right" id="ai-manager-btn-mob" onclick="toggleAiManager(true)" style="width:40px; padding:0;">
                🧠
            </button>
            {% endif %}
            <!-- Mobile Options Button -->
            <button class="glass-btn mobile-only push-right" id="options-btn-mob" onclick="toggleOptionsMenu(event)" style="width:40px; padding:0; margin-left:5px;">
                ⚙️
            </button>
        </div>
    </div>

    <!-- === DESKTOP TOOLBAR (Row 2) === -->
    <div class="toolbar-container desktop-only">
        <div class="toolbar-row">
            
            <!-- Filters Button (Hidden during AI Search) -->
            {% if not is_ai_search %}
            <button type="button" id="search-toggle-desktop" class="glass-btn filter-main-btn {% if active_filters_count > 0 %}active-blue{% endif %}">
                🔍 Filters {% if active_filters_count > 0 %}({{ active_filters_count }}){% endif %}
                {% if active_filters_count > 0 %}
                    <span class="filter-reset-icon filter-reset-badge" title="Clear all filters">✕</span>
                {% endif %}
            </button>
            {% endif %}

            {% if enable_ai_search %}
            <button type="button" id="ai-search-toggle-desktop" class="glass-btn {% if is_ai_search %}active-fuxia{% endif %}">
                ✨ AI Search
            </button>
            {% endif %}

            <div style="display:flex; gap:10px; margin-left:20px;">
                {% if not is_global_search and not (is_ai_search and ' ||| ' not in ai_query) %}
                <button type="button" id="show-upload-modal-btn" class="glass-btn">📤 Upload</button>
                <button type="button" id="rescan-folder-btn" class="glass-btn">♻️ Rescan</button>
                
                <div class="refresh-group-wrapper" id="refresh-container">
                    <div class="btn-group">
                        <button type="button" id="refresh-btn" class="glass-btn" title="Manual Refresh">🔃 Refresh</button>
                        <button type="button" id="refresh-options-btn" class="glass-btn" title="Auto-Refresh Options">⋮</button>
                    </div>
                    <div id="auto-refresh-popover">
                        <h4 style="margin:0 0 10px 0; color:var(--success-color);">⏱️ Auto-Watch</h4>
                        <div class="ar-row">
                            <label for="ar-toggle">Enable Watch</label>
                            <input type="checkbox" id="ar-toggle" style="accent-color:var(--success-color);">
                        </div>
                        <div class="ar-row" style="margin-top:8px;">
                            <label for="ar-interval">Seconds:</label>
                            <input type="number" id="ar-interval" class="ar-input" value="10" min="5" max="3600">
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="push-right toolbar-row" style="gap:10px;">
                <span class="file-count-badge">
                    {% if is_ai_search or is_global_search %}
                        🔍 {{ total_files }} Result{% if total_files != 1 %}s{% endif %}
                        <span style="opacity: 0.6; margin-left: 5px;">(of {{ total_db_files }} Total)</span>
                    {% else %}
                        📂 {{ total_files }} File{% if total_files != 1 %}s{% endif %}
                        {% if total_files != total_folder_files %}
                            <span style="opacity: 0.6; margin-left: 5px;">(of {{ total_folder_files }})</span>
                        {% endif %}
                    {% endif %}
                </span>
                
                <button type="button" id="toggle-select-btn" class="glass-btn toggle-select-all-btn" onclick="toggleSelectAll()">
                    ✅ Select All
                </button>
                
                {% if not is_ai_search %}
                <div class="btn-group">
                    <button type="button" onclick="applySort('date')" class="glass-btn {% if current_sort_by == 'date' %}active-blue{% endif %}">
                       📅 Date {% if current_sort_by == 'date' %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                    </button>
                    <button type="button" onclick="applySort('name')" class="glass-btn {% if current_sort_by == 'name' %}active-blue{% endif %}">
                       🔤 Name {% if current_sort_by == 'name' %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- === MOBILE TOOLBAR (Optimized for AI toggle) === -->
    <div class="toolbar-container mobile-only">
        
        <!-- Row 2: Metadata & Conditional Filter Button -->
        <div class="mobile-meta-row">
            {% if not enable_ai_search %}
                <!-- If AI is disabled, show Filters button here next to the badge -->
                <button type="button" id="mobile-filter-toggle" class="glass-btn filter-main-btn {% if active_filters_count > 0 %}active-blue{% endif %}">
                    🔍 Filters {% if active_filters_count > 0 %}({{ active_filters_count }}){% endif %}
                    {% if active_filters_count > 0 %}<span class="filter-reset-icon filter-reset-badge">✕</span>{% endif %}
                </button>
            {% endif %}

            <span class="file-count-badge">
                {% if is_ai_search or is_global_search %}
                    🔍 {{ total_files }} Result{% if total_files != 1 %}s{% endif %}
                    <span style="opacity: 0.6; margin-left: 5px; font-weight: normal;">(of {{ total_db_files }})</span>
                {% else %}
                    📂 {{ total_files }} File{% if total_files != 1 %}s{% endif %}
                    {% if total_files != total_folder_files %}
                        <span style="opacity: 0.6; margin-left: 5px; font-weight: normal;">(of {{ total_folder_files }})</span>
                    {% endif %}
                {% endif %}
            </span>
        </div>
        
        <!-- Row 3: Big Actions (Only if AI is enabled) -->
        {% if enable_ai_search %}
        <div class="mobile-big-actions">
            <!-- Filters Button (Hidden during AI Search) -->
            {% if not is_ai_search %}
            <button type="button" id="mobile-filter-toggle" class="glass-btn filter-main-btn {% if active_filters_count > 0 %}active-blue{% endif %}">
                🔍 Filters {% if active_filters_count > 0 %}({{ active_filters_count }}){% endif %}
                {% if active_filters_count > 0 %}<span class="filter-reset-icon filter-reset-badge">✕</span>{% endif %}
            </button>
            {% endif %}
            
            <button type="button" id="ai-search-toggle-mobile" class="glass-btn {% if is_ai_search %}active-fuxia{% endif %}">
                ✨ AI Search
            </button>
        </div>
        {% endif %}

        <!-- Row 4: Icon Toolbar (Horizontal Scroll) -->
        <div class="mobile-icon-toolbar">
            <button type="button" onclick="document.getElementById('show-upload-modal-btn').click()" class="glass-btn" title="Upload">📤</button>
            <button type="button" onclick="document.getElementById('rescan-folder-btn').click()" class="glass-btn" title="Rescan">♻️</button>
            
            <div class="refresh-group-wrapper" id="refresh-container-mob">
                <div class="btn-group">
                    <button type="button" onclick="startSyncProcess(true)" class="glass-btn">🔃</button>
                    <button type="button" onclick="toggleAutoRefreshMenu(event)" class="glass-btn">⋮</button>
                </div>
            </div>

            <button type="button" class="glass-btn toggle-select-all-btn" onclick="toggleSelectAll()">✅</button>
            
            {% if not is_ai_search %}
            <div class="btn-group">
                <button type="button" onclick="applySort('date')" class="glass-btn {% if current_sort_by == 'date' %}active-blue{% endif %}">
                   📅 {% if current_sort_by == 'date' %}<span style="font-size:0.7em;">{{ '↑' if current_sort_order == 'asc' else '↓' }}</span>{% endif %}
                </button>
                <button type="button" onclick="applySort('name')" class="glass-btn {% if current_sort_by == 'name' %}active-blue{% endif %}">
                   🔤 {% if current_sort_by == 'name' %}<span style="font-size:0.7em;">{{ '↑' if current_sort_order == 'asc' else '↓' }}</span>{% endif %}
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- === BANNERS === -->
    {% if is_ai_search %}
    <div class="ai-banner">
        <div class="ai-banner-title" id="ai-banner-text" data-raw-query="{{ ai_query }}"><span>🧠</span> Loading AI Results...</div>
        <div class="ai-banner-actions">
            <button onclick="openAiSearchModal()" style="margin-right: 8px;">✏️ Edit</button>
            <button onclick="window.location.href='{{ url_for('gallery_view', folder_key=current_folder_key) }}'">Exit AI Mode</button>
        </div>
    </div>
    {% endif %}

    {% if is_global_search and not is_ai_search %}
   <!-- Element hidden for future use -->
    <div class="global-search-banner" style="display: none !important;">
        <div class="ai-banner-title"><span class="ai-scope-part"><span>🌐</span> Global Search Results</span><span class="ai-query-part">Showing all matches</span></div>
        <div class="ai-banner-actions"><button onclick="window.location.href='{{ url_for('gallery_view', folder_key=current_folder_key) }}'">Exit Global Search</button></div>
    </div>
    {% endif %}

    <!-- === FILTER PANEL (FULL FORM) === -->
    {% if not is_ai_search %}
    <div class="search-overlay-panel" id="desktop-search-panel">
        <form method="GET" action="{{ url_for('gallery_view', folder_key=current_folder_key) }}" id="filter-form">
            <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
            <input type="hidden" name="sort_order" value="{{ current_sort_order }}">
            
            <div class="filter-form-grid">
                <!-- Search Scope -->
                <div class="filter-group">
                    <label>Search Scope</label>
                    <div class="scope-options">
                        <label class="scope-label {% if current_scope == 'local' %}active{% endif %}">
                            <input type="radio" name="scope" value="local" {% if current_scope == 'local' %}checked{% endif %}> 📂 Current Folder
                        </label>
                        <label class="scope-label {% if current_scope == 'global' %}active{% endif %}">
                            <input type="radio" name="scope" value="global" {% if current_scope == 'global' %}checked{% endif %}> 🌐 Global (All)
                        </label>
                    </div>
                    <label class="recursive-wrapper {% if request.args.get('recursive') == 'true' %}active{% endif %}" id="recursive-standard-ui">
                        <input type="checkbox" name="recursive" value="true" {% if request.args.get('recursive') == 'true' %}checked{% endif %} onchange="this.parentElement.classList.toggle('active', this.checked)">
                        <span class="recursive-label">📂 Include Subfolders</span>
                    </label>
                </div>
                
                <div class="filter-group"><label>🔍 Search by Name</label><input type="text" name="search" placeholder="Search files..." value="{{ request.args.get('search', '') }}"></div>
                <div class="filter-group"><label>⚙️ Workflow Files</label><input type="text" name="workflow_files" placeholder="Models, LoRAs..." value="{{ request.args.get('workflow_files', '') }}"></div>
                <div class="filter-group"><label>🎨 Prompt Keywords</label><input type="text" name="workflow_prompt" placeholder="Prompts..." value="{{ request.args.get('workflow_prompt', '') }}"></div>

                <div class="filter-group">
                    <label>📄 Extensions</label>
                    <div class="c-multi-select" id="wrapper-extensions">
                        <button type="button" class="c-select-trigger" onclick="toggleCustomDropdown(event, 'dropdown-extensions')">
                            <span class="trigger-text">Select extensions...</span>
                            <span class="c-select-counter" id="count-extensions">0</span>
                        </button>
                        <div class="c-dropdown-menu" id="dropdown-extensions"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>🏷️ Prefixes</label>
                    <div id="prefix-warning-container" class="limit-warning-box" style="display: {% if prefix_limit_reached %}flex{% else %}none{% endif %};"><span class="limit-warning-icon">⚠️</span><span>Too many prefixes.</span></div>
                    <div class="c-multi-select" id="wrapper-prefixes" style="display: {% if prefix_limit_reached %}none{% else %}block{% endif %};">
                        <button type="button" class="c-select-trigger" onclick="toggleCustomDropdown(event, 'dropdown-prefixes')">
                            <span class="trigger-text">Select prefixes...</span>
                            <span class="c-select-counter" id="count-prefixes">0</span>
                        </button>
                        <div class="c-dropdown-menu" id="dropdown-prefixes"></div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>📅 Date Range</label>
                    <div class="date-row" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 140px;"><label style="font-size: 0.7rem;">From:</label><input type="date" name="start_date" id="start-date" value="{{ request.args.get('start_date', '') }}"></div>
                        <div style="flex: 1; min-width: 140px;"><label style="font-size: 0.7rem;">To:</label><input type="date" name="end_date" id="end-date" value="{{ request.args.get('end_date', '') }}"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>Options</label>
                    <div class="filter-group-inline"><input type="checkbox" name="favorites" id="favorites-check" value="true" {% if request.args.get('favorites') == 'true' %}checked{% endif %}><label for="favorites-check">⭐ Favorites Only</label></div>
                    <div class="filter-group-inline"><input type="checkbox" name="no_workflow" id="no-workflow-check" value="true" {% if request.args.get('no_workflow') == 'true' %}checked{% endif %}><label for="no-workflow-check">🚫 No Workflow</label></div>
                     <!-- No AI Caption (Only if AI is enabled) -->
                    {% if enable_ai_search %}
                    <div class="filter-group-inline">
                        <input type="checkbox" name="no_ai_caption" id="no-ai-check" value="true" {% if request.args.get('no_ai_caption') == 'true' %}checked{% endif %}>
                        <label for="no-ai-check">🧠 Missing AI Caption</label>
                    </div>
                    {% endif %}
                </div>
                
                <div class="filter-group">
                    <label>Actions</label>
                     <div class="filter-actions-row">
                        <!-- Submit Button (Primary) -->
                        <button type="submit" class="glass-btn">
                            🔍 Apply Filters
                        </button>
                        <!-- Reset Button (Secondary) -->
                        <a href="{{ url_for('gallery_view', folder_key=current_folder_key) }}" class="glass-btn btn-reset">
                            🗑️ Reset Filters
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
    {% endif %}
    
        <div id="gallery-anchor"></div>
        <main class="gallery-container" id="gallery-container"></main>
        <!-- Load More Button with Logic Check -->
        <div id="load-more-container" {% if total_files <= files|length %}style="display:none;"{% endif %}>
            <button id="load-more-btn">
                <span>Load More / Scroll Down</span>
                <svg class="arrow-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
                </svg>
            </button>
        </div>
    </div>
    <!-- Beautiful Go To Top Button -->
    <button onclick="scrollToTop()" id="backToTopBtn" title="Back to Top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 15l-6-6-6 6"/>
        </svg>
    </button>
    <div id="drag-drop-overlay"></div>
    <div id="drop-zone-panel">
        <h3>📁 Move to Folder:</h3>
        <div class="folder-controls" style="padding: 0 1rem; margin-top: 1rem;">
            <input type="search" class="folder-search-input" id="folder-search-move" placeholder="🔍 Search folders...">
            <div class="folder-sort-buttons" id="folder-sort-move"><button data-sort="name"
                    class="active">A-Z</button><button data-sort="mtime">🗓️</button></div>
        </div>
        <div id="drop-zone-folders">
            <div class="folder-tree-container" style="padding: 1rem;">
                <ul class="folder-tree" id="move-folder-tree"></ul>
            </div>
        </div>
        <button id="cancel-drop-btn">❌ Cancel</button>
    </div>
    <!-- MODERN SELECTION BAR -->
    <div id="selection-bar">
        <!-- Left: Context -->
        <div class="sel-bar-left">
            <button id="deselect-all-btn" class="sel-btn close-x" title="Clear Selection">✕</button>
            <span id="selection-counter">0 Selected</span>
        </div>

        <!-- Right: Primary Actions -->
        <div class="sel-bar-actions">
            <!-- Range Select -->
            <button id="range-select-btn" class="sel-btn" title="Select Range between files" style="display:none; color: var(--ai-color);">↔️</button>
            <!-- Favorite (Quick Access) -->
            <button id="favorite-selected-btn" class="sel-btn" title="Add to Favorites">⭐</button>
            
            <!-- Delete (Always visible for speed) -->
            <button id="delete-selected-btn" class="sel-btn danger" title="Delete Selected">🗑️</button>
            
            <!-- More Menu Trigger -->
            <button class="sel-btn" onclick="toggleSelMenu()" title="More Actions">⋮</button>
        </div>

        <!-- Hidden Drop-up Menu -->
        <div class="sel-more-menu" id="sel-more-menu">
            {% if enable_ai_search %}
            <button id="index-selected-btn" onclick="indexSelectedFiles()">🧠 Index AI Data</button>
            <div class="sel-separator"></div>
            {% endif %}
            <button id="compare-menu-btn" onclick="startCompareMode()" style="display:none;">⚖️ Compare</button>
            <div id="compare-menu-sep" class="sel-separator" style="display:none;"></div>
            <button id="copy-selected-btn">Cc Copy to Folder...</button>
            <button id="move-selected-btn">📁 Move to Folder...</button>
            <button id="download-zip-btn">📦 Download as Zip</button>
            <button id="unfavorite-selected-btn">☆ Remove Favorite</button>
            
            <div class="sel-separator"></div>
            <button id="select-all-btn">✅ Select All Files</button>
        </div>
    </div>
    <div id="lightbox-overlay">
        <div id="lightbox-header">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <div id="lightbox-title"></div>
                <div id="lightbox-folder-name" style="margin-top:0.2rem;"></div>
            </div>
            
            <div id="lightbox-toolbar">
                <button id="lightbox-zoom-out" title="Zoom Out">-</button>
                <button id="lightbox-zoom-in" title="Zoom In">+</button>
                
                {% if enable_ai_search %}
                <button id="lightbox-index-btn" title="Force AI Re-Indexing" onclick="indexCurrentLightboxFile()" style="border-color:var(--ai-color); color:var(--ai-color);">⚡</button>
                <button id="lightbox-reset-ai-btn" title="Erase AI Data Only" onclick="resetAiDataCurrentLightbox()" style="border-color:var(--danger-color); color:var(--danger-color); display:none;">❌</button>
                {% endif %}
                
                <a id="lightbox-download" href="#" title="Download File">💾</a>
                <button id="lightbox-rename-btn" title="Rename File">✏️</button>
                <button id="lightbox-summary-btn" title="Node Summary">📝</button>
                <button id="lightbox-caption-icon" title="View AI Caption" style="display:none;">🧠</button>
                <a id="lightbox-workflow" href="#" class="workflow-btn" title="Download Workflow">⚙️</a>
                <button id="lightbox-filmstrip-btn" title="Generate Storyboard" onclick="openStoryboard(null)" style="display:none;">🎞️</button>
                <button id="lightbox-copy-json" title="Copy Workflow to Clipboard" style="display:none;">📋</button>
                <button id="lightbox-delete-btn" title="Delete File">🗑️</button>
                <a id="lightbox-new-tab" href="#" target="_blank" title="Open in New Tab">↗️</a>
                <button id="lightbox-help-btn" title="Toolbar Help" style="font-size: 0.8rem; padding: 0 10px !important; min-width: auto !important;">HELP</button>
                <button class="close-btn" onclick="closeLightbox()" title="Close">×</button>
            </div>
        </div>

        <div id="lightbox-content">
            <div id="lightbox-media"></div>
                        <!-- NEW: Toggle Button Below Image -->
            <div id="lightbox-bottom-controls">
                <button id="lightbox-ui-toggle" onclick="toggleLightboxUi()" title="Hide Toolbar">
                    👁️ <span>Hide Toolbar</span>
                </button>
            </div>

            <div id="lightbox-ai-caption"></div>
        </div>

        <button id="lightbox-prev" class="lightbox-nav">‹</button>
        <button id="lightbox-next" class="lightbox-nav">›</button>

        <!-- Shortcuts Bar (Hidden on mobile) -->
        <div id="lightbox-shortcuts">
            <div class="kb-group"><span class="kb-key">←</span><span class="kb-key">→</span><span>Nav</span></div>
            <div class="kb-separator"></div>
            <div class="kb-group"><span class="kb-key">+</span><span class="kb-key">-</span><span>Zoom</span></div>
            <div class="kb-separator"></div>
            <div class="kb-group"><span class="kb-key">N</span><span>Nodes</span></div>
            <div class="kb-separator"></div>
            <div class="kb-group"><span class="kb-key">W</span><span>Workflow</span></div>
            <div class="kb-separator"></div>
            <div class="kb-group"><span class="kb-key">C</span><span>Copy</span></div>
            <div class="kb-separator"></div>
            <div class="kb-group"><span class="kb-key">D</span><span>Delete</span></div>
            <div class="kb-separator"></div>
            <div class="kb-group"><span class="kb-key">H</span><span>Toggle UI</span></div>
            <div class="kb-separator"></div>
            <div class="kb-group"><span class="kb-key">Esc</span><span>Close</span></div>
        </div>
    </div>
    <div id="node-summary-overlay">
        <div class="node-summary-panel">
            <div class="node-summary-header">
                <h2>📝 Node Summary</h2><button class="close-btn" id="close-summary-btn">×</button>
            </div>
            <div id="node-summary-content"></div>
        </div>
    </div>
    <!-- LIGHTBOX TOOLBAR HELP OVERLAY -->
    <div id="lightbox-help-overlay" class="modal-overlay">
        <div class="shortcuts-panel" style="max-width: 500px;">
            <div class="shortcuts-header">
                <h2>ℹ️ Toolbar Legend</h2>
                <button class="close-btn" onclick="closeLightboxHelp()">x</button>
            </div>
            <div class="shortcuts-content" style="grid-template-columns: 1fr;">
                <div class="shortcut-item"><span class="key">-</span> / <span class="key">+</span> <span class="desc">Zoom Out / Zoom In</span></div>
                {% if enable_ai_search %}
                <div class="shortcut-item"><span class="key" style="color:var(--ai-color)">⚡</span> <span class="desc">Force AI Re-Indexing (Vision Analysis)</span></div>
                <div class="shortcut-item"><span class="key" style="color:var(--danger-color)">❌</span> <span class="desc">Erase AI Data (Captions/Embeddings)</span></div>
                {% endif %}
                <div class="shortcut-item"><span class="key">💾</span> <span class="desc">Download Media File</span></div>
                <div class="shortcut-item"><span class="key">✏️</span> <span class="desc">Rename File (Keep extension)</span></div>
                <div class="shortcut-item"><span class="key">📝</span> <span class="desc">View Node Summary (Parameters)</span></div>
                <div class="shortcut-item"><span class="key">🎞️</span> <span class="desc">Generate Video Storyboard</span></div>
                <div class="shortcut-item"><span class="key" style="color:var(--ai-color)">🧠</span> <span class="desc">Show/Hide AI Generated Caption</span></div>
                <div class="shortcut-item"><span class="key">⚙️</span> <span class="desc">Download Workflow JSON</span></div>
                <div class="shortcut-item"><span class="key">📋</span> <span class="desc">Copy Workflow to Clipboard</span></div>
                <div class="shortcut-item"><span class="key">🗑️</span> <span class="desc">Delete File</span></div>
                <div class="shortcut-item"><span class="key">↗️</span> <span class="desc">Open Full-res in New Tab</span></div>
                <div class="shortcut-item"><span class="key">👁️</span> <span class="desc">Hide/Show UI (Clean View)</span></div>
            </div>
            <div style="padding: 15px; text-align: center; border-top: 1px solid var(--border-color);">
                <button class="glass-btn active-blue" style="width: 100%;" onclick="closeLightboxHelp()">Close Help</button>
            </div>
        </div>
    </div>
    <div id="upload-overlay">
        <div id="upload-panel">
            <div class="upload-header">
                <h2>Upload Files</h2>
                <p id="upload-destination-text">Upload to: <strong></strong></p>
            </div>
            <div class="upload-body"><input type="file" id="upload-file-input" multiple>
                <div id="drop-zone">
                    <p>Drag & Drop files here</p><button type="button" id="file-upload-btn">Or select files...</button>
                </div>
                <ul id="file-list"></ul>
                <div id="upload-progress-container">
                    <div id="upload-progress-bar">
                        <div id="upload-progress-fill"></div>
                    </div>
                </div>
            </div>
            <div class="upload-footer"><button type="button" id="upload-cancel-btn">Cancel</button><button type="button"
                    id="upload-submit-btn">Upload</button></div>
        </div>
    </div>
    <div id="sync-overlay">
        <div id="sync-panel">
            <h3 id="sync-message">Scanning...</h3>
            <div id="sync-progress-bar">
                <div id="sync-progress-fill"></div>
            </div>
        </div>
    </div>
    <!-- AI INDEXING OPTIONS MODAL -->
    <div id="ai-options-modal">
        <div class="ai-options-panel">
            <div class="ai-opt-header"><span>🧠</span> Indexing Options</div>
            
            <div class="ai-path-preview" id="ai-opt-path">...</div>
            
            <!-- SECTION A: Standard Controls (For new folders, or re-indexing implicit ones) -->
            <div id="ai-opt-standard-controls">
                
                <!-- Implicit Watch Message (Hidden by default) -->
                <div id="ai-opt-implicit-msg" style="display:none; background:rgba(0, 123, 255, 0.1); border:1px solid var(--primary-color); padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9rem; color:#ccc;">
                    👁️ This folder is monitored by a <strong>Parent Folder</strong>.<br>
                    You can force a re-index here, but watch settings are managed by the parent.
                </div>

                <!-- Recursive Option -->
                <div class="ai-opt-row">
                    <label for="ai-opt-recursive" style="cursor:pointer; font-weight:bold;">Include Subfolders</label>
                    <input type="checkbox" id="ai-opt-recursive" style="width:20px; height:20px; accent-color:var(--ai-color);">
                </div>
                <span class="ai-opt-desc">If checked, processes all nested folders.</span>

                <!-- Watch Option (Container to hide it easily) -->
                <div id="ai-opt-watch-container">
                    <div class="ai-opt-row">
                        <label for="ai-opt-watch" style="cursor:pointer; font-weight:bold;">Add to Watch List</label>
                        <input type="checkbox" id="ai-opt-watch" style="width:20px; height:20px; accent-color:var(--success-color);">
                    </div>
                    <span class="ai-opt-desc">Monitor for new files in the future.</span>
                </div>

                <!-- Force Option -->
                <div class="ai-opt-row" style="margin-top:10px;">
                    <label for="ai-opt-force" style="cursor:pointer; font-weight:bold;">Force Re-Index</label>
                    <input type="checkbox" id="ai-opt-force" style="width:20px; height:20px; accent-color:var(--danger-color);">
                </div>
                <span class="ai-opt-desc">Reprocess files even if they already have AI data.</span>
            </div>

            <!-- SECTION B: Explicitly Watched Controls (Only for Root Watch Folders) -->
            <div id="ai-opt-watched-controls" style="display:none;">
                <p style="color:var(--favorite-color); font-weight:bold; margin-top:0;">👁️ This folder is explicitly monitored.</p>
                <p style="font-size:0.9rem; color:#ccc;">You cannot add it again, but you can stop monitoring it.</p>
                
                <button class="nav-btn" onclick="stopWatchingFromModal()" 
                        style="background:var(--danger-color); color:white; width:100%; margin-top:10px; border:1px solid var(--danger-color);">
                    🚫 Stop Watching & Remove
                </button>
            </div>

            <div class="ai-opt-actions" style="justify-content: space-between; margin-top: 20px;">
                <!-- Left Side: Erase -->
                <button class="nav-btn nav-btn-danger-outline" onclick="confirmAiReset()">🗑️ Erase AI Data</button>
                
                <!-- Right Side: Standard Actions -->
                <div style="display:flex; gap:10px;">
                    <button class="nav-btn nav-btn-cancel" onclick="closeAiOptions()">Cancel</button>
                    <button id="ai-opt-start-btn" class="nav-btn nav-btn-primary" onclick="confirmAiIndex()" style="background:var(--ai-gradient);">Start Indexing</button>
                </div>
            </div>
        </div>
    </div>
    <!-- AI MANAGER OVERLAY (Nuovo) -->
    <div id="ai-manager-overlay">
        <div class="ai-manager-panel">
            <div class="ai-manager-header">
                <h2>🧠 AI Indexing Manager</h2>
                <button class="ai-manager-close" onclick="toggleAiManager(false)">×</button>
            </div>
            <div class="ai-manager-tabs">
                <button class="ai-tab-btn active" onclick="switchAiTab('queue')">Queue & Status</button>
                <button class="ai-tab-btn" onclick="switchAiTab('watched')">Watched Folders</button>
                <button class="ai-tab-btn" onclick="switchAiTab('settings')">Settings</button>
            </div>
            <div class="ai-manager-content">
                <!-- TAB: QUEUE -->
                <div id="ai-tab-queue" class="ai-tab-content active">
                    
                    <div id="ai-gpu-warning" class="gpu-warning">
                        <span>⚠️ <strong>GPU High Load!</strong> Paused to protect ComfyUI generation. Will resume automatically.</span>
                    </div>

                   <div class="ai-status-bar">
                        <div class="ai-stat-item">
                            <!-- Wrap text and dots in a flex container for alignment -->
                            <div style="display:flex; align-items:center; justify-content:center;">
                                <span class="ai-stat-val" id="ai-stat-status">Idle</span>
                                <!-- Animated Dots Container -->
                                <div id="ai-status-anim" class="ai-working-dots" style="display:none;">
                                    <div class="ai-dot"></div>
                                    <div class="ai-dot"></div>
                                    <div class="ai-dot"></div>
                                </div>
                            </div>
                            <span class="ai-stat-lbl">Status</span>
                        </div>
                        <div class="ai-stat-item">
                            <span class="ai-stat-val" id="ai-stat-pending">0</span>
                            <span class="ai-stat-lbl">Total Pending</span>
                        </div>
                         <div class="ai-stat-item">
                            <span class="ai-stat-val" id="ai-stat-time">0s</span>
                            <span class="ai-stat-lbl">Avg Time/File</span>
                        </div>
                    </div>

                    <div class="ai-progress-wrapper">
                        <div class="ai-progress-text">
                            <span id="ai-current-file">No active job</span>
                            <span id="ai-progress-percent">0%</span>
                        </div>
                        <div class="ai-progress-track">
                            <div class="ai-progress-fill" id="ai-progress-bar"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.8rem; font-weight:bold; color:var(--text-muted);">UP NEXT (Preview):</label>
                        <div id="ai-queue-preview" class="ai-queue-list-container">
                            <div style="padding:10px; text-align:center; color:#555;">Queue empty</div>
                        </div>
                    </div>

                    <div class="ai-controls-row">
                        <!-- Combined Toggle Button -->
                        <button id="ai-toggle-pause" class="state-running" onclick="toggleAiPause()">
                            ⏸ Pause
                        </button>
                        
                        <button class="ai-btn-action ai-btn-danger" onclick="controlAiQueue('clear')">🗑 Clear Queue</button>
                    </div>
                </div>
                <!-- TAB: WATCHED -->
                <div id="ai-tab-watched" class="ai-tab-content">
                    <p style="color:var(--text-muted)">Folders monitored for auto-indexing:</p>
                    <div id="watched-folders-list" style="border:1px solid var(--border-color); border-radius:8px; overflow:hidden;">
                        <div style="padding:20px; text-align:center;">Loading...</div>
                    </div>
                </div>
                <!-- TAB: SETTINGS -->
                <!-- TAB: SETTINGS -->
                <div id="ai-tab-settings" class="ai-tab-content">
                    <div class="ai-settings-grid">
                        
                        <!-- Precision Setting -->
                        <div class="ai-options-group">
                            <div class="ai-group-title">⚡ Precision Mode</div>
                            <div class="ai-group-desc">
                                Select calculation accuracy. Use <strong>FP16</strong> for speed (recommended for RTX cards). Use <strong>FP32</strong> only for compatibility.
                            </div>
                            
                            <div class="ai-radio-grid">
                                <!-- Option 1: FP16 -->
                                <label>
                                    <input type="radio" name="ai_precision" value="fp16" class="ai-radio-input" checked>
                                    <div class="ai-radio-card">
                                        <div class="ai-check-icon">✓</div>
                                        <span class="ai-opt-name">FP16</span>
                                        <span class="ai-opt-sub">Half Precision</span>
                                        <span class="ai-opt-sub" style="color:var(--success-color); margin-top:4px;">Recommended</span>
                                    </div>
                                </label>
                                
                                <!-- Option 2: FP32 -->
                                <label>
                                    <input type="radio" name="ai_precision" value="fp32" class="ai-radio-input">
                                    <div class="ai-radio-card">
                                        <div class="ai-check-icon">✓</div>
                                        <span class="ai-opt-name">FP32</span>
                                        <span class="ai-opt-sub">Full Precision</span>
                                        <span class="ai-opt-sub" style="color:var(--text-muted); margin-top:4px;">Slower / Safe</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Beams Setting -->
                        <div class="ai-options-group">
                            <div class="ai-group-title">🎯 Analysis Depth (Beams)</div>
                            <div class="ai-group-desc">
                                Controls how many variations the AI explores. Higher values catch more details but are slower.
                            </div>
                            
                            <div class="ai-radio-grid">
                                <!-- Beam 3 (First Option) -->
                                <label>
                                    <input type="radio" name="ai_beams" value="3" class="ai-radio-input" checked>
                                    <div class="ai-radio-card">
                                        <div class="ai-check-icon">✓</div>
                                        <span class="ai-opt-name">3 Beams</span>
                                        <span class="ai-opt-sub">Best Quality</span>
                                        <span class="ai-opt-sub" style="color:var(--ai-color); margin-top:4px;">Slowest</span>
                                    </div>
                                </label>

                                <!-- Beam 2 -->
                                <label>
                                    <input type="radio" name="ai_beams" value="2" class="ai-radio-input">
                                    <div class="ai-radio-card">
                                        <div class="ai-check-icon">✓</div>
                                        <span class="ai-opt-name">2 Beams</span>
                                        <span class="ai-opt-sub">Balanced</span>
                                    </div>
                                </label>

                                <!-- Beam 1 (Last Option) -->
                                <label>
                                    <input type="radio" name="ai_beams" value="1" class="ai-radio-input">
                                    <div class="ai-radio-card">
                                        <div class="ai-check-icon">✓</div>
                                        <span class="ai-opt-name">1 Beam</span>
                                        <span class="ai-opt-sub">Fastest</span>
                                        <span class="ai-opt-sub" style="color:var(--text-muted); margin-top:4px;">Less Detail</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- AI Search Modal -->
    <div id="ai-search-overlay">
        <div class="ai-modal-panel">
            <button class="ai-modal-close" id="ai-modal-close">×</button>
            <div class="ai-modal-header">
                <h2>🧠 Semantic Search</h2>
                <p style="color: #ccc; margin-top: 5px;">Powered by SmartGallery AI</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div class="ai-search-options-row">
                    <div style="flex:1;">
                        <label style="color: #fff; font-weight: bold; display:block; margin-bottom:5px;">Search Scope:</label>
                        <div class="ai-scope-selector">
                            <div class="ai-scope-option active" data-scope="global" onclick="selectAiScope('global')">Global (All)</div>
                            <div class="ai-scope-option" data-scope="local" onclick="selectAiScope('local')">Current Folder</div>
                        </div>
                        <!-- NEW: Recursive Toggle for AI (hidden by default, shown by JS when local is selected) -->
                        <label class="recursive-wrapper" id="ai-recursive-toggle" style="display:none; margin-top:10px; width:100%; justify-content:center;">
                            <input type="checkbox" id="ai-search-recursive" value="true">
                            <span class="recursive-label">📂 Include Subfolders</span>
                        </label>
                        
                    </div>
                    <div>
                        <label style="color: #fff; font-weight: bold; display:block; margin-bottom:5px;">Max Results:</label>
                        <div class="ai-limit-container">
                            <!-- Minus Button -->
                            <button class="ai-limit-btn" onclick="adjustAiLimit(-50)">-</button>
                            
                            <!-- Input (native arrows hidden via CSS) -->
                            <input type="number" id="ai-search-limit" class="ai-limit-input" value="100" min="10" max="1000" step="10">
                            
                            <!-- Plus Button -->
                            <button class="ai-limit-btn" onclick="adjustAiLimit(50)">+</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="ai-input-wrapper">
                    <textarea id="ai-search-input" class="ai-search-textarea" placeholder="Describe what you are looking for in English..."></textarea>
                    <button id="ai-search-clear-text" title="Clear Query">×</button>
                </div>
            </div>
            
            <button id="ai-search-submit" class="ai-search-submit">Search</button>
        </div>
    </div>

    <!-- AI INFO / PROMO MODAL -->
    <div id="ai-info-overlay">
        <div class="ai-info-panel">
            <button class="ai-info-close" onclick="closeAiInfoModal()">×</button>
            
            <div class="ai-hero-icon">🧠✨</div>
            <h2 class="ai-info-title">Enable Semantic AI <span style="font-size:0.6em; color:#fff; font-weight:normal;">(Free & Local)</span></h2>
            
            <!-- STATUS ALERT BOX -->
            <div class="ai-status-alert">
                ⚠️ <strong>AI is currently disabled.</strong><br>
                Your environment variable is detected as: <code>ENABLE_AI_SEARCH=False</code>
                <p class="ai-info-text">
                    To unlock the AI features, you need to set the variable to <code>true</code>. 
                    Depending on your current installation, follow the steps below:
                </p>

            </div>

            <div class="ai-comparison-box">
                <h3 style="margin-top:0; color:white;">Activation Guide:</h3>
                
                <!-- SCENARIO A: GIÀ INSTALLATO -->
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <strong>🔹 Case A: You already have the AI files</strong><br>
                    <span style="font-size: 0.9rem; color: #bbb;">(You previously downloaded the full AI version)</span><br>
                    <p style="margin: 5px 0 0 0;">
                        You just need to set <code>ENABLE_AI_SEARCH=true</code> in your startup script or environment and restart. No new downloads required.
                    </p>
                </div>

                <!-- SCENARIO B: NUOVA INSTALLAZIONE -->
                <div>
                    <strong>🔹 Case B: You are on the Light Version</strong><br>
                    <span style="font-size: 0.9rem; color: #bbb;">(First time enabling AI)</span><br>
                    <ol class="ai-steps-list" style="margin-top: 5px; margin-bottom: 0;">
                        <li>
                            <strong>Upgrade:</strong> Read the instructions & Install the Full AI Configuration from our GitHub repo ->  
                            <a href="https://github.com/biagiomaf/smart-comfyui-gallery" target="_blank" style="color:var(--ai-color); word-break: break-all;">*here*</a> 
                        </li>
                        <li><strong>Activate:</strong> Set ENABLE_AI_SEARCH=true and restart.</li>
                    </ol>
                </div>
            </div>

            <!-- SEMANTIC SEARCH EXPLANATION (COLLAPSIBLE) -->
            <details class="ai-details">
                <summary>🤔 What is Semantic Search? (Read More)</summary>
                <div class="ai-details-content">
                    <p>Standard search only looks for exact filenames (e.g., <code>img_001.png</code>). Semantic Search is different: it <strong>understands</strong> the content of your image.</p>
                    <p>Using <strong>Florence-2</strong> (Vision) and <strong>Nomic</strong> (Embeddings), the system scans your images and creates a mathematical map of their meaning.</p>
                    <p>This allows you to search for concepts like <em>"a cyberpunk city in the rain"</em> or <em>"red flowers on a table"</em>, even if those words are not in the filename. We are thrilled to bring this advanced technology to your local machine!</p>
                </div>
            </details>
                
            <p style="font-size: 1.2rem; color: #aaa; margin-bottom: 1.5rem;">
                🛡️ <strong>Privacy Guaranteed:</strong> Our AI models run <strong>100% locally</strong>. 
                No external API calls. Your images never leave your computer.
            </p>

            <a href="https://github.com/biagiomaf/smart-comfyui-gallery" target="_blank" class="ai-cta-btn">
                🚀 View Installation Guide
            </a>
        </div>
    </div>
    
    <div id="rescan-modal-overlay"
        style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:2400;display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:opacity 0.3s;">
        <div
            style="background:var(--surface-color);border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--shadow-lg);padding:2rem;max-width:400px;text-align:center;">
            <h3 style="margin-top:0;">♻️ Rescan Folder</h3>
            <p style="color:var(--text-muted);margin-bottom:1.5rem;">Choose how you want to rescan files in this folder.
            </p>
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <button id="rescan-recent-btn"
                    style="background:var(--primary-color);color:white;border:none;padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Rescan
                    Outdated (> 1h)</button>
                <button id="rescan-all-btn"
                    style="background:var(--danger-color);color:white;border:none;padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Rescan
                    All Files</button>
                <button id="rescan-cancel-btn"
                    style="background:var(--surface-hover);color:var(--text-color);border:1px solid var(--border-color);padding:0.75rem;border-radius:8px;cursor:pointer;font-weight:600;">Cancel</button>
            </div>
        </div>
    </div>
    <!-- MOUNT FOLDER MODAL (Advanced) -->
    <div id="mount-folder-overlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);backdrop-filter:blur(5px);z-index:4000;display:none;justify-content:center;align-items:center;">
        <div class="smart-dialog-panel" style="width:600px; max-width:95vw; height: auto; max-height: 90vh;">
            <h3 style="margin-top:0; color:white; display:flex; align-items:center; gap:10px;">🔗 Link External Folder</h3>
            
            <div class="mount-info-box" style="margin-bottom:10px;">
                <p style="margin:0 0 8px 0;"><strong>Navigate and select a folder from the server disk.</strong></p>
                <!-- Rimosso font-size piccolo, aumentata opacità a 1 per massima leggibilità -->
                <div style="opacity:1; margin-top:5px;">
                    <span style="color:var(--favorite-color); font-weight:bold;">ℹ️ Docker Users:</span> 
                    You are browsing the container's internal filesystem. To see external drives, map them as Volumes first.
                </div>
            </div>

            <!-- FILE BROWSER UI -->
            <div class="fs-browser-container">
                <div class="fs-header">
                    <button class="glass-btn" onclick="fsNavigate('..')" style="padding:2px 8px; height:24px; min-height:0; font-size:0.8rem;">⬆ Up</button>
                    <div class="fs-path-display" id="fs-current-path">Reading drives...</div>
                </div>
                <ul class="fs-list" id="fs-list-view">
                    <!-- Folders load here -->
                </ul>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
                <div>
                    <label style="display:block; color:var(--text-muted); font-size:0.85rem; margin-bottom:5px;">Selected Target Path</label>
                    <input type="text" id="mount-target-path" class="sd-text-input" placeholder="Select a folder above..." readonly style="background:rgba(0,0,0,0.5); cursor:not-allowed; color:var(--success-color);">
                </div>
                <div>
                    <label style="display:block; color:var(--text-muted); font-size:0.85rem; margin-bottom:5px;">Link Name (Folder Name in Gallery)</label>
                    <input type="text" id="mount-link-name" class="sd-text-input" placeholder="e.g. External Photos">
                </div>
            </div>

            <div class="sd-actions" style="margin-top:15px;">
                <button onclick="closeMountModal()" class="glass-btn">Cancel</button>
                <button onclick="confirmMountFolder()" id="mount-confirm-btn" class="glass-btn active-blue" disabled>🔗 Create Link</button>
            </div>
        </div>
    </div>
    
    <!-- COMPARE MODE OVERLAY -->
    <div id="compare-overlay">
        <div class="compare-header">
            <h3 class="cmp-title" style="margin:0; color:white; font-size:1.1rem; white-space:nowrap;">
                ⚖️ Compare <span class="cmp-mode-text">Mode</span>
            </h3>
            
            <div style="display:flex; gap:5px; align-items:center;">
                <!-- [NEW] Rotate Button -->
                <button class="glass-btn" onclick="cmpRotate()" title="Rotate 90° (Best for Portrait on Wide Screens)" style="min-width:40px; padding:0;">🔄</button>
                
                <div style="width:1px; height:20px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>

                <!-- Zoom Controls -->
                <button class="glass-btn" onclick="cmpZoom(-0.2)" title="Zoom Out (-)" style="min-width:35px; padding:0;">-</button>
                <button class="glass-btn" onclick="cmpZoom(0.2)" title="Zoom In (+)" style="min-width:35px; padding:0;">+</button>
                <button class="glass-btn" onclick="cmpResetZoom()" title="Reset (0)" style="font-size:0.85rem; padding:0 10px;">Original</button>
                
                <button class="close-btn" onclick="closeCompareMode()" style="font-size:2rem; background:none; border:none; color:white; cursor:pointer; margin-left:5px;">×</button>
            </div>
        </div>

        <div class="compare-stage" id="compare-stage">
            <!-- IMAGE B (BEFORE/RIGHT) Container -->
            <div class="cmp-layer" id="cmp-before-wrapper">
                <div id="cmp-container-b" class="cmp-media-container"></div>
                <!-- Interactive Label B -->
                <div id="cmp-label-b" class="cmp-floating-label" style="right:20px;" onclick="showCmpDetails(this)">Image B</div>
            </div>
            
            <!-- IMAGE A (AFTER/LEFT) Container -->
            <div class="cmp-layer" id="cmp-after-wrapper">
                <div id="cmp-container-a" class="cmp-media-container"></div>
                <!-- Interactive Label A -->
                <div id="cmp-label-a" class="cmp-floating-label" style="left:20px; color:var(--primary-color);" onclick="showCmpDetails(this)">Image A</div>
            </div>

            <!-- HANDLE -->
            <div class="cmp-handle" id="cmp-handle"></div>
        </div>

        <div class="compare-info-panel" id="compare-info-panel">
            <div class="cmp-info-toggle" onclick="toggleCmpInfo()" title="Shortcut: 'I'">
                <span>📝 Parameter Differences</span>
                <span id="cmp-toggle-icon">▼</span>
            </div>
            <div class="cmp-table-container">
                <table class="cmp-table">
                    <thead>
                        <tr>
                            <th style="width:20%">Parameter</th>
                            <!-- Added IDs to headers to inject filenames -->
                            <th style="width:40%" id="cmp-header-a">Image A</th>
                            <th style="width:40%" id="cmp-header-b">Image B</th>
                        </tr>
                    </thead>
                    <tbody id="cmp-table-body">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    

    <div id="loader-overlay">
        <div class="loader"></div>
    </div>
    <div id="shortcuts-help-overlay">
        <div class="shortcuts-panel" style="width: 1000px; max-width: 95vw;">
            <div class="shortcuts-header">
                <h2>⌨️ Keyboard Shortcuts</h2>
                <button class="close-btn" id="close-shortcuts-btn">×</button>
            </div>
            <div class="shortcuts-content">
                
                <!-- COL 1: NAVIGATION & APP GLOBALS -->
                <div class="sc-column">
                    <div class="sc-header">🌍 App Controls</div>
                    <div class="shortcut-item"><span class="key">?</span> <span class="desc">This Help</span></div>
                    <div class="shortcut-item"><span class="key">Q</span> <span class="desc">Toggle Focus Mode</span></div>
                    <div class="shortcut-item"><span class="key">T</span> <span class="desc">Toggle Filters/Top</span></div>
                    <div class="shortcut-item"><span class="key">P</span> <span class="desc">Toggle Video Autoplay</span></div>
                    <div class="shortcut-item"><span class="key">L</span> <span class="desc">Refresh View</span></div>
                    <div class="shortcut-item"><span class="key">K</span> <span class="desc">Rescan Folder</span></div>
                    
                    <div class="sc-header" style="margin-top:15px;">↕️ Page Nav (Std)</div>
                    <div class="shortcut-item"><span class="key std">Home</span> <span class="desc">Go to Top</span></div>
                    <div class="shortcut-item"><span class="key std">End</span> <span class="desc">Go to Bottom</span></div>
                    <div class="shortcut-item"><span class="key std">PgUp</span> <span class="key std">PgDn</span> <span class="desc">Scroll</span></div>
                </div>

                <!-- COL 2: GRID ITEM ACTIONS -->
                <div class="sc-column">
                    <div class="sc-header">
                        ▦ Single Item
                        <span class="sc-sub">Hover or Selected</span>
                    </div>
                    <div class="shortcut-item"><span class="key">V</span> or <span class="key">Enter</span> <span class="desc">Open Lightbox</span></div>
                    <div class="shortcut-item"><span class="key">X</span> or <span class="key">Spacebar</span> <span class="desc">Select / Deselect</span></div>
                    <div class="shortcut-item"><span class="key">N</span> <span class="desc">Node Summary</span></div>
                    <div class="shortcut-item"><span class="key">F</span> <span class="desc">Toggle Favorite</span></div>
                    <div class="shortcut-item"><span class="key">W</span> <span class="desc">Download Workflow</span></div>
                    <div class="shortcut-item"><span class="key">C</span> <span class="desc">Copy Workflow</span></div>
                    <div class="shortcut-item"><span class="key">S</span> <span class="desc">Download File</span></div>
                    <div class="shortcut-item"><span class="key">R</span> <span class="desc">Rename File</span></div>
                    <div class="shortcut-item"><span class="key">E</span> <span class="desc">Video Storyboard</span></div>
                    <div class="shortcut-item"><span class="key">Del</span> <span class="desc">Quick Delete</span></div>
                </div>

                <!-- COL 3: SELECTION STANDARD & BATCH -->
                <div class="sc-column">
                    <div class="sc-header">🖱️ Selection (Std)</div>
                    <!-- Mouse Actions -->
                    <div class="shortcut-item"><span class="key std">Click</span> <span class="desc">Focus mode OFF-> Open Lightbox</span></div>
                    <div class="shortcut-item"><span class="key std">Click</span> <span class="desc">Focus mode ON- > Select / Deselect</span></div>
                    <div class="shortcut-item"><span class="key std cmd-key">Ctrl</span>+<span class="key std">Click</span> <span class="desc">Add One</span></div>
                    <div class="shortcut-item"><span class="key std">Shift</span>+<span class="key std">Click</span> <span class="desc">Range Select</span></div>
                    
                    <!-- Keyboard Actions -->
                    <div class="shortcut-item"><span class="key std cmd-key">Ctrl</span>+<span class="key std">A</span> <span class="desc">Select All</span></div>
                    
                    <div class="sc-header" style="margin-top:15px;">📦 Batch Actions</div>
                    <div class="shortcut-item"><span class="key">Esc</span> <span class="desc">Deselect All</span></div>
                    <div class="shortcut-item"><span class="key">M</span> <span class="desc">Move Selected</span></div>
                    <div class="shortcut-item"><span class="key">Z</span> <span class="desc">Zip Selected</span></div>
                    <div class="shortcut-item"><span class="key">Del</span> <span class="desc">Delete Batch</span></div>
                </div>

               <!-- COL 4: LIGHTBOX (SPLIT INTO 3 SUB-COLUMNS) -->
                <div class="sc-column" style="flex: 2 1 620px; /* Wide priority for 3 cols */">
                    <div class="sc-header">🖼️ Lightbox View</div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px 20px;">
                        
                        <!-- Sub-Col 1: Navigation & View -->
                        <div style="display:flex; flex-direction:column; gap:0.4rem;">
                            <div class="shortcut-item"><span class="key">Esc</span> <span class="desc">Close Lightbox</span></div>
                            <div class="shortcut-item"><span class="key std">←</span> <span class="key std">→</span> <span class="desc">Navigate</span></div>
                            <div class="shortcut-item"><span class="key std">+</span> <span class="key std">-</span> <span class="desc">Zoom In / Out</span></div>
                            <div class="shortcut-item"><span class="key">0</span> <span class="desc">Reset Zoom</span></div>
                            <div class="shortcut-item"><span class="key">Keypad</span> <span class="desc">Pan Image</span></div>
                        </div>
                        
                        <!-- Sub-Col 2: Display & Info -->
                        <div style="display:flex; flex-direction:column; gap:0.4rem;">
                            <div class="shortcut-item"><span class="key">H</span> <span class="desc">Hide/Show UI</span></div>
                            <div class="shortcut-item"><span class="key">O</span> <span class="desc">Open New Tab</span></div>
                            <div class="shortcut-item"><span class="key">N</span> <span class="desc">Node Summary</span></div>
                            <div class="shortcut-item"><span class="key">F</span> <span class="desc">Toggle Favorite</span></div>
                            <div class="shortcut-item"><span class="key">S</span> <span class="desc">Download File</span></div>
                        </div>

                        <!-- Sub-Col 3: Workflow & Edits -->
                        <div style="display:flex; flex-direction:column; gap:0.4rem;">
                            <div class="shortcut-item"><span class="key">W</span> <span class="desc">Download Workflow</span></div>
                            <div class="shortcut-item"><span class="key">C</span> <span class="desc">Copy Workflow</span></div>
                            <div class="shortcut-item"><span class="key">R</span> <span class="desc">Rename File</span></div>
                            <div class="shortcut-item"><span class="key">E</span> <span class="desc">Video Storyboard</span></div>
                            <div class="shortcut-item"><span class="key">Del</span> <span class="desc">Quick Delete</span></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SMART DIALOG OVERLAY (Replaces Native Alerts) -->
    <div id="smart-dialog-overlay">
        <div class="smart-dialog-panel">
            <h3 id="sd-title">Confirm Action</h3>
            <div id="sd-message">Are you sure?</div>
            
            <!-- Input Container (Visible only for Prompts) -->
            <div id="sd-input-container" style="display:none;">
                <input type="text" id="sd-input" class="sd-text-input" autocomplete="off">
            </div>

            <div class="sd-actions">
                <!-- Third button for Yes/No/Cancel workflows -->
                <button id="sd-btn-deny" class="glass-btn" style="display:none; color:var(--danger-color); border-color:var(--danger-color);">No</button>
                <button id="sd-btn-cancel" class="glass-btn">Cancel</button>
                <button id="sd-btn-confirm" class="glass-btn active-blue">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- STORYBOARD MODAL (Full Screen Grid) -->
    <div id="storyboard-overlay">
        <div class="sb-panel">
            <div class="sb-header">
                <h3>🎞️ Storyboard Overview</h3>
                <button class="close-btn" onclick="closeStoryboard()">×</button>
            </div>
            <div class="sb-body">
                <div id="sb-loader" style="display:none;">
                    <div class="loader"></div>
                    <p style="margin-top:10px; color:var(--text-muted);">Analyzing video frames...</p>
                </div>
                <div id="sb-grid" class="sb-grid"></div>
            </div>
            <div class="sb-footer">
                <p>Click a frame to zoom in.</p>
            </div>
        </div>
    </div>

    <!-- SINGLE FRAME ZOOM OVERLAY -->
    <div id="sb-zoom-overlay" onclick="if(event.target === this) closeSbZoom()">
        <!-- Status Badge (First/Last) -->
        <div id="sb-zoom-status"></div>
        <!-- Navigation Buttons -->
        <button id="sb-nav-prev" class="sb-nav-btn" onclick="navigateSbZoom(-1)">‹</button>
        <img id="sb-zoom-img" src="" alt="Zoomed Frame">
        <button id="sb-nav-next" class="sb-nav-btn" onclick="navigateSbZoom(1)">›</button>
        <!-- Low Resolution Warning Badge -->
        <div id="sb-zoom-quality-msg">⚠️ Low-Res Preview (360p)</div>
        <!-- Close Button -->
        <button class="close-btn" onclick="closeSbZoom()" style="position:absolute; top:20px; right:20px; font-size:2rem; z-index:4005;">×</button>
    </div>
    
    <script>
        // --- DATA INITIALIZATION AND GLOBAL STATE ---
        const foldersData = {{ folders | tojson }};
        const ffmpegAvailable = {{ ffmpeg_available | tojson }};
        const streamThresholdBytes = {{ stream_threshold }}; 
        const currentFolderInfo = {{ current_folder_info | tojson }};
        const protectedFolderKeys = {{ protected_folder_keys | tojson }};
        const initialFiles = {{ files | tojson }};
        let totalFiles = {{ total_files }};
        let totalFolderFiles = {{ total_folder_files }};
        const currentFolderKey = '{{ current_folder_key }}';
        const ancestorKeys = {{ ancestor_keys | tojson }};
        // --- USER PREFERENCES (LocalStorage) ---
        // Default to FALSE (OFF) if not set. User must explicitly enable it.
        // We check if it equals 'true' string.
        let videoAutoplay = localStorage.getItem('sg_videoAutoplay') === 'true';
        // Grid Size Preference (Default: 'normal')
        let gridSizePref = localStorage.getItem('sg_gridSize') || 'normal';
         // --- AI SEARCH VARIABLES ---
        const enableAiSearch = {{ enable_ai_search | tojson }};
        const isAiSearch = {{ is_ai_search | tojson }};
        const isGlobalSearch = {{ is_global_search | tojson }};
        const activeFiltersCount = {{ active_filters_count }};
        const rawAiQuery = {{ ai_query | tojson }};
        const isAiGlobal = isAiSearch && (rawAiQuery && rawAiQuery.indexOf(" ||| ") === -1);
        let currentAiScope = 'global'; 

        const galleryContainer = document.getElementById('gallery-container');
        const selectionBar = document.getElementById('selection-bar');
        const selectionCounter = document.getElementById('selection-counter');
        const loaderOverlay = document.getElementById('loader-overlay');
        const backToTopBtn = document.getElementById('backToTopBtn');
        let currentItemCount = 0;
        let galleryItems = [];
        let allFilesData = [];
        const selectedFiles = new Set();
        let lastSelectedItem = null;
        let currentSearch = { nav: '', move: '' };
        let focusedItemIndex = -1;
        let hoveredItemIndex = -1;
        let currentDropAction = 'move'; // 'move' or 'copy'
        let copyKeepFavorites = false; // Store user choice
        let isFilmstripDragging = false;

        // --- UI STATE PERSISTENCE MANAGEMENT ---
        const savedSort = localStorage.getItem('gallerySortPreference');
        let currentSort = savedSort
            ? JSON.parse(savedSort)
            : { nav: { key: 'name', dir: 'asc' }, move: { key: 'name', dir: 'asc' } };

        const savedFolderState = localStorage.getItem('galleryFolderState');
        const expandedFolderKeys = savedFolderState ? new Set(JSON.parse(savedFolderState)) : new Set();

        // --- GLOBAL UTILITIES (Load first to avoid ReferenceErrors) ---
        
        // --- SMART DIALOG SYSTEM ---
        
        // Internal Helper to handle Promise
        function showSmartDialog(type, title, message, defaultValue = '', confirmColor = 'active-blue') {
            return new Promise((resolve) => {
                const overlay = document.getElementById('smart-dialog-overlay');
                const titleEl = document.getElementById('sd-title');
                const msgEl = document.getElementById('sd-message');
                const inputContainer = document.getElementById('sd-input-container');
                const inputEl = document.getElementById('sd-input');
                const btnConfirm = document.getElementById('sd-btn-confirm');
                const btnCancel = document.getElementById('sd-btn-cancel');
                const btnDeny = document.getElementById('sd-btn-deny');

                // 1. Reset State
                btnDeny.style.display = 'none';
                btnConfirm.textContent = 'Confirm';
                btnCancel.textContent = 'Cancel';
                btnCancel.style.display = 'inline-flex';
                
                // 2. Setup Content
                titleEl.textContent = title;
                msgEl.innerHTML = message.replace(/\n/g, '<br>');
                
                // 3. Setup Type
                if (type === 'prompt') {
                    inputContainer.style.display = 'block';
                    inputEl.value = defaultValue;
                    setTimeout(() => { inputEl.focus(); inputEl.select(); }, 100);
                } else {
                    inputContainer.style.display = 'none';
                }

                // 4. Custom Mode: Yes/No/Cancel
                if (type === 'yes_no_cancel') {
                    btnDeny.style.display = 'inline-flex'; // Show "No"
                    btnDeny.textContent = "No";
                    btnConfirm.textContent = "Yes";
                    // Confirm Color usually Blue for Yes
                } else if (type === 'confirm_danger') {
                    btnConfirm.textContent = 'Delete';
                }

                // 5. Setup Buttons Colors
                btnConfirm.className = `glass-btn ${confirmColor}`;

                // 6. Show
                overlay.classList.add('visible');

                // 7. Handlers
                const close = (result) => {
                    overlay.classList.remove('visible');
                    btnConfirm.onclick = null;
                    btnCancel.onclick = null;
                    btnDeny.onclick = null;
                    inputEl.onkeydown = null;
                    resolve(result);
                };

                // Confirm (Yes)
                btnConfirm.onclick = () => {
                    if (type === 'prompt') close(inputEl.value);
                    else close(true); // True = Yes/Confirm
                };

                // Deny (No) - Returns FALSE
                btnDeny.onclick = () => {
                    close(false); 
                };

                // Cancel - Returns NULL (distinct from False)
                btnCancel.onclick = () => {
                    close(null); 
                };

                if (type === 'prompt') {
                    inputEl.onkeydown = (e) => { if(e.key === 'Enter') btnConfirm.click(); };
                }
            });
        }
        
        // --- PUBLIC API (Use these instead of native) ---
        
        // Replace confirm() -> await smartConfirm("Title", "Text")
        async function smartConfirm(title, message, isDanger = false) {
            return await showSmartDialog(isDanger ? 'confirm_danger' : 'confirm', title, message, '', isDanger ? 'btn-reset' : 'active-blue'); 
            // Nota: btn-reset nel tuo CSS è rosso, active-blue è blu
        }

        // Replace prompt() -> await smartPrompt("Title", "Label", "DefaultValue")
        async function smartPrompt(title, message, defaultValue) {
            return await showSmartDialog('prompt', title, message, defaultValue);
        }
        
        function applySort(newSortBy) {
            // Read current URL parameters to preserve filters
            const params = new URLSearchParams(window.location.search);
            const currentSortBy = params.get('sort_by') || 'date';
            const currentSortOrder = params.get('sort_order') || 'desc';

            let newSortOrder = 'desc';
            
            if (currentSortBy === newSortBy) {
                // Toggle direction if clicking the same sort criteria
                newSortOrder = (currentSortOrder === 'desc') ? 'asc' : 'desc';
            } else {
                // Default order when switching sort type
                newSortOrder = (newSortBy === 'name') ? 'asc' : 'desc';
            }

            params.set('sort_by', newSortBy);
            params.set('sort_order', newSortOrder);

            // Redirect with full parameters string
            window.location.href = window.location.pathname + "?" + params.toString();
        }

        // --- FOLDER TREE MANAGEMENT FUNCTIONS ---
        
        // Utility for notifications with custom duration support
        function showNotification(message, type = 'info', duration = 5000) { 
            const container = document.getElementById('notification-container'); 
            if (!container) return; 
            const notification = document.createElement('div'); 
            notification.className = `notification ${type}`; 
            notification.textContent = message; 
            container.appendChild(notification); 
            // Animation In
            setTimeout(() => { notification.classList.add('show'); }, 10); 
            // Animation Out
            setTimeout(() => { 
                notification.classList.remove('show'); 
                notification.addEventListener('transitionend', () => notification.remove()); 
            }, duration); 
        }
        // --- GLOBAL WORKER MONITOR ---
        // Checks if items are stuck in 'Queued' state without being picked up by the worker
        let workerStuckCounter = 0;
        let workerAlertShown = false;

        function startGlobalWorkerMonitor() {
            if (!enableAiSearch) return;

            // Lightweight check every 10 seconds
            setInterval(async () => {
                // If we already warned the user once this session, stop checking logic
                if (workerAlertShown) return;

                try {
                    const res = await fetch('/galleryout/ai_indexing/status');
                    const data = await res.json();

                    // LOGIC: 
                    // 1. Are there pending items? (data.pending_count > 0)
                    // 2. Is the global status specifically 'Queued'? (data.global_status === 'Queued')
                    // 'Queued' means items are in DB but Worker hasn't switched status to 'Indexing' yet.
                    // If it stays 'Queued' for too long, the worker is likely down.
                    if (data.pending_count > 0 && data.global_status === 'Queued') {
                        workerStuckCounter++;
                    } else {
                        // Reset counter if queue is empty OR if status is 'Indexing' (Worker is active)
                        // Also resets if status is 'Paused' or 'waiting_gpu' (valid idle states)
                        workerStuckCounter = 0;
                    }

                    // TRIGGER ALERT: If stuck for 3 cycles (approx 30 seconds)
                    if (workerStuckCounter >= 3) {
                        workerAlertShown = true; 
                        
                        const msg = "⚠️ AI WORKER ALERT\n" +
                                    "Items are pending but the AI Service is not responding.\n" +
                                    "Please check if the worker terminal is running.";
                        
                        // Show generic error notification for 10 seconds
                        showNotification(msg, "error", 10000);
                    }

                } catch (e) {
                    // Silent catch (e.g. network error), don't annoy user unless persistent
                    console.warn("Monitor check skipped");
                }
            }, 10000); // Check every 10 seconds
        }
        
        function handleError(error) { console.error('API Error:', error); showNotification(error.message || 'An unexpected network error occurred.', 'error'); }
        function handleGenericResponse(response) { 
            return response.json().then(data => { 
                if (!response.ok) { 
                    throw new Error(data.message || `HTTP error! status: ${response.status}`); 
                } 
                if (data.status === 'success' || data.status === 'partial_success') { 
                    // [MODIFIED] Save message and reload immediately
                    sessionStorage.setItem('gallery_notification', JSON.stringify({
                        message: data.message || 'Action completed successfully!',
                        type: 'success'
                    }));
                    window.location.reload(); 
                } else { 
                    throw new Error(data.message || 'An unspecified error occurred.'); 
                } 
            }).catch(handleError); 
        }
        function sortChildren(folder, sortKey, direction) {
            if (!folder.children || folder.children.length === 0) return [];
            const dirMultiplier = direction === 'asc' ? 1 : -1;
            return [...folder.children].sort((keyA, keyB) => {
                const folderA = foldersData[keyA];
                const folderB = foldersData[keyB];
                if (!folderA || !folderB) return 0;
                let comparison = 0;
                if (sortKey === 'mtime') {
                    comparison = (folderA.mtime || 0) - (folderB.mtime || 0);
                } else {
                    const nameA = folderA.display_name || '';
                    const nameB = folderB.display_name || '';
                    comparison = nameA.localeCompare(nameB, undefined, { numeric: true, sensitivity: 'base' });
                }
                return comparison * dirMultiplier;
            });
        }

        function buildFolderTreeHTML(folderKey, isMovePanel = false) {
            const folder = foldersData[folderKey];
            if (!folder) return '';

            const hasChildren = folder.children && folder.children.length > 0;
            const isManuallyExpanded = expandedFolderKeys.has(folderKey);
            const isAncestor = ancestorKeys.includes(folderKey);
            const isCollapsed = folderKey !== '_root_' && !isAncestor && !isManuallyExpanded;
            const isActive = !isMovePanel && folderKey === currentFolderKey;
            const folderDisplayName = folder.display_name;
            
            // --- GLOBAL ICON LOGIC (Applies to both Sidebar and Move/Copy Panel) ---
            let folderIconHtml = '📁';
            
            if (folder.is_mount) {
                // Case 1: External Link / Mount Point - Priority 1
                folderIconHtml = '🔗';
            } else if (folder.is_watched) {
                // Case 2: AI Watched Folder (Purple Hue) - Priority 2
                folderIconHtml = '<span style="filter: hue-rotate(290deg) saturate(300%) brightness(1.1); display:inline-block;" title="Watched by AI">📁</span>';
            }

            let childrenHTML = '';
            if (hasChildren) {
                const sortSettings = isMovePanel ? currentSort.move : currentSort.nav;
                const sortedChildren = sortChildren(folder, sortSettings.key, sortSettings.dir);
                childrenHTML = sortedChildren.map(childKey => buildFolderTreeHTML(childKey, isMovePanel)).join('');
            }

            let itemHTML;

            // NOTE: HTML must be all in one only row to avoid indentations in the side bar 
            if (isMovePanel) {
                const isRecursive = document.querySelector('input[name="recursive"]')?.checked || false;
                // Disable move to current folder unless copying, global/AI search, or recursive
                const shouldDisable = (currentDropAction !== 'copy' && folderKey === currentFolderKey && !isAiGlobal && !isGlobalSearch && !isRecursive);
                const disabledAttr = shouldDisable ? 'disabled' : '';

                itemHTML = `
                    <div class="folder-item">
                        <span class="toggle-btn ${!hasChildren ? 'empty' : ''}"></span>
                        <span class="folder-link" title="${folderDisplayName}">${folderIconHtml} ${folderDisplayName}</span>
                        <button class="move-here-btn" data-folder-key="${folderKey}" title="Move here" ${disabledAttr}>➜</button>
                    </div>`;
            
            } else {
                // --- SIDEBAR VIEW LOGIC ---
                let actionsHTML = '';
                
                if (folderKey !== '_root_' && !protectedFolderKeys.includes(folderKey)) {
                    const aiBtn = enableAiSearch 
                        ? `<button onclick="indexFolder('${folderKey}')">🧠 AI Index</button>` 
                        : '';
                    
                    // --- MOUNT POINT BUTTON LOGIC ---
                    let deleteOption = '';
                    if (folder.is_mount) {
                        deleteOption = `<button onclick="unmountFolder(event, '${folderKey}', '${folderDisplayName}')" style="color:#ff6b6b; border-top:1px solid rgba(255,255,255,0.1);">⛓️ Unmount</button>`;
                    } else {
                        deleteOption = `<button onclick="deleteFolder(event, '${folderKey}', '${folderDisplayName}')" style="color:#ff6b6b;">🗑️ Delete</button>`;
                    }

                    actionsHTML = `
                        <div class="folder-menu-container">
                            <button class="folder-menu-btn" onclick="event.stopPropagation(); toggleFolderMenu(this)">⋮</button>
                            <div class="folder-dropdown">
                                <button onclick="showFolderInfo(event, '${folderKey}')">ℹ️ Info</button>
                                ${aiBtn}
                                ${!folder.is_mount ? `<button onclick="renameFolder(event, '${folderKey}', '${folderDisplayName}')">✏️ Rename</button>` : ''}
                                ${deleteOption}
                            </div>
                        </div>`;
                }

                itemHTML = `
                    <div class="folder-item ${isActive ? 'active' : ''}">
                        <span class="toggle-btn ${!hasChildren ? 'empty' : ''}"></span>
                        <span class="folder-link navigation-link" data-folder-url="/galleryout/view/${folderKey}" title="${folderDisplayName}">${folderIconHtml} ${folderDisplayName}</span>
                        ${actionsHTML}
                    </div>`;
            }

            return `
                <li data-folder-key="${folderKey}" 
                    data-folder-name="${folderDisplayName.toLowerCase()}" 
                    class="${isCollapsed ? 'collapsed' : ''} ${!hasChildren ? 'no-children' : ''}">
                    ${itemHTML}
                    ${hasChildren ? `<ul>${childrenHTML}</ul>` : ''}
                </li>`;
        }
        
        function renderAllTrees() {
            document.getElementById('folder-tree-nav').innerHTML = buildFolderTreeHTML('_root_', false);
            filterTree('folder-tree-nav', currentSearch.nav, false);
        }

        function filterTree(treeId, searchTerm, saveState = true) {
            const term = searchTerm.toLowerCase().trim();
            const tree = document.getElementById(treeId);
            if (!tree) return;
            const allItems = Array.from(tree.getElementsByTagName('li'));

            allItems.forEach(li => li.classList.remove('is-hidden'));

            if (!term) return;

            let stateChanged = false;
            allItems.forEach(li => li.classList.add('is-hidden'));
            allItems.forEach(li => {
                if (li.dataset.folderName.includes(term)) {
                    li.classList.remove('is-hidden');
                    let parent = li.parentElement.closest('li');
                    while (parent) {
                        parent.classList.remove('is-hidden');
                        if (parent.classList.contains('collapsed')) {
                            parent.classList.remove('collapsed');
                            expandedFolderKeys.add(parent.dataset.folderKey);
                            stateChanged = true;
                        }
                        parent = parent.parentElement.closest('li');
                    }
                }
            });

            if (saveState && stateChanged) {
                localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));
            }
        }

        function setupFolderControls(navId, treeId) {
            document.getElementById(`folder-search-${navId}`).addEventListener('input', (e) => {
                currentSearch[navId] = e.target.value;
                filterTree(treeId, currentSearch[navId], true);
            });
            const sortContainer = document.getElementById(`folder-sort-${navId}`);
            sortContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const newSortKey = button.dataset.sort;
                const sortTarget = (navId === 'nav') ? currentSort.nav : currentSort.move;

                if (sortTarget.key === newSortKey) {
                    sortTarget.dir = sortTarget.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortTarget.key = newSortKey;
                    sortTarget.dir = newSortKey === 'name' ? 'asc' : 'desc';
                }

                updateSortButtonsUI(navId);
                const isMovePanel = navId === 'move';
                document.getElementById(treeId).innerHTML = buildFolderTreeHTML('_root_', isMovePanel);
                filterTree(treeId, currentSearch[navId], false);

                localStorage.setItem('gallerySortPreference', JSON.stringify(currentSort));
            });
            updateSortButtonsUI(navId);
        }

        function updateSortButtonsUI(navId) {
            const sortContainer = document.getElementById(`folder-sort-${navId}`);
            const sortTarget = (navId === 'nav') ? currentSort.nav : currentSort.move;
            sortContainer.querySelectorAll('button').forEach(btn => {
                const sortType = btn.dataset.sort;
                let text = sortType === 'name' ? 'A-Z' : '🗓️';
                btn.classList.remove('active');
                if (sortType === sortTarget.key) {
                    btn.classList.add('active');
                    const arrow = sortTarget.dir === 'asc' ? '↑' : '↓';
                    text += ` ${arrow}`;
                }
                btn.innerHTML = text;
            });
        }
        // --- SIDEBAR MINIFY LOGIC ---
        function setupSidebarMinify() {
            const btn = document.getElementById('sidebar-minify-btn');
            const body = document.body;
            
            if (!btn) return;
            
             // Hide automatically if on mobile/small tablet
            if (window.innerWidth <= 1024) {
                btn.style.display = 'none';
                return;
            }

            // Helper to update icon
            const updateUI = () => {
                const isMin = body.classList.contains('sidebar-minimized');
                
                // UX FIX: Directional arrows
                // If minimized: Show Right Arrow (▶) to indicate "Open/Expand to Right"
                // If open: Show Left Arrow (◀) to indicate "Collapse/Minimize to Left"
                btn.innerHTML = isMin ? '<span>▶</span>' : '<span>◀</span>';
                
                // Tooltip text
                btn.title = isMin ? 'Show Sidebar' : 'Minimize Sidebar';
                
                // When minimized, hide the other "Expand Width" button to avoid confusion
                const expandBtn = document.getElementById('sidebar-expand-btn');
                if(expandBtn) expandBtn.style.display = isMin ? 'none' : 'flex';
            };

            // Restore State
            const savedState = localStorage.getItem('sidebarMinimizedState');
            if (savedState === 'true') {
                body.classList.add('sidebar-minimized');
            }
            // Always run UI update to set initial icon
            updateUI();

            // Click Handler
            btn.addEventListener('click', () => {
                body.classList.toggle('sidebar-minimized');
                
                // If minimizing, remove the "Expanded" (extra wide) state to reset layout
                if (body.classList.contains('sidebar-minimized')) {
                    body.classList.remove('sidebar-expanded');
                    localStorage.removeItem('sidebarExpandedState');
                    
                    // Reset the expander icon too
                    const expandBtn = document.getElementById('sidebar-expand-btn');
                    if(expandBtn) {
                        expandBtn.querySelector('span').innerHTML = '↔️';
                        expandBtn.title = 'Expand Sidebar Width';
                    }
                }
                
                const isNowMin = body.classList.contains('sidebar-minimized');
                localStorage.setItem('sidebarMinimizedState', isNowMin);
                updateUI();
            });
        }
        function setupSidebarExpansion() {
            const btn = document.getElementById('sidebar-expand-btn');
            const body = document.body;
            
            if (!btn) return;

            function updateButtonUI() {
                const iconSpan = btn.querySelector('span');
                if (body.classList.contains('sidebar-expanded')) {
                    // Expanded State -> Icon pointing LEFT to indicate shrinking/resetting
                    iconSpan.innerHTML = '⬅️'; 
                    btn.title = 'Reset Sidebar Width';
                } else {
                    // Normal State -> Icon indicating expansion
                    iconSpan.innerHTML = '↔️'; 
                    btn.title = 'Expand Sidebar Width';
                }
            }

            // Restore saved state
            if (localStorage.getItem('sidebarExpandedState') === 'true') {
                body.classList.add('sidebar-expanded');
            }
            updateButtonUI();

            btn.addEventListener('click', () => {
                body.classList.toggle('sidebar-expanded');

                if (body.classList.contains('sidebar-expanded')) {
                    localStorage.setItem('sidebarExpandedState', 'true');
                    // If expanding, ensure it's not minimized
                    body.classList.remove('sidebar-minimized');
                    localStorage.setItem('sidebarMinimizedState', 'false');
                    
                    // Update minify button icon too if present
                    const minBtn = document.getElementById('sidebar-minify-btn');
                    if(minBtn) {
                        minBtn.innerHTML = '<span>◀</span>';
                        minBtn.title = 'Minimize Sidebar';
                    }
                } else {
                    localStorage.removeItem('sidebarExpandedState');
                }

                updateButtonUI();
            });
        }
        
        // --- MODIFIED SYNC PROCESS (Supports Silent Mode) ---
        function startSyncProcess(isManualRefresh = false, isSilent = false) { 
            const syncOverlay = document.getElementById('sync-overlay'); 
            const syncMessage = document.getElementById('sync-message'); 
            const syncProgressFill = document.getElementById('sync-progress-fill'); 
            const eventSource = new EventSource(`/galleryout/sync_status/${currentFolderKey}`); 
            let hasChanges = false; 
            
            // SHOW OVERLAY ONLY IF NOT SILENT
            if (isManualRefresh && !isSilent) { 
                syncOverlay.style.display = 'flex'; 
                syncMessage.textContent = 'Checking for changes...'; 
                syncProgressFill.style.width = '0%'; 
                syncProgressFill.style.backgroundColor = 'var(--primary-color)'; 
            } 
            
            const cleanupAndClose = (shouldReload = false) => { 
                eventSource.close(); 
                if (shouldReload) { 
                    // If silent, just reload without fanfare
                    if (isSilent) {
                        console.log("Auto-Refresh: Changes detected, reloading...");
                        window.location.reload();
                    } else {
                        setTimeout(() => window.location.reload(), 1200); 
                    }
                } else { 
                    if (!isSilent) {
                        setTimeout(() => { syncOverlay.style.display = 'none'; }, isManualRefresh ? 1200 : 0); 
                    }
                } 
            }; 
            
            eventSource.onmessage = function (event) { 
                try { 
                    const data = JSON.parse(event.data); 
                    
                    if (!hasChanges && data.status !== 'no_changes') { 
                        // Found changes! If silent, show overlay NOW because it might take time
                        if (isSilent) {
                            // Optional: You can choose to show a small toast instead of full overlay
                            // For now, we show nothing until reload, or we could show a notification
                            // showNotification("Auto-Refresh: Processing new files...", "info");
                        } else {
                            syncOverlay.style.display = 'flex'; 
                        }
                        hasChanges = true; 
                    } 
                    
                    if (syncOverlay.style.display === 'flex') { 
                        syncMessage.textContent = data.message; 
                        if (data.total > 0) { 
                            syncProgressFill.style.width = `${(data.current / data.total) * 100}%`; 
                        } 
                    } 
                    
                    if (data.status === 'no_changes') { 
                        if (isManualRefresh && !isSilent) { 
                            syncProgressFill.style.width = '100%'; 
                            cleanupAndClose(true); // Manual refresh always reloads to be sure
                        } else {
                            // Silent mode and no changes? Do nothing, just close.
                            cleanupAndClose(false); 
                        }
                    } else if (data.status === 'reloading') { 
                        cleanupAndClose(true); 
                    } else if (data.error) { 
                        if(!isSilent) syncProgressFill.style.backgroundColor = 'var(--danger-color)'; 
                        cleanupAndClose(false); 
                    } 
                } catch (e) { 
                    console.error("Error parsing SSE data:", e); 
                    cleanupAndClose(false); 
                } 
            }; 
            
            eventSource.onerror = function () { eventSource.close(); }; 
        }
        // --- AUTO REFRESH LOGIC (Body Append Version) ---
        let autoRefreshTimer = null;
        let isAutoRefreshActive = false;

        function toggleAutoRefreshMenu(e) {
            e.stopPropagation();
            const popover = document.getElementById('auto-refresh-popover');
            const btn = document.getElementById('refresh-options-btn');
            
            if (!popover || !btn) return;

            if (popover.classList.contains('visible')) {
                popover.classList.remove('visible');
            } else {
                const rect = btn.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // Set a fixed preferred width for calculation
                const preferredWidth = 260; 
                const margin = 15; // Safe distance from screen edges
                
                // 1. Calculate Horizontal Position (Left)
                // Default: align the right edge of the popover with the right edge of the button
                let left = rect.right - preferredWidth;
                
                // MOBILE SAFETY: Check if it overflows on the right
                if (left + preferredWidth > screenWidth - margin) {
                    left = screenWidth - preferredWidth - margin;
                }
                
                // MOBILE SAFETY: Check if it overflows on the left
                if (left < margin) {
                    left = margin;
                }

                // 2. Calculate Vertical Position (Top)
                let top = rect.bottom + 5;
                
                // FLIP LOGIC: If the button is near the bottom, show the menu ABOVE it
                // Estimated height of popover is ~160px
                const estimatedHeight = 160;
                if (top + estimatedHeight > screenHeight && rect.top > estimatedHeight) {
                    top = rect.top - estimatedHeight - 5;
                }

                // 3. Apply styles and show
                popover.style.top = top + 'px';
                popover.style.left = left + 'px';
                popover.classList.add('visible');
            }
        }
        
        // --- FUNCTION: EXECUTE AUTO-REFRESH CYCLE ---
        function runAutoRefreshCycle() {
            // SAFETY CHECKS: Skip refresh if user is performing operations
            
            // 1. Check if files are selected (Selection Bar is visible)
            // This prevents losing the user's current selection work
            if (selectedFiles && selectedFiles.size > 0) {
                return;
            }

            // 2. Check if user is busy with UI elements (Lightbox, Modals, Upload)
            if (document.body.classList.contains('lightbox-open') || 
                document.body.classList.contains('modal-open') ||
                (document.getElementById('upload-overlay') && document.getElementById('upload-overlay').classList.contains('visible'))) {
                // Skip this cycle to avoid disturbing the user
                return;
            }
            
            // Run Silent Sync (isManual=false, isSilent=true)
            startSyncProcess(false, true);
        }
        function updateAutoRefreshState() {
            const toggle = document.getElementById('ar-toggle');
            const intervalInput = document.getElementById('ar-interval');
            
            // Select both containers (Desktop & Mobile) to sync the red dot UI
            const containerDesk = document.getElementById('refresh-container');
            const containerMob = document.getElementById('refresh-container-mob');
            
            isAutoRefreshActive = toggle.checked;
            
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            
            if (isAutoRefreshActive) {
                // Activate the red dot indicator on both containers
                if(containerDesk) containerDesk.classList.add('auto-active');
                if(containerMob) containerMob.classList.add('auto-active');
                
                let seconds = parseInt(intervalInput.value);
                if (seconds < 5) seconds = 5; // Enforce minimum interval
                
                autoRefreshTimer = setInterval(runAutoRefreshCycle, seconds * 1000);
                
                // Save preference
                localStorage.setItem('galleryAutoRefresh', JSON.stringify({active: true, interval: seconds}));
            } else {
                // Deactivate the red dot indicator on both containers
                if(containerDesk) containerDesk.classList.remove('auto-active');
                if(containerMob) containerMob.classList.remove('auto-active');
                
                // Save preference
                localStorage.setItem('galleryAutoRefresh', JSON.stringify({active: false, interval: parseInt(intervalInput.value)}));
            }
        }

        function initAutoRefresh() {
            // Debug log to confirm initialization
            console.log("AutoRefresh: Initializing...");
            
            const optionsBtn = document.getElementById('refresh-options-btn');
            const toggle = document.getElementById('ar-toggle');
            const intervalInput = document.getElementById('ar-interval');
            const popover = document.getElementById('auto-refresh-popover');
            
            if (!optionsBtn || !popover) {
                console.warn("AutoRefresh: Elements not found in DOM.");
                return;
            }

            // CRITICAL: Move the popover to the document body.
            // This solves clipping issues (overflow:hidden) caused by parent containers
            // on both Desktop and Mobile layouts.
            if (popover.parentNode !== document.body) {
                document.body.appendChild(popover);
            }

            // 1. Handle Click (Works for Touch on Mobile too)
            optionsBtn.addEventListener('click', toggleAutoRefreshMenu);
            
            // 2. Listen for Settings Changes
            if(toggle) toggle.addEventListener('change', updateAutoRefreshState);
            if(intervalInput) intervalInput.addEventListener('change', updateAutoRefreshState);
            
            // 3. Close popover when clicking outside
            document.addEventListener('click', (e) => {
                if (popover.classList.contains('visible')) {
                    // Close if click is NOT inside popover AND NOT on the trigger button
                    if (!popover.contains(e.target) && !optionsBtn.contains(e.target)) {
                        popover.classList.remove('visible');
                    }
                }
            });
            
            // 4. Restore State from Storage
            const saved = localStorage.getItem('galleryAutoRefresh');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if(intervalInput) intervalInput.value = settings.interval || 60;
                    if (settings.active && toggle) {
                        toggle.checked = true;
                        updateAutoRefreshState();
                    }
                } catch (e) {
                    console.error("Error restoring AutoRefresh settings:", e);
                }
            }
        }
        
        function formatBytes(bytes, decimals = 1) { if (!bytes) return '0 B'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['B', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }
        function appendFiles(files) { if (!files || files.length === 0) { if (currentItemCount === 0) showEmptyState(); updateLoadMoreVisibility(); return; } const fragment = document.createDocumentFragment(); const newLazyElements = []; files.forEach(file => { allFilesData.push(file); const item = createGalleryItem(file); fragment.appendChild(item); galleryItems.push(item); const lazyEl = item.querySelector('.lazy'); if (lazyEl) newLazyElements.push(lazyEl); }); galleryContainer.appendChild(fragment); initializeLazyLoading(newLazyElements); currentItemCount += files.length; updateLoadMoreVisibility(); }
        function createGalleryItem(file) {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            if (isGlobalSearch) item.classList.add('ai-global'); // reuse global style
            item.dataset.fileId = file.id;
            item.dataset.fileType = file.type;
            item.dataset.aiCaption = file.ai_caption || '';
            item.dataset.aiDate = file.ai_last_scanned || 0;
            item.setAttribute('draggable', 'true');
            item.addEventListener('dragstart', (event) => dragStart(event, file.id));
            let mediaHTML = '';
            if (file.type === 'audio') {
                mediaHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:4rem;color:#1ed760;">🎵</div>`;
            } else if (['image', 'animated_image'].includes(file.type)) {
                mediaHTML = `<img class="lazy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E" data-src="/galleryout/thumbnail/${file.id}" alt="${file.name}" loading="lazy">`;
            } else if (file.type === 'video') {
                // SMART STREAMING LOGIC
                // 1. Is it a format browsers can't play natively? (MOV/ProRes) -> Force Stream
                const isMov = file.name.toLowerCase().endsWith('.mov');
                
                // 2. Is it a large file exceeding the threshold? -> Prefer Stream (if FFmpeg exists)
                const isLarge = (file.size > streamThresholdBytes);
                
                // Final Decision: Use stream if necessary OR if beneficial (and possible)
                // If FFmpeg is missing, we MUST fallback to the raw file (except for MOVs which might fail to play)
                const useStream = ffmpegAvailable && (isMov || isLarge);
                
                const videoSource = useStream ? `/galleryout/stream/${file.id}` : `/galleryout/file/${file.id}`;
                
                // Logic: 
                // Autoplay ON: Plays automatically, muted.
                // Autoplay OFF: NO CONTROLS (fixes mobile tap issue), shows Overlay Icon, opens Lightbox on click.
                // Note: pointer-events-none on video ensures the click hits the parent thumbnail-link
                
                let vidAttrs = "";
                let overlayHTML = "";
                
                if (videoAutoplay) {
                    vidAttrs = "autoplay muted";
                } else {
                    // Autoplay OFF:
                    // CSS handles the interaction difference between Mobile (Pass-through) and Desktop (Clickable).
                    // We attach the onclick handler here; it will only fire on Desktop thanks to CSS pointer-events.
                    vidAttrs = 'preload="none" style="pointer-events:none;"'; 
                    overlayHTML = `<div class="video-play-overlay" title="Play Preview" onclick="playVideoInGrid(event, this)">▶</div>`;
                }

                mediaHTML = `
                    <video ${vidAttrs} loop playsinline class="lazy" 
                        data-src="${videoSource}" 
                        poster="/galleryout/thumbnail/${file.id}"></video>
                    ${overlayHTML}
                `;
            } else {
                mediaHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:3rem;color:var(--text-muted);">📄</div>`;
            }
            const summaryButtonHTML = file.has_workflow ? `<button title="Node Summary" onclick="showNodeSummary(event, '${file.id}')">📝</button>` : '';
            let metadataHTML = '';
            if (file.dimensions || file.mtime || file.size) {
                const date = new Date(file.mtime * 1000);
                const formattedDate = date.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                const dimensionsPart = file.dimensions ? `<span>📐 ${file.dimensions}</span>` : '';
                const datePart = file.mtime ? `<span>📅 ${formattedDate}</span>` : '';
                const sizePart = file.size ? `<span>💾 ${formatBytes(file.size)}</span>` : '';
                metadataHTML = `<div class="file-metadata">${dimensionsPart}${sizePart}${datePart}</div>`;
            }

            let scannedHTML = '';
            if (file.last_scanned) {
                const scannedDate = new Date(file.last_scanned * 1000);
                const formattedScannedDate = scannedDate.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                scannedHTML = `<div class="file-scanned-time" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; opacity: 0.8;">🔍 Scanned: ${formattedScannedDate}</div>`;
            }
            
            // AI Score Badge
            let aiBadgeHTML = '';
            if (isAiSearch && file.score) {
                const percentage = Math.round(file.score * 100);
                aiBadgeHTML = `<div class="ai-badge">score ${percentage}%</div>`;
            }

            item.innerHTML = `
                <div class="selection-checkmark" onclick="toggleSelection(event, '${file.id}', this.closest('.gallery-item'))">✓</div>
                <div class="thumbnail-link" onclick="openLightbox(event, '${file.id}'); event.stopPropagation();" draggable="false">
                    <div class="thumbnail-wrapper">
                        ${mediaHTML}
                        ${file.has_workflow ? `<a href="/galleryout/workflow/${file.id}" class="workflow-badge" onclick="event.stopPropagation()">⚙️ Workflow</a>` : ''}
                        ${aiBadgeHTML}
                        ${file.duration ? `<span class="duration-overlay">⏱️ ${file.duration}</span>` : ''}
                    </div>
                </div>
                <div class="item-info">
                    <div>
                        <p title="${file.name}"><strong>${file.name}</strong></p>
                        ${metadataHTML}
                        ${scannedHTML}
                    </div>
                    <div class="item-actions">
                        ${summaryButtonHTML}
                        <button class="favorite-btn ${file.is_favorite ? 'favorited' : ''}" title="Favorite" onclick="toggleFavorite(event, '${file.id}', this)">
                            ${file.is_favorite ? '⭐' : '☆'}
                        </button>
                        <a href="/galleryout/download/${file.id}" onclick="event.stopPropagation()" title="Download">💾</a>
                        <button class="delete-btn" onclick="deleteFile(event, '${file.id}', this)">🗑️</button>
                    </div>
                </div>
            `;
            
            // --- NEW: Hover Listeners for Shortcuts ---
            // Focus follows Mouse ONLY on active movement (prevents scroll-jumping)
            item.addEventListener('mousemove', (e) => {
                // If coordinates are same as last recorded, it's a scroll, not a move. Ignore.
                if (e.clientX === window.lastActiveX && e.clientY === window.lastActiveY) {
                    return;
                }
                
                // Update active coordinates
                window.lastActiveX = e.clientX;
                window.lastActiveY = e.clientY;

                // Sync focus
                if (focusedItemIndex !== galleryItems.indexOf(item)) {
                    if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                        galleryItems[focusedItemIndex].classList.remove('focused');
                    }
                    focusedItemIndex = galleryItems.indexOf(item);
                    item.classList.add('focused');
                }
            });
            item.addEventListener('mouseleave', () => { hoveredItemIndex = -1; });
            
            return item;
        }
        function updateLoadMoreVisibility() { const loadMoreContainer = document.getElementById('load-more-container'); if (!loadMoreContainer) return; const shouldHide = currentItemCount >= totalFiles || totalFiles === 0; loadMoreContainer.style.display = shouldHide ? 'none' : 'block'; }
        function updateFileCountBadge() { const fileCountBadge = document.querySelector('.file-count-badge'); if (!fileCountBadge) return; const displayCount = galleryItems.length; totalFiles = displayCount; totalFolderFiles--; const showTotal = totalFiles !== totalFolderFiles; fileCountBadge.textContent = `📂 ${displayCount} File${displayCount !== 1 ? 's' : ''}${showTotal ? ` (${totalFolderFiles} Total)` : ''}`; }
        function showEmptyState() { 
            const logoSrc = "{{ app_logo_b64 }}";
            let htmlContent = '';
            
            // Shared logo style (Full color + Blue Glow)
            const logoStyle = "width:80px; height:80px; margin-bottom:20px; filter: drop-shadow(0 0 15px rgba(0, 123, 255, 0.4));";
            
            // Check if filters are active to distinguish the case
            if (activeFiltersCount > 0) {
                // CASE 2: Filters active but no results found
                htmlContent = `
                    <div class="empty-state" style="grid-column: 1/-1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:4rem 1rem;">
                        <img src="${logoSrc}" style="${logoStyle}" alt="SmartGallery">
                        <h3 style="margin:0 0 10px 0; font-size:1.5rem; font-weight:700;">No results found</h3>
                        <p style="color:var(--text-muted); margin:0; font-size:1.1rem;">No files match your current search criteria.</p>
                        <a href="{{ url_for('gallery_view', folder_key=current_folder_key) }}" class="glass-btn" style="margin-top:25px; text-decoration:none; padding: 0.8rem 1.5rem;">
                            🗑️ Reset Filters
                        </a>
                    </div>
                `;
            } else {
                // CASE 1: Folder is physically empty
                htmlContent = `
                    <div class="empty-state" style="grid-column: 1/-1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:4rem 1rem;">
                        <img src="${logoSrc}" style="${logoStyle}" alt="SmartGallery">
                        <h3 style="margin:0 0 10px 0; font-size:1.5rem; font-weight:700;">This folder is empty</h3>
                        <p style="color:var(--text-muted); margin:0; font-size:1.1rem;">There are no files here yet.</p>
                        <button onclick="document.getElementById('show-upload-modal-btn').click()" class="glass-btn" style="margin-top:25px; padding: 0.8rem 1.5rem;">
                            📤 Upload Files
                        </button>
                    </div>
                `;
            }
            
            galleryContainer.innerHTML = htmlContent; 
        }
        function initializeLazyLoading(elements) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const el = entry.target;
                    
                    // Handle Images (Keep original simple logic: load once)
                    if (el.tagName === 'IMG') {
                        if (entry.isIntersecting) {
                            if (el.dataset.src) {
                                el.src = el.dataset.src;
                                el.removeAttribute('data-src');
                            }
                            el.classList.remove("lazy");
                            observer.unobserve(el); // Images are done once loaded
                        }
                        return;
                    }

                    // Handle Videos (Smart Play/Pause logic)
                    if (el.tagName === 'VIDEO') {
                        if (entry.isIntersecting) {
                            // 1. Load source if not loaded yet
                            if (el.dataset.src) {
                                el.src = el.dataset.src;
                                // If Autoplay is OFF (Click-to-play), we DON'T call load() aggressively 
                                // unless user interacts, but setting src usually triggers loading metadata.
                                // With preload="none", it should be fine.
                                if (videoAutoplay) el.load(); 
                                el.removeAttribute('data-src');
                                el.classList.remove("lazy");
                            }
                            
                            // 2. Play when visible ONLY if preference is ON
                            if (videoAutoplay) {
                                const playPromise = el.play();
                                if (playPromise !== undefined) {
                                    playPromise.catch(error => { console.log("Autoplay prevented:", error); });
                                }
                            }
                        } else {
                            // 3. Pause when out of viewport to save resources
                            if (!el.paused && !el.dataset.src) {
                                el.pause();
                            }
                        }
                        // Do NOT unobserve video! We need to check it continuously.
                    }
                });
            }, {
                root: null,
                rootMargin: '50px', // Preload slightly before appearing
                threshold: 0.2      // Trigger when 20% visible
            });

            elements.forEach(el => observer.observe(el));
        }
        async function createFolder() {
            const folderName = await smartPrompt("📁 New Folder", "Enter a name for the new folder:", "");
            
            if (folderName && folderName.trim()) {
                fetch('/galleryout/create_folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder_name: folderName.trim(),
                        parent_key: currentFolderKey
                    })
                })
                .then(handleGenericResponse)
                .catch(handleError);
            }
        }
        
        // --- SHOW FOLDER INFO FUNCTION (Advanced) ---
        function showFolderInfo(event, folderKey) {
            event.stopPropagation();
            const folder = foldersData[folderKey];
            if (!folder) return;

            // 1. Base Info (Gallery Logical Path)
            let msg = `📂 Folder: ${folder.display_name}\n\n📍 Gallery Location:\n${folder.path}`;
            
            // 2. Resolve Paths for comparison (normalize slashes and case)
            const normPath = (folder.path || "").replace(/\\/g, '/').toLowerCase();
            const normReal = (folder.real_path || "").replace(/\\/g, '/').toLowerCase();

            // 3. Check if it's a Link or inside a Link
            // If the logical path differs from the real physical path, it's a link (or child of a link)
            if (normReal && normPath !== normReal) {
                msg += `\n\n🔗 Real Physical Source:\n${folder.real_path}`;
                
                if (folder.is_mount) {
                    msg += `\n(Root Link / Mount Point)`;
                } else {
                    msg += `\n(Subfolder of a Linked Drive)`;
                }
            }

            // Use 'path-msg' class for monospace font and word wrapping on mobile
            showNotification(msg, 'info path-msg', 10000);
            
            // Close the menu
            const btn = event.target;
            const menu = btn.closest('.folder-dropdown');
            if (menu) menu.classList.remove('show');
        }
        
        async function renameFolder(event, folderKey, oldName) {
            event.stopPropagation();
            const newName = await smartPrompt("✏️ Rename Folder", `Enter the new name for "${oldName}":`, oldName);

            if (newName && newName.trim() && newName.trim() !== oldName) {
                fetch(`/galleryout/rename_folder/${folderKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: newName.trim() })
                })
                .then(handleGenericResponse)
                .catch(handleError);
            }
        }
        async function deleteFolder(event, folderKey, folderName) {
            event.stopPropagation();
            const confirmed = await smartConfirm(
                "🗑️ Delete Folder?", 
                `Delete the folder "${folderName}" and all its contents?\nThis cannot be undone.`, 
                true // isDanger = true (Red Button)
            );

            if (confirmed) {
                fetch(`/galleryout/delete_folder/${folderKey}`, { method: 'POST' })
                .then(handleGenericResponse)
                .catch(handleError);
            }
        }
        
        function hideDropZone() { document.getElementById('drag-drop-overlay').classList.remove('visible'); document.getElementById('drop-zone-panel').classList.remove('visible'); }
        function dragStart(event, fileId) {
            event.stopPropagation();
            // If the item being dragged isn't selected, select it (and deselect others)
            if (!selectedFiles.has(fileId)) {
                deselectAll();
                selectedFiles.add(fileId);
                updateSelectionUI();
            }
            // Visual feedback: Create a ghost image for dragging
            const dragImage = document.createElement('div');
            dragImage.style.cssText = `position:absolute;top:-100px;background:var(--primary-color);color:white;padding:8px 16px;border-radius:8px;font-weight:600;z-index:10000;`;
            dragImage.textContent = `📦 ${selectedFiles.size} file${selectedFiles.size !== 1 ? 's' : ''}`;
            document.body.appendChild(dragImage);
            event.dataTransfer.setDragImage(dragImage, 0, 0);
            // Cleanup: remove the temporary element after drag starts
            setTimeout(() => document.body.removeChild(dragImage), 0);
            // Pass the selected file IDs to the dataTransfer object
            event.dataTransfer.setData('text/plain', [...selectedFiles].join(','));
        }
        function toggleSelection(event, fileId, item) {
            event.stopPropagation();
                        
            // Sync keyboard focus with mouse selection
            const newIndex = galleryItems.indexOf(item);
            if (newIndex !== -1) {
                if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                    galleryItems[focusedItemIndex].classList.remove('focused');
                }
                focusedItemIndex = newIndex;
                galleryItems[focusedItemIndex].classList.add('focused');
            }

            const isShift = event.shiftKey;
            if (isShift && lastSelectedItem) {
                const lastIndex = galleryItems.findIndex(i => i.dataset.fileId === lastSelectedItem.dataset.fileId);
                const currentIndex = galleryItems.findIndex(i => i.dataset.fileId === fileId);
                const [start, end] = [lastIndex, currentIndex].sort((a, b) => a - b);
                for (let i = start; i <= end; i++) {
                    selectedFiles.add(galleryItems[i].dataset.fileId);
                }
            } else {
                selectedFiles.has(fileId) ? selectedFiles.delete(fileId) : selectedFiles.add(fileId);
                lastSelectedItem = item;
            }
            updateSelectionUI();
        }
        
        // --- FOCUS MODE LOGIC ---
        function toggleFocusMode() {
            const body = document.body;
            const btn = document.getElementById('focus-mode-btn');
            
            const isActive = body.classList.toggle('focus-mode');
            
            if (btn) {
                if (isActive) {
                    btn.classList.add('active-focus');
                    showNotification("⚡ You’re in Focus Mode — Use shortcuts for actions (press '?' for help).", "info", 6000);
                } else {
                    btn.classList.remove('active-focus');
                }
            }
            
            // Save state
            localStorage.setItem('galleryFocusMode', isActive);
        }

        function initFocusMode() {
            const savedState = localStorage.getItem('galleryFocusMode');
            const btn = document.getElementById('focus-mode-btn');
            
            // Only apply on Desktop to avoid confusion on mobile
            if (savedState === 'true' && window.innerWidth > 1024) {
                document.body.classList.add('focus-mode');
                if (btn) btn.classList.add('active-focus');
            }
        }
        
        function updateSelectionUI() {
            
            // 1. Refresh visual selection on all items
            galleryItems.forEach(item => { 
                item.classList.toggle('selected', selectedFiles.has(item.dataset.fileId)); 
            });

            const count = selectedFiles.size;
            selectionCounter.textContent = `📊 ${count} file${count !== 1 ? 's' : ''} selected`;
            
            // 2. Show/Hide selection bar
            selectionBar.classList.toggle('visible', count > 0);

            // Smart BackToTop Position Logic
            const btnTop = document.getElementById('backToTopBtn');
            if (count > 0) {
                const barHeight = selectionBar.offsetHeight;
                btnTop.style.bottom = (barHeight + 50) + 'px';
            } else {
                btnTop.style.bottom = '';
            }

            // 3. RANGE BUTTON LOGIC (Restored)
            const rangeBtn = document.getElementById('range-select-btn');
            if (rangeBtn) {
                if (count === 2) {
                    const selectedIds = Array.from(selectedFiles);
                    const index1 = galleryItems.findIndex(item => item.dataset.fileId === selectedIds[0]);
                    const index2 = galleryItems.findIndex(item => item.dataset.fileId === selectedIds[1]);
                    
                    if (index1 !== -1 && index2 !== -1 && Math.abs(index1 - index2) > 1) {
                        rangeBtn.style.display = 'inline-block';
                        rangeBtn.onclick = () => selectRange(index1, index2);
                    } else {
                        rangeBtn.style.display = 'none';
                    }
                } else {
                    rangeBtn.style.display = 'none';
                }
            }
            
            // --- COMPARE BUTTON LOGIC ---
            const selCount = selectedFiles.size;
            let compareBtn = document.getElementById('compare-selected-btn');
            
            // Inject button if missing
            if (!compareBtn) {
                compareBtn = document.createElement('button');
                compareBtn.id = 'compare-selected-btn';
                compareBtn.className = 'sel-btn';
                compareBtn.title = 'Compare 2 Files';
                compareBtn.innerHTML = '⚖️';
                compareBtn.onclick = startCompareMode;
                // Insert before delete button
                const actionsDiv = document.querySelector('.sel-bar-actions');
                const deleteBtn = document.getElementById('delete-selected-btn');
                if(actionsDiv && deleteBtn) actionsDiv.insertBefore(compareBtn, deleteBtn);
            }
            
            // Only show if exactly 2 items are selected
            if(compareBtn) {
                compareBtn.style.display = (selCount === 2) ? 'flex' : 'none';
                if (selCount === 2) compareBtn.style.color = 'var(--ai-color)';
            }
            
            // --- COMPARE MENU ITEM LOGIC (Redundant for Mobile) ---
            const cmpMenuBtn = document.getElementById('compare-menu-btn');
            const cmpMenuSep = document.getElementById('compare-menu-sep');
            
            if (cmpMenuBtn && cmpMenuSep) {
                if (count === 2) {
                    // Show in menu if exactly 2 items selected
                    cmpMenuBtn.style.display = 'flex';
                    cmpMenuSep.style.display = 'block';
                } else {
                    // Hide otherwise
                    cmpMenuBtn.style.display = 'none';
                    cmpMenuSep.style.display = 'none';
                }
            }

            // 4. Sync the "Select All" toggle button text
            updateSelectAllButtonState();
        }
        
        function selectAll() { galleryItems.forEach(item => selectedFiles.add(item.dataset.fileId)); lastSelectedItem = galleryItems.length > 0 ? galleryItems[galleryItems.length - 1] : null; updateSelectionUI(); }
        function deselectAll() { selectedFiles.clear(); lastSelectedItem = null; updateSelectionUI(); }
        
        // --- RANGE SELECTION LOGIC ---
        function selectRange(index1, index2) {
            const start = Math.min(index1, index2);
            const end = Math.max(index1, index2);
            
            for (let i = start + 1; i < end; i++) {
                if (galleryItems[i]) {
                    selectedFiles.add(galleryItems[i].dataset.fileId);
                }
            }
            // Update UI to show newly selected items
            updateSelectionUI();
        }
        
        // --- TOGGLE SELECT LOGIC ---
        
        // --- TOGGLE SELECT LOGIC (Fixed for Desktop Text & Mobile Icon) ---
        function updateSelectAllButtonState() {
            // Select all buttons used for toggling selection (Desktop and Mobile)
            const buttons = document.querySelectorAll('.toggle-select-all-btn');
            
            // Check if all currently visible items in the grid are selected
            const allSelected = galleryItems.length > 0 && galleryItems.every(item => selectedFiles.has(item.dataset.fileId));

            buttons.forEach(btn => {
                // Identify the desktop button by its specific ID
                const isDesktop = (btn.id === 'toggle-select-btn');

                if (allSelected) {
                    // State: EVERYTHING SELECTED -> Show DESELECT option
                    btn.innerHTML = isDesktop ? "❎ Deselect All" : "❎";
                    btn.classList.add('active-blue'); 
                } else {
                    // State: NOT EVERYTHING SELECTED -> Show SELECT ALL option
                    btn.innerHTML = isDesktop ? "✅ Select All" : "✅";
                    btn.classList.remove('active-blue');
                }
            });
        }

        function toggleSelectAll() {
            const allSelected = galleryItems.length > 0 && galleryItems.every(item => selectedFiles.has(item.dataset.fileId));
            if (allSelected) deselectAll();
            else selectAll();
        }
        
        function toggleFavorite(event, fileId, element) { 
            event.stopPropagation(); 
            const originalContent = element.innerHTML; 
            element.innerHTML = '⏳'; 
            element.disabled = true; 
            
            fetch(`/galleryout/toggle_favorite/${fileId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => { 
                if (data.status === 'success') { 
                    // 1. Update UI
                    element.classList.toggle('favorited', data.is_favorite); 
                    element.innerHTML = data.is_favorite ? '⭐' : '☆'; 
                    
                    // 2. Update Global Data (Critical for Copy logic)
                    const fileData = allFilesData.find(f => f.id === fileId);
                    if (fileData) {
                        fileData.is_favorite = data.is_favorite;
                    }

                    showNotification(data.is_favorite ? 'Added to favorites!' : 'Removed from favorites!', 'success'); 
                } else { 
                    element.innerHTML = originalContent; 
                    showNotification('Error toggling favorite', 'error'); 
                } 
            })
            .catch(error => { 
                element.innerHTML = originalContent; 
                handleError(error); 
            })
            .finally(() => element.disabled = false); 
        }
        
        // Added skipConfirm parameter for Quick Delete via keyboard
        async function deleteFile(event, fileId, element, skipConfirm = false) {
            if (event) event.stopPropagation();

            // Only ask for confirmation if NOT skipping (Normal click mode)
            if (!skipConfirm) {
                const confirmed = await smartConfirm(
                    "🗑️ Delete File?", 
                    "Are you sure you want to delete this file?\nThis cannot be undone.", 
                    true
                );
                if (!confirmed) return;
            }

            // If triggered via keyboard hover, 'element' might be the button or the item itself. 
            // We need to ensure we find the container item safely.
            const item = element.closest('.gallery-item');
            
            // Disable button if passed (might be null or undefined in keyboard trigger)
            if (element && element.tagName === 'BUTTON') element.disabled = true;

            fetch(`/galleryout/delete/${fileId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        item.style.transition = 'all 0.2s ease'; // Faster transition for quick delete
                        item.style.opacity = '0';
                        item.style.transform = 'scale(0.8)';
                        
                        // [CHANGED] Always show notification, even for Quick Delete
                        showNotification('File deleted!', 'success');
                        
                        setTimeout(() => {
                            item.remove();
                            galleryItems = galleryItems.filter(gi => gi !== item);
                            allFilesData = allFilesData.filter(f => f.id !== fileId);
                            selectedFiles.delete(fileId);
                            updateSelectionUI();
                            currentItemCount--;
                            updateFileCountBadge();
                            updateLoadMoreVisibility();
                        }, 200); // Faster removal
                    } else {
                        // Always show error notifications
                        showNotification(`Error: ${data.message || 'Deletion failed'}`, 'error');
                        if (element && element.tagName === 'BUTTON') element.disabled = false;
                    }
                })
                .catch(error => {
                    handleError(error);
                    if (element && element.tagName === 'BUTTON') element.disabled = false;
                });
        }
        
        function moveSelected() { if (selectedFiles.size > 0) populateAndShowDropPanel(); }
        
        // --- COPY FILES LOGIC ---
        // Wrapper to start Move
        function initiateMove() {
            if (selectedFiles.size === 0) return;
            currentDropAction = 'move';
            populateAndShowDropPanel();
        }
        
         // Wrapper to start Copy
        async function copySelected() {
            if (selectedFiles.size === 0) return;
            
            // 1. Check for Favorites in selection
            let hasFavorites = false;
            const ids = Array.from(selectedFiles);
            
            for (const id of ids) {
                const f = allFilesData.find(x => x.id === id);
                // Check allows for 1 (int), true (bool)
                if (f && (f.is_favorite === 1 || f.is_favorite === true)) {
                    hasFavorites = true;
                    break;
                }
            }
            
            copyKeepFavorites = false; // Reset default
            
            // 2. Ask User if favorites exist
            if (hasFavorites) {
                const choice = await showSmartDialog(
                    'yes_no_cancel',
                    '⭐ Handling Favorites',
                    'Some selected files are marked as Favorites.\n\nDo you want to keep the "Favorite" status on the new copies?',
                    '',
                    'active-blue'
                );
                
                if (choice === null) return; // Cancelled
                copyKeepFavorites = choice; // True (Yes) or False (No)
            }
            
            // 3. Open Panel
            currentDropAction = 'copy';
            populateAndShowDropPanel();
        }

        // Updated Panel Show Logic
        function populateAndShowDropPanel() {
            // Update Title based on Action
            const titleEl = document.querySelector('#drop-zone-panel h3');
            if (titleEl) {
                const actionName = (currentDropAction === 'copy') ? 'Cc Copy' : '➜ Move';
                titleEl.textContent = `${actionName} to Folder:`;
            }

            // Sync sorting state
            currentSort.move = { ...currentSort.nav };

            document.getElementById('drag-drop-overlay').classList.add('visible');
            document.getElementById('drop-zone-panel').classList.add('visible');

            updateSortButtonsUI('move');
            document.getElementById('move-folder-tree').innerHTML = buildFolderTreeHTML('_root_', true);
            filterTree('move-folder-tree', currentSearch.move, false);
        }

        // Updated Confirm Logic
        function confirmMoveToFolder(folderKey) { 
            if (!selectedFiles || selectedFiles.size === 0) { 
                showNotification('No files selected.', 'warning'); 
                return; 
            } 
            
            if (currentDropAction === 'copy') {
                // Copy Action
                performBatchAction('/galleryout/copy_batch', { 
                    file_ids: [...selectedFiles], 
                    destination_folder: folderKey,
                    keep_favorites: copyKeepFavorites
                });
            } else {
                // Move Action
                performBatchAction('/galleryout/move_batch', { 
                    file_ids: [...selectedFiles], 
                    destination_folder: folderKey 
                }); 
            }
            
            hideDropZone(); 
        }
        async function deleteSelected() {
            const count = selectedFiles.size;
            if (count > 0) {
                const confirmed = await smartConfirm(
                    "🗑️ Delete Batch", 
                    `Are you sure you want to delete ${count} files?\nThis cannot be undone.`, 
                    true
                );
                
                if (confirmed) {
                    performBatchAction('/galleryout/delete_batch', { file_ids: [...selectedFiles] });
                }
            }
        }
         function performBatchAction(url, body) { 
            fetch(url, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(body) 
            })
            .then(handleGenericResponse)
            .catch(handleError); 
        }
        function favoriteSelected(status) { if (selectedFiles.size === 0) return; performBatchAction('/galleryout/favorite_batch', { file_ids: [...selectedFiles], status: status }); }
        function downloadSelectedZip() {
            if (selectedFiles.size === 0) return;
            const fileIds = [...selectedFiles];
            
            showNotification('Generating zip file in background...', 'info');

            fetch('/galleryout/prepare_batch_zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_ids: fileIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    pollZipStatus(data.job_id);
                } else {
                    showNotification('Error starting zip: ' + data.message, 'error');
                }
            })
            .catch(handleError);
        }

        function pollZipStatus(jobId) {
            const interval = setInterval(() => {
                fetch(`/galleryout/check_zip_status/${jobId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'ready') {
                            clearInterval(interval);
                            // Creiamo una notifica speciale persistente con il link
                            showDownloadNotification(data.download_url, data.filename);
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            showNotification('Zip generation failed: ' + data.message, 'error');
                        }
                        // if 'processing', keep waiting
                    })
                    .catch(err => {
                        clearInterval(interval);
                        console.error(err);
                    });
            }, 2000); // Check every 2 secs
        }

        function showDownloadNotification(url, filename) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.style.display = 'flex';
            notification.style.flexDirection = 'column';
            notification.style.gap = '10px';
            
            const text = document.createElement('span');
            text.textContent = '📦 Zip archive is ready!';
            
            const btn = document.createElement('a');
            btn.href = url;
            btn.textContent = 'Download Now';
            btn.style.backgroundColor = 'white';
            btn.style.color = 'var(--success-color)';
            btn.style.padding = '5px 10px';
            btn.style.borderRadius = '4px';
            btn.style.textDecoration = 'none';
            btn.style.fontWeight = 'bold';
            btn.style.textAlign = 'center';
            btn.style.cursor = 'pointer';
            
            // By clicking onload and close the notification after a bit
            btn.onclick = (e) => {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }, 1000);
            };

            notification.appendChild(text);
            notification.appendChild(btn);
            
            container.appendChild(notification);
            
            // Animation entry
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Does not disappear automaticly after 3 seconds, 
            // stays till the user downloads or closes it
            setTimeout(() => {
                if(document.body.contains(notification)) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }
            }, 60000); // Disappear after 60 secs if ignored
        }
        const lightboxOverlay = document.getElementById('lightbox-overlay'); const lightboxMedia = document.getElementById('lightbox-media'); const lightboxTitle = document.getElementById('lightbox-title'); const lightboxDownload = document.getElementById('lightbox-download'); const lightboxWorkflow = document.getElementById('lightbox-workflow'); const lightboxNewTab = document.getElementById('lightbox-new-tab'); const lightboxAiCaption = document.getElementById('lightbox-ai-caption'); let currentLightboxIndex = -1; let currentLightboxFile = null; let currentZoom = 1; let currentTranslateX = 0; let currentTranslateY = 0; let panStep = 50;
        function updateLightboxTitle() { if (!currentLightboxFile) return; const zoomPercentage = Math.round(currentZoom * 100); lightboxTitle.textContent = `${currentLightboxFile.name} (Scale: ${zoomPercentage}%)`; }
        function updateMediaTransform() { const mediaEl = lightboxMedia.querySelector('img, video'); if (!mediaEl) return; mediaEl.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentZoom})`; updateLightboxTitle(); }
        
        function openLightbox(event, fileId, forceOpen = false) { 
            if (event && event.target && event.target.closest('a, button')) return; 
            if (event && event.stopPropagation) event.stopPropagation(); 
            
            // --- FOCUS MODE INTERCEPTION ---
            // If in Focus Mode AND NOT forcing open (like via 'V' key),
            // simply toggle selection.
            if (!forceOpen && document.body.classList.contains('focus-mode')) {
                const item = galleryItems.find(i => i.dataset.fileId === fileId);
                if (item) {
                    toggleSelection(event, fileId, item);
                }
                return;
            }
            // -------------------------------

            currentLightboxIndex = galleryItems.findIndex(item => item.dataset.fileId === fileId); 
            if (currentLightboxIndex === -1) return; 
            currentZoom = 1; currentTranslateX = 0; currentTranslateY = 0; panStep = 50; 
            document.body.classList.add('lightbox-open'); 
            lightboxOverlay.classList.add('visible'); 
            showItemAtIndex(currentLightboxIndex); 
        }
        
        function closeLightbox() {
            // FIX: Use correct function name for the new Storyboard
            if (typeof closeStoryboard === "function") {
                closeStoryboard();
            }
            
            const mediaElement = lightboxMedia.querySelector('video, audio');
            if (mediaElement) mediaElement.pause();
            
            toggleAiCaption(false);

            if (currentLightboxIndex !== -1 && galleryItems.length > 0) {
                if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                    galleryItems[focusedItemIndex].classList.remove('focused');
                }
                focusedItemIndex = currentLightboxIndex;
                const newItem = galleryItems[focusedItemIndex];
                if (newItem) {
                    newItem.classList.add('focused');
                    newItem.scrollIntoView({ behavior: 'auto', block: 'center' });
                }
            }

            document.body.classList.remove('lightbox-open');
            lightboxOverlay.classList.remove('visible');
            lightboxMedia.innerHTML = '';
            currentLightboxIndex = -1;
            currentLightboxFile = null;
        }
        
        // --- LIGHTBOX HELP LOGIC ---
        function openLightboxHelp() {
            const overlay = document.getElementById('lightbox-help-overlay');
            overlay.classList.add('visible');
            document.body.classList.add('modal-open');
        }

        function closeLightboxHelp() {
            const overlay = document.getElementById('lightbox-help-overlay');
            overlay.classList.remove('visible');
            // Remove modal-open only if no other modal is visible
            if (!document.getElementById('node-summary-overlay').classList.contains('visible')) {
                document.body.classList.remove('modal-open');
            }
        }
        
        function updateLightboxPathTooltip(file) {
            const lightboxFolderEl = document.getElementById('lightbox-folder-name');
            if (!lightboxFolderEl || !file || !file.path) return;

            lightboxFolderEl.onclick = (e) => {
                e.stopPropagation();

                // 1. Local helper to normalize paths (ONLY HERE)
                // Converts every backslash (\) to forward slash (/) for uniformity
                const normalize = (p) => p ? p.replace(/\\/g, '/') : null;

                const cleanInternal = normalize(file.path);
                const cleanReal = normalize(file.real_path);

                let msg = "";

                // 2. Robust comparison logic
                // Check if real path exists AND differs from internal path
                // Use toLowerCase() to avoid false positives on Windows (C:\A vs c:\a)
                const isDifferent = cleanReal && (cleanInternal.toLowerCase() !== cleanReal.toLowerCase());

                if (isDifferent) {
                    // Case: Mounted Folder (Link)
                    msg = `📍 Gallery Link:\n${cleanInternal}\n\n🔗 Real Source:\n${cleanReal}`;
                } else {
                    // Case: Standard Folder (or identical paths)
                    msg = `📍 File Path:\n${cleanInternal}`;
                }
                
                // Show notification for 10 seconds
                showNotification(msg, 'info path-msg', 10000);
            };
        }
        
        function showItemAtIndex(index) {
            const item = galleryItems[index];
            if (!item) return;
            
            const file = allFilesData.find(f => f.id === item.dataset.fileId);
            if (!file) return;
            
            currentLightboxFile = file;
            updateLightboxTitle();
            
            // Set Folder Name AND Resolution in Lightbox
            const lightboxFolderEl = document.getElementById('lightbox-folder-name');
            let metaHtml = '';
            
            // 1. Folder Path Logic
            if (file.path) {
                const parts = file.path.split(/[/\\]/);
                if (parts.length > 1) {
                    let folderName = parts[parts.length - 2];
                    if (folderName.toLowerCase() === 'output') folderName = 'Main';
                    metaHtml += `📂 ${folderName} `;
                }
            }
            
            // 2. Resolution & Megapixel Logic (Using Helper)
            if (file.dimensions) {
                // Add separator if we already have folder text
                if (metaHtml) metaHtml += ' <span style="opacity:0.4; margin:0 8px;">|</span> ';
                
                // Use the helper function to get "1024x1024 (1 MP)"
                const resString = getResolutionString(file);
                metaHtml += `<span style="color:var(--text-muted); font-family:monospace;">📐 ${resString}</span>`;
            }
            
            // 3. Info Icon & Tooltip Binding
            if (file.path) {
                metaHtml += ` <span style="color:var(--favorite-color); font-size:1em; margin-left:6px; cursor:help;" title="Click to see full path">ⓘ</span>`;
                lightboxFolderEl.title = file.path; 
                lightboxFolderEl.style.cursor = 'help';
                
                // Bind the click event for the full path notification
                updateLightboxPathTooltip(file);
            } else {
                lightboxFolderEl.title = '';
                lightboxFolderEl.style.cursor = 'default';
                lightboxFolderEl.onclick = null;
            }

            // Apply final HTML
            lightboxFolderEl.innerHTML = metaHtml;
            
            // Clear the container
            lightboxMedia.innerHTML = '';
            // Hide caption by default when changing images
            toggleAiCaption(false);
            
            let mediaEl;
            const isImage = ['image', 'animated_image'].includes(file.type);

            // Create element based on type
            if (file.type === 'audio') {
                mediaEl = document.createElement('audio');
                mediaEl.src = `/galleryout/file/${file.id}`;
                mediaEl.controls = true;
                mediaEl.autoplay = true;
            } else if (isImage) {
                mediaEl = document.createElement('img');
                mediaEl.src = `/galleryout/file/${file.id}`;
                mediaEl.alt = file.name;
            } else if (file.type === 'video') {
                mediaEl = document.createElement('video');
                
                const lowerName = file.name.toLowerCase();
                
                // LOGIC: NATIVE vs STREAMING
                // Browsers natively support: .mp4 (h264), .webm
                // Browsers FAIL on: .mkv, .avi, .mov (ProRes/HEVC), .wmv, .flv
                // We force streaming for ANY container that isn't strictly standard mp4/webm
                // or if it's a "heavy" file (streamThresholdBytes).
                
                const isNativeContainer = lowerName.endsWith('.mp4') || lowerName.endsWith('.webm');
                const isHeavy = (file.size > streamThresholdBytes);
                
                // Special check for MOV: Browsers play simple h264 MOVs, but crash on ProRes.
                // To be safe in post-production context, we usually stream MOVs too.
                
                let useStream = isHeavy; // Default rule based on size
                
                if (!isNativeContainer) {
                    useStream = true; // Always stream MKV, AVI, WMV, etc.
                }
                
                // Force stream for .mov to support ProRes/DNxHD
                if (lowerName.endsWith('.mov')) {
                    useStream = true;
                }

                if (useStream && ffmpegAvailable) {
                    mediaEl.src = `/galleryout/stream/${file.id}`;
                } else {
                    mediaEl.src = `/galleryout/file/${file.id}`;
                }
                
                mediaEl.controls = true;
                mediaEl.autoplay = true;
                mediaEl.loop = true;
            }
            
            if (mediaEl) {
                const showMedia = () => {
                    const loader = lightboxMedia.querySelector('.lightbox-loader');
                    if (loader) loader.remove();
                    mediaEl.style.opacity = '1';
                    updateMediaTransform();
                };

                if (isImage && mediaEl.complete) {
                    mediaEl.style.opacity = '1'; 
                    lightboxMedia.appendChild(mediaEl);
                    updateMediaTransform();
                } 
                else {
                    const loader = document.createElement('div');
                    loader.className = 'lightbox-loader';
                    lightboxMedia.appendChild(loader);

                    mediaEl.style.opacity = '0';
                    mediaEl.style.transition = 'opacity 0.15s ease-out'; 

                    if (isImage) {
                        mediaEl.onload = showMedia;
                    } else {
                        mediaEl.onloadeddata = showMedia;
                        mediaEl.onerror = () => {
                            if (loader) loader.remove();
                            lightboxMedia.innerHTML = `<div style="color:var(--danger-color);">Error loading media</div>`;
                        };
                    }
                    
                    lightboxMedia.appendChild(mediaEl);
                }
                requestAnimationFrame(() => updateMediaTransform());

            } else {
                lightboxMedia.innerHTML = `<div style="color:white;font-size:1.2rem;text-align:center;">📄<br>Preview not available</div>`;
            }
            
            // Update toolbar (Initial rendering from Cache)
            lightboxDownload.href = `/galleryout/download/${file.id}`;
            lightboxNewTab.href = `/galleryout/file/${file.id}`;
            
            updateLightboxButtonsUI(file.has_workflow, file.ai_caption, file.id);

            // --- NEW: Perform a background check for fresh metadata ---
            verifyMetadataRealtime(file.id);
        }

        // Helper to update buttons state in Lightbox
        function updateLightboxButtonsUI(hasWorkflow, aiCaption, fileId) {
            const summaryBtn = document.getElementById('lightbox-summary-btn');
            const workflowBtn = document.getElementById('lightbox-workflow');
            const copyBtn = document.getElementById('lightbox-copy-json');
            const captionBtn = document.getElementById('lightbox-caption-icon');
            const resetAiBtn = document.getElementById('lightbox-reset-ai-btn'); // Reference to the new Erase button

            // 1. Workflow Buttons Logic
            if (hasWorkflow) {
                workflowBtn.href = `/galleryout/workflow/${fileId}`;
                workflowBtn.style.display = 'flex';
                
                // Show Copy Button
                if(copyBtn) copyBtn.style.display = 'flex';
                
                summaryBtn.style.display = 'flex';
                summaryBtn.onclick = (event) => {
                    event.stopPropagation();
                    showNodeSummary(event, fileId);
                };
            } else {
                workflowBtn.style.display = 'none';
                if(copyBtn) copyBtn.style.display = 'none';
                summaryBtn.style.display = 'none';
                summaryBtn.onclick = null;
            }
            
            // 2. AI Buttons Logic (Caption & Reset)
            if (aiCaption) {
                // Show Brain Icon
                captionBtn.style.display = 'flex';
                captionBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleAiCaption(true, aiCaption);
                };
                
                // Show Erase Button (only if file has AI data)
                if(resetAiBtn) resetAiBtn.style.display = 'flex';
            } else {
                // Hide Brain Icon
                captionBtn.style.display = 'none';
                
                // Hide Erase Button
                if(resetAiBtn) resetAiBtn.style.display = 'none';
            }
            
            // --- STORYBOARD BUTTON LOGIC ---
            const filmstripBtn = document.getElementById('lightbox-filmstrip-btn');
            if (filmstripBtn && currentLightboxFile) {
                const isSupported = (currentLightboxFile.type === 'video' || currentLightboxFile.type === 'animated_image');
                if (isSupported && ffmpegAvailable) {
                    filmstripBtn.style.display = 'flex';
                    // Click handler now calls openStoryboard
                    filmstripBtn.onclick = () => openStoryboard(currentLightboxFile.id);
                } else {
                    filmstripBtn.style.display = 'none';
                }
            }
            
        }
        
        // New Function: Fetches real status from server and updates UI
        function verifyMetadataRealtime(fileId) {
            fetch(`/galleryout/check_metadata/${fileId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 1. Update the cached data object
                        const fileIndex = allFilesData.findIndex(f => f.id === fileId);
                        if (fileIndex !== -1) {
                            allFilesData[fileIndex].has_workflow = data.has_workflow;
                            allFilesData[fileIndex].ai_caption = data.ai_caption;
                            allFilesData[fileIndex].ai_last_scanned = data.ai_last_scanned;
                            // NEW: Store real path if available
                            allFilesData[fileIndex].real_path = data.real_path; 
                        }

                        // 2. If we are still looking at the same file, update the UI
                        if (currentLightboxFile && currentLightboxFile.id === fileId) {
                            currentLightboxFile.ai_last_scanned = data.ai_last_scanned; 
                            currentLightboxFile.real_path = data.real_path; // Cache locally
                            
                            updateLightboxButtonsUI(data.has_workflow, data.ai_caption, fileId);
                            
                            // 3. REFRESH PATH CLICK HANDLER (To include the real path if just discovered)
                            // We call a helper to re-bind the click event with fresh data
                            updateLightboxPathTooltip(currentLightboxFile); 

                            // Update open caption if needed
                            const captionBox = document.getElementById('lightbox-ai-caption');
                            if (captionBox.classList.contains('visible') && data.ai_caption) {
                                toggleAiCaption(true, data.ai_caption);
                            }
                        }
                    }
                })
                .catch(err => console.error("Metadata check failed:", err));
        }
        
        function toggleAiCaption(show, text='') {
            const captionBox = document.getElementById('lightbox-ai-caption');
            
            if (show && text) {
                const formattedText = formatAiCaptionText(text);
                
                // --- LOGIC DATE ---
                let dateHtml = '';
                // Se siamo nel lightbox, usiamo i dati freschi del file corrente
                if (currentLightboxFile && currentLightboxFile.ai_last_scanned) {
                    const ts = parseFloat(currentLightboxFile.ai_last_scanned);
                    if (ts > 0) {
                        const dateObj = new Date(ts * 1000);
                        // Formato leggibile: DD/MM/YYYY HH:MM
                        const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        dateHtml = `<span style="color:#aaa; font-size:0.85rem; font-weight:normal; margin-left:10px;">(Indexed: ${dateStr})</span>`;
                    }
                }
                // -------------------

                captionBox.innerHTML = `
                    <button class="caption-close-btn" title="Close" onclick="toggleAiCaption(false)">×</button>
                    <div id="lightbox-ai-text-scroll">
                        <strong style="color:var(--ai-color); display:block; margin-bottom:10px; font-size:1.1rem;">
                            🧠 AI Caption: ${dateHtml}
                        </strong>
                        ${formattedText}
                    </div>
                `;
                captionBox.classList.add('visible');
            } else {
                captionBox.classList.remove('visible');
            }
        }
        
        function navigateLightbox(direction) { if (galleryItems.length === 0) return; currentLightboxIndex = (currentLightboxIndex + direction + galleryItems.length) % galleryItems.length; showItemAtIndex(currentLightboxIndex); }
        function zoomLightbox(amount) { const mediaEl = lightboxMedia.querySelector('img, video'); if (!mediaEl) return; currentZoom = Math.max(0.1, Math.min(10, currentZoom + amount)); panLightbox(0, 0); }
        function panLightbox(dx, dy) {
            const mediaEl = lightboxMedia.querySelector('img, video');
            if (!mediaEl) return;

            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const iw = mediaEl.offsetWidth * currentZoom;
            const ih = mediaEl.offsetHeight * currentZoom;

            const maxTx = Math.max(0, (iw - vw) / 2);
            const maxTy = Math.max(0, (ih - vh) / 2);

            let newTx = currentTranslateX + dx;
            let newTy = currentTranslateY + dy;

            currentTranslateX = Math.max(-maxTx, Math.min(maxTx, newTx));
            currentTranslateY = Math.max(-maxTy, Math.min(maxTy, newTy));

            updateMediaTransform();
        }
        function cyclePanStep() { panStep += 50; if (panStep > 200) panStep = 50; showNotification(`Pan step: ${panStep}px`, 'info'); }
        
        // --- LIGHTBOX UI TOGGLE LOGIC (UPDATED) ---
        function toggleLightboxUi() {
            const toolbar = document.getElementById('lightbox-toolbar');
            const shortcuts = document.getElementById('lightbox-shortcuts'); // Ref to shortcuts bar
            const header = document.getElementById('lightbox-header');
            const btn = document.getElementById('lightbox-ui-toggle');
            
            // Toggle classes on Toolbar
            const isHidden = toolbar.classList.toggle('ui-hidden');
            
            // Toggle classes on Shortcuts Bar (Sync with toolbar)
            if (shortcuts) {
                shortcuts.classList.toggle('ui-hidden', isHidden);
            }

            // Toggle Header background
            header.classList.toggle('clean-view');
            
            // Update Icon AND Text
            if (isHidden) {
                // Visual State: Hidden -> Show 'Show Toolbar' option
                btn.innerHTML = "🚫 <span>Show Toolbar</span>";
                btn.style.color = "var(--danger-color)";
                btn.style.borderColor = "var(--danger-color)";
                btn.title = "Show Toolbar";
            } else {
                // Visual State: Visible -> Show 'Hide Toolbar' option
                btn.innerHTML = "👁️ <span>Hide Toolbar</span>";
                btn.style.color = "var(--text-muted)";
                btn.style.borderColor = "rgba(255, 255, 255, 0.2)";
                btn.title = "Hide Toolbar";
            }
        }
        async function deleteFromLightbox(noConfirm = false) {
            if (currentLightboxIndex < 0 || currentLightboxIndex >= galleryItems.length) return;

            // Safety: in AI/Global mode confirm always
            if ((isAiSearch || isGlobalSearch) && noConfirm) noConfirm = false;

            let message = 'Are you sure you want to delete this file?\nThis cannot be undone.';
            if (isAiSearch || isGlobalSearch) {
                message = 'Global Mode Warning:\nAre you sure you want to delete this file from its original folder?';
            }

            if (!noConfirm) {
                const confirmed = await smartConfirm("🗑️ Delete File?", message, true);
                if (!confirmed) return;
            }

            const itemToDelete = galleryItems[currentLightboxIndex];
            const fileId = itemToDelete.dataset.fileId;
            const deleteBtn = document.getElementById('lightbox-delete-btn');

            if (deleteBtn) deleteBtn.disabled = true;

            fetch(`/galleryout/delete/${fileId}`, { method: 'POST' })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(({ ok, data }) => {
                    if (ok && data.status === 'success') {
                        showNotification(data.message || 'File deleted!', 'success');
                        itemToDelete.remove();
                        galleryItems.splice(currentLightboxIndex, 1);
                        allFilesData = allFilesData.filter(f => f.id !== fileId);
                        currentItemCount--;
                        updateFileCountBadge();
                        
                        if (galleryItems.length === 0) {
                            closeLightbox();
                            showEmptyState();
                        } else {
                            if (currentLightboxIndex >= galleryItems.length) {
                                currentLightboxIndex = galleryItems.length - 1;
                            }
                            showItemAtIndex(currentLightboxIndex);
                        }
                    } else {
                        throw new Error(data.message || 'Deletion failed on the server.');
                    }
                })
                .catch(handleError)
                .finally(() => {
                    if (deleteBtn) deleteBtn.disabled = false;
                });
        }

        // --- NEW FEATURE: RENAME FILE FROM LIGHTBOX ---

        async function renameFile(fileId, currentName) {
            const lastDotIndex = currentName.lastIndexOf('.');
            const baseName = lastDotIndex > -1 ? currentName.substring(0, lastDotIndex) : currentName;
            const extension = lastDotIndex > -1 ? currentName.substring(lastDotIndex) : '';

            const newBaseName = await smartPrompt(
                "✏️ Rename File", 
                "Enter new filename (extension will be preserved):", 
                baseName
            );

            if (newBaseName === null || newBaseName.trim() === '' || newBaseName.trim() === baseName) {
                return;
            }

            const newName = newBaseName.trim() + extension;

            fetch(`/galleryout/rename_file/${fileId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_name: newName })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.status === 'success') {
                    showNotification(data.message, 'success');
                    const newId = data.new_id;

                    // Update local data
                    const fileIndexInData = allFilesData.findIndex(f => f.id === fileId);
                    if (fileIndexInData !== -1) {
                        allFilesData[fileIndexInData].name = data.new_name;
                        allFilesData[fileIndexInData].id = newId;
                        if (currentLightboxFile && currentLightboxFile.id === fileId) {
                            currentLightboxFile.name = data.new_name;
                            currentLightboxFile.id = newId;
                            updateLightboxTitle();
                        }
                    }

                    // Update DOM
                    const galleryItem = document.querySelector(`.gallery-item[data-file-id="${fileId}"]`);
                    if (galleryItem) {
                        galleryItem.dataset.fileId = newId;
                        galleryItem.querySelector('.item-info p strong').textContent = data.new_name;
                        galleryItem.querySelector('.item-info p').title = data.new_name;
                        
                        // Update Handlers
                        galleryItem.querySelector('.thumbnail-link').setAttribute('onclick', `openLightbox(event, '${newId}'); event.stopPropagation();`);
                        galleryItem.querySelector('.selection-checkmark').setAttribute('onclick', `toggleSelection(event, '${newId}', this.closest('.gallery-item'))`);
                        galleryItem.querySelector('.favorite-btn').setAttribute('onclick', `toggleFavorite(event, '${newId}', this)`);
                        galleryItem.querySelector('.delete-btn').setAttribute('onclick', `deleteFile(event, '${newId}', this)`);
                        galleryItem.querySelector('a[title="Download"]').href = `/galleryout/download/${newId}`;
                        const summaryBtn = galleryItem.querySelector('button[title="Node Summary"]');
                        if (summaryBtn) summaryBtn.setAttribute('onclick', `showNodeSummary(event, '${newId}')`);
                        const workflowBadge = galleryItem.querySelector('.workflow-badge');
                        if (workflowBadge) workflowBadge.href = `/galleryout/workflow/${newId}`;
                    }
                    
                    if (currentLightboxFile && currentLightboxFile.id === newId) {
                        showItemAtIndex(currentLightboxIndex);
                    }
                } else {
                    throw new Error(data.message || 'Failed to rename file.');
                }
            })
            .catch(error => {
                showNotification(error.message, 'error');
            });
        }

        function renameFileFromLightbox() {
            if (!currentLightboxFile) return;
            renameFile(currentLightboxFile.id, currentLightboxFile.name);
        }

        const summaryOverlay = document.getElementById('node-summary-overlay'); const summaryContent = document.getElementById('node-summary-content');
        function escapeHTML(value) {
            if (value === null || typeof value === 'undefined') {
                return '<em>null</em>';
            }
            
            // Handle Objects (like JSON configs in nodes) by converting to string first
            if (typeof value === 'object') {
                try {
                    value = JSON.stringify(value, null, 2);
                } catch (e) {
                    return '[Unserializable Object]';
                }
            }
            
            // Robust replacement using a switch to avoid 'undefined' mapping errors
            return String(value).replace(/[&<>"']/g, function(m) {
                switch (m) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return m;
                }
            });
        }
        
        // Helper for Copy with Notification
        function copyTextAndNotify(text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                showNotification("📋 Copied to clipboard!", "success");
            }).catch(err => {
                console.error(err);
                showNotification("Failed to copy.", "error");
            });
        }

        async function showNodeSummary(event, fileId) {
            event.stopPropagation();
            const summaryContent = document.getElementById('node-summary-content');
            const summaryOverlay = document.getElementById('node-summary-overlay');
            
            summaryContent.innerHTML = '<div class="loader" style="margin:2rem auto;"></div>';
            document.body.classList.add('modal-open');
            summaryOverlay.classList.add('visible');

            try {
                const response = await fetch(`/galleryout/node_summary/${fileId}`);
                const data = await response.json();

                if (data.status === 'success') {
                    let dashboardHTML = '';
                    
                    // --- 1. GENERATION DASHBOARD (NEW) ---
                    if (data.meta) {
                        const m = data.meta;
                        
                        // A. Prompts (Using new Copy Notification)
                        let promptSection = '';
                        // Positive
                        const posText = m.positive_prompt_clean || m.positive_prompt;
                        if (posText) {
                            // We escape HTML but keep the raw text for copying
                            const safePos = escapeHTML(posText);
                            // Use a temporary attribute or pass string directly (careful with quotes)
                            promptSection += `
                                <div style="margin-bottom:10px;">
                                    <div class="gen-section-title">✨ Positive Prompt</div>
                                    <div class="gen-prompt-box positive">
                                        ${safePos}
                                        <button class="copy-prompt-btn" onclick="copyTextAndNotify(this.parentElement.innerText.replace('Copy', '').trim())">Copy</button>
                                    </div>
                                </div>`;
                        }
                        // Negative
                        if (m.negative_prompt) {
                            const safeNeg = escapeHTML(m.negative_prompt);
                            promptSection += `
                                <div>
                                    <div class="gen-section-title">🚫 Negative Prompt</div>
                                    <div class="gen-prompt-box negative">
                                        ${safeNeg}
                                        <button class="copy-prompt-btn" onclick="copyTextAndNotify(this.parentElement.innerText.replace('Copy', '').trim())">Copy</button>
                                    </div>
                                </div>`;
                        }

                        // B. Tech Stats Grid (Updated with Seed Copy)
                        let statsHTML = '';
                        
                        // Helper to create card
                        const createStatCard = (label, value, extraClass = '', allowCopy = false) => {
                            const safeVal = escapeHTML(value);
                            let copyHtml = '';
                            if (allowCopy) {
                                copyHtml = `<button class="stat-copy-btn" onclick="copyTextAndNotify('${safeVal}')" title="Copy">📋</button>`;
                            }
                            
                            return `
                            <div class="gen-stat-card">
                                <span class="gen-stat-label">${label} ${copyHtml}</span>
                                <span class="gen-stat-value ${extraClass}" title="${safeVal}">${safeVal}</span>
                            </div>`;
                        };

                        if (m.seed) statsHTML += createStatCard('Seed', m.seed, 'seed', true); // Copy Enabled
                        if (m.model) statsHTML += createStatCard('Model', m.model, 'model');
                        if (m.steps) statsHTML += createStatCard('Steps', m.steps);
                        if (m.cfg) statsHTML += createStatCard('CFG', m.cfg);
                        if (m.sampler) statsHTML += createStatCard('Sampler', m.sampler);
                        if (m.scheduler) statsHTML += createStatCard('Scheduler', m.scheduler);
                        if (m.width && m.height) statsHTML += createStatCard('Resolution', `${m.width}x${m.height}`);

                        let statsSection = '';
                        if (statsHTML) {
                            statsSection = `
                                <div style="margin-top:10px;">
                                    <div class="gen-section-title">⚙️ Generation Parameters</div>
                                    <div class="gen-stats-grid">${statsHTML}</div>
                                </div>`;
                        }

                        // C. LoRAs
                        let loraSection = '';
                        if (m.loras && m.loras.length > 0) {
                            const loraChips = m.loras.map(l => 
                                `<div class="gen-lora-chip"><span>${escapeHTML(l.name)}</span><span class="gen-lora-val">${l.value}</span></div>`
                            ).join('');
                            
                            loraSection = `
                                <div style="margin-top:10px;">
                                    <div class="gen-section-title">💊 Active LoRAs</div>
                                    <div class="gen-lora-container">${loraChips}</div>
                                </div>`;
                        }

                        // Combine Dashboard
                        if (promptSection || statsSection || loraSection) {
                            dashboardHTML = `
                                <div class="gen-dashboard">
                                    ${promptSection}
                                    ${statsSection}
                                    ${loraSection}
                                </div>`;
                        }
                    }

                    // --- 2. EXISTING NODE LIST (Legacy) ---
                    let contentHTML = '';
                    let mediaCardsHTML = ''; 

                    if (data.summary && data.summary.length > 0) {
                        // ... (Il resto della funzione rimane identico a prima per la parte dei nodi raw) ...
                        data.summary.forEach(node => {
                            let paramsHTML = '<ul class="summary-node-params">';
                            if (node.params && node.params.length > 0) {
                                node.params.forEach(p => {
                                    paramsHTML += `<li><strong>${escapeHTML(p.name)}:</strong> <code>${escapeHTML(p.value)}</code>`;
                                    if (p.is_input_file) {
                                        paramsHTML += ` <span style="color:var(--success-color); font-size:0.8rem;">(Found in Inputs)</span>`;
                                        const fileExt = p.value.toString().split('.').pop().toLowerCase();
                                        const isVideo = ['mp4', 'mov', 'webm', 'mkv', 'avi'].includes(fileExt);
                                        const isAudio = ['mp3', 'wav', 'ogg', 'flac', 'm4a', 'aac'].includes(fileExt);
                                        let mediaTag = '';
                                        if (isAudio) {
                                            mediaTag = `<div style="height:200px; display:flex; align-items:center; justify-content:center; width:100%; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:1rem; flex-direction:column; gap:10px;">
                                                <span style="font-size:3rem;">🎵</span>
                                                <audio controls src="${p.input_url}" style="width:90%;"></audio>
                                            </div>`;
                                        } else if (isVideo) {
                                            mediaTag = `<video src="${p.input_url}" controls class="input-media-preview"></video>`;
                                        } else {
                                            mediaTag = `<img src="${p.input_url}" class="input-media-preview">`;
                                        }
                                        mediaCardsHTML += `
                                            <div class="input-media-card">
                                                <div class="input-media-title">📥 ${escapeHTML(p.value)}</div>
                                                ${mediaTag}
                                                <div class="input-media-actions">
                                                    <a href="${p.input_url}" download class="input-media-btn">
                                                        💾 Download
                                                    </a>
                                                    <a href="${p.input_url}" target="_blank" class="input-media-btn secondary">
                                                        ↗️ Open Tab
                                                    </a>
                                                </div>
                                            </div>`;
                                    }
                                    paramsHTML += `</li>`;
                                });
                            } else {
                                paramsHTML += `<li>No parameters</li>`;
                            }
                            paramsHTML += '</ul>';

                            contentHTML += `<div class="summary-node-item">
                                <div class="summary-node-header" style="background-color:${node.color};">
                                    ${escapeHTML(node.type)} <small>(ID: ${node.id})</small>
                                </div>
                                ${paramsHTML}
                            </div>`;
                        });
                    } else {
                        contentHTML = '<p class="empty-state">No active nodes found in this workflow.</p>';
                    }
                    
                    // --- 3. ASSEMBLE FINAL HTML ---
                    let finalInputsSection = '';
                    if (mediaCardsHTML) {
                        finalInputsSection = `
                            <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                                🎨 Source Media (Inputs)
                            </h3>
                            <div class="input-media-grid">
                                ${mediaCardsHTML}
                            </div>
                            <hr style="border:0; border-top:1px solid var(--border-color); margin: 2rem 0;">
                        `;
                    }
                    
                    let nodesHeader = '';
                    if (dashboardHTML) {
                        nodesHeader = `<h3 style="margin: 2rem 0 1rem; border-bottom:1px solid var(--border-color); padding-bottom:10px;">🔌 Raw Node List</h3>`;
                    }

                    summaryContent.innerHTML = dashboardHTML + finalInputsSection + nodesHeader + contentHTML;

                } else {
                    summaryContent.innerHTML = `<p style="color:var(--danger-color);">Error: ${data.message || 'Could not load summary.'}</p>`;
                }
            } catch (error) {
                console.error(error);
                summaryContent.innerHTML = `<p style="color:var(--danger-color);">A network error occurred.</p>`;
            }
        }

        function closeNodeSummary() { document.body.classList.remove('modal-open'); summaryOverlay.classList.remove('visible'); summaryContent.innerHTML = ''; }
        const uploadOverlay = document.getElementById('upload-overlay'); const showUploadModalBtn = document.getElementById('show-upload-modal-btn'); const uploadCancelBtn = document.getElementById('upload-cancel-btn'); const uploadSubmitBtn = document.getElementById('upload-submit-btn'); const dropZone = document.getElementById('drop-zone'); const fileInput = document.getElementById('upload-file-input'); const fileBrowseBtn = document.getElementById('file-upload-btn'); const fileList = document.getElementById('file-list'); const uploadProgressContainer = document.getElementById('upload-progress-container'); const uploadProgressFill = document.getElementById('upload-progress-fill'); const uploadDestinationText = document.getElementById('upload-destination-text').querySelector('strong'); let filesToUpload = [];
        function resetUploadModal() { filesToUpload = []; fileList.innerHTML = ''; uploadProgressContainer.style.display = 'none'; uploadProgressFill.style.width = '0%'; fileInput.value = ''; uploadSubmitBtn.disabled = false; }
        function showUploadModal() { resetUploadModal(); uploadDestinationText.textContent = currentFolderInfo.display_name; document.body.classList.add('modal-open'); uploadOverlay.classList.add('visible'); }
        function closeUploadModal() { document.body.classList.remove('modal-open'); uploadOverlay.classList.remove('visible'); }
        function handleFiles(files) { filesToUpload = [...filesToUpload, ...Array.from(files)]; renderFileList(); }
        function renderFileList() { fileList.innerHTML = ''; filesToUpload.forEach(file => { const li = document.createElement('li'); const sizeKB = (file.size / 1024).toFixed(1); li.innerHTML = `<span>${file.name}</span> <span class="file-size">${sizeKB} KB</span>`; fileList.appendChild(li); }); }
        function performUpload() {
            if (filesToUpload.length === 0) {
                showNotification('Please select files to upload.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('folder_key', currentFolderKey);
            filesToUpload.forEach(file => {
                formData.append('files', file);
            });

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/galleryout/upload', true);

            uploadProgressContainer.style.display = 'block';
            uploadSubmitBtn.disabled = true;
            uploadSubmitBtn.textContent = 'Uploading...';

            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    uploadProgressFill.style.width = percentComplete + '%';
                }
            };

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const response = JSON.parse(xhr.responseText);

                    // [MODIFIED] Save message to session storage and reload immediately
                    // This ensures the notification survives the page reload
                    sessionStorage.setItem('gallery_notification', JSON.stringify({
                        message: response.message || 'Upload successful!',
                        type: 'success'
                    }));
                    window.location.reload();

                } else {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        showNotification(`Upload failed: ${response.message}`, 'error');
                    } catch (e) {
                        showNotification(`Upload failed with status: ${xhr.status}`, 'error');
                    }
                    uploadSubmitBtn.disabled = false;
                    uploadSubmitBtn.textContent = 'Upload';
                }
            };

            xhr.onerror = function() {
                showNotification('An error occurred during the upload.', 'error');
                uploadSubmitBtn.disabled = false;
                uploadSubmitBtn.textContent = 'Upload';
            };

            xhr.send(formData);
        }
        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        // --- RESCAN FOLDER LOGIC ---
        const rescanModalOverlay = document.getElementById('rescan-modal-overlay');
        const rescanRecentBtn = document.getElementById('rescan-recent-btn');
        const rescanAllBtn = document.getElementById('rescan-all-btn');
        const rescanCancelBtn = document.getElementById('rescan-cancel-btn');

        function showRescanModal() {
            rescanModalOverlay.style.opacity = '1';
            rescanModalOverlay.style.pointerEvents = 'auto';
        }

        function hideRescanModal() {
            rescanModalOverlay.style.opacity = '0';
            rescanModalOverlay.style.pointerEvents = 'none';
        }

        // --- RESCAN LOGIC WITH POLLING ---
        function performRescan(mode) {
            hideRescanModal();
            
            // Show sync overlay immediately
            const syncOverlay = document.getElementById('sync-overlay');
            const syncMessage = document.getElementById('sync-message');
            const syncProgressFill = document.getElementById('sync-progress-fill');
            
            syncOverlay.style.display = 'flex';
            syncMessage.textContent = 'Initializing background scan...';
            syncProgressFill.style.width = '0%';
            syncProgressFill.style.backgroundColor = 'var(--primary-color)';
            
            // Store the folder key where the scan started
            const originFolderKey = currentFolderKey;
            
            fetch('/galleryout/rescan_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_key: originFolderKey, mode: mode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'started') {
                    // Start Polling
                    pollRescanProgress(data.job_id, originFolderKey);
                } else if (data.status === 'success' && data.count === 0) {
                    // Immediate success (nothing to do)
                    syncOverlay.style.display = 'none';
                    showNotification(data.message, 'info');
                } else {
                    syncOverlay.style.display = 'none';
                    showNotification("Error: " + data.message, 'error');
                }
            })
            .catch(error => {
                syncOverlay.style.display = 'none';
                handleError(error);
            });
        }

        function pollRescanProgress(jobId, originFolderKey) {
            const syncOverlay = document.getElementById('sync-overlay');
            const syncMessage = document.getElementById('sync-message');
            const syncProgressFill = document.getElementById('sync-progress-fill');
            
            const interval = setInterval(() => {
                fetch(`/galleryout/check_rescan_status/${jobId}`)
                    .then(res => res.json())
                    .then(job => {
                        if (job.status === 'processing') {
                            // Update UI
                            const pct = Math.round((job.current / job.total) * 100);
                            syncMessage.textContent = `Scanning: ${job.current} / ${job.total}`;
                            syncProgressFill.style.width = `${pct}%`;
                            
                        } else if (job.status === 'done') {
                            clearInterval(interval);
                            syncOverlay.style.display = 'none';
                            
                            // CHECK: Are we still in the same folder?
                            // 'currentFolderKey' is a global variable in your script
                            if (currentFolderKey === originFolderKey) {
                                // Yes -> Reload page to show new data
                                sessionStorage.setItem('gallery_notification', JSON.stringify({
                                    message: 'Rescan completed successfully!',
                                    type: 'success'
                                }));
                                window.location.reload();
                            } else {
                                // No -> Just show notification (don't reload wrong folder)
                                showNotification(`Rescan of "${job.folder_name}" completed in background.`, 'success', 8000);
                            }
                            
                        } else if (job.status === 'error' || job.status === 'not_found') {
                            clearInterval(interval);
                            syncOverlay.style.display = 'none';
                            showNotification("Rescan failed or lost connection.", 'error');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        // Don't stop polling for a single network glitch, keep trying
                    });
            }, 1000); // Check every 1 second
        }
        
        // --- AI SEARCH FUNCTIONS ---
        function selectAiScope(scope) {
            currentAiScope = scope;
            document.querySelectorAll('.ai-scope-option').forEach(el => {
                el.classList.toggle('active', el.dataset.scope === scope);
            });
            
            // Show recursive toggle ONLY if scope is local
            const recursiveToggle = document.getElementById('ai-recursive-toggle');
            if (recursiveToggle) {
                if (scope === 'local') {
                    recursiveToggle.style.display = 'flex';
                    
                    const lastAiRecursive = localStorage.getItem('lastAiRecursive');
                    const aiRecursiveCheckbox = document.getElementById('ai-search-recursive');
                    
                    if (lastAiRecursive !== null) {
                        // Confronta con la stringa "true"
                        aiRecursiveCheckbox.checked = (lastAiRecursive === "true");
                        recursiveToggle.classList.toggle('active', aiRecursiveCheckbox.checked);
                    } else {
                        // Default: unchecked
                        aiRecursiveCheckbox.checked = false;
                        recursiveToggle.classList.remove('active');
                    }
                } else {
                    recursiveToggle.style.display = 'none';
                    const aiRecursiveCheckbox = document.getElementById('ai-search-recursive');
                    if (aiRecursiveCheckbox) {
                        aiRecursiveCheckbox.checked = false;
                    }
                }
            }
        }
        
        // --- MODAL AI ---
        function closeAiInfoModal() {
            document.getElementById('ai-info-overlay').classList.remove('visible');
        }

        function openAiSearchModal() {
        if (!enableAiSearch) {
            const infoOverlay = document.getElementById('ai-info-overlay');
            infoOverlay.classList.add('visible');
            
            infoOverlay.addEventListener('click', (e) => {
                if (e.target === infoOverlay) closeAiInfoModal();
            }, { once: true });
            
            return;
        }
        
        // AI Enabled 
        const overlay = document.getElementById('ai-search-overlay');
        const inputEl = document.getElementById('ai-search-input');
        const clearBtn = document.getElementById('ai-search-clear-text');
        const limitInput = document.getElementById('ai-search-limit');
        
        // 1. Restore QUERY
        const lastQuery = localStorage.getItem('lastAiQuery');
        if (lastQuery) {
            inputEl.value = lastQuery;
            clearBtn.style.display = 'flex';
        } else {
            inputEl.value = '';
            clearBtn.style.display = 'none';
        }

        // 2. Restore LIMIT
        const lastLimit = localStorage.getItem('lastAiLimit');
        if (lastLimit && limitInput) {
            limitInput.value = lastLimit;
        } else if (limitInput) {
            limitInput.value = 100;
        }

        // 3. Restore SCOPE
        const lastScope = localStorage.getItem('lastAiScope');
        if (lastScope && (lastScope === 'global' || lastScope === 'local')) {
            selectAiScope(lastScope); // Questa funzione ora gestirà anche la checkbox
        } else {
            selectAiScope('global');
        }        

        overlay.classList.add('visible');
        document.body.classList.add('modal-open');
        inputEl.focus();
        }
        
        function closeAiSearchModal() {
            const overlay = document.getElementById('ai-search-overlay');
            overlay.classList.remove('visible');
            document.body.classList.remove('modal-open');
        }
        
        function submitAiSearch() {
            const inputEl = document.getElementById('ai-search-input');
            const query = inputEl.value.trim();
            const limit = document.getElementById('ai-search-limit').value || 100;
            
            if (!query) return;
            
            // --- save STATUS ---
            localStorage.setItem('lastAiQuery', query);
            localStorage.setItem('lastAiLimit', limit);
            localStorage.setItem('lastAiScope', currentAiScope);
            
            const aiRecursiveCheckbox = document.getElementById('ai-search-recursive');
            if (aiRecursiveCheckbox) {
                localStorage.setItem('lastAiRecursive', aiRecursiveCheckbox.checked);
            }
            
            closeAiSearchModal();
            
            // Show Loader
            const loader = document.getElementById('loader-overlay');
            loader.style.display = 'flex';
            loader.style.opacity = '1';
            
            let finalQuery = query;
            const isRecursive = document.getElementById('ai-search-recursive')?.checked;

            if (currentAiScope === 'local') {
                // We append a special flag if recursive is enabled
                const pathSuffix = isRecursive ? " [RECURSIVE]" : "";
                finalQuery += " ||| " + currentFolderInfo.path + pathSuffix;
            }
            
            const searchPayload = { 
                query: finalQuery, 
                limit: parseInt(limit),
                scope: currentAiScope
            };

            fetch('/galleryout/ai_queue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchPayload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'queued') {
                    pollAiStatus(data.session_id);
                } else {
                    showNotification("Error starting AI search: " + data.message, 'error');
                    loader.style.display = 'none';
                }
            })
            .catch(err => {
                console.error(err);
                showNotification("Network error starting AI search", 'error');
                loader.style.display = 'none';
            });
        }
        
        function pollAiStatus(sessionId) {
            let attempts = 0;
            const maxAttempts = 15; 
            
            const interval = setInterval(() => {
                attempts++;
                
                fetch(`/galleryout/ai_check/${sessionId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            clearInterval(interval);
                            window.location.href = `{{ url_for('gallery_view', folder_key=current_folder_key) }}?ai_session_id=${sessionId}`;
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            showNotification("AI Search failed (Worker Error).", 'error');
                            document.getElementById('loader-overlay').style.display = 'none';
                        } else {
                            // Status is 'pending' or 'processing'
                            // Timeout reached
                            if (attempts >= maxAttempts) {
                                clearInterval(interval);
                                document.getElementById('loader-overlay').style.display = 'none';
                                
                                const repoUrl = "https://github.com/biagiomaf/smart-comfyui-gallery";
                                
                                // Construct HTML message for Smart Dialog
                                const msg = "The search request was sent, but the AI service did not respond in time.\n\n" +
                                            "Please ensure that the <strong>'smartgallery_ai_service'</strong> script is running in your backend terminal.\n\n" +
                                            "If you haven't installed the AI dependencies yet, please consult the installation guide here:\n" +
                                            `<a href="${repoUrl}" target="_blank" style="color:var(--ai-color); font-weight:bold; word-break:break-all;">${repoUrl}</a>`;
                                
                                smartConfirm("⚠️ AI Service Timeout", msg, false);
                            }
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        // do not stop for temporarly network errors
                    });
            }, 1000);
        }
        
        
        // --- SCOPE SELECTOR & RECURSIVE LOGIC (Custom Native Dropdowns) ---
        const scopeRadios = document.querySelectorAll('input[name="scope"]');
        const recursiveCheckbox = document.querySelector('input[name="recursive"]');
        const recursiveWrapper = document.getElementById('recursive-standard-ui');

        let selectedExts = new Set({{ selected_extensions | tojson }});
        let selectedPfxs = new Set({{ selected_prefixes | tojson }});

        // 1. Core Dropdown Logic
        function toggleCustomDropdown(event, menuId) {
            // Stop propagation prevents global listeners from immediately closing it
            event.stopPropagation();
            
            const menu = document.getElementById(menuId);
            const wrapper = menu.closest('.c-multi-select');
            const isOpen = menu.classList.contains('show');

            // Always start clean: close others
            closeAllDropdowns();

            // Toggle current
            if (!isOpen) {
                menu.classList.add('show');
                wrapper.classList.add('open');
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.c-dropdown-menu.show').forEach(el => {
                el.classList.remove('show');
                el.closest('.c-multi-select').classList.remove('open');
            });
        }

        // LISTENER 1: Document (Handles clicks completely outside)
        document.addEventListener('click', (e) => {
            if (e.target.closest('.c-dropdown-menu')) return; 
            closeAllDropdowns();
        });

        // LISTENER 2: Search Panel Fix (CRITICAL FOR UX)
        // Intercepts clicks inside the filter panel. If clicking a label or input that isn't
        // the dropdown itself, we force close the dropdowns.
        const searchPanelFix = document.getElementById('desktop-search-panel');
        if (searchPanelFix) {
            searchPanelFix.addEventListener('click', (e) => {
                // If clicking inside panel but NOT inside a dropdown wrapper...
                if (!e.target.closest('.c-multi-select')) {
                    closeAllDropdowns();
                }
            });
        }

        // 2. Rendering Options
        function renderCustomOptions(containerId, counterId, items, paramName, selectedSet) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            
            if (items.length > 0) {
                const clearDiv = document.createElement('div');
                clearDiv.style.cssText = "padding:12px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px; cursor:pointer; color:var(--text-muted); font-size:0.9rem; text-align:center; font-weight:bold;";
                clearDiv.innerText = "❌ Clear Selection";
                clearDiv.onclick = (e) => {
                    e.stopPropagation(); 
                    selectedSet.clear();
                    container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    updateTriggerCounter(counterId, 0);
                };
                container.appendChild(clearDiv);
            } else {
                container.innerHTML = '<div style="padding:15px; color:gray; text-align:center;">No options found</div>';
            }

            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'c-option-label';
                // Stop propagation on label click to prevent menu closing while selecting
                label.onclick = (e) => e.stopPropagation(); 
                
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.name = paramName;
                cb.value = item;
                if (selectedSet.has(item)) cb.checked = true;
                
                cb.addEventListener('change', () => {
                    if (cb.checked) selectedSet.add(item);
                    else selectedSet.delete(item);
                    updateTriggerCounter(counterId, selectedSet.size);
                });

                label.appendChild(cb);
                label.appendChild(document.createTextNode(item));
                container.appendChild(label);
            });
            
            updateTriggerCounter(counterId, selectedSet.size);
        }

        function updateTriggerCounter(counterId, count) {
            const el = document.getElementById(counterId);
            if (el) {
                el.innerText = count;
                el.classList.toggle('visible', count > 0);
                const triggerText = el.previousElementSibling;
                if(triggerText) {
                    if(counterId.includes('extensions')) triggerText.innerText = count > 0 ? 'Extensions selected' : 'Select extensions...';
                    if(counterId.includes('prefixes')) triggerText.innerText = count > 0 ? 'Prefixes selected' : 'Select prefixes...';
                }
            }
        }

        // 3. Logic to disable/enable Recursive checkbox based on Global Scope
        function updateRecursiveUIState() {
            const isGlobal = document.querySelector('input[name="scope"][value="global"]')?.checked;
            if (recursiveWrapper && recursiveCheckbox) {
                if (isGlobal) {
                    recursiveWrapper.classList.add('disabled');
                    recursiveCheckbox.checked = false; 
                    recursiveWrapper.classList.remove('active');
                } else {
                    recursiveWrapper.classList.remove('disabled');
                    recursiveWrapper.classList.toggle('active', recursiveCheckbox.checked);
                }
            }
        }

        // 4. AJAX Refresh
        function triggerOptionsRefresh() {
            const scope = document.querySelector('input[name="scope"]:checked')?.value || 'local';
            const isRec = recursiveCheckbox?.checked || false;
            const folderKey = '{{ current_folder_key }}';
            
            const wrapExt = document.getElementById('wrapper-extensions');
            const wrapPfx = document.getElementById('wrapper-prefixes');
            if(wrapExt) wrapExt.style.opacity = '0.5';
            if(wrapPfx) wrapPfx.style.opacity = '0.5';

            fetch(`/galleryout/api/search_options?scope=${scope}&folder_key=${folderKey}&recursive=${isRec}`)
                .then(response => response.json())
                .then(data => {
                    renderCustomOptions('dropdown-extensions', 'count-extensions', data.extensions, 'extension', selectedExts);
                    
                    const warningBox = document.getElementById('prefix-warning-container');
                    const wrapperPfx = document.getElementById('wrapper-prefixes');

                    if (data.prefix_limit_reached) {
                        if(warningBox) warningBox.style.display = 'flex';
                        if(wrapperPfx) wrapperPfx.style.display = 'none';
                    } else {
                        if(warningBox) warningBox.style.display = 'none';
                        if(wrapperPfx) wrapperPfx.style.display = 'block';
                        renderCustomOptions('dropdown-prefixes', 'count-prefixes', data.prefixes, 'prefix', selectedPfxs);
                    }
                    
                    if(wrapExt) wrapExt.style.opacity = '1';
                    if(wrapPfx) wrapPfx.style.opacity = '1';
                })
                .catch(err => {
                    console.error("Search options refresh failed:", err);
                    if(wrapExt) wrapExt.style.opacity = '1';
                    if(wrapPfx) wrapPfx.style.opacity = '1';
                });
        }

        // 5. Event Listeners
        scopeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.scope-label').forEach(label => label.classList.remove('active'));
                if (this.checked) this.closest('.scope-label').classList.add('active');
                updateRecursiveUIState();
                triggerOptionsRefresh();
            });
        });

        if (recursiveCheckbox) {
            recursiveCheckbox.addEventListener('change', function() {
                if (recursiveWrapper) recursiveWrapper.classList.toggle('active', this.checked);
                triggerOptionsRefresh();
            });
        }

        // 6. Initial Population
        const initialExts = {{ available_extensions | tojson }};
        renderCustomOptions('dropdown-extensions', 'count-extensions', initialExts, 'extension', selectedExts);
        
        const pfxLimit = {{ prefix_limit_reached | tojson }};
        if (!pfxLimit) {
            const initialPfxs = {{ available_prefixes | tojson }};
            renderCustomOptions('dropdown-prefixes', 'count-prefixes', initialPfxs, 'prefix', selectedPfxs);
        }

        updateRecursiveUIState();
        
        // --- MOUNT FOLDER & FILESYSTEM BROWSER LOGIC ---
        
        let currentFsPath = '';

        function openMountModal() {
            document.getElementById('mount-folder-overlay').style.display = 'flex';
            document.getElementById('mount-link-name').value = '';
            document.getElementById('mount-target-path').value = '';
            document.getElementById('mount-confirm-btn').disabled = true;
            
            // Start browsing from root/drives
            fsNavigate(''); 
        }

        function closeMountModal() {
            document.getElementById('mount-folder-overlay').style.display = 'none';
        }

        async function fsNavigate(path) {
            const listView = document.getElementById('fs-list-view');
            const pathDisplay = document.getElementById('fs-current-path');
            
            listView.innerHTML = '<li style="padding:10px; color:#888; text-align:center;">Loading...</li>';
            
            // If navigating "Up" from root/drives, go to empty string to trigger drive list again
            if (path === '..') {
                if (!currentFsPath || currentFsPath === 'Computer') path = ''; 
                else path = document.getElementById('fs-parent-path-hidden')?.value || '';
            }

            try {
                const response = await fetch('/galleryout/api/browse_filesystem', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ path: path })
                });
                const data = await response.json();
                
                if (data.error) {
                    listView.innerHTML = `<li style="color:var(--danger-color); padding:10px;">Error: ${data.error}</li>`;
                    return;
                }

                // Update State
                currentFsPath = data.current_path;
                pathDisplay.textContent = currentFsPath || 'My Computer';
                
                // Save parent for "Up" button logic
                // Using a hidden data attribute or variable would be cleaner, but let's use a hidden input logic conceptually
                // We'll just store the parent path in a dataset on the list view
                listView.dataset.parent = data.parent_path;
                
                // Store parent in a hidden input creation on the fly if needed, or better, keep it in DOM
                let hiddenParent = document.getElementById('fs-parent-path-hidden');
                if (!hiddenParent) {
                    hiddenParent = document.createElement('input');
                    hiddenParent.type = 'hidden';
                    hiddenParent.id = 'fs-parent-path-hidden';
                    document.body.appendChild(hiddenParent);
                }
                hiddenParent.value = data.parent_path;

                // Render List
                listView.innerHTML = '';
                
                if (data.folders.length === 0) {
                    listView.innerHTML = '<li style="padding:10px; color:#666; font-style:italic;">(Empty)</li>';
                }

                data.folders.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'fs-item';
                    
                    const iconClass = item.is_drive ? 'fs-drive-icon' : 'fs-icon';
                    const iconChar = item.is_drive ? '💽' : '📁';
                    
                    li.innerHTML = `<span class="${iconClass}">${iconChar}</span> <span>${item.name}</span>`;
                    
                    // Click to navigate INTO
                    li.onclick = () => fsNavigate(item.path);
                    
                    // Add a specific select button on the right for this folder? 
                    // Better UX: Click selects it, Double Click enters it? 
                    // Let's keep it simple for mobile: Click ENTERS. 
                    // But we need a way to SELECT the CURRENT folder we are IN.
                    
                    listView.appendChild(li);
                });
                
                // UPDATE TARGET SELECTION to current path (if valid)
                if (currentFsPath && currentFsPath !== 'Computer') {
                    selectFolderForMount(currentFsPath);
                } else {
                    document.getElementById('mount-target-path').value = '';
                    document.getElementById('mount-confirm-btn').disabled = true;
                }

            } catch (e) {
                listView.innerHTML = `<li style="color:var(--danger-color); padding:10px;">Network Error</li>`;
            }
        }
        
        function selectFolderForMount(path) {
            const input = document.getElementById('mount-target-path');
            const confirmBtn = document.getElementById('mount-confirm-btn');
            
            input.value = path;
            
            // Enable button only if we have a path. 
            // NOTE: Validation for empty name happens on click.
            confirmBtn.disabled = false;
        }

        async function confirmMountFolder() {
            const linkName = document.getElementById('mount-link-name').value.trim();
            const targetPath = document.getElementById('mount-target-path').value.trim();
            
            // Validation: Name is mandatory
            if (!linkName) {
                showNotification("⚠️ Please enter a Name for this folder link.", "warning");
                document.getElementById('mount-link-name').focus();
                return;
            }
            
            // Validation: Path is mandatory
            if (!targetPath) {
                showNotification("⚠️ Please select a folder from the list.", "warning");
                return;
            }
            
            // UI Feedback
            const btn = document.querySelector('#mount-folder-overlay .active-blue');
            const originalText = btn.innerHTML;
            btn.innerHTML = "⏳ Linking...";
            btn.disabled = true;
            
            try {
                const response = await fetch('/galleryout/mount_folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ link_name: linkName, target_path: targetPath })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    sessionStorage.setItem('gallery_notification', JSON.stringify({
                        message: data.message,
                        type: 'success'
                    }));
                    window.location.reload();
                } else {
                    showNotification(data.message, "error");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (e) {
                showNotification("Network error: " + e, "error");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function unmountFolder(event, folderKey, folderName) {
            event.stopPropagation();
            
            const confirmed = await smartConfirm(
                "⛓️ Unmount Folder?", 
                `Remove the link to "${folderName}"? Confirm with [Delete] button.\n\nThis will NOT delete your actual files on the disk, only the shortcut in the gallery.`, 
                true // isDanger
            );
            
            if (!confirmed) return;
            
            fetch('/galleryout/unmount_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_key: folderKey })
            })
            .then(handleGenericResponse)
            .catch(handleError);
        }
        
        // --- MAIN INITIALIZATION FUNCTION ---
        document.addEventListener('DOMContentLoaded', () => {
        
            // Initialize Focus Mode state
            initFocusMode();
            
            // --- GLOBAL MOUSE TRACKER (INSIDE DOMContentLoaded) ---
            window.lastMouseX = 0;
            window.lastMouseY = 0;
            document.addEventListener('mousemove', (e) => {
                window.lastMouseX = e.clientX;
                window.lastMouseY = e.clientY;
            }, { passive: true, capture: true });
            
            // Check for pending notifications from previous page load
            const pendingMsg = sessionStorage.getItem('gallery_notification');
            if (pendingMsg) {
                try {
                    const { message, type } = JSON.parse(pendingMsg);
                    // Show for 6 seconds to ensure readability
                    showNotification(message, type, 6000); 
                } catch (e) { console.error(e); }
                sessionStorage.removeItem('gallery_notification');
            }
            
            loaderOverlay.style.opacity = '0';
            setTimeout(() => { loaderOverlay.style.display = 'none'; }, 400);
            // --- FILTER REMINDER ---
            if (activeFiltersCount > 0) {
                const urlParams = new URLSearchParams(window.location.search);
                
                // Check if we just transitioned from Global to Local scope
                if (urlParams.get('global_transition') === 'true') {
                    const msg = "⚠️ Filters previously set to Global are now active on this Local Folder.\nReset filters if not needed.";
                    showNotification(msg, 'warning', 6000); // 6 seconds duration
                } else {
                    // Standard reminder
                    const msg = "🔍 Filters are active.";
                    showNotification(msg, 'warning', 2000);
                }
            }
            setupFolderControls('nav', 'folder-tree-nav');
            setupFolderControls('move', 'move-folder-tree');
            renderAllTrees();
            setupSidebarExpansion();
            setupSidebarMinify();
            appendFiles(initialFiles);
            startGlobalWorkerMonitor();
            
            // --- DATE VALIDATION LOGIC ---
            const filterForm = document.getElementById('filter-form');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            if (filterForm && startDateInput && endDateInput) {
                
                // Helper: Update 'min' attribute of end date based on start date
                startDateInput.addEventListener('change', () => {
                    endDateInput.min = startDateInput.value;
                });

                // Helper: Auto-fill end date if empty when start is selected (UX improvement)
                startDateInput.addEventListener('blur', () => {
                     if (startDateInput.value && !endDateInput.value) {
                         // Optional: set to today or same as start. 
                         // Let's enforce validation instead as requested.
                     }
                });

                // Form Submit Validation
                filterForm.addEventListener('submit', (e) => {
                    const start = startDateInput.value;
                    const end = endDateInput.value;

                    // Only validate if BOTH dates are present
                    if (start && end) {
                        if (start > end) {
                            e.preventDefault();
                            showNotification('⚠️ Start Date cannot be after End Date.', 'error');
                            return;
                        }
                    }
                    // If only one is present, the backend will handle the >= or <= logic automatically
                });
            }
            
            // Initialize Auto-Refresh Logic
            initAutoRefresh();
            
            initAiSettingsPersistence();
            
            // --- SAVE STATUS CHECKBOX AI RECURSIVE ---
            const aiRecursiveCheckbox = document.getElementById('ai-search-recursive');
            if (aiRecursiveCheckbox) {
                aiRecursiveCheckbox.addEventListener('change', function() {
                    // Salva come stringa "true" o "false" (booleano convertito in stringa)
                    localStorage.setItem('lastAiRecursive', this.checked.toString());
                    console.log('AI Recursive saved:', this.checked, 'as', this.checked.toString());
                    
                    // Aggiorna anche l'aspetto visivo
                    const wrapper = this.closest('.recursive-wrapper');
                    if (wrapper) {
                        wrapper.classList.toggle('active', this.checked);
                    }
                });
            }
            
            // Aggiungi nella sezione DOMContentLoaded o dopo aver creato gli elementi:
            const aiRecursiveWrapper = document.getElementById('ai-recursive-toggle');
            if (aiRecursiveWrapper) {
                aiRecursiveWrapper.addEventListener('click', function(e) {
                    // Se clicchi sul wrapper ma non sulla checkbox stessa
                    if (e.target !== document.getElementById('ai-search-recursive')) {
                        const checkbox = document.getElementById('ai-search-recursive');
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            // Only run regular sync if not in AI mode
            if(!isAiSearch) {
                // startSyncProcess(false); // OLD
                startSyncProcess(false, false); // NEW Signature
            }
            // Lightbox Help Button listener
            const helpBtn = document.getElementById('lightbox-help-btn');
            if (helpBtn) {
                helpBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openLightboxHelp();
                });
            }
            
            // Close on background click
            document.getElementById('lightbox-help-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'lightbox-help-overlay') closeLightboxHelp();
            });
            // --- JS: AI BANNER TEXT FORMATTING ---
            const aiBannerText = document.getElementById('ai-banner-text');
            if (aiBannerText) {
                const rawQuery = aiBannerText.dataset.rawQuery || "";
                const separator = " ||| ";
                
                let labelHtml = "";
                let queryText = "";

                if (rawQuery.includes(separator)) {
                    // Local
                    const parts = rawQuery.split(separator);
                    queryText = parts[0];
                    labelHtml = `<span>🧠</span> Current Folder`;
                } else {
                    //  Global
                    queryText = rawQuery;
                    labelHtml = `<span>🧠</span> All Folders`;
                }

                // Inseriamo DUE span separati per permettere al CSS Mobile di spostarli
                aiBannerText.innerHTML = `
                    <span class="ai-scope-part">${labelHtml}</span>
                    <span class="ai-query-part">"${escapeHTML(queryText)}"</span>
                `;
            }
            
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const sidebarToggleText = document.getElementById('sidebar-toggle-text');
            const galleryAnchor = document.getElementById('gallery-anchor');
            const isMobile = window.innerWidth <= 1024;
            if (sidebar && sidebarToggleBtn && isMobile) {
                sidebar.classList.add('nav-collapsed');
                sidebarToggleText.textContent = 'Folders';
                sidebarToggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('nav-collapsed');
                    sidebarToggleText.textContent = sidebar.classList.contains('nav-collapsed') ? 'Folders' : 'Close';
                });
            }
            if (isMobile && sessionStorage.getItem('galleryMobileNav') === 'true' && galleryAnchor) {
                setTimeout(() => galleryAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
                sessionStorage.removeItem('galleryMobileNav');
            }
            // --- MOBILE FILTER TOGGLE LOGIC ---
            const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
            // We use the same panel ID for both desktop and mobile
            const searchPanel = document.getElementById('desktop-search-panel'); 

            if (mobileFilterToggle && searchPanel) { 
                mobileFilterToggle.addEventListener('click', (e) => { 
                    if (e.target.classList.contains('filter-reset-icon')) return;

                    e.stopPropagation();
                    searchPanel.classList.toggle('visible'); 
                    
                    // Update button text maintaining the X icon structure
                    const isVisible = searchPanel.classList.contains('visible');
                    const activeCount = {{ active_filters_count }};
                    
                    let baseText = isVisible ? '✕  Hide Filters' : '⚙️ Filters';
                    if (!isVisible && activeCount > 0) baseText += ` (${activeCount})`;
                    
                    let iconHtml = '';
                    if (activeCount > 0) {
                        iconHtml = ' <span class="filter-reset-icon" title="Clear all filters">✕</span>';
                    }
                    
                    mobileFilterToggle.innerHTML = baseText + iconHtml;
                }); 
            }
            
            // --- NEW: DESKTOP SEARCH PANEL TOGGLE ---
            const searchToggleDesktop = document.getElementById('search-toggle-desktop');
            const desktopSearchPanel = document.getElementById('desktop-search-panel');
            
            if (searchToggleDesktop && desktopSearchPanel) {
                searchToggleDesktop.addEventListener('click', (e) => {
                    // FIX: Se l'utente ha cliccato sulla X di reset, fermati qui!
                    // Non eseguire lo stopPropagation (così sale al body per il reset)
                    // e non aprire il pannello.
                    if (e.target.classList.contains('filter-reset-icon')) return;

                    e.stopPropagation();
                    desktopSearchPanel.classList.toggle('visible');
                });
                
                // Close when clicking outside
                document.addEventListener('click', (e) => {
                    if (desktopSearchPanel.classList.contains('visible')) {
                        // Check if click is outside panel AND outside button
                        if (!desktopSearchPanel.contains(e.target) && e.target !== searchToggleDesktop) {
                            desktopSearchPanel.classList.remove('visible');
                        }
                    }
                });
                
                // Prevent closing when clicking inside the panel
                desktopSearchPanel.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // --- SMART NAVIGATION (Seamless) ---
            // Navigates directly but preserves filters if active
            function handleSeamlessNavigation(targetUrl) {
                // If filters are active, keep them in URL
                if (activeFiltersCount > 0) {
                    const currentParams = new URLSearchParams(window.location.search);
                    
                    // If we were in Global Search, switch to Local for the specific folder
                    // but keep keywords/extensions.
                    if (currentParams.get('scope') === 'global') {
                        currentParams.set('scope', 'local');
                        // ADDED: Flag to notify user about the scope change on next page load
                        currentParams.set('global_transition', 'true');
                    }
                    
                    window.location.href = targetUrl + "?" + currentParams.toString();
                } else {
                    // Standard clean navigation
                    window.location.href = targetUrl;
                }
            }
        
            // Updated Tree Listener: Handles Toggles, Actions, and Smart Navigation
            document.getElementById('folder-tree-nav').addEventListener('click', (e) => {
                const link = e.target.closest('.navigation-link');
                const toggle = e.target.closest('.toggle-btn');
                const actionBtn = e.target.closest('.folder-action-btn');

                if (toggle) {
                    // Standard folder expand/collapse logic
                    const li = toggle.closest('li');
                    const key = li.dataset.folderKey;
                    const isNowCollapsed = li.classList.toggle('collapsed');
                    if (isNowCollapsed) {
                        expandedFolderKeys.delete(key);
                    } else {
                        expandedFolderKeys.add(key);
                    }
                    localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));

                } else if (actionBtn) {
                    // Folder actions (Rename/Delete)
                    const li = actionBtn.closest('li');
                    const key = li.dataset.folderKey;
                    const name = actionBtn.dataset.name;
                    if (actionBtn.dataset.action === 'rename') renameFolder(e, key, name);
                    if (actionBtn.dataset.action === 'delete') deleteFolder(e, key, name);

                } else if (link) {
                    // Seamless Navigation (No modal)
                    e.preventDefault();
                    handleSeamlessNavigation(link.dataset.folderUrl);
                }
            });
            
            // Updated Breadcrumbs Listener: Uses Smart Navigation
            const breadcrumbContainer = document.querySelector('.breadcrumb-links');
            if (breadcrumbContainer) {
                breadcrumbContainer.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (link) {
                        e.preventDefault();
                        handleSeamlessNavigation(link.getAttribute('href'));
                    }
                });
            }
            
            document.getElementById('move-folder-tree').addEventListener('click', (e) => {
                const toggle = e.target.closest('.toggle-btn');
                const moveBtn = e.target.closest('.move-here-btn');

                if (toggle) {
                    const li = toggle.closest('li');
                    const key = li.dataset.folderKey;
                    const isNowCollapsed = li.classList.toggle('collapsed');
                    if (isNowCollapsed) {
                        expandedFolderKeys.delete(key);
                    } else {
                        expandedFolderKeys.add(key);
                    }
                    localStorage.setItem('galleryFolderState', JSON.stringify([...expandedFolderKeys]));
                }

                if (moveBtn) {
                    confirmMoveToFolder(moveBtn.dataset.folderKey);
                }
            });
            
            // AI Listeners
            // Bottone Desktop
            const aiToggleDesktop = document.getElementById('ai-search-toggle-desktop');
            if (aiToggleDesktop) {
                aiToggleDesktop.addEventListener('click', openAiSearchModal);
            }
            
            // Bottone Mobile
            const aiToggleMobile = document.getElementById('ai-search-toggle-mobile');
            if (aiToggleMobile) {
                aiToggleMobile.addEventListener('click', openAiSearchModal);
            }
            
            document.getElementById('ai-modal-close').addEventListener('click', closeAiSearchModal);
            
            document.getElementById('ai-search-submit').addEventListener('click', submitAiSearch);
            
            const refreshBtn = document.getElementById('refresh-btn');
            if(refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); startSyncProcess(true); });
            
            const rescanBtn = document.getElementById('rescan-folder-btn');
            if(rescanBtn) rescanBtn.addEventListener('click', showRescanModal);
            
            rescanRecentBtn.addEventListener('click', () => performRescan('recent'));
            rescanAllBtn.addEventListener('click', () => performRescan('all'));
            rescanCancelBtn.addEventListener('click', hideRescanModal);
            
            const mainSelectAll = document.getElementById('main-select-all-btn');
            if(mainSelectAll) mainSelectAll.addEventListener('click', selectAll);
            
            const showUpload = document.getElementById('show-upload-modal-btn');
            if(showUpload) showUpload.addEventListener('click', showUploadModal);
            
            document.getElementById('create-folder-btn').addEventListener('click', createFolder);
            document.getElementById('cancel-drop-btn').addEventListener('click', hideDropZone);
            document.getElementById('select-all-btn').addEventListener('click', selectAll);
            document.getElementById('deselect-all-btn').addEventListener('click', deselectAll);
            // Listeners for Move and Copy
            const moveBtn = document.getElementById('move-selected-btn');
            if (moveBtn) moveBtn.addEventListener('click', initiateMove);

            const copyBtn = document.getElementById('copy-selected-btn');
            if (copyBtn) copyBtn.addEventListener('click', copySelected);
            document.getElementById('download-zip-btn').addEventListener('click', downloadSelectedZip);
            document.getElementById('delete-selected-btn').addEventListener('click', deleteSelected);
            document.getElementById('favorite-selected-btn').addEventListener('click', () => favoriteSelected(true));
            document.getElementById('unfavorite-selected-btn').addEventListener('click', () => favoriteSelected(false));
            document.querySelector('#lightbox-overlay .close-btn').addEventListener('click', closeLightbox);
            document.getElementById('lightbox-prev').addEventListener('click', () => navigateLightbox(-1));
            document.getElementById('lightbox-next').addEventListener('click', () => navigateLightbox(1));
            document.getElementById('lightbox-zoom-in').addEventListener('click', () => zoomLightbox(0.2));
            document.getElementById('lightbox-zoom-out').addEventListener('click', () => zoomLightbox(-0.2));
            document.getElementById('lightbox-delete-btn').addEventListener('click', () => deleteFromLightbox(false));
            document.getElementById('lightbox-rename-btn').addEventListener('click', renameFileFromLightbox);
            // --- COPY WORKFLOW TO CLIPBOARD (Button Click) ---
            const copyJsonBtn = document.getElementById('lightbox-copy-json');
            if (copyJsonBtn) {
                copyJsonBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentLightboxFile) {
                        // Visual feedback on button
                        const originalText = copyJsonBtn.innerHTML;
                        copyJsonBtn.innerHTML = '⏳';
                        
                        copyWorkflowToClipboard(currentLightboxFile.id);
                        
                        // Restore button icon quickly
                        setTimeout(() => { copyJsonBtn.innerHTML = originalText; }, 500);
                    }
                });
            }
           // --- LIGHTBOX INTERACTIONS (ZOOM & DRAG) ---
            
            // 1. ZOOM via Mouse Wheel
            document.getElementById('lightbox-content').addEventListener('wheel', (event) => { 
                if (lightboxOverlay.classList.contains('visible')) { 
                    event.preventDefault(); // Blocca lo scroll della pagina sottostante
                    // Zoom In se scorri su, Zoom Out se scorri giù
                    zoomLightbox(event.deltaY < 0 ? 0.1 : -0.1); 
                } 
            }, { passive: false }); // 'passive: false' è importante per far funzionare preventDefault() sui browser moderni

            // 2. PAN via Mouse Drag
            const lbMediaContainer = document.getElementById('lightbox-media');
            let isLbDragging = false;
            let lbStartX = 0;
            let lbStartY = 0;

            lbMediaContainer.addEventListener('mousedown', (e) => {
                // Attiva solo se clicchi sull'immagine o video, non sullo sfondo vuoto
                if (e.target.tagName !== 'IMG' && e.target.tagName !== 'VIDEO') return;
                
                e.preventDefault();
                isLbDragging = true;
                lbStartX = e.clientX;
                lbStartY = e.clientY;
                
                e.target.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', (e) => {
                if (!isLbDragging) return;
                e.preventDefault();

                const dx = e.clientX - lbStartX;
                const dy = e.clientY - lbStartY;

                lbStartX = e.clientX;
                lbStartY = e.clientY;

                panLightbox(dx, dy);
            });

            window.addEventListener('mouseup', () => {
                if (isLbDragging) {
                    isLbDragging = false;
                    const media = lbMediaContainer.querySelector('img, video');
                    if (media) media.style.cursor = 'grab';
                }
            });

            // --- FIX SCROLL CAPTION ---
            const captionBoxElement = document.getElementById('lightbox-ai-caption');
            if (captionBoxElement) {
                captionBoxElement.addEventListener('wheel', (event) => {
                    event.stopPropagation();
                }, { passive: true });
            }
            document.getElementById('close-summary-btn').addEventListener('click', closeNodeSummary);
            summaryOverlay.addEventListener('click', (event) => { if (event.target === summaryOverlay) closeNodeSummary(); });
            if(showUpload) showUploadModalBtn.addEventListener('click', showUploadModal);
            uploadCancelBtn.addEventListener('click', closeUploadModal);
            uploadOverlay.addEventListener('click', (event) => { if (event.target === uploadOverlay) closeUploadModal(); });
            fileBrowseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));

            // --- KEYBOARD SHORTCUTS (FIXED ESCAPE PRIORITY) ---
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

                // --- 1. Storyboard Zoom Navigation ---
                const sbZoomOverlay = document.getElementById('sb-zoom-overlay');
                if (sbZoomOverlay && sbZoomOverlay.style.display === 'flex') {
                    if (e.key === 'ArrowLeft') { e.preventDefault(); e.stopPropagation(); navigateSbZoom(-1); return; }
                    if (e.key === 'ArrowRight') { e.preventDefault(); e.stopPropagation(); navigateSbZoom(1); return; }
                    if (e.key === 'Escape') { e.preventDefault(); closeSbZoom(); return; }
                    return;
                }

                // --- 2. Compare Mode Shortcuts ---
                if (document.getElementById('compare-overlay').classList.contains('visible')) {
                    if (e.key === 'Escape') { closeCompareMode(); return; }
                    if (e.key === '+' || e.key === '=') { e.preventDefault(); cmpZoom(0.2); return; }
                    if (e.key === '-' || e.key === '_') { e.preventDefault(); cmpZoom(-0.2); return; }
                    if (e.key === '0') { e.preventDefault(); cmpResetZoom(); return; }
                    if (e.key === 'i' || e.key === 'I') { e.preventDefault(); toggleCmpInfo(); return; }
                    e.stopPropagation(); return; 
                }

                // --- 3. Global Shortcuts ---
                if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) { e.preventDefault(); selectAll(); return; }

                // --- 4. Escape Handler (Priority Stack) ---
                if (e.key === 'Escape') {
                    // A. High Priority Overlays
                    const sbOverlay = document.getElementById('storyboard-overlay');
                    if (sbOverlay && sbOverlay.classList.contains('visible')) { closeStoryboard(); return; }
                    if (document.getElementById('shortcuts-help-overlay').classList.contains('visible')) { closeShortcutsHelp(); return; }
                    if (document.getElementById('upload-overlay').classList.contains('visible')) { closeUploadModal(); return; }
                    if (document.getElementById('node-summary-overlay').classList.contains('visible')) { closeNodeSummary(); return; }
                    if (document.getElementById('ai-search-overlay').classList.contains('visible')) { closeAiSearchModal(); return; }
                    
                    // B. Lightbox (Moved here to ensure it catches the event)
                    if (document.body.classList.contains('lightbox-open')) { 
                        closeLightbox(); 
                        return; 
                    }

                    // C. Panels & Selection
                    const panel = document.getElementById('desktop-search-panel');
                    if (panel && panel.classList.contains('visible')) { panel.classList.remove('visible'); return; }
                    
                    if (selectedFiles.size > 0) { deselectAll(); }
                    hideDropZone();
                    return;
                }

                if (document.body.classList.contains('modal-open')) return;

                const isLightboxOpen = document.body.classList.contains('lightbox-open');
                
                // --- 5. Lightbox Actions ---
                if (isLightboxOpen) {
                    switch (e.key) {
                        case 'ArrowLeft': navigateLightbox(-1); break;
                        case 'ArrowRight': navigateLightbox(1); break;
                        case 'v': case 'V': closeLightbox(); break; // V acts as close inside lightbox
                        case 'd': case 'D': case 'Delete': deleteFromLightbox(true); break;
                        case 's': case 'S': if(currentLightboxFile) { const l = document.createElement('a'); l.href = `/galleryout/download/${currentLightboxFile.id}`; l.download = ''; document.body.appendChild(l); l.click(); l.remove(); } break;
                        case 'r': case 'R': renameFileFromLightbox(); break;
                        case 'w': case 'W': 
                            if(currentLightboxFile && currentLightboxFile.has_workflow) { const l = document.createElement('a'); l.href = `/galleryout/workflow/${currentLightboxFile.id}`; l.download = ''; document.body.appendChild(l); l.click(); l.remove(); } 
                            else { showNotification('No workflow available.', 'info'); } break;
                        case 'c': case 'C': if(currentLightboxFile) copyWorkflowToClipboard(currentLightboxFile.id); break;
                        case 'o': case 'O': if(currentLightboxFile) window.open(`/galleryout/file/${currentLightboxFile.id}`, '_blank'); break;
                        case 'n': case 'N': if(currentLightboxFile && currentLightboxFile.has_workflow) document.getElementById('lightbox-summary-btn').click(); else showNotification('No summary available.', 'info'); break;
                        case 'f': case 'F': if(currentLightboxFile) { const item = galleryItems[currentLightboxIndex]; if(item) toggleFavorite(e, currentLightboxFile.id, item.querySelector('.favorite-btn')); } break;
                        case '+': case '=': zoomLightbox(0.1); break;
                        case '-': case '_': zoomLightbox(-0.1); break;
                        case '0': currentZoom = 1; currentTranslateX = 0; currentTranslateY = 0; updateMediaTransform(); break;
                        case '.': cyclePanStep(); break;
                        case '8': panLightbox(0, panStep); break;
                        case '2': panLightbox(0, -panStep); break;
                        case '4': panLightbox(panStep, 0); break;
                        case '6': panLightbox(-panStep, 0); break;
                        case '7': panLightbox(panStep, panStep); break;
                        case '9': panLightbox(-panStep, panStep); break;
                        case '1': panLightbox(panStep, -panStep); break;
                        case '3': panLightbox(-panStep, -panStep); break;
                        case 'h': case 'H': toggleLightboxUi(); break;
                        case '?': showShortcutsHelp(); break;
                        case 'e': case 'E': if(currentLightboxFile) openStoryboard(currentLightboxFile.id); break;
                    }
                } 
                
                // --- 6. Grid View Shortcuts ---
                else {
                    // Global Helpers
                    if (e.key === 'z' || e.key === 'Z') { downloadSelectedZip(); return; }
                    if (e.key === 'p' || e.key === 'P') { e.preventDefault(); toggleVideoAutoplay(); return; }
                    if (e.key === 'l' || e.key === 'L') { startSyncProcess(true); return; }
                    if (e.key === 'k' || e.key === 'K') { showRescanModal(); return; }
                    if (e.key === '?') { showShortcutsHelp(); return; }
                    if (e.key === 't' || e.key === 'T') { 
                        e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' });
                        const deskBtn = document.getElementById('search-toggle-desktop');
                        const mobBtn = document.getElementById('mobile-filter-toggle');
                        if(deskBtn && deskBtn.offsetParent !== null) deskBtn.click(); else if(mobBtn) mobBtn.click();
                        return;
                    }
                    // Toggle Focus Mode
                    if (e.key === 'q' || e.key === 'Q') {
                        toggleFocusMode();
                        return;
                    }
                    if (galleryItems.length === 0) return;

                    // Navigation Helper
                    const getColumns = () => {
                        const style = window.getComputedStyle(galleryContainer);
                        return style.getPropertyValue('grid-template-columns').split(' ').length;
                    };

                    // --- ROBUST TARGET LOGIC (V5: Drill-down & State Check) ---
                    const getTargetIndex = () => {
                        // The focused element is now the single source of truth
                        return (focusedItemIndex !== -1) ? focusedItemIndex : -1;
                    };

                    // --- Inside keydown listener, Grid View section ---
                    switch (e.key) {
                        case 'Enter': {
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                e.preventDefault(); // Prevent accidental form submissions or page jumps
                                // PRIMARY ACTION: Open Lightbox
                                // We pass 'true' for forceOpen to bypass Focus Mode selection logic
                                openLightbox(null, galleryItems[idx].dataset.fileId, true);
                            }
                            break;
                        }
                        case ' ': { // Spacebar
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                e.preventDefault(); // CRITICAL: Stop the page from scrolling down!
                                // TOGGLE SELECTION: Same as 'X' key or clicking the checkmark
                                toggleSelection(e, galleryItems[idx].dataset.fileId, galleryItems[idx]);
                            }
                            break;
                        }
                        case 'ArrowRight': // ... rest of the navigation code ...
                        case 'ArrowRight': e.preventDefault(); updateFocus(1); break;
                        case 'ArrowLeft': e.preventDefault(); updateFocus(-1); break;
                        case 'ArrowDown': e.preventDefault(); updateFocus(getColumns()); break;
                        case 'ArrowUp': e.preventDefault(); updateFocus(-getColumns()); break;
                        
                        case 'Delete': {
                            const idx = getTargetIndex();
                            // Quick Delete only if hovering exact element (Safety)
                            const elAtMouse = (window.lastMouseX > 0) ? document.elementFromPoint(window.lastMouseX, window.lastMouseY) : null;
                            const itemAtMouse = elAtMouse ? elAtMouse.closest('.gallery-item') : null;
                            
                            if (itemAtMouse && galleryItems.indexOf(itemAtMouse) === idx) {
                                deleteFile(e, galleryItems[idx].dataset.fileId, galleryItems[idx].querySelector('.delete-btn'), true);
                                return;
                            }
                            // Standard Delete
                            if (selectedFiles.size > 0) { deleteSelected(); return; }
                            if (idx !== -1) {
                                deleteFile(e, galleryItems[idx].dataset.fileId, galleryItems[idx].querySelector('.delete-btn'), false);
                            }
                            break;
                        }
                        case 'd': case 'D':
                            if (selectedFiles.size > 0) deleteSelected();
                            else {
                                const idx = getTargetIndex();
                                if(idx !== -1) deleteFile(e, galleryItems[idx].dataset.fileId, galleryItems[idx].querySelector('.delete-btn'));
                            }
                            break;
                        
                        // --- UNIFIED ACTIONS ---
                        case 'v': case 'V': {
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                // Pass dummy event and TRUE for forceOpen
                                const safeEvent = { target: document.body, stopPropagation: () => {} };
                                openLightbox(safeEvent, galleryItems[idx].dataset.fileId, true);
                            }
                            break;
                        }
                        case 'n': case 'N': {
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                const item = galleryItems[idx];
                                item.style.transform = "scale(1.02)";
                                setTimeout(() => item.style.transform = "", 150);
                                showNodeSummary(e, item.dataset.fileId);
                            }
                            break;
                        }
                        case 'f': case 'F': {
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                const btn = galleryItems[idx].querySelector('.favorite-btn');
                                if(btn) toggleFavorite(e, galleryItems[idx].dataset.fileId, btn);
                            }
                            break;
                        }
                        case 'x': case 'X': {
                            const idx = getTargetIndex();
                            if (idx !== -1) toggleSelection(e, galleryItems[idx].dataset.fileId, galleryItems[idx]);
                            break;
                        }
                        case 's': case 'S': {
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                const l = document.createElement('a'); 
                                l.href = `/galleryout/download/${galleryItems[idx].dataset.fileId}`; 
                                l.download = ''; document.body.appendChild(l); l.click(); l.remove();
                            }
                            break;
                        }
                        case 'r': case 'R': {
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                const f = allFilesData.find(x => x.id === galleryItems[idx].dataset.fileId);
                                if(f) renameFile(f.id, f.name);
                            }
                            break;
                        }
                        case 'w': case 'W': {
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                const f = allFilesData.find(x => x.id === galleryItems[idx].dataset.fileId);
                                if(f && f.has_workflow) {
                                    const l = document.createElement('a');
                                    l.href = `/galleryout/workflow/${f.id}`; 
                                    l.download = ''; document.body.appendChild(l); l.click(); l.remove();
                                } else showNotification('No workflow available.', 'info');
                            }
                            break;
                        }
                        case 'c': case 'C': {
                            const idx = getTargetIndex();
                            if (idx !== -1) copyWorkflowToClipboard(galleryItems[idx].dataset.fileId);
                            break;
                        }
                        case 'e': case 'E': {
                            const idx = getTargetIndex();
                            if (idx !== -1) openStoryboard(galleryItems[idx].dataset.fileId);
                            break;
                        }
                        case 'm': case 'M': {
                            if (selectedFiles.size > 0) { moveSelected(); break; }
                            const idx = getTargetIndex();
                            if (idx !== -1) {
                                deselectAll();
                                selectedFiles.add(galleryItems[idx].dataset.fileId);
                                updateSelectionUI();
                                initiateMove();
                            }
                            break;
                        }
                    }
                }
            });

            function updateFocus(delta) {
                if (galleryItems.length === 0) return;

                let newIndex = focusedItemIndex + delta;

                if (newIndex < 0) newIndex = 0;
                if (newIndex >= galleryItems.length) newIndex = galleryItems.length - 1;

                if (newIndex !== focusedItemIndex) {
                    if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                        galleryItems[focusedItemIndex].classList.remove('focused');
                    }
                    focusedItemIndex = newIndex;
                    const newItem = galleryItems[focusedItemIndex];
                    newItem.classList.add('focused');
                    newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else if (focusedItemIndex === -1) {
                    focusedItemIndex = 0;
                    galleryItems[0].classList.add('focused');
                }
            }

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
            uploadSubmitBtn.addEventListener('click', performUpload);

            // --- FIX LOAD MORE BUTTON LOGIC & INFINITE SCROLL ---
            const loadMoreBtn = document.getElementById('load-more-btn');
            const loadMoreContainer = document.getElementById('load-more-container');

            if (loadMoreBtn) {
                // 1. Click Handler (Original Logic)
                loadMoreBtn.addEventListener('click', async function () {
                    if (this.disabled) return; // Prevent double firing
                    
                    this.disabled = true;
                    
                    // [FIX] Update text span only, preserve SVG icon
                    const textSpan = this.querySelector('span');
                    const originalText = textSpan ? textSpan.textContent : 'Load More';
                    if (textSpan) textSpan.textContent = 'Loading...';
                    
                    try {
                        let fetchUrl = `/galleryout/load_more?offset=${currentItemCount}&folder_key=${currentFolderKey}`;
                        
                        const filterForm = document.querySelector('#filter-form');
                        if (filterForm) {
                            fetchUrl += `&${new URLSearchParams(new FormData(filterForm))}`;
                        }
                        
                        const response = await fetch(fetchUrl);
                        const data = await response.json();
                        
                        if (data.files && data.files.length > 0) {
                            appendFiles(data.files);
                        } else {
                            // No more files: hide container and disconnect observer
                            // showNotification('No more files to load.', 'info'); // Optional: usually distracting on infinite scroll
                            if (loadMoreContainer) loadMoreContainer.style.display = 'none';
                        }
                    } catch (error) {
                        handleError(error);
                    }
                    
                    if (currentItemCount < totalFiles) {
                        this.disabled = false;
                        // [FIX] Restore original text
                        if (textSpan) textSpan.textContent = originalText;
                    } else {
                        if (loadMoreContainer) loadMoreContainer.style.display = 'none';
                    }
                });

                // 2. Infinite Scroll Observer
                // Triggers the click automatically when the button comes into view
                if (loadMoreContainer) {
                    const scrollObserver = new IntersectionObserver((entries) => {
                        const entry = entries[0];
                        // If visible AND not already loading AND container is not hidden
                        if (entry.isIntersecting && !loadMoreBtn.disabled && loadMoreContainer.style.display !== 'none') {
                            console.log("Infinite Scroll: Triggering load more...");
                            loadMoreBtn.click();
                        }
                    }, {
                        root: null, // Viewport
                        rootMargin: '300px', // Trigger loading 300px BEFORE reaching the bottom for smoothness
                        threshold: 0.1
                    });
                    
                    scrollObserver.observe(loadMoreContainer);
                }
            }

            document.getElementById('shortcuts-help-overlay').addEventListener('click', (e) => { if (e.target.id === 'shortcuts-help-overlay') closeShortcutsHelp(); });
            const closeShortcutsBtn = document.getElementById('close-shortcuts-btn');
            if (closeShortcutsBtn) {
                closeShortcutsBtn.addEventListener('click', closeShortcutsHelp);
            }

            // --- CLEAR BUTTON ---
            const aiInput = document.getElementById('ai-search-input');
            const aiClearBtn = document.getElementById('ai-search-clear-text');
            
            if (aiInput && aiClearBtn) {
                // Mostra/Nascondi X mentre scrivi
                aiInput.addEventListener('input', () => {
                    aiClearBtn.style.display = aiInput.value.trim().length > 0 ? 'flex' : 'none';
                });
                
                // Click on X
                aiClearBtn.addEventListener('click', () => {
                    aiInput.value = ''; // Pulisce
                    aiClearBtn.style.display = 'none'; 
                    localStorage.removeItem('lastAiQuery'); 
                    aiInput.focus(); // Rimette il focus
                });
            }

            // --- BACK TO TOP ---
            const backToTopBtn = document.getElementById('backToTopBtn');
            window.addEventListener('scroll', () => {
                if (backToTopBtn) {
                    backToTopBtn.style.display = (window.scrollY > 300) ? 'block' : 'none';
                }
            });
            
            // --- QUICK FILTER RESET LOGIC (Event Delegation) ---
            // Using delegation ensures it works even after the mobile button 
            // rewrites its own HTML (Hide/Show toggle).
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-reset-icon')) {
                    e.stopPropagation(); 
                    e.preventDefault();
                    
                    // Redirect to clear filters
                    window.location.href = "{{ url_for('gallery_view', folder_key=current_folder_key) }}";
                }
            });
            
            // --- SMART UI ZOOM COMPENSATION ---
            // Keeps the Selection Bar usable even when browser zoom is < 100%
            function handleBrowserZoom() {
                // Calculate rough zoom level (e.g., 0.6 for 60%)
                // Note: window.outerWidth/innerWidth is a reliable proxy on Chrome/Edge desktop
                const zoomLevel = Math.round(window.outerWidth / window.innerWidth * 100) / 100;
                
                // We only compensate if zoom is significantly small (below 90%)
                if (zoomLevel < 0.9) {
                    // Calculate inverse scale (e.g., if zoom 0.5, we scale 2.0x)
                    // We cap it at 2.5x to prevent absurdly huge UI on massive resolutions
                    let scaleFactor = 1 / zoomLevel;
                    scaleFactor = Math.min(Math.max(scaleFactor, 1), 2.5);
                    
                    document.documentElement.style.setProperty('--ui-zoom-scale', scaleFactor);
                } else {
                    // Reset to normal
                    document.documentElement.style.setProperty('--ui-zoom-scale', '1');
                }
            }
            
            // --- PLATFORM DETECTION (Mac vs PC) ---
            // Changes "Ctrl" to "⌘" in the help panel if user is on Mac
            function detectPlatformLabels() {
                const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0 || navigator.userAgent.toUpperCase().indexOf('MAC') >= 0;
                
                if (isMac) {
                    document.querySelectorAll('.cmd-key').forEach(el => {
                        el.textContent = '⌘'; // Sostituisce "Ctrl" con il simbolo Command
                        el.style.fontFamily = 'system-ui, sans-serif'; // Assicura che il simbolo si veda bene
                    });
                }
            }
            detectPlatformLabels();
            
            // Listen for resize (which triggers on zoom change in modern browsers)
            window.addEventListener('resize', handleBrowserZoom);
            
            // Initial check
            handleBrowserZoom();
            
            // Close Options on click outside
            document.addEventListener('click', (e) => {
                const pop = document.getElementById('options-popover');
                const btnD = document.getElementById('options-btn-desk');
                const btnM = document.getElementById('options-btn-mob');
                
                if (pop && pop.classList.contains('visible')) {
                    if (!pop.contains(e.target) && e.target !== btnD && e.target !== btnM && !btnD.contains(e.target) && !btnM.contains(e.target)) {
                        pop.classList.remove('visible');
                    }
                }
            });
            
            // Run Autoplay Notification Check
            setTimeout(checkVideoAutoplayNotification, 1000); // Small delay to let UI settle
            // Apply saved grid size preference
            applyGridSize();
            
        });
        
        // --- GLOBAL HELPER FUNCTIONS (Moved out for HTML access) ---
        function showShortcutsHelp() { 
            document.getElementById('shortcuts-help-overlay').classList.add('visible'); 
        }
        function closeShortcutsHelp() { 
            document.getElementById('shortcuts-help-overlay').classList.remove('visible'); 
        }
        
        // --- OPTIONS MENU LOGIC ---
        function toggleOptionsMenu(e) {
            e.stopPropagation();
            const popover = document.getElementById('options-popover');
            const btn = e.currentTarget; // Works for both desk and mobile buttons
            
            if (popover.classList.contains('visible')) {
                popover.classList.remove('visible');
            } else {
                // Position logic (Simple Anchor)
                const rect = btn.getBoundingClientRect();
                const pW = 240; // Popover width
                
                // Align right edge
                let left = rect.right - pW;
                if (left < 10) left = 10; // Mobile safety
                
                let top = rect.bottom + 10;
                
                popover.style.top = top + 'px';
                popover.style.left = left + 'px';
                
                // Update UI state before showing
                updateOptionsUI();
                
                popover.classList.add('visible');
            }
        }
        
        function updateOptionsUI() {
            // 1. Autoplay UI
            const statusEl = document.getElementById('opt-status-autoplay');
            const itemEl = document.getElementById('opt-btn-autoplay');
            
            if (videoAutoplay) {
                statusEl.textContent = "ON";
                statusEl.className = "opt-status on";
                // FIX: Usa classList per non cancellare altre classi esistenti
                itemEl.classList.add('active');
                itemEl.classList.remove('inactive');
            } else {
                statusEl.textContent = "OFF";
                statusEl.className = "opt-status off";
                // FIX: Usa classList
                itemEl.classList.remove('active');
                itemEl.classList.add('inactive');
            }

            // 2. Grid Size UI
            const sizeStatusEl = document.getElementById('opt-status-size');
            const sizeItemEl = document.getElementById('opt-btn-size');
            
            if (sizeStatusEl && sizeItemEl) {
                if (gridSizePref === 'small') {
                    sizeStatusEl.textContent = "COMPACT";
                    sizeStatusEl.className = "opt-status on";
                    sizeStatusEl.style.backgroundColor = "var(--primary-color)";
                    
                    // FIX CRITICO: Non usare .className = ... altrimenti cancelli 'opt-desktop-only'
                    sizeItemEl.classList.add('active');
                } else {
                    sizeStatusEl.textContent = "NORMAL";
                    sizeStatusEl.className = "opt-status off";
                    sizeStatusEl.style.backgroundColor = ""; 
                    
                    sizeItemEl.classList.remove('active');
                }
            }
        }

        function applyGridSize() {
            const container = document.getElementById('gallery-container');
            if (!container) return;
            
            if (gridSizePref === 'small') {
                container.style.setProperty('--grid-item-size', '220px');
            } else {
                container.style.setProperty('--grid-item-size', '320px');
            }
            updateOptionsUI();
        }

        function toggleGridSize() {
            gridSizePref = (gridSizePref === 'normal') ? 'small' : 'normal';
            localStorage.setItem('sg_gridSize', gridSizePref);
            applyGridSize();
            // Optional: Re-layout lazy loading check
            window.dispatchEvent(new Event('resize')); 
        }

        function toggleVideoAutoplay() {
            // 1. Toggle State
            videoAutoplay = !videoAutoplay;
            localStorage.setItem('sg_videoAutoplay', videoAutoplay);
            
            // 2. Immediate Visual Feedback (Toggle switch in menu)
            updateOptionsUI();
            
            // 3. Smart Feedback Notification
            const status = videoAutoplay ? "ENABLED" : "DISABLED";
            
            // Check if we actually need to reload (are there videos?)
            const hasVideos = allFilesData.some(f => f.type === 'video');
            
            if (hasVideos) {
                // Show notification briefly
                showNotification(`Autoplay ${status}. Reloading...`, "info", 4000);
                
                // Show Loader immediately to block interaction while waiting for refresh
                setTimeout(() => {
                    const loader = document.getElementById('loader-overlay');
                    if (loader) {
                        loader.style.display = 'flex';
                        // Force opacity for transition
                        requestAnimationFrame(() => { loader.style.opacity = '1'; });
                    }
                    
                    // Trigger reload
                    window.location.reload();
                }, 500); // 0.5s delay just to let the user glimpse the "Enabled/Disabled" change in the menu
            } else {
                // No videos on screen? No need to reload! Just confirm saving.
                showNotification(`Autoplay ${status} (Saved for next time)`, "success");
            }
        }
        
        // Function to play video IN GRID (Desktop Only)
        function playVideoInGrid(event, btnElement) {
            // Prevent opening Lightbox or Selecting
            event.stopPropagation();
            event.preventDefault();

            const wrapper = btnElement.closest('.thumbnail-wrapper');
            const video = wrapper.querySelector('video');
            
            if (!video) return;

            // 1. Hide the overlay button
            btnElement.style.display = 'none';

            // 2. Enable interaction on the video tag (so users can pause/seek)
            video.style.pointerEvents = 'auto';
            
            // 3. Add controls
            video.setAttribute('controls', 'true');
            
            // 4. Force load and play
            video.setAttribute('preload', 'auto');
            video.load(); 
            
            const playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => console.log("Play failed:", error));
            }

            // --- FOCUS TRAP FIX ---
            // Native video controls steal keyboard focus. We must release it manually.

            // A. Release focus immediately on Pause or End
            video.onpause = () => video.blur();
            video.onended = () => video.blur();

            // B. Allow Global Shortcuts to break out even while playing
            video.onkeydown = (e) => {
                // Allow native player keys (Space, Arrows, F)
                if ([' ', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'f', 'F'].includes(e.key)) return;

                // If user presses App Shortcuts (V, Q, Esc, Delete, etc.), force blur and re-trigger
                const appKeys = ['v', 'V', 'q', 'Q', 'Escape', 'Delete', 'Backspace'];
                if (appKeys.includes(e.key)) {
                    e.preventDefault(); // Stop video player from absorbing it
                    video.blur();       // Release focus back to body
                    document.body.focus();
                    
                    // Re-dispatch the event so the global listener catches it immediately
                    const newEvent = new KeyboardEvent('keydown', {
                        key: e.key,
                        code: e.code,
                        bubbles: true,
                        cancelable: true,
                        shiftKey: e.shiftKey,
                        ctrlKey: e.ctrlKey,
                        metaKey: e.metaKey
                    });
                    document.dispatchEvent(newEvent);
                }
            };
        }
        
        
        // Helper to check for videos and warn user
        function checkVideoAutoplayNotification() {
            if (allFilesData.length === 0) return;
            
            // Check if there is at least one video (mp4, mov, etc - NOT animated images)
            const hasVideo = allFilesData.some(f => f.type === 'video');
            
            if (hasVideo) {
                const isMobile = window.innerWidth <= 768;
                const action = isMobile ? "use Options ⚙️" : "press 'P'";
                let msg = "";
                
                if (videoAutoplay) {
                    // Message for Autoplay ON
                    msg = `▶️ Autoplay ON.\n (Slow connection? Disable: ${action})`;
                    showNotification(msg, "info multiline-msg", 6000); 
                } else {
                    // Message for Autoplay OFF (Differentiated by platform)
                    if (isMobile) {
                        // Mobile: Tap opens Lightbox
                        // Usiamo \n e passiamo la nuova classe
                        msg = `⏸️ Autoplay OFF.\nTap to open the Lightbox and play the video.\n (Enable Autoplay: ${action})`;
                    } else {
                        // Desktop: Click the little icon to play in thumbnail
                        // Usiamo \n e passiamo la nuova classe
                        msg = `⏸️ Autoplay OFF.\nClick the ▶️ to play inside the thumbnail.\n (Enable Autoplay: ${action})`;
                    }
                    // Passiamo "multiline-msg" come parte del parametro 'type' (es: "info multiline-msg")
                    showNotification(msg, `info multiline-msg`, 6000); 
                }
            }
        }
        
        // --- BUTTONS + - LIMIT MAX RESULTS ---
        window.adjustAiLimit = function(delta) {
            const input = document.getElementById('ai-search-limit');
            if (input) {
                let val = parseInt(input.value) || 100;
                val += delta;
                
                // Limiti di sicurezza (Minimo 10, Massimo 2000)
                if (val < 10) val = 10;
                if (val > 2000) val = 2000;
                
                input.value = val;
            }
        };
        // --- FORMATTING CAPTION TEXT ---
        function formatAiCaptionText(text) {
            if (!text) return "";
            const frameRegex = /\[(Start|Middle|End):\s*([\s\S]*?)\]/gi;
            if (text.match(frameRegex)) {
                return text.replace(frameRegex, (match, label, content) => {
                    return `
                        <div class="ai-caption-card">
                            <div class="ai-card-header">${label.toUpperCase()} FRAME</div>
                            <div class="ai-card-body">${content.trim()}</div>
                        </div>
                    `;
                });
            }
            
            return text;
        }
        // --- COPY WORKFLOW HELPER FUNCTION ---
        function copyWorkflowToClipboard(fileId) {
            const file = allFilesData.find(f => f.id === fileId);
            
            if (!file) return;
            
            if (!file.has_workflow) {
                showNotification('No workflow data available for this file.', 'warning');
                return;
            }

            showNotification('Fetching workflow data...', 'info');

            fetch(`/galleryout/workflow/${fileId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Workflow not found');
                    return response.json();
                })
                .then(json => {
                    const jsonStr = JSON.stringify(json, null, 2);
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(jsonStr)
                            .then(() => {
                                showNotification('📋 Workflow copied! Press Ctrl+V (or system equivalent) in ComfyUI.', 'success');
                            })
                            .catch(err => {
                                console.error('Clipboard write failed:', err);
                                showNotification('Failed to copy (Browser restriction).', 'error');
                            });
                    } else {
                        const textArea = document.createElement("textarea");
                        textArea.value = jsonStr;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        textArea.style.top = "0";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                showNotification('📋 Workflow copied! Press Ctrl+V (or system equivalent) in ComfyUI.', 'success');
                            } else {
                                showNotification('Clipboard API not supported in this context.', 'error');
                            }
                        } catch (err) {
                            showNotification('Clipboard API not supported in this context.', 'error');
                        }
                        document.body.removeChild(textArea);
                    }
                })
                .catch(err => {
                    showNotification('Error fetching workflow: ' + err.message, 'error');
                });
        }
        
        // --- AI MANAGER FUNCTIONS (RENAMED TO FIX CONFLICT) ---
        let aiManagerPollInterval = null;

        function toggleAiManager(show) {
            const overlay = document.getElementById('ai-manager-overlay');
            if (show) {
                overlay.classList.add('visible');
                document.body.classList.add('modal-open');
                switchAiTab('queue');
                startAiManagerPolling(); // Rinomina qui
            } else {
                overlay.classList.remove('visible');
                document.body.classList.remove('modal-open');
                stopAiManagerPolling(); // Rinomina qui
            }
        }

        function switchAiTab(tabName) {
            document.querySelectorAll('.ai-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.ai-tab-content').forEach(c => c.classList.remove('active'));
            
            const btns = document.querySelectorAll('.ai-tab-btn');
            if (tabName === 'queue') btns[0].classList.add('active');
            if (tabName === 'watched') btns[1].classList.add('active');
            if (tabName === 'settings') btns[2].classList.add('active');

            document.getElementById('ai-tab-' + tabName).classList.add('active');
            if (tabName === 'watched') loadWatchedFolders();
        }

        function startAiManagerPolling() {
            if (aiManagerPollInterval) clearInterval(aiManagerPollInterval);
            pollAiManagerStatus();
            aiManagerPollInterval = setInterval(pollAiManagerStatus, 2000);
        }
        
        function stopAiManagerPolling() {
            if (aiManagerPollInterval) clearInterval(aiManagerPollInterval);
        }
        
        async function pollAiManagerStatus() {
            try {
                const res = await fetch('/galleryout/ai_indexing/status');
                const data = await res.json();
                
                // --- 1. Status Text, Color & Animation Logic ---
                const statusEl = document.getElementById('ai-stat-status');
                const dotsEl = document.getElementById('ai-status-anim'); // Get the dots container
                const isPaused = (data.global_status === 'Paused');
                
                if(statusEl) {
                    statusEl.textContent = data.global_status;
                    statusEl.className = "ai-stat-val"; // Reset base class
                    
                    // Apply colors and toggle animation based on state
                    if (isPaused) {
                        statusEl.classList.add("status-paused"); // Yellow (defined in CSS)
                        if(dotsEl) dotsEl.style.display = 'none'; // Hide dots
                    } else if (data.global_status === 'Indexing') {
                        statusEl.style.color = 'var(--success-color)'; // Green
                        if(dotsEl) dotsEl.style.display = 'inline-flex'; // Show dots
                    } else {
                        statusEl.style.color = 'white'; // Default
                        if(dotsEl) dotsEl.style.display = 'none'; // Hide dots
                    }
                }
                
                // --- 2. Toggle Button Update (Pause/Resume) ---
                const toggleBtn = document.getElementById('ai-toggle-pause');
                if (toggleBtn) {
                    if (isPaused) {
                        toggleBtn.innerHTML = "▶ Resume";
                        toggleBtn.className = "state-paused"; // Green background
                        toggleBtn.dataset.nextAction = "resume";
                    } else {
                        toggleBtn.innerHTML = "⏸ Pause";
                        toggleBtn.className = "state-running"; // Standard background
                        toggleBtn.dataset.nextAction = "pause";
                    }
                }
                
                // --- 3. Standard Stats ---
                const pendingEl = document.getElementById('ai-stat-pending');
                if(pendingEl) pendingEl.textContent = data.pending_count;
                
                const timeEl = document.getElementById('ai-stat-time');
                if(timeEl) timeEl.textContent = data.avg_time.toFixed(1) + 's';

                // GPU Warning (FIXED: Added removal of class)
                const warn = document.getElementById('ai-gpu-warning');
                if (warn) {
                    if (data.global_status === 'waiting_gpu') {
                        warn.classList.add('visible');
                    } else {
                        warn.classList.remove('visible');
                    }
                }

                // --- 4. Progress Bar & Current File ---
                const total = data.current_job_total || 1;
                const current = data.current_job_progress || 0;
                let pct = 0;
                let text = "Idle";
                
                if (data.current_file) {
                    pct = Math.round((current / total) * 100);
                    text = `Processing: .../${data.current_file}`; 
                } else if (data.pending_count > 0) {
                     text = "Waiting for worker...";
                }
                
                const progressBar = document.getElementById('ai-progress-bar');
                if(progressBar) progressBar.style.width = pct + '%';
                
                const progressPct = document.getElementById('ai-progress-percent');
                if(progressPct) progressPct.textContent = pct + '%';
                
                const currentFileEl = document.getElementById('ai-current-file');
                if(currentFileEl) currentFileEl.textContent = text;
                
                // --- 5. Queue List Preview (With Priority Support) ---
                const queueList = document.getElementById('ai-queue-preview');
                if (queueList) {
                    if(data.next_files && data.next_files.length > 0) {
                        queueList.innerHTML = data.next_files.map(item => {
                            // Backend returns object {path: "...", is_priority: true/false}
                            const fPath = item.path;
                            const isPrio = item.is_priority;
                            // Robust split for both / and \
                            const shortName = fPath.split(/[/\\]/).slice(-2).join('/');
                            
                            return `
                            <div class="ai-queue-item ${isPrio ? 'priority' : ''}">
                                <span title="${fPath}">
                                    ${isPrio ? '⚡ ' : ''}.../${shortName}
                                </span>
                                <span>${isPrio ? 'High Priority' : 'Pending'}</span>
                            </div>
                        `}).join('');
                    } else if (data.pending_count === 0) {
                        queueList.innerHTML = '<div style="padding:10px; text-align:center; color:#555;">Queue empty</div>';
                    }
                }

            } catch (e) { console.error("Manager Poll Error", e); }
        }
        
        // --- AI SETTINGS PERSISTENCE ---
        function initAiSettingsPersistence() {
            const STORAGE_KEY = 'galleryAiSettings';
            
            // 1. Restore saved settings on load
            const savedRaw = localStorage.getItem(STORAGE_KEY);
            if (savedRaw) {
                try {
                    const s = JSON.parse(savedRaw);
                    
                    // Restore Precision
                    if (s.precision) {
                        const el = document.querySelector(`input[name="ai_precision"][value="${s.precision}"]`);
                        if (el) el.checked = true;
                    }
                    
                    // Restore Beams
                    if (s.beams) {
                        const el = document.querySelector(`input[name="ai_beams"][value="${s.beams}"]`);
                        if (el) el.checked = true;
                    }
                } catch (e) {
                    console.error("Error loading AI settings:", e);
                }
            }

            // 2. Attach listeners to save on every change
            const inputs = document.querySelectorAll('input[name="ai_precision"], input[name="ai_beams"]');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    // We reuse the existing helper to get the clean object
                    const currentSettings = getAiParams(); 
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSettings));
                });
            });
        }
        
        async function controlAiQueue(action) {
            try {
                const res = await fetch('/galleryout/ai_indexing/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: action })
                });
                const d = await res.json();
                pollAiManagerStatus(); // Chiama la nuova funzione rinominata
                showNotification(d.message, d.status === 'success' ? 'success' : 'error');
            } catch (e) { console.error(e); }
        }
        
        function getAiParams() {
            // Updated to read from Radio Buttons instead of Select
            const beamsEl = document.querySelector('input[name="ai_beams"]:checked');
            const precEl = document.querySelector('input[name="ai_precision"]:checked');
            
            // Fallback defaults if nothing selected (should not happen)
            const beamsVal = beamsEl ? parseInt(beamsEl.value) : 3;
            const precVal = precEl ? precEl.value : 'fp16';

            return {
                beams: beamsVal,
                precision: precVal
            };
        }
        
        // --- AI MODAL & WATCHED FOLDERS LOGIC ---
        let pendingFolderKey = null;

        // 1. Open Options Modal (triggered by Brain icon in Sidebar)
        function indexFolder(folderKey) {
            pendingFolderKey = folderKey;
            
            const folder = foldersData[folderKey];
            const name = folder ? folder.display_name : folderKey;
            
            const pathPreview = document.getElementById('ai-opt-path');
            if(pathPreview) pathPreview.textContent = `Target: ${name}`;
            
            // --- UI TOGGLE LOGIC ---
            const stdControls = document.getElementById('ai-opt-standard-controls');
            const watchedControls = document.getElementById('ai-opt-watched-controls');
            const startBtn = document.getElementById('ai-opt-start-btn');
            
            const implicitMsg = document.getElementById('ai-opt-implicit-msg');
            const watchContainer = document.getElementById('ai-opt-watch-container');
            const recCheckbox = document.getElementById('ai-opt-recursive');
            const watchCheckbox = document.getElementById('ai-opt-watch');
            const forceCheckbox = document.getElementById('ai-opt-force');

            // Reset values
            if(recCheckbox) recCheckbox.checked = false;
            if(watchCheckbox) watchCheckbox.checked = true;
            if(forceCheckbox) forceCheckbox.checked = false;

            if (folder && folder.is_explicitly_watched) {
                // CASE 1: EXPLICITLY WATCHED (Root)
                // Show "Stop Watching" UI
                stdControls.style.display = 'none';
                watchedControls.style.display = 'block';
                startBtn.style.display = 'none'; 
            
            } else if (folder && folder.is_watched && !folder.is_explicitly_watched) {
                // CASE 2: IMPLICITLY WATCHED (Child of a watched folder)
                // Show Standard UI but HIDE Watch Option and SHOW Info Message
                stdControls.style.display = 'block';
                watchedControls.style.display = 'none';
                startBtn.style.display = 'block';
                
                // Customize for implicit
                implicitMsg.style.display = 'block'; // Show "Covered by Parent"
                watchContainer.style.display = 'none'; // Hide "Add to Watch List"
                watchCheckbox.checked = false; // Ensure it's not sent as true
                
            } else {
                // CASE 3: NOT WATCHED
                // Standard UI
                stdControls.style.display = 'block';
                watchedControls.style.display = 'none';
                startBtn.style.display = 'block';
                
                // Reset standard view
                implicitMsg.style.display = 'none';
                watchContainer.style.display = 'block';
                watchCheckbox.checked = true;
            }
            
            document.getElementById('ai-options-modal').classList.add('visible');
        }
        
        // New function to handle removal directly from the modal
        async function stopWatchingFromModal() {
            if (!pendingFolderKey) return;

            const folder = foldersData[pendingFolderKey];
            if (!folder) return;

            // 1. Confirm Stop
            const stopConfirmed = await smartConfirm(
                "⚠️ Stop Monitoring?", 
                `Stop monitoring "${folder.display_name}"?\n\nIf this folder was added with "Include Subfolders", all its subfolders will also be removed from the watch list.`, 
                true
            );
            
            if (!stopConfirmed) return;

            // 2. Ask Wipe Data
            const wipeConfirmed = await smartConfirm(
                "🗑️ Reset Data?", 
                "Do you also want to RESET existing AI data for this folder?\n\nDelete = Wipe Data (Captions/Embeddings)\nCancel = Keep Data (Stop monitoring only)", 
                true // Using red button for Wipe
            );

            closeAiOptions();
            showNotification("Removing from Watch List...", "info");

            const safePath = encodeURIComponent(folder.path);

            fetch('/galleryout/ai_indexing/watched', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    folder_path: folder.path,
                    reset_data: wipeConfirmed
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification("Folder removed from Watch List.", "success");
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification(data.message || "Error removing folder", "error");
                }
            })
            .catch(handleError);
        }
        
        function closeAiOptions() {
            document.getElementById('ai-options-modal').classList.remove('visible');
            pendingFolderKey = null;
        }
        function toggleAiPause() {
            const btn = document.getElementById('ai-toggle-pause');
            const action = btn.dataset.nextAction || 'pause';
            controlAiQueue(action);
        }
        // --- NEW: RESET / ERASE LOGIC ---
        async function confirmAiReset() {
            const confirmed = await smartConfirm(
                "🗑️ Erase AI Data", 
                "Are you sure you want to ERASE the AI data (captions/embeddings) for this target?\n\nThe files themselves will NOT be deleted, only the AI metadata.", 
                true
            );
            
            if (!confirmed) return;

            const recursive = document.getElementById('ai-opt-recursive').checked;
            const payload = {};

            if (pendingFolderKey) {
                payload.folder_key = pendingFolderKey;
                payload.recursive = recursive;
            } else if (selectedFiles.size > 0) {
                payload.file_ids = [...selectedFiles];
            } else {
                return;
            }

            const btn = document.querySelector('.nav-btn-danger-outline');
            let originalText = "🗑️ Erase AI Data";
            if (btn) {
                originalText = btn.textContent;
                btn.textContent = "Erasing...";
                btn.disabled = true;
            }

            fetch('/galleryout/ai_indexing/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    showNotification(d.message, 'success', 6000);
                    closeAiOptions();
                    if (!pendingFolderKey) deselectAll();
                } else {
                    showNotification(d.message, 'error');
                }
            })
            .catch(handleError)
            .finally(() => {
                if (btn) {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });
        }
        
        
        // 2. Execute Action after user confirmation in Modal
        // --- UPDATED: CONFIRM INDEXING ---
        function confirmAiIndex() {
            // Get common params
            let techParams = { beams: 3, precision: 'fp16' };
            try { techParams = getAiParams(); } catch(e){}
            
            const force = document.getElementById('ai-opt-force').checked;

            // MODE A: FOLDER
            if (pendingFolderKey) {
                const recursive = document.getElementById('ai-opt-recursive').checked;
                const watch = document.getElementById('ai-opt-watch').checked;
                
                fetch('/galleryout/ai_indexing/add_folder', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        folder_key: pendingFolderKey, 
                        recursive: recursive,
                        watch: watch,
                        force: force,
                        beams: techParams.beams,
                        precision: techParams.precision
                    })
                })
                .then(r => r.json())
                .then(d => {
                    const status = d.status === 'success' ? 'success' : 'warning';
                    showNotification(d.message, status);
                    
                    // --- INSTANT UI UPDATE (FIX) ---
                    // Aggiorniamo subito il modello locale JS per cambiare colore senza reload
                    if (d.status === 'success' && watch) {
                        if (foldersData[pendingFolderKey]) {
                            // Impostiamo i flag che la funzione buildFolderTreeHTML controlla
                            foldersData[pendingFolderKey].is_watched = true;
                            foldersData[pendingFolderKey].is_explicitly_watched = true; 
                            
                            // Ridisegniamo immediatamente l'albero nella sidebar
                            renderAllTrees(); 
                        }
                    }
                    
                    closeAiOptions();
                    
                    // Apriamo il manager per mostrare il progresso (comportamento standard)
                    toggleAiManager(true);
                    
                    if(watch) loadWatchedFolders();
                })
                .catch(handleError);
            } 
            // MODE B: BATCH FILES
            else if (selectedFiles.size > 0) {
                fetch('/galleryout/ai_indexing/add_files', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        file_ids: [...selectedFiles],
                        force: force, 
                        beams: techParams.beams,
                        precision: techParams.precision
                    })
                })
                .then(r => r.json())
                .then(d => {
                    const type = d.status === 'success' ? 'success' : 'warning';
                    showNotification(d.message, type);
                    
                    closeAiOptions();
                    if (d.count > 0) toggleAiManager(true);
                    deselectAll();
                })
                .catch(err => {
                    console.error(err);
                    showNotification("Error queuing files", "error");
                });
            }
        }
        
        // Update the Watched list passing the encoded PATH
        async function loadWatchedFolders() {
            const list = document.getElementById('watched-folders-list');
            if(!list) return;
            
            list.innerHTML = '<div style="padding:20px; text-align:center;">Loading...</div>';
            try {
                const res = await fetch('/galleryout/ai_indexing/watched');
                const data = await res.json();
                
                if (!data.folders || data.folders.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">No folders monitored.</div>';
                    return;
                }
                
                // SPACING FIX: HTML compacted into a single line to prevent pre-wrap from reading code indentation
                list.innerHTML = data.folders.map(f => {
                    const safePath = encodeURIComponent(f.path);
                    const displayName = f.rel_path || f.display_name;
                    return `<div class="watched-folder-item"><div style="display:flex; flex-direction:column; overflow:hidden; align-items:flex-start;"><span class="watched-folder-path" title="${f.path}" style="font-size:0.85rem; color:var(--primary-color);">${displayName}</span><span style="font-size:0.75rem; color:#666;">${f.recursive ? '↳ Recursive' : '⏹ Flat'}</span></div><button onclick="removeWatchedFolder('${safePath}')" class="delete-btn" style="padding:4px 8px; font-size:0.8rem; flex-shrink:0;">Stop</button></div>`;
                }).join('');
                
            } catch (e) { list.innerHTML = 'Error loading folders.'; }
        }

        // Accepts encoded path, then decodes it and sends it to the server
        async function removeWatchedFolder(encodedPath) {
            const fullPath = decodeURIComponent(encodedPath);

            // 1. Confirm Stop
            const stopConfirmed = await smartConfirm(
                "🚫 Stop Monitoring?", 
                `Stop monitoring this folder?\n\n${fullPath}`, 
                true
            );
            
            if (!stopConfirmed) return;

            // 2. Ask Wipe
            const wipeConfirmed = await smartConfirm(
                "🗑️ Reset Data?", 
                "Do you also want to RESET existing AI data for this folder?\n\nDelete = Wipe Data\nCancel = Keep Data", 
                true
            );

            try {
                const btn = document.activeElement;
                if (btn) btn.textContent = "...";

                const res = await fetch('/galleryout/ai_indexing/watched', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folder_path: fullPath,
                        reset_data: wipeConfirmed
                    })
                });

                const data = await res.json();

                if (data.status === 'success') {
                    showNotification("Folder removed.", "success");
                    await loadWatchedFolders();

                    // Update UI Instantly if possible
                    let treeNeedsUpdate = false;
                    for (const key in foldersData) {
                        const fdPath = foldersData[key].path.replace(/\\/g, '/').toLowerCase();
                        const remPath = fullPath.replace(/\\/g, '/').toLowerCase();

                        if (fdPath === remPath || fdPath.startsWith(remPath + '/')) {
                            foldersData[key].is_watched = false;
                            foldersData[key].is_explicitly_watched = false;
                            treeNeedsUpdate = true;
                        }
                    }

                    if (treeNeedsUpdate) {
                        renderAllTrees();
                    }
                } else {
                    showNotification(data.message || "Error removing folder", "error");
                    await loadWatchedFolders();
                }

            } catch (e) {
                handleError(e);
                loadWatchedFolders();
            }
        }
        
        // --- UPDATED: BATCH SELECTION HANDLER ---
        function indexSelectedFiles() {
            if (selectedFiles.size === 0) {
                showNotification("No files selected", "warning");
                return;
            }
            
            // Open the standard AI Options Modal but in "File Mode"
            // We set a special flag/state to know we are processing selected IDs
            pendingFolderKey = null; // Ensure folder mode is off
            
            const pathPreview = document.getElementById('ai-opt-path');
            if(pathPreview) pathPreview.textContent = `Target: ${selectedFiles.size} Selected Files`;
            
            // Hide Folder-specific options
            document.getElementById('ai-opt-recursive').parentElement.style.display = 'none';
            document.getElementById('ai-opt-watch').parentElement.style.display = 'none';
            // Show only relevant description
            document.querySelector('.ai-opt-desc').textContent = "Apply to selected files only.";
            
            document.getElementById('ai-options-modal').classList.add('visible');
        }
        
        function indexCurrentLightboxFile() {
            
            if (!currentLightboxFile || !currentLightboxFile.id) return;

            // 1. BLOCCO DEI DATI INIZIALI
            // Ci serve per capire se l'utente è ancora su questa immagine tra 10 secondi
            const targetFileId = currentLightboxFile.id; 
            const oldTimestamp = currentLightboxFile.ai_last_scanned || 0;
            
            // 2. Feedback Visivo
            const btn = document.getElementById('lightbox-index-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '⏳'; 
            btn.style.cursor = 'wait';
            btn.disabled = true;

            // Parametri
            let params = { force: false, beams: 3, precision: 'fp16' };
            try { params = getAiParams(); } catch(e) {}

            // 3. Invio richiesta
            fetch('/galleryout/ai_indexing/add_files', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    file_ids: [targetFileId],
                    force: true, 
                    beams: params.beams,
                    precision: params.precision
                })
            })
            .then(r => r.json())
            .then(d => {
                showNotification("Re-indexing started...", 'info');
                
                // 4. POLLING INTELLIGENTE (30 sec timeout)
                let attempts = 0;
                const maxAttempts = 30;
                
                const pollInterval = setInterval(() => {
                    attempts++;

                    // --- CHECK DI SICUREZZA ---
                    // Se l'utente ha chiuso il lightbox o ha cambiato immagine, smetti di rompere
                    if (!document.body.classList.contains('lightbox-open') || 
                        !currentLightboxFile || 
                        currentLightboxFile.id !== targetFileId) {
                        clearInterval(pollInterval);
                        return; 
                    }
                    // --------------------------
                    
                    fetch(`/galleryout/check_metadata/${targetFileId}`)
                        .then(res => res.json())
                        .then(meta => {
                            // Se il timestamp è NUOVO => LAVORO FINITO
                            if (meta.status === 'success' && (meta.ai_last_scanned > oldTimestamp)) {
                                clearInterval(pollInterval); // Stop polling
                                
                                // A. Aggiorna i dati in RAM (Coda globale)
                                const fileIndex = allFilesData.findIndex(f => f.id === targetFileId);
                                if (fileIndex !== -1) {
                                    allFilesData[fileIndex].ai_caption = meta.ai_caption;
                                    allFilesData[fileIndex].ai_last_scanned = meta.ai_last_scanned;
                                }
                                
                                // B. Aggiorna l'oggetto corrente del Lightbox
                                currentLightboxFile.ai_caption = meta.ai_caption;
                                currentLightboxFile.ai_last_scanned = meta.ai_last_scanned;
                                
                                // C. Aggiorna la toolbar (fa apparire l'icona cervello se mancava)
                                updateLightboxButtonsUI(meta.has_workflow, meta.ai_caption, targetFileId);
                                
                                // D. AZIONE AUTOMATICA: APRI/AGGIORNA LA CAPTION
                                // Passando 'true', questa funzione apre la finestra se chiusa,
                                // o aggiorna il testo se era già aperta.
                                toggleAiCaption(true, meta.ai_caption);
                                
                                // E. Reset UI
                                showNotification("⚡ Finished! Caption updated.", 'success');
                                btn.innerHTML = originalContent;
                                btn.disabled = false;
                                btn.style.cursor = 'pointer';
                            }
                        })
                        .catch(err => console.error("Polling error:", err));

                    // Timeout
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                        btn.style.cursor = 'pointer';
                        showNotification("Indexing takes longer than expected. Check AI Manager.", 'warning');
                    }
                }, 1000); 
            })
            .catch(err => {
                console.error("Lightbox Error:", err);
                showNotification("Error queuing image", "error");
                btn.innerHTML = originalContent;
                btn.disabled = false;
            });
        }
        
        async function resetAiDataCurrentLightbox() {
            if (!currentLightboxFile || !currentLightboxFile.id) return;

            const confirmed = await smartConfirm(
                "⚠️ Reset AI Data", 
                "Erase AI metadata (caption & embedding) for this image?\nThe file itself will NOT be deleted.", 
                true
            );
            
            if (!confirmed) return;

            const btn = document.getElementById('lightbox-reset-ai-btn');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = "⏳";
            btn.disabled = true;

            fetch('/galleryout/ai_indexing/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_ids: [currentLightboxFile.id] })
            })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    showNotification("AI Data erased.", "success");

                    // Update local data
                    currentLightboxFile.ai_caption = null;
                    currentLightboxFile.ai_last_scanned = 0;

                    const idx = allFilesData.findIndex(f => f.id === currentLightboxFile.id);
                    if (idx !== -1) {
                        allFilesData[idx].ai_caption = null;
                        allFilesData[idx].ai_last_scanned = 0;
                    }

                    updateLightboxButtonsUI(currentLightboxFile.has_workflow, null, currentLightboxFile.id);
                    toggleAiCaption(false);
                } else {
                    showNotification("Error: " + d.message, "error");
                }
            })
            .catch(handleError)
            .finally(() => {
                if (btn) {
                    btn.innerHTML = originalIcon;
                    btn.disabled = false;
                }
            });
        }
        
        // --- FOLDER MENU TOGGLE ---
        function toggleFolderMenu(btn) {
            // Close all other open menus first
            document.querySelectorAll('.folder-dropdown.show').forEach(el => {
                if (el !== btn.nextElementSibling) el.classList.remove('show');
            });
            
            const dropdown = btn.nextElementSibling;
            dropdown.classList.toggle('show');
        }

        // Close menu when clicking anywhere else
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.folder-menu-container')) {
                document.querySelectorAll('.folder-dropdown.show').forEach(el => el.classList.remove('show'));
            }
        });
        
        // --- SELECTION BAR MENU LOGIC ---
        function toggleSelMenu() {
            const menu = document.getElementById('sel-more-menu');
            menu.classList.toggle('show');
        }

        // --- COMPARE MODE CORE LOGIC (HYBRID IMAGE/VIDEO) ---

        // [NEW] Helper to format resolution string with MegaPixels
        function getResolutionString(file) {
            if (!file || !file.dimensions) return "";
            
            let result = file.dimensions; // Default: "1024x1024"
            
            const dims = file.dimensions.split('x');
            if (dims.length === 2) {
                const w = parseInt(dims[0]);
                const h = parseInt(dims[1]);
                if (!isNaN(w) && !isNaN(h)) {
                    // Formula: (Width * Height) / 1,000,000
                    const mp = (w * h) / 1000000;
                    // Show 1 decimal (e.g. "12.4 MP") or integer if exact
                    const mpFormatted = mp % 1 === 0 ? mp.toFixed(0) : mp.toFixed(1);
                    result += ` (${mpFormatted} MP)`;
                }
            }
            return result;
        }

        // [NEW] Show full details in notification when label is clicked
        function showCmpDetails(el) {
            if (el.dataset.fullInfo) {
                // Use 'path-msg' class for monospace font and word-wrapping
                showNotification(el.dataset.fullInfo, 'info path-msg', 5000);
            }
        }
        
        let cmpState = {
            active: false,
            zoom: 1, panX: 0, panY: 0,
            rotation: 0, // [NEW] Track rotation state
            isDraggingHandle: false,
            sliderPos: 50,
            fileA: null, fileB: null
        };

        function startCompareMode() {
            if (selectedFiles.size !== 2) return;
            const ids = Array.from(selectedFiles);
            
            const fileA = allFilesData.find(f => f.id === ids[0]);
            const fileB = allFilesData.find(f => f.id === ids[1]);
            
            if (!fileA || !fileB) return;
            
            cmpState.fileA = fileA;
            cmpState.fileB = fileB;
            cmpState.active = true;
            cmpState.zoom = 1; cmpState.panX = 0; cmpState.panY = 0;
            cmpState.rotation = 0; // Reset rotation
            cmpState.sliderPos = 50;

            // [NEW] Calculate Resolution Strings (e.g., "1024x1024 (1 MP)")
            const resA = getResolutionString(fileA);
            const resB = getResolutionString(fileB);

            // 1. Inject into Table Headers (Detailed Info with Filename)
            document.getElementById('cmp-header-a').textContent = `A: ${fileA.name}`;
            document.getElementById('cmp-header-a').title = `${fileA.name}\n${resA}`;
            
            document.getElementById('cmp-header-b').textContent = `B: ${fileB.name}`;
            document.getElementById('cmp-header-b').title = `${fileB.name}\n${resB}`;

            // 2. Setup Floating Labels
            const lblA = document.getElementById('cmp-label-a');
            const lblB = document.getElementById('cmp-label-b');
            
            // Visual Label (Short: "Image A · 1 MP ℹ")
            lblA.innerHTML = `Image A ${resA ? '· ' + resA : ''} <span style="opacity:0.7">ℹ</span>`;
            lblB.innerHTML = `Image B ${resB ? '· ' + resB : ''} <span style="opacity:0.7">ℹ</span>`;
            
            // Data for Notification (Full Details on click)
            lblA.dataset.fullInfo = `Image A\n\n📄 Name:\n${fileA.name}\n\n📐 Resolution:\n${resA || 'N/A'}`;
            lblB.dataset.fullInfo = `Image B\n\n📄 Name:\n${fileB.name}\n\n📐 Resolution:\n${resB || 'N/A'}`;

            document.getElementById('compare-overlay').classList.add('visible');
            document.body.classList.add('modal-open');

            // 1. Render Media (Dynamic: Video or Image)
            const elA = renderCmpMedia(fileA, 'cmp-container-a', 'cmp-media-a');
            const elB = renderCmpMedia(fileB, 'cmp-container-b', 'cmp-media-b');
            
            // 2. Setup Video Sync
            if (fileA.type === 'video' && fileB.type === 'video') {
                setupVideoSync(elA, elB);
            }

            updateCmpTransform();
            updateCmpSlider();
            loadCmpDiffData(fileA.id, fileB.id);
        }

        function closeCompareMode() {
            document.getElementById('compare-overlay').classList.remove('visible');
            document.body.classList.remove('modal-open');
            cmpState.active = false;
            // Clear containers to stop videos
            document.getElementById('cmp-container-a').innerHTML = '';
            document.getElementById('cmp-container-b').innerHTML = '';
        }

        // Helper: Creates <img> or <video> dynamically
        function renderCmpMedia(file, containerId, elementId) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 
            
            let el;
            if (file.type === 'video') {
                el = document.createElement('video');
                el.src = `/galleryout/stream/${file.id}`;
                el.loop = true; el.autoplay = true; el.muted = true; el.playsInline = true;
                el.controls = false;
            } else {
                el = document.createElement('img');
                el.src = `/galleryout/file/${file.id}`;
            }
            
            el.id = elementId;
            el.className = 'cmp-content';
            el.draggable = false;
            container.appendChild(el);
            return el;
        }

        // Helper: Syncs Play/Pause/Seek
        function setupVideoSync(vidA, vidB) {
            let isSyncing = false;
            const sync = (source, target) => {
                if (isSyncing) return;
                isSyncing = true;
                
                if (!source.paused && target.paused) target.play();
                if (source.paused && !target.paused) target.pause();
                
                if (Math.abs(source.currentTime - target.currentTime) > 0.1) {
                    target.currentTime = source.currentTime;
                }
                isSyncing = false;
            };

            ['play', 'pause', 'seeking', 'seeked', 'timeupdate'].forEach(evt => vidA.addEventListener(evt, () => sync(vidA, vidB)));
            ['play', 'pause', 'seeking', 'seeked'].forEach(evt => vidB.addEventListener(evt, () => sync(vidB, vidA)));
            
            // Double Click to toggle play/pause
            const stage = document.getElementById('compare-stage');
            stage.ondblclick = (e) => {
                if(e.target.id === 'cmp-handle') return;
                if (vidA.paused) vidA.play(); else vidA.pause();
            };
        }

        function updateCmpTransform() {
            // [UPDATED] Apply Rotation logic
            const transform = `translate(${cmpState.panX}px, ${cmpState.panY}px) scale(${cmpState.zoom}) rotate(${cmpState.rotation}deg)`;
            const elA = document.getElementById('cmp-media-a');
            const elB = document.getElementById('cmp-media-b');
            if(elA) elA.style.transform = transform;
            if(elB) elB.style.transform = transform;
        }

        function updateCmpSlider() {
            const pct = cmpState.sliderPos;
            document.getElementById('cmp-after-wrapper').style.clipPath = `inset(0 ${100 - pct}% 0 0)`;
            document.getElementById('cmp-handle').style.left = `${pct}%`;
        }
        
        // Continuous Rotation Cycle (0 -> 90 -> 180 -> 270 -> 0)
        function cmpRotate() {
            // Add 90 degrees and wrap around at 360
            cmpState.rotation = (cmpState.rotation + 90) % 360;
            updateCmpTransform();
        }

        // Helper for Buttons and Keyboard
        function cmpZoom(amount) {
            const newZoom = cmpState.zoom + amount;
            // Clamp zoom level between 0.1x and 20x
            cmpState.zoom = Math.max(0.1, Math.min(20, newZoom));
            updateCmpTransform();
        }
        
        function cmpResetZoom() {
            cmpState.zoom = 1; cmpState.panX = 0; cmpState.panY = 0;
            cmpState.rotation = 0; // Reset rotation
            updateCmpTransform();
        }

        // --- EVENTS: Slider & Pan/Zoom ---
        const cmpStage = document.getElementById('compare-stage');
        const cmpHandle = document.getElementById('cmp-handle');
        
        const onSliderMove = (clientX) => {
            const rect = cmpStage.getBoundingClientRect();
            let pct = ((clientX - rect.left) / rect.width) * 100;
            cmpState.sliderPos = Math.max(0, Math.min(100, pct));
            updateCmpSlider();
        };

        cmpHandle.addEventListener('mousedown', () => cmpState.isDraggingHandle = true);
        cmpHandle.addEventListener('touchstart', () => cmpState.isDraggingHandle = true, {passive: false});
        window.addEventListener('mouseup', () => cmpState.isDraggingHandle = false);
        window.addEventListener('touchend', () => cmpState.isDraggingHandle = false);

        window.addEventListener('mousemove', (e) => {
            if (cmpState.isDraggingHandle) { e.preventDefault(); onSliderMove(e.clientX); }
        });
        window.addEventListener('touchmove', (e) => {
            if (cmpState.isDraggingHandle) { e.preventDefault(); onSliderMove(e.touches[0].clientX); }
        }, {passive: false});

        // Pan/Zoom Wheel
        cmpStage.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.ctrlKey) {
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                cmpState.zoom = Math.max(0.1, Math.min(20, cmpState.zoom * delta));
            } else {
                cmpState.panX -= e.deltaX; cmpState.panY -= e.deltaY;
            }
            updateCmpTransform();
        }, {passive: false});

        // Pan Drag
        let isCmpPanning = false;
        let cmpStartPanX = 0, cmpStartPanY = 0;

        cmpStage.addEventListener('mousedown', (e) => {
            if (e.target === cmpHandle) return;
            isCmpPanning = true;
            cmpStartPanX = e.clientX - cmpState.panX;
            cmpStartPanY = e.clientY - cmpState.panY;
            cmpStage.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (isCmpPanning) {
                e.preventDefault();
                cmpState.panX = e.clientX - cmpStartPanX;
                cmpState.panY = e.clientY - cmpStartPanY;
                updateCmpTransform();
            }
        });

        window.addEventListener('mouseup', () => {
            isCmpPanning = false;
            cmpStage.style.cursor = 'grab';
        });

        // --- INFO PANEL LOGIC ---
        function toggleCmpInfo() {
            const panel = document.getElementById('compare-info-panel');
            panel.classList.toggle('collapsed');
            document.getElementById('cmp-toggle-icon').style.transform = panel.classList.contains('collapsed') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        async function loadCmpDiffData(idA, idB) {
            const tbody = document.getElementById('cmp-table-body');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">⏳ Analyzing...</td></tr>';
            try {
                const res = await fetch('/galleryout/api/compare_files', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id_a: idA, id_b: idB })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    tbody.innerHTML = '';
                    if (data.diff.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No workflow data found.</td></tr>';
                        return;
                    }
                    data.diff.forEach(row => {
                        const tr = document.createElement('tr');
                        if (row.is_diff) tr.className = 'cmp-row-diff';
                        tr.innerHTML = `<td>${row.key}</td><td>${row.val_a || '-'}</td><td>${row.val_b || '-'}</td>`;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color)">Error: ${data.message}</td></tr>`;
                }
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="3" style="color:var(--danger-color)">Network Error</td></tr>`;
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('sel-more-menu');
            const btn = document.querySelector('.sel-btn[onclick="toggleSelMenu()"]');
            
            if (menu && menu.classList.contains('show')) {
                if (!menu.contains(e.target) && e.target !== btn) {
                    menu.classList.remove('show');
                }
            }
        });
        
        // Auto-close menu after clicking an action inside it
        document.getElementById('sel-more-menu').addEventListener('click', () => {
             document.getElementById('sel-more-menu').classList.remove('show');
        });
        

        // --- STORYBOARD LOGIC (Updated with Navigation) ---
        let currentStoryboardFile = null;
        let currentSbFrames = []; // Store the URLs for navigation
        let currentSbZoomIndex = 0; // Track current index

        async function openStoryboard(fileId) {
            // ... (Questa parte rimane identica alla precedente fino al fetch) ...
            // Context resolution (Grid or Lightbox)
            let file = null;
            if (fileId) {
                file = allFilesData.find(f => f.id === fileId);
            } else if (currentLightboxFile) {
                file = currentLightboxFile;
            } else if (focusedItemIndex !== -1) {
                file = allFilesData.find(f => f.id === galleryItems[focusedItemIndex].dataset.fileId);
            }

            if (!file) return;
            if (!['video', 'animated_image'].includes(file.type)) {
                showNotification("Storyboard available for Videos/Animations only.", "warning");
                return;
            }

            currentStoryboardFile = file;
            const overlay = document.getElementById('storyboard-overlay');
            const grid = document.getElementById('sb-grid');
            const loader = document.getElementById('sb-loader');
            
            overlay.classList.add('visible');
            // document.body.classList.add('modal-open'); // Already handled globally often
            
            grid.innerHTML = '';
            loader.style.display = 'flex';
            
            try {
                const response = await fetch(`/galleryout/storyboard/${file.id}`);
                const data = await response.json();
                
                loader.style.display = 'none';
                
                if (data.status === 'success' && data.frames) {
                    // NEW: Store frames globally
                    currentSbFrames = data.frames;
                    renderStoryboardGrid(data.frames);
                } else {
                    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--danger-color); padding:20px;">Error: ${data.message}</div>`;
                }
            } catch (e) {
                loader.style.display = 'none';
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--danger-color);">Network Error</div>`;
            }
        }

        function renderStoryboardGrid(imageUrls) {
            const grid = document.getElementById('sb-grid');
            
            imageUrls.forEach((url, index) => {
                const div = document.createElement('div');
                div.className = 'sb-frame';
                
                const img = document.createElement('img');
                img.src = url;
                img.loading = "lazy";
                
                // CLICK ACTION: Pass index instead of just URL
                div.onclick = (e) => {
                    e.stopPropagation();
                    openSbZoom(index);
                };
                
                div.appendChild(img);
                grid.appendChild(div);
            });
        }

        // --- ZOOM & NAVIGATION LOGIC ---
        
        function openSbZoom(index) {
            if (index < 0 || index >= currentSbFrames.length) return;
            
            currentSbZoomIndex = index;
            const url = currentSbFrames[index];
            const total = currentSbFrames.length;
            
            const overlay = document.getElementById('sb-zoom-overlay');
            const img = document.getElementById('sb-zoom-img');
            const statusBadge = document.getElementById('sb-zoom-status');
            
            // Update Image
            img.src = url;
            
            // Update Status Badge Logic
            statusBadge.className = ''; // Reset classes
            let statusText = `${index + 1} / ${total}`;
            
            if (index === 0) {
                statusText = `START • ${statusText}`;
                statusBadge.classList.add('is-first'); // Green
            } else if (index === total - 1) {
                statusText = `${statusText} • END`;
                statusBadge.classList.add('is-last'); // Red
            }
            
            statusBadge.textContent = statusText;
            
            overlay.style.display = 'flex';
        }

        function navigateSbZoom(direction) {
            if (currentSbFrames.length === 0) return;
            
            // Calculate new index with wrap-around
            let newIndex = currentSbZoomIndex + direction;
            if (newIndex < 0) newIndex = currentSbFrames.length - 1;
            if (newIndex >= currentSbFrames.length) newIndex = 0;
            
            openSbZoom(newIndex);
        }

        function closeSbZoom() {
            document.getElementById('sb-zoom-overlay').style.display = 'none';
        }

        function closeStoryboard() {
            document.getElementById('storyboard-overlay').classList.remove('visible');
            // Remove modal-open only if Lightbox isn't active
            if (!document.body.classList.contains('lightbox-open')) {
                document.body.classList.remove('modal-open');
                // Ensure the focused item is visible when returning to grid
                if (focusedItemIndex !== -1 && galleryItems[focusedItemIndex]) {
                    galleryItems[focusedItemIndex].scrollIntoView({ behavior: 'auto', block: 'nearest' });
                }
            }
        }
        
        // Background click close
        document.getElementById('storyboard-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'storyboard-overlay') closeStoryboard();
        });

    </script>
</body>
</html>