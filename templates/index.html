<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGallery: {{ current_folder_info.display_name }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='galleryout/favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
    
    <!-- Alpine.js Core + Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0a0a0a; --surface-color: #1a1a1a; --surface-hover: #252525;
            --primary-color: #007bff; --primary-hover: #0056b3; --text-color: #f8f9fa;
            --text-muted: #adb5bd; --border-color: #343a40; --danger-color: #dc3545;
            --danger-hover: #c82333; --favorite-color: #ffc107; --workflow-color: #28a745;
            --success-color: #20c997; --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass-bg: rgba(255, 255, 255, 0.05); --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1); --shadow-md: 0 4px 12px rgba(0,0,0,0.2);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.3);
            --sidebar-width: 320px;
        }
        * { box-sizing: border-box; }
        
        /* Accessibility: Focus States */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); line-height: 1.6; display: flex; min-height: 100vh; }
        body.lightbox-open, body.modal-open { overflow: hidden; }
        
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        .notification { background-color: var(--surface-color); color: var(--text-color); padding: 12px 20px; border-radius: 8px; box-shadow: var(--shadow-lg); border-left: 5px solid var(--primary-color); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); font-weight: 600; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: var(--success-color); color: white; border-color: #1a9c77; }
        .notification.error { background-color: var(--danger-color); color: white; border-color: #b32a38; }
        .notification.warning { background-color: var(--favorite-color); color: #000; border-color: #d39e00;}
        .notification.info { background-color: var(--primary-color); color: white; border-color: #0056b3; }

        .sidebar { width: var(--sidebar-width); min-width: var(--sidebar-width); background: var(--surface-color); border-right: 1px solid var(--border-color); padding: 1.5rem; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; transition: min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        body.sidebar-expanded .sidebar { min-width: 600px; }
        .main-content { flex-grow: 1; padding-bottom: 80px; transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);}
        .sidebar-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-shrink: 0;}
        .sidebar-header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        #sidebar-toggle-btn { display: none; background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; align-items: center; gap: 0.5rem; }
        .folder-controls { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; flex-shrink: 0;}
        .folder-search-input { width: 100%; background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--glass-border); border-radius: 8px; padding: 0.5rem 0.75rem; font-size: 0.9rem; }
        .folder-sort-buttons { display: flex; gap: 0.5rem; }
        .folder-sort-buttons button { flex-grow: 1; background: var(--surface-hover); color: var(--text-muted); border: 1px solid var(--glass-border); padding: 0.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .folder-sort-buttons button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .sidebar-actions { display: flex; gap: 0.5rem; align-items: center; }
        .sidebar-actions button { background: none; border: 1px solid var(--glass-border); color: var(--text-color); border-radius: 8px; padding: 0.5rem 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; }
        .sidebar-actions button:hover { background: var(--surface-color); border-color: var(--primary-color); }
        .folder-tree-container { flex-grow: 1; overflow-y: auto; min-height: 0; }
        .folder-tree, .folder-tree ul { list-style: none; padding: 0; margin: 0; }
        .folder-tree li { padding-left: 20px; position: relative; }
        .folder-tree > li:first-child { padding-left: 0; }
        .folder-item { display: flex; align-items: center; padding: 8px; border-radius: 8px; transition: background-color 0.2s; position: relative; }
        .folder-item:hover { background-color: var(--surface-hover); }
        .folder-item.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .toggle-btn { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; line-height: 1; user-select: none; }
        .toggle-btn.empty { visibility: hidden; }
        .folder-link { flex-grow: 1; text-decoration: none; color: inherit; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 25px; cursor: pointer; }
        .folder-actions { margin-left: auto; display: flex; opacity: 1; }
        .folder-action-btn { background: none; border: none; color: inherit; cursor: pointer; padding: 4px; border-radius: 4px; font-size: 0.9rem; }
        .folder-action-btn:hover { background-color: rgba(255,255,255,0.15); }
        .folder-tree li.collapsed > ul { display: none; }
        .folder-tree li.is-hidden { display: none; }
        .folder-tree li:not(.collapsed) > .folder-item > .toggle-btn::before { content: '▾'; }
        .folder-tree li.collapsed > .folder-item > .toggle-btn::before { content: '▸'; }
        .folder-tree li.no-children > .folder-item > .toggle-btn { visibility: hidden; }
        #create-folder-btn { width: 100%; background: var(--gradient-secondary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s; box-shadow: var(--shadow-sm); margin-top: 1.5rem; flex-shrink: 0;}
        #create-folder-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .breadcrumbs { display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 1rem 2rem; background: var(--surface-color); border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .breadcrumb-links { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; overflow: hidden; flex-grow: 1; }
        .breadcrumb-links a, .breadcrumb-links span { color: var(--text-muted); text-decoration: none; font-weight: 500; white-space: nowrap; }
        .breadcrumb-links a:hover { color: var(--text-color); }
        .breadcrumb-links span:last-child { color: var(--text-color); font-weight: 700; text-overflow: ellipsis; overflow: hidden; }
        .gallery-sort-controls { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .gallery-sort-controls .sort-btn { flex-shrink: 0; padding: 0.5rem 1rem; font-size: 0.85rem; background: var(--surface-hover); color: var(--text-color); font-weight: 600; text-decoration: none; border-radius: 8px; border: 1px solid var(--glass-border); transition: all 0.3s; }
        .gallery-sort-controls .sort-btn:hover { background: var(--surface-color); }
        .gallery-sort-controls .sort-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color);}
        
        /* Results Count Indicator */
        .results-count { 
            padding: 0.5rem 1rem; 
            background: var(--glass-background); 
            border: 1px solid var(--glass-border); 
            border-radius: 8px; 
            font-size: 0.85rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }
        .results-count .count-label { display: inline-block; }
        .results-count strong { color: var(--text-color); font-weight: 700; }
        
        .filter-bar { padding: 1.5rem 2rem; }
        .filter-bar form { display: flex; flex-direction: column; gap: 1.5rem; }
        
        /* Modern Filter Panel Styles */
        #filter-panel { position: fixed; top: 0; right: 0; width: 450px; height: 100vh; background: var(--surface-color); border-left: 1px solid var(--border-color); transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; display: flex; flex-direction: column; box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5); }
        #filter-panel.open { transform: translateX(0); }
        #filter-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1999; }
        #filter-backdrop.visible { opacity: 1; pointer-events: auto; }
        
        .filter-panel-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); background: var(--gradient-primary); color: white; flex-shrink: 0; position: sticky; top: 0; z-index: 10; }
        .filter-panel-header h2 { margin: 0; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .filter-panel-header h2 .filter-count-badge { background: rgba(255, 255, 255, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; min-width: 24px; text-align: center; }
        #filter-close-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 0.5rem; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.3s; }
        #filter-close-btn:hover { background: rgba(255, 255, 255, 0.2); transform: rotate(90deg); }
        
        .filter-panel-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .filter-panel-content::-webkit-scrollbar { width: 8px; }
        .filter-panel-content::-webkit-scrollbar-track { background: var(--surface-hover); border-radius: 4px; }
        .filter-panel-content::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .filter-panel-content::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        .filter-form-grid { display: flex; flex-direction: column; gap: 1.5rem; }
        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem;  /* Modern gap property replaces label margin-bottom */
        }
        
        /* Filter Form Controls - applies to both .filter-bar and .filter-panel-content */
        .filter-bar label, .filter-panel-content label { 
            font-weight: 600; 
            color: var(--text-muted); 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            display: block;
        }
        .filter-bar select, .filter-bar input[type="text"], .filter-bar input[type="number"], .filter-bar button, .filter-bar a,
        .filter-panel-content select, .filter-panel-content input[type="text"], .filter-panel-content input[type="number"], .filter-panel-footer button, .filter-panel-footer a { 
            background: var(--glass-bg); 
            color: var(--text-color); 
            border: 1px solid var(--glass-border); 
            border-radius: 8px; 
            padding: 0.75rem 1rem; 
            font-size: 0.9rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            backdrop-filter: blur(10px);
            font-family: inherit;
        }
        .filter-bar input[type="text"]::placeholder,
        .filter-panel-content input[type="text"]::placeholder {
            color: var(--text-muted);
            opacity: 0.5;
        }
        .filter-bar select[multiple], .filter-panel-content select[multiple] { 
            min-height: 120px; 
            padding: 0.5rem;
        }
        .filter-bar select[multiple] option,
        .filter-panel-content select[multiple] option {
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 2px;
        }
        .filter-bar select[multiple] option:checked,
        .filter-panel-content select[multiple] option:checked {
            background: var(--primary-color) linear-gradient(0deg, var(--primary-color) 0%, var(--primary-color) 100%);
            color: white;
            font-weight: 600;
        }
        .filter-bar input[type="text"]:focus, .filter-bar input[type="number"]:focus, .filter-bar select:focus,
        .filter-panel-content input[type="text"]:focus, .filter-panel-content input[type="number"]:focus, .filter-panel-content select:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
            background: rgba(0, 123, 255, 0.05);
        }
        .filter-bar input[type="text"]:hover, .filter-bar input[type="number"]:hover, .filter-bar select:hover,
        .filter-panel-content input[type="text"]:hover, .filter-panel-content input[type="number"]:hover, .filter-panel-content select:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.03);
        }
        .filter-bar input[type="number"], .filter-panel-content input[type="number"] { 
            font-variant-numeric: tabular-nums; 
            font-family: 'SF Mono', 'Monaco', 'Consolas', 'Courier New', monospace;
            letter-spacing: 0.5px;
        }
        .filter-bar input[type="number"]::-webkit-inner-spin-button, .filter-bar input[type="number"]::-webkit-outer-spin-button,
        .filter-panel-content input[type="number"]::-webkit-inner-spin-button, .filter-panel-content input[type="number"]::-webkit-outer-spin-button { 
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .filter-bar input[type="number"]:hover::-webkit-inner-spin-button, .filter-bar input[type="number"]:hover::-webkit-outer-spin-button,
        .filter-panel-content input[type="number"]:hover::-webkit-inner-spin-button, .filter-panel-content input[type="number"]:hover::-webkit-outer-spin-button { 
            opacity: 1; 
        }
        .filter-bar button, .filter-panel-footer button { background: var(--primary-color); cursor: pointer; font-weight: 600; color: white; border: 1px solid var(--primary-color); }
        .filter-bar button:hover, .filter-panel-footer button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button.refresh-btn { background: var(--workflow-color); border-color: var(--workflow-color); }
        .filter-bar a, .filter-panel-footer a { text-decoration: none; text-align: center; color: var(--text-muted); }
        .filter-bar a:hover, .filter-panel-footer a:hover { background: var(--surface-hover); color: var(--text-color); }
        .filter-group-inline { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            margin-bottom: 0;  /* No extra margin, gap handles spacing */
        }
        .filter-group-inline input[type="checkbox"] { 
            width: 18px; 
            height: 18px; 
            accent-color: var(--primary-color); 
            flex-shrink: 0;  /* Prevent checkbox from shrinking */
        }
        .filter-group-inline label {
            /* Make checkbox labels consistent with other labels */
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0;  /* Override default label margin */
        }
        
        /* Filter Toggle Button in Header */
        #filter-toggle-btn { position: relative; background: var(--gradient-primary); color: white; border: none; padding: 0.65rem 1.25rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: var(--shadow-sm); }
        #filter-toggle-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        #filter-toggle-btn .filter-icon { font-size: 1.1rem; transition: transform 0.3s; }
        #filter-toggle-btn.active .filter-icon { transform: rotate(180deg); }
        #filter-toggle-btn .active-count-badge { position: absolute; top: -6px; right: -6px; background: var(--danger-color); color: white; border-radius: 50%; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; padding: 0 6px; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4); animation: pulse-badge 2s infinite; }
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        /* Active Filter Pills */
        .active-filters-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem 1rem; background: rgba(0, 123, 255, 0.05); border-radius: 8px; margin-bottom: 1.5rem; }
        .active-filters-container:empty { display: none; }
        .active-filter-pill { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--primary-color); color: white; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .active-filter-pill:hover { background: var(--primary-hover); transform: scale(1.05); }
        .active-filter-pill .remove-icon { font-size: 1rem; font-weight: 700; }
        #clear-all-filters-btn { background: var(--danger-color); color: white; border: none; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        #clear-all-filters-btn:hover { background: var(--danger-hover); }
        
        /* Workflow Metadata Section */
        .workflow-filters-section { display: contents; }
        .workflow-section-header { 
            margin: 1.5rem 0 1rem 0;  /* Consistent top margin with grid gap */
            padding: 0.75rem 1rem; 
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 50%, transparent 100%); 
            border-left: 3px solid var(--workflow-color); 
            border-radius: 6px; 
        }
        .workflow-section-header h3 { 
            margin: 0; 
            font-size: 0.95rem; 
            font-weight: 700; 
            color: var(--workflow-color); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        
        /* Range Filter Pairs */
        .filter-range-pair { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 0.75rem;
            /* Visual grouping for min/max pairs */
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            position: relative;
        }
        .filter-range-pair .filter-group { position: relative; }
        .filter-range-pair .filter-group:first-child::after { 
            content: '↔'; 
            position: absolute; 
            right: -0.5rem; 
            top: 50%; 
            transform: translateY(-50%) translateY(0.5rem); 
            color: var(--text-color); 
            font-size: 1.2rem; 
            font-weight: 700; 
            opacity: 0.4; 
            z-index: 1; 
            pointer-events: none; 
        }
        .filter-range-pair .filter-group label { color: var(--text-muted); }
        .filter-range-pair .filter-group:first-child label { 
            color: var(--success-color); 
            font-weight: 700;
        }
        .filter-range-pair .filter-group:last-child label { 
            color: var(--danger-color); 
            font-weight: 700;
        }
        
        /* Dimension Filters - Unified with Range Pair Styling */
        .dimension-filters { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem 0.75rem;  /* row-gap column-gap */
            padding: 1rem; 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            border-radius: 8px;
        }
        .dimension-filters .filter-group label { 
            font-size: 0.85rem;  /* Match standard label size */
            display: flex; 
            align-items: center; 
            gap: 0.4rem; 
        }
        .dimension-filters .filter-group input { 
            background: var(--surface-color); 
            border-color: rgba(255, 255, 255, 0.08);  /* Slightly more visible */
        }
        
        /* Panel Footer Actions */
        .filter-panel-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); background: var(--surface-hover); display: flex; gap: 0.75rem; flex-shrink: 0; }
        .filter-panel-footer button { flex: 1; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 0.95rem; }
        .filter-panel-footer a { flex: 0.5; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; }
        .filter-actions-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .filter-actions-row > a, .filter-actions-row > button { display: inline-flex; align-items: center; justify-content: center; }
        .filter-actions-row button[type="submit"] { padding-left: 0.8rem; padding-right: 0.8rem; }
        .mobile-actions-row { display: flex; gap: 0.75rem; }
        .mobile-actions-row > * { flex-grow: 1; text-align: center; justify-content: center; }
        .mobile-actions-row button { padding-left: 0.8rem; padding-right: 0.8rem; }
        
        /* Tom-Select Multi-Select Dropdown Styling */
        .ts-wrapper { width: 100%; }
        .ts-control { 
            background: var(--glass-bg) !important; 
            border: 1px solid var(--glass-border) !important; 
            border-radius: 8px !important; 
            backdrop-filter: blur(10px) !important; 
            padding: 0.5rem !important;
            min-height: 42px !important;
        }
        .ts-control, .ts-control input { 
            color: var(--text-color) !important; 
            font-size: 0.9rem !important;
        }
        .ts-control input::placeholder {
            color: var(--text-muted) !important;
            opacity: 0.6 !important;
        }
        
        /* Tom-Select Dropdown Menu */
        .ts-dropdown { 
            background: var(--surface-color) !important; 
            border: 1px solid var(--border-color) !important; 
            border-radius: 8px !important; 
            box-shadow: var(--shadow-lg) !important;
            margin-top: 4px !important;
            z-index: 1000 !important;
        }
        .ts-dropdown-content { 
            background: var(--surface-color) !important;
            color: var(--text-color) !important;
            max-height: 240px !important;
        }
        
        /* Tom-Select Options */
        .ts-dropdown .option, .ts-dropdown .optgroup-header, .ts-dropdown .no-results, .ts-dropdown .create {
            background: var(--surface-color) !important;
            color: var(--text-color) !important;
            padding: 0.65rem 0.85rem !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        .ts-dropdown .option:hover, .ts-dropdown .option.active {
            background: var(--surface-hover) !important;
            color: var(--text-color) !important;
        }
        .ts-dropdown .option.selected {
            background: rgba(0, 123, 255, 0.15) !important;
            color: var(--primary-color) !important;
            font-weight: 600 !important;
        }
        .ts-dropdown .option.selected:hover {
            background: rgba(0, 123, 255, 0.25) !important;
        }
        
        /* Tom-Select Selected Items (Pills) */
        .ts-control .item {
            background: var(--primary-color) !important;
            color: white !important;
            border: none !important;
            border-radius: 16px !important;
            padding: 0.35rem 0.65rem !important;
            margin: 0.15rem 0.25rem 0.15rem 0 !important;
            font-size: 0.85rem !important;
            font-weight: 600 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.4rem !important;
        }
        .ts-control .item .remove {
            color: rgba(255, 255, 255, 0.8) !important;
            border: none !important;
            padding: 0 !important;
            margin-left: 0.25rem !important;
            font-size: 1rem !important;
            font-weight: 700 !important;
            opacity: 0.8 !important;
        }
        .ts-control .item .remove:hover {
            background: none !important;
            color: white !important;
            opacity: 1 !important;
        }
        
        /* Tom-Select Focus State */
        .ts-wrapper.focus .ts-control {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1) !important;
        }
        
        /* Tom-Select Optgroup Headers */
        .ts-dropdown .optgroup-header {
            background: var(--surface-hover) !important;
            color: var(--text-muted) !important;
            font-weight: 700 !important;
            font-size: 0.8rem !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            padding: 0.5rem 0.85rem !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 1 !important;
        }
        
        /* Tom-Select No Results */
        .ts-dropdown .no-results {
            color: var(--text-muted) !important;
            font-style: italic !important;
        }
        
        #gallery-anchor { display: block; position: relative; top: -20px; visibility: hidden; }
        .gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; padding: 2rem; min-height: 50vh; }
        .gallery-item { background: var(--glass-bg); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; position: relative; border: 2px solid transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
        .gallery-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .gallery-item.selected { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2); }
        .selection-checkmark { position: absolute; bottom: 12px; right: 12px; width: 24px; height: 24px; background: rgba(0,0,0,0.6); border: 2px solid var(--text-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 11; transition: all 0.3s; color: transparent; cursor: pointer; font-size: 12px; backdrop-filter: blur(10px); }
        .gallery-item.selected .selection-checkmark { background: var(--primary-color); border-color: var(--primary-color); color: white; transform: scale(1.1); }
        .thumbnail-link { cursor: pointer; }
        .thumbnail-wrapper { position: relative; width: 100%; background: var(--surface-color); overflow: hidden; }
        .thumbnail-wrapper img, .thumbnail-wrapper video { display: block; width: 100%; height: auto; transition: transform 0.3s; }
        .gallery-item:hover .thumbnail-wrapper img, .gallery-item:hover .thumbnail-wrapper video { transform: scale(1.05); }
        .item-info { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; padding-bottom: 48px; }
        .item-info p { margin: 0; word-wrap: break-word; font-size: 0.95rem; font-weight: 500; line-height: 1.4; margin-bottom: 0.75rem; }
        .file-metadata { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; flex-wrap: wrap; gap: 0.25rem 0.75rem; }
        .file-metadata span { display: inline-flex; align-items: center; gap: 0.3rem; }
        .item-actions { display: flex; gap: 0.75rem; margin-top: auto; flex-wrap: wrap; }
        .item-actions a, .item-actions button { display: inline-flex; align-items: center; justify-content: center; text-decoration: none; background: var(--glass-bg); color: var(--text-color); padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.8rem; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.3s; font-weight: 500; backdrop-filter: blur(10px); }
        .item-actions .delete-btn { background: var(--danger-color); border-color: var(--danger-color); color: white; }
        .favorite-btn.favorited { background: var(--favorite-color); color: #000; border-color: var(--favorite-color); }
        .duration-overlay { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 500; backdrop-filter: blur(10px); z-index: 10; }
        .workflow-badge { position: absolute; top: 8px; left: 8px; background: var(--workflow-color); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; text-decoration: none; font-weight: 600; transition: all 0.3s; }
        .workflow-badge:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4); }
        .workflow-badge[data-sampler-count="2"],
        .workflow-badge[data-sampler-count="3"] { background: linear-gradient(135deg, var(--workflow-color) 0%, #3498db 100%); }
        .workflow-badge[data-sampler-count="4"],
        .workflow-badge[data-sampler-count="5"] { background: linear-gradient(135deg, #3498db 0%, #9b59b6 100%); }
        .workflow-badge[data-sampler-count="6"],
        .workflow-badge[data-sampler-count="7"],
        .workflow-badge[data-sampler-count="8"],
        .workflow-badge[data-sampler-count="9"] { background: linear-gradient(135deg, #9b59b6 0%, #e74c3c 100%); }
        /* Sampler Panel Styles */
        .lightbox-sampler-panel { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 800px; z-index: 2003; background: rgba(0, 0, 0, 0.85); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(20px); overflow: hidden; }
        .sampler-toggle-btn { width: 100%; padding: 1rem 1.5rem; background: transparent; border: none; color: white; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.3s; }
        .sampler-toggle-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .toggle-icon { font-size: 0.9rem; transition: transform 0.3s; }
        .sampler-toggle-btn.expanded .toggle-icon { transform: rotate(180deg); }
        .sampler-badge { margin-left: auto; background: var(--primary-color); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; }
        .sampler-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 0 1.5rem; }
        .sampler-content.expanded { max-height: min(500px, calc(100vh - 250px)); overflow-y: auto; padding: 0 1.5rem 1.5rem; }
        .sampler-item { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
        .sampler-item:last-child { margin-bottom: 0; }
        .sampler-header { font-size: 1.1rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .sampler-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; }
        .sampler-field { display: flex; flex-direction: column; gap: 0.25rem; }
        .sampler-field-label { font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); text-transform: uppercase; letter-spacing: 0.5px; }
        .sampler-field-value { font-size: 1rem; color: white; font-weight: 500; font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.3); padding: 0.4rem 0.6rem; border-radius: 4px; }
        .sampler-prompts { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .sampler-prompt-label { font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.4rem; font-weight: 600; }
        .sampler-prompt-text { font-size: 0.85rem; color: rgba(255, 255, 255, 0.9); background: rgba(0, 0, 0, 0.3); padding: 0.6rem; border-radius: 4px; line-height: 1.5; max-height: 100px; overflow-y: auto; }
        .sampler-loader { padding: 2rem; text-align: center; color: rgba(255, 255, 255, 0.6); }
        .sampler-error { padding: 1rem; color: var(--danger-color); text-align: center; }
        #selection-bar { position: fixed; bottom: 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); left: 320px; right: 0; background: var(--glass-bg); border-top: 1px solid var(--glass-border); padding: 1.5rem; display: flex; align-items: center; gap: 1rem; z-index: 1001; box-sizing: border-box; backdrop-filter: blur(20px); flex-wrap: wrap; }
        body.sidebar-expanded #selection-bar { left: 600px; }
        #selection-bar.visible { transform: translateY(0); }
        #selection-bar button { padding: 0.75rem 1.5rem; font-size: 0.9rem; border-radius: 8px; border: none; background: var(--primary-color); color: white; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        #selection-bar .delete-btn { background: var(--danger-color); }
        #selection-counter { font-weight: 700; margin-right: auto; padding-left: 1rem; color: var(--primary-color); }
        #drag-drop-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 1002; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        #drag-drop-overlay.visible { display: block; opacity: 1; }
        #drop-zone-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; z-index: 1003; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow-lg); display: none; flex-direction: column; max-height: 80vh; }
        #drop-zone-panel.visible { display: flex; }
        #drop-zone-panel h3 { margin: 0; padding: 1rem 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); font-weight: 600; flex-shrink: 0;}
        #drop-zone-folders { overflow-y: auto; display: flex; flex-direction: column; padding: 0; min-height: 0; flex-grow: 1; }
        #cancel-drop-btn { background: var(--danger-color); color: white; border: none; padding: 1rem; cursor: pointer; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; font-weight: 600; transition: background-color 0.3s; flex-shrink: 0;}
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.4s; }
        .loader { border: 4px solid var(--surface-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 48px; height: 48px; animation: spin 1.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #lightbox-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #lightbox-overlay.visible { opacity: 1; pointer-events: auto; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 60px; height: 60px; font-size: 1.8rem; cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); z-index: 2001; }
        #lightbox-prev { left: 30px; }
        #lightbox-next { right: 30px; }
        #lightbox-header { position: absolute; top: 0; left: 0; right: 0; z-index: 2002; padding: 1rem; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%); backdrop-filter: blur(10px); display: flex; flex-direction: column; gap: 1rem; align-items: center; text-align: center; }
        #lightbox-title { font-size: 1.1rem; font-weight: 600; color: white; word-break: break-word; hyphens: auto; max-width: 90vw; }
        #lightbox-toolbar { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.75rem; }
        #lightbox-toolbar button, #lightbox-toolbar a { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 10px; font-size: 1.2rem; cursor: pointer; transition: all 0.3s; text-decoration: none; display: flex; align-items: center; justify-content: center; min-width: 44px; height: 44px; backdrop-filter: blur(10px); }
        #lightbox-toolbar button:hover, #lightbox-toolbar a:hover { background: rgba(255,255,255,0.2); }
        #lightbox-content { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 6rem 1rem 2rem; }
        #lightbox-media { display: flex; align-items: center; justify-content: center; max-width: 95vw; max-height: 90vh; }
        #lightbox-media img, #lightbox-media video { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 12px; box-shadow: var(--shadow-lg); cursor: grab; }
        #backToTopBtn { display: none; position: fixed; bottom: 110px; right: 30px; z-index: 99; font-size: 1.2rem; border: none; background: var(--primary-color); color: white; cursor: pointer; padding: 12px 16px; border-radius: 50%; transition: all 0.3s; box-shadow: var(--shadow-md); }
        #load-more-container { text-align: center; padding: 3rem; }
        #load-more-btn { background: var(--gradient-primary); color: white; border: none; padding: 1rem 2.5rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; box-shadow: var(--shadow-sm); }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
        #node-summary-overlay, #upload-overlay, #sync-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #node-summary-overlay { z-index: 2100; }
        #upload-overlay { z-index: 2200; }
        #sync-overlay { z-index: 2300; display: none; opacity: 1; pointer-events: all;}
        #node-summary-overlay.visible, #upload-overlay.visible { opacity: 1; pointer-events: auto; }
        .node-summary-panel, #upload-panel, #sync-panel { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: var(--shadow-lg); width: 90vw; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .node-summary-panel { max-width: 900px; max-height: 85vh; }
        #upload-panel { max-width: 600px; max-height: 85vh; }
        #sync-panel { max-width: 500px; padding: 2rem; align-items: center; text-align: center; }
        #node-summary-overlay.visible .node-summary-panel, #upload-overlay.visible #upload-panel { transform: scale(1); }
        .node-summary-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--surface-color); }
        .node-summary-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .node-summary-header .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; padding: 0; line-height: 1; }
        #node-summary-content { padding: 1.5rem; overflow-y: auto; }
        .summary-node-item { margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .summary-node-header { color: white; padding: 0.75rem 1rem; font-weight: bold; font-size: 0.9rem; }
        .summary-node-header small { opacity: 0.8; font-weight: normal; margin-left: 0.5rem; }
        .summary-node-params { list-style: none; margin: 0; padding: 1rem; background: var(--glass-bg); }
        .summary-node-params li { padding: 0.5rem 0; font-size: 1rem; border-bottom: 1px solid var(--glass-border); }
        .summary-node-params li:last-child { border-bottom: none; }
        .summary-node-params strong { color: var(--text-color); margin-right: 0.5rem; }
        .summary-node-params code { color: var(--text-muted); word-break: break-all; white-space: pre-wrap; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px; }
        #refresh-btn { margin-left: auto; }
        .upload-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); text-align: center; }
        .upload-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .upload-header p { margin: 0.5rem 0 0; color: var(--text-muted); }
        .upload-body { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }
        #drop-zone { border: 2px dashed var(--border-color); border-radius: 12px; padding: 2rem; text-align: center; color: var(--text-muted); transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; }
        #drop-zone.dragover { border-color: var(--primary-color); background: var(--surface-hover); transform: scale(1.02); }
        #drop-zone p { font-size: 1.1rem; font-weight: 500; margin: 0 0 1rem 0; }
        #file-upload-btn { background: var(--primary-color); color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; }
        #file-list { list-style: none; padding: 0; margin-top: 1.5rem; max-height: 200px; overflow-y: auto; }
        #file-list li { background: var(--glass-bg); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .file-size { color: var(--text-muted); font-size: 0.8rem; }
        .upload-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; }
        .upload-footer button { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        #upload-cancel-btn { background: var(--surface-hover); color: var(--text-color); }
        #upload-submit-btn { background: var(--success-color); color: white; }
        #upload-progress-container { display: none; margin-top: 1rem; }
        #upload-progress-bar { width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
        #upload-progress-fill { width: 0%; height: 100%; background: var(--primary-color); transition: width 0.2s; }
        #upload-file-input { display: none; }
        #sync-message { margin: 0 0 1rem; font-size: 1.1rem; font-weight: 500; }
        #sync-progress-bar { width: 100%; height: 10px; background-color: var(--border-color); border-radius: 5px; overflow: hidden; }
        #sync-progress-fill { width: 0%; height: 100%; background-color: var(--primary-color); transition: width 0.3s ease; }
        #mobile-filter-toggle { display: none; width: 100%; background: var(--surface-hover); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; text-align: left; }
        .mobile-actions-only { display: none; }
        @media (max-width: 1024px) {
            body.sidebar-expanded-mobile .sidebar { position: fixed; width: 100%; min-width: 100%; height: 100%; top: 0; left: 0; transform: translateX(0); z-index: 1005; }
            body.sidebar-expanded-mobile .main-content { display: none; }
            body:not(.sidebar-expanded-mobile) { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: static; border-right: none; border-bottom: 1px solid var(--border-color); }
            #selection-bar { left: 0; }
            body.sidebar-expanded #selection-bar { left: 0; }
            #sidebar-toggle-btn { display: flex; }
            #sidebar-expand-btn { display: none; }
            .sidebar.nav-collapsed .folder-controls, .sidebar.nav-collapsed .folder-tree-container, .sidebar.nav-collapsed #create-folder-btn { display: none; }
        }
        @media (max-width: 768px) {
            .breadcrumbs { flex-direction: column; align-items: stretch; }
            .gallery-sort-controls { justify-content: space-around; width: 100%; }
            .filter-bar form { grid-template-columns: 1fr; }
            
            /* Mobile: Bottom Sheet Style */
            #filter-panel { width: 100%; height: 75vh; top: auto; bottom: 0; transform: translateY(100%); border-left: none; border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; }
            #filter-panel.open { transform: translateY(0); }
            .filter-panel-header { border-radius: 20px 20px 0 0; position: relative; }
            .filter-panel-header::before { content: ''; position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 2px; }
            
            .filter-range-pair { grid-template-columns: 1fr; gap: 1rem; }
            .filter-range-pair .filter-group:first-child::after { display: none; }
            .dimension-filters { grid-template-columns: 1fr; gap: 1rem; }
            .workflow-section-header { margin-top: 0.5rem; padding: 0.5rem 0.75rem; }
            .workflow-section-header h3 { font-size: 0.85rem; }
            .desktop-actions-only { display: none; }
            .mobile-actions-only { display: flex; flex-direction: column; gap: 0.75rem; }
            .gallery-container { grid-template-columns: 1fr; padding: 1rem; }
            #selection-bar { flex-direction: column; align-items: stretch; gap: 0.5rem; padding: 1rem; }
            #selection-bar .actions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; width: 100%; }
            #selection-bar > #select-all-btn, #selection-bar > #deselect-all-btn { grid-column: span 2; }
            #selection-counter { text-align: center; padding-left: 0; margin-bottom: 0.5rem; }
            #drop-zone-panel { width: 90vw; }
            .lightbox-nav { width: 50px; height: 50px; }
            #lightbox-prev { left: 10px; }
            #lightbox-next { right: 10px; }
            .node-summary-panel { width: 95vw; max-height: 90vh; }
            .summary-node-params li { font-size: 0.9rem; }
        }
        @media (min-width: 1025px) {
            #drop-zone-panel { width: 650px; max-width: 90vw; }
        }
    </style>
</head>
<body x-data="gallery()" 
      @keydown.escape.window="handleEscape()" 
      @keydown.ctrl.a.window.prevent="selectAll()"
      @resize.window.debounce.150ms="handleResize()"
      :class="{ 
          'lightbox-open': isLightboxOpen, 
          'modal-open': isUploadOpen || isSummaryOpen,
          'sidebar-expanded': sidebarExpanded
      }">
    <div id="notification-container">
        <template x-for="notification in $store.notifications.list" :key="notification.id">
            <div class="notification show"
                 :class="notification.type"
                 x-transition:enter="transition ease-out duration-500"
                 x-transition:enter-start="opacity-0 translate-x-full"
                 x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-500"
                 x-transition:leave-start="opacity-100 translate-x-0"
                 x-transition:leave-end="opacity-0 translate-x-full">
                <span x-text="notification.message"></span>
            </div>
        </template>
    </div>
    <aside class="sidebar" :class="{ 'nav-collapsed': isMobileView && isMobileNavCollapsed }">
        <div class="sidebar-header">
            <a href="{{ url_for('gallery_view', folder_key='_root_') }}" style="text-decoration: none;"><h1>SmartGallery</h1></a>
            <div class="sidebar-actions">
                <button id="sidebar-expand-btn" title="Expand Sidebar">
                    <span>↔️</span><span id="sidebar-expand-text">Expand</span>
                </button>
                <button id="sidebar-toggle-btn" 
                        x-show="isMobileView" 
                        @click="isMobileNavCollapsed = !isMobileNavCollapsed"
                        style="display: none;">
                    <span>☰</span>
                    <span id="sidebar-toggle-text" 
                          x-text="isMobileNavCollapsed ? 'Show Folders' : 'Hide Folders'">
                    </span>
                </button>
            </div>
        </div>
        <div class="folder-controls">
            <input type="search" 
                   class="folder-search-input" 
                   id="folder-search-nav" 
                   placeholder="🔍 Search folders..."
                   x-model.debounce.300ms="$store.gallery.folderSearchTerm">
            <div class="folder-sort-buttons" id="folder-sort-nav">
                <button @click="$store.gallery.folderSort = { key: 'name', dir: $store.gallery.folderSort.key === 'name' && $store.gallery.folderSort.dir === 'asc' ? 'desc' : 'asc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'name' }"
                        :title="'Sort by name ' + ($store.gallery.folderSort.key === 'name' ? ($store.gallery.folderSort.dir === 'asc' ? '↓' : '↑') : '')"
                        x-text="'A-Z' + ($store.gallery.folderSort.key === 'name' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')">A-Z</button>
                <button @click="$store.gallery.folderSort = { key: 'mtime', dir: $store.gallery.folderSort.key === 'mtime' && $store.gallery.folderSort.dir === 'desc' ? 'asc' : 'desc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'mtime' }"
                        :title="'Sort by date ' + ($store.gallery.folderSort.key === 'mtime' ? ($store.gallery.folderSort.dir === 'asc' ? '↓' : '↑') : '')"
                        x-text="'🗓️' + ($store.gallery.folderSort.key === 'mtime' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')">🗓️</button>
            </div>
        </div>
        <div class="folder-tree-container">
            <ul class="folder-tree">
                <!-- Start the recursion by looping over the root node's children -->
                <template x-for="folderKey in $store.gallery.folders['_root_'].children" :key="folderKey">
                    <!-- Each top-level folder becomes a self-contained, recursive component -->
                    <li x-data="folderNode(folderKey)" x-show="isVisible">
                        <div class="folder-item" :class="{ 'active': key === $store.gallery.currentFolderKey }">
                            <!-- Toggle button -->
                            <span class="toggle-btn" 
                                  :class="{ 'empty': !folder.children || folder.children.length === 0 }" 
                                  @click.stop="toggle()"
                                  x-text="isOpen ? '▾' : '▸'"></span>
                            
                            <!-- Folder link -->
                            <a class="folder-link" 
                               :href="`/galleryout/view/${key}`" 
                               :title="folder.display_name">
                                📁 <span x-text="folder.display_name"></span>
                            </a>
                            
                            <!-- Action buttons (rename/delete) -->
                            <template x-if="key !== '_root_' && !$store.gallery.protectedFolderKeys.includes(key)">
                                <div class="folder-actions">
                                    <button class="folder-action-btn" 
                                            title="Rename" 
                                            @click.stop="renameFolder(key, folder.display_name)">✏️</button>
                                    <button class="folder-action-btn" 
                                            title="Delete" 
                                            @click.stop="deleteFolder(key, folder.display_name)">🗑️</button>
                                </div>
                            </template>
                        </div>
                        
                        <!-- RECURSION HAPPENS HERE: Children UL -->
                        <ul x-show="isOpen" x-collapse>
                            <template x-for="childKey in filteredAndSortedChildren" :key="childKey">
                                <!-- Nested folderNode component for recursion -->
                                <li x-data="folderNode(childKey)" x-show="isVisible">
                                    <div class="folder-item" :class="{ 'active': key === $store.gallery.currentFolderKey }">
                                        <span class="toggle-btn" 
                                              :class="{ 'empty': !folder.children || folder.children.length === 0 }" 
                                              @click.stop="toggle()"
                                              x-text="isOpen ? '▾' : '▸'"></span>
                                        
                                        <a class="folder-link" 
                                           :href="`/galleryout/view/${key}`" 
                                           :title="folder.display_name">
                                            📁 <span x-text="folder.display_name"></span>
                                        </a>
                                        
                                        <template x-if="key !== '_root_' && !$store.gallery.protectedFolderKeys.includes(key)">
                                            <div class="folder-actions">
                                                <button class="folder-action-btn" 
                                                        title="Rename" 
                                                        @click.stop="renameFolder(key, folder.display_name)">✏️</button>
                                                <button class="folder-action-btn" 
                                                        title="Delete" 
                                                        @click.stop="deleteFolder(key, folder.display_name)">🗑️</button>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <!-- Third level nesting (sufficient for most use cases) -->
                                    <ul x-show="isOpen" x-collapse>
                                        <template x-for="grandchildKey in filteredAndSortedChildren" :key="grandchildKey">
                                            <li x-data="folderNode(grandchildKey)" x-show="isVisible">
                                                <div class="folder-item" :class="{ 'active': key === $store.gallery.currentFolderKey }">
                                                    <span class="toggle-btn" 
                                                          :class="{ 'empty': !folder.children || folder.children.length === 0 }" 
                                                          @click.stop="toggle()"
                                                          x-text="isOpen ? '▾' : '▸'"></span>
                                                    
                                                    <a class="folder-link" 
                                                       :href="`/galleryout/view/${key}`" 
                                                       :title="folder.display_name">
                                                        📁 <span x-text="folder.display_name"></span>
                                                    </a>
                                                    
                                                    <template x-if="key !== '_root_' && !$store.gallery.protectedFolderKeys.includes(key)">
                                                        <div class="folder-actions">
                                                            <button class="folder-action-btn" 
                                                                    title="Rename" 
                                                                    @click.stop="renameFolder(key, folder.display_name)">✏️</button>
                                                            <button class="folder-action-btn" 
                                                                    title="Delete" 
                                                                    @click.stop="deleteFolder(key, folder.display_name)">🗑️</button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </li>
                                        </template>
                                    </ul>
                                </li>
                            </template>
                        </ul>
                    </li>
                </template>
            </ul>
        </div>
        <button @click="createFolder()">➕ Create New Folder</button>
    </aside>
    <div class="main-content">
        <header class="breadcrumbs">
            <div class="breadcrumb-links">
                {% for crumb in breadcrumbs %}
                    <a href="{{ url_for('gallery_view', folder_key=crumb.key) }}">{{ crumb.display_name }}</a>
                    {% if not loop.last %}<span>/</span>{% endif %}
                {% endfor %}
            </div>
            <div class="gallery-sort-controls">
                {% set current_sort_by = request.args.get('sort_by', 'date') %}
                {% set current_sort_order = request.args.get('sort_order', 'desc') %}
                {% set date_is_active = current_sort_by == 'date' %}
                {% set date_next_order = 'asc' if date_is_active and current_sort_order == 'desc' else 'desc' %}
                {% set date_query_params = dict(request.args.to_dict(flat=False), sort_by='date', sort_order=date_next_order) %}
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **date_query_params) }}" class="sort-btn {{ 'active' if date_is_active else '' }}">
                    Sort by Date {% if date_is_active %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                </a>
                {% set name_is_active = current_sort_by == 'name' %}
                {% set name_next_order = 'desc' if name_is_active and current_sort_order == 'asc' else 'asc' %}
                {% set name_query_params = dict(request.args.to_dict(flat=False), sort_by='name', sort_order=name_next_order) %}
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key, **name_query_params) }}" class="sort-btn {{ 'active' if name_is_active else '' }}">
                    Sort by Name {% if name_is_active %}{{ '↑' if current_sort_order == 'asc' else '↓' }}{% endif %}
                </a>
                <button type="button" class="sort-btn" @click="isFilterPanelOpen = true" :class="{ 'active': isFilterPanelOpen }">
                    <span class="filter-icon">🎛️</span>
                    <span>Filters</span>
                    <span class="active-count-badge" x-show="activeFilterCount > 0" x-text="activeFilterCount"></span>
                </button>
                <button type="button" class="sort-btn" @click="isUploadOpen = true">☁️ Upload</button>
                <button type="button" class="sort-btn refresh-btn" @click="startSyncProcess(true)">♻️ Refresh</button>
            </div>
            
            <!-- Results Count Indicator -->
            <div class="results-count" x-show="totalFiles > 0">
                <span class="count-label">
                    <template x-if="filesOnPage.length < totalFiles">
                        <span>Showing <strong x-text="filesOnPage.length"></strong> of <strong x-text="totalFiles"></strong> files</span>
                    </template>
                    <template x-if="filesOnPage.length === totalFiles">
                        <span><strong x-text="totalFiles"></strong> file<span x-show="totalFiles !== 1">s</span></span>
                    </template>
                </span>
            </div>
        </header>
        
        <!-- Filter Panel (Slide-out) -->
        <div id="filter-backdrop" x-show="isFilterPanelOpen" @click="isFilterPanelOpen = false" x-transition:enter="transition ease-out duration-400" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-400" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"></div>
        <div id="filter-panel" :class="{ 'open': isFilterPanelOpen }">
            <div class="filter-panel-header">
                <h2>
                    <span>🎛️ Filters & Options</span>
                    <span>
                        <span class="filter-count-badge" x-text="activeFilterCount + ' Active'"></span>
                        <button type="button" @click="isFilterPanelOpen = false">✕</button>
                    </span>
                </h2>
            </div>
            <div class="filter-panel-content">
                <form method="GET" action="{{ url_for('gallery_view', folder_key=current_folder_key) }}" id="filter-form" @submit.prevent="applyFilters()">
                    <input type="hidden" name="sort_by" value="{{ request.args.get('sort_by', 'date') }}">
                    <input type="hidden" name="sort_order" value="{{ request.args.get('sort_order', 'desc') }}">
                    
                    <!-- Active Filters Display -->
                    <div class="active-filters-container" id="active-filters-display">
                        <template x-for="pill in activeFilterPills" :key="pill.key">
                            <span class="active-filter-pill" @click="pill.action()">
                                <span x-text="pill.label"></span>
                                <span class="remove-icon">×</span>
                            </span>
                        </template>
                        <template x-if="activeFilterPills.length > 0">
                            <button type="button" id="clear-all-filters-btn" @click="clearAllFilters()">🔄 Clear All</button>
                        </template>
                    </div>
                    
                    <div class="filter-form-grid" id="filter-form-grid">
                    <!-- Basic Filters -->
                    <div class="filter-group"><label for="search-input">🔍 Search by Name</label><input type="text" name="search" id="search-input" placeholder="Search files..." x-model.debounce.300ms="filters.search"></div>
                    <div class="filter-group"><label for="extension-select">📄 Extensions</label><select name="extension" id="extension-select" multiple x-model="filters.extensions" x-tom-select placeholder="📄 Select extensions...">{% for ext in available_extensions %}<option value="{{ ext }}" {% if ext in selected_extensions %}selected{% endif %}>{{ ext }}</option>{% endfor %}</select></div>
                    <div class="filter-group"><label for="prefix-select">🏷️ Prefixes</label><select name="prefix" id="prefix-select" multiple x-model="filters.prefixes" x-tom-select placeholder="🏷️ Select prefixes...">{% for pfx in available_prefixes %}{% if pfx != '.gallery ' %}<option value="{{ pfx }}" {% if pfx in selected_prefixes %}selected{% endif %}>{{ pfx }}</option>{% endif %}{% endfor %}</select></div>
                    <div class="filter-group"><div class="filter-group-inline"><input type="checkbox" name="favorites" id="favorites-check" value="true" x-model="filters.favorites"><label for="favorites-check">⭐ Favorites Only</label></div></div>
                    
                    <!-- Workflow Metadata Section -->
                    <div class="workflow-section-header">
                        <h3>🎨 Workflow Parameters</h3>
                    </div>
                    
                    <div class="filter-group"><label for="model-select">🤖 Model</label><select name="filter_model" id="model-select" x-model="filters.model" x-tom-select placeholder="🤖 Select model..."><option value="">All Models</option><template x-for="model in filterOptions.models" :key="model.value"><option :value="model.value" x-text="`${model.value} (${model.count})`"></option></template></select></div>
                    <div class="filter-group"><label for="sampler-select">🎲 Sampler</label><select name="filter_sampler" id="sampler-select" x-model="filters.sampler" x-tom-select placeholder="🎲 Select sampler..."><option value="">All Samplers</option><template x-for="sampler in filterOptions.samplers" :key="sampler.value"><option :value="sampler.value" x-text="`${sampler.value} (${sampler.count})`"></option></template></select></div>
                    <div class="filter-group"><label for="scheduler-select">📅 Scheduler</label><select name="filter_scheduler" id="scheduler-select" x-model="filters.scheduler" x-tom-select placeholder="📅 Select scheduler..."><option value="">All Schedulers</option><template x-for="scheduler in filterOptions.schedulers" :key="scheduler.value"><option :value="scheduler.value" x-text="`${scheduler.value} (${scheduler.count})`"></option></template></select></div>
                    
                    <!-- CFG Range Pair -->
                    <div class="filter-range-pair">
                        <div class="filter-group"><label for="cfg-min-input">⚙️ CFG Min</label><input type="number" name="filter_cfg_min" id="cfg-min-input" placeholder="Min CFG" step="0.1" x-model.debounce.500ms="filters.cfg_min"></div>
                        <div class="filter-group"><label for="cfg-max-input">⚙️ CFG Max</label><input type="number" name="filter_cfg_max" id="cfg-max-input" placeholder="Max CFG" step="0.1" x-model.debounce.500ms="filters.cfg_max"></div>
                    </div>
                    
                    <!-- Steps Range Pair -->
                    <div class="filter-range-pair">
                        <div class="filter-group"><label for="steps-min-input">🔢 Steps Min</label><input type="number" name="filter_steps_min" id="steps-min-input" placeholder="Min Steps" step="1" x-model.debounce.500ms="filters.steps_min"></div>
                        <div class="filter-group"><label for="steps-max-input">🔢 Steps Max</label><input type="number" name="filter_steps_max" id="steps-max-input" placeholder="Max Steps" step="1" x-model.debounce.500ms="filters.steps_max"></div>
                    </div>
                    
                    <!-- Dimension Filters -->
                    <div class="dimension-filters">
                        <div class="filter-group"><label for="width-min-input">📏 Width Min</label><input type="number" name="filter_width_min" id="width-min-input" placeholder="Min Width" step="64" x-model.debounce.500ms="filters.width_min"></div>
                        <div class="filter-group"><label for="width-max-input">📏 Width Max</label><input type="number" name="filter_width_max" id="width-max-input" placeholder="Max Width" step="64" x-model.debounce.500ms="filters.width_max"></div>
                        <div class="filter-group"><label for="height-min-input">📐 Height Min</label><input type="number" name="filter_height_min" id="height-min-input" placeholder="Min Height" step="64" x-model.debounce.500ms="filters.height_min"></div>
                        <div class="filter-group"><label for="height-max-input">📐 Height Max</label><input type="number" name="filter_height_max" id="height-max-input" placeholder="Max Height" step="64" x-model.debounce.500ms="filters.height_max"></div>
                    </div>
                    </div>
                </form>
            </div>
            <div class="filter-panel-footer">
                <button type="submit" form="filter-form">🔍 Apply Filters</button>
                <a href="{{ url_for('gallery_view', folder_key=current_folder_key) }}" style="flex: 0.5; background: var(--surface-hover); color: var(--text-muted); text-decoration: none; padding: 0.75rem 1.5rem; border-radius: 8px; text-align: center; font-weight: 600;">🔄 Reset</a>
            </div>
        </div>
        <div id="gallery-anchor"></div>
        <main class="gallery-container" id="gallery-container">
            <!-- Alpine x-for Gallery Grid -->
            <template x-for="file in filesOnPage" :key="file.id">
                <div class="gallery-item" 
                     :data-file-id="file.id" 
                     :data-file-type="file.type"
                     :class="{ 'selected': selectedFiles.includes(file.id) }"
                     draggable="true"
                     @dragstart="dragStart($event, file.id)">
                    
                    <!-- Selection Checkmark -->
                    <div class="selection-checkmark" 
                         @click="toggleSelection($event, file.id)"
                         x-text="'✓'">
                    </div>
                    
                    <!-- Thumbnail Link -->
                    <div class="thumbnail-link" 
                         @click="openLightbox(file.id)">
                        <div class="thumbnail-wrapper">
                            <!-- Media Content -->
                            <template x-if="file.type === 'audio'">
                                <div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:4rem;color:#1ed760;">🎵</div>
                            </template>
                            
                            <template x-if="['image', 'animated_image'].includes(file.type)">
                                <img class="lazy" 
                                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"
                                     :data-src="`/galleryout/thumbnail/${file.id}`"
                                     :alt="file.name"
                                     loading="lazy"
                                     x-intersect:enter="$el.src = $el.dataset.src">
                            </template>
                            
                            <template x-if="file.type === 'video'">
                                <video autoplay muted loop playsinline class="lazy"
                                       :data-src="`/galleryout/file/${file.id}`"
                                       poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E"
                                       x-intersect:enter="$el.src = $el.dataset.src; $el.load();">
                                </video>
                            </template>
                            
                            <template x-if="!['audio', 'image', 'animated_image', 'video'].includes(file.type)">
                                <div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:3rem;color:var(--text-muted);">📄</div>
                            </template>
                            
                            <!-- Workflow Badge -->
                            <template x-if="file.has_workflow">
                                <a :href="`/galleryout/workflow/${file.id}`"
                                   class="workflow-badge"
                                   :data-sampler-count="file.sampler_count || 0"
                                   :title="(file.sampler_count || 0) > 1 ? `This workflow uses ${file.sampler_count} different sampler configurations` : 'View workflow JSON'"
                                   @click.stop>
                                    <span x-text="(file.sampler_count || 0) > 1 ? `⚙️ ${file.sampler_count} Samplers` : '⚙️ Workflow'"></span>
                                </a>
                            </template>
                            
                            <!-- Duration Overlay -->
                            <template x-if="file.duration">
                                <span class="duration-overlay" x-text="`⏱️ ${file.duration}`"></span>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Item Info -->
                    <div class="item-info">
                        <div>
                            <p :title="file.name">
                                <strong x-text="file.name"></strong>
                            </p>
                            
                            <!-- File Metadata -->
                            <template x-if="file.dimensions || file.mtime">
                                <div class="file-metadata">
                                    <template x-if="file.dimensions">
                                        <span x-text="`📐 ${file.dimensions}`"></span>
                                    </template>
                                    <template x-if="file.mtime">
                                        <span x-text="`📅 ${new Date(file.mtime * 1000).toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}`"></span>
                                    </template>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Item Actions -->
                        <div class="item-actions">
                            <template x-if="file.has_workflow">
                                <button title="Node Summary" @click.stop="showNodeSummary(file.id)">📝</button>
                            </template>
                            
                            <button class="favorite-btn"
                                    :class="{ 'favorited': file.is_favorite }"
                                    :title="file.is_favorite ? 'Unfavorite' : 'Favorite'"
                                    @click.stop="toggleFavorite(file.id)"
                                    x-text="file.is_favorite ? '⭐' : '☆'">
                            </button>
                            
                            <a :href="`/galleryout/download/${file.id}`"
                               @click.stop
                               title="Download">💾</a>
                            
                            <button class="delete-btn"
                                    @click.stop="deleteFile(file.id)"
                                    title="Delete">🗑️</button>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Empty State -->
            <template x-if="filesOnPage.length === 0">
                <div class="empty-state" style="grid-column: 1/-1;">
                    <h3>📭 No files found</h3>
                    <p>There are no files matching your criteria in this folder.</p>
                </div>
            </template>
        </main>
        <div id="load-more-container" x-show="filesOnPage.length < totalFiles">
            <button id="load-more-btn"
                    @click="loadMore()" 
                    :disabled="isLoadingMore">
                <span x-show="!isLoadingMore">
                    📂 Load More 
                    <template x-if="totalFiles - filesOnPage.length <= {{ files_per_page }}">
                        <span x-text="`(${totalFiles - filesOnPage.length} remaining)`"></span>
                    </template>
                    <template x-if="totalFiles - filesOnPage.length > {{ files_per_page }}">
                        <span x-text="`(${Math.min({{ files_per_page }}, totalFiles - filesOnPage.length)} of ${totalFiles - filesOnPage.length})`"></span>
                    </template>
                </span>
                <span x-show="isLoadingMore">📂 Loading...</span>
            </button>
        </div>
    </div>
    <button @click="scrollToTop()" id="backToTopBtn" title="Go to Top" x-show="shouldShowBackToTop" style="display: none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
    <div id="drag-drop-overlay"></div>
    <div id="drop-zone-panel">
        <h3>📁 Move to Folder:</h3>
        <div class="folder-controls" style="padding: 0 1rem; margin-top: 1rem;">
            <input type="search" 
                   class="folder-search-input" 
                   id="folder-search-move" 
                   placeholder="🔍 Search folders..."
                   x-model.debounce.300ms="$store.gallery.folderSearchTerm">
            <div class="folder-sort-buttons" id="folder-sort-move">
                <button @click="$store.gallery.folderSort = { key: 'name', dir: $store.gallery.folderSort.key === 'name' && $store.gallery.folderSort.dir === 'asc' ? 'desc' : 'asc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'name' }"
                        x-text="'A-Z' + ($store.gallery.folderSort.key === 'name' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')">A-Z</button>
                <button @click="$store.gallery.folderSort = { key: 'mtime', dir: $store.gallery.folderSort.key === 'mtime' && $store.gallery.folderSort.dir === 'desc' ? 'asc' : 'desc' }; $store.gallery.saveSortState()" 
                        :class="{ 'active': $store.gallery.folderSort.key === 'mtime' }"
                        x-text="'🗓️' + ($store.gallery.folderSort.key === 'mtime' ? ($store.gallery.folderSort.dir === 'asc' ? ' ↑' : ' ↓') : '')">🗓️</button>
            </div>
        </div>
        <div id="drop-zone-folders">
            <div class="folder-tree-container" style="padding: 1rem;">
                <ul class="folder-tree">
                    <!-- Start the recursion by looping over the root node's children -->
                    <template x-for="folderKey in $store.gallery.folders['_root_'].children" :key="folderKey">
                        <!-- Each top-level folder in move panel -->
                        <li x-data="folderNode(folderKey)" x-show="isVisible">
                            <div class="folder-item">
                                <span class="toggle-btn" 
                                      :class="{ 'empty': !folder.children || folder.children.length === 0 }" 
                                      @click.stop="toggle()"
                                      x-text="isOpen ? '▾' : '▸'"></span>
                                
                                <span class="folder-link" 
                                      :title="folder.display_name">
                                    📁 <span x-text="folder.display_name"></span>
                                </span>
                                
                                <button class="move-here-btn" 
                                        :disabled="key === $store.gallery.currentFolderKey"
                                        @click.stop="confirmMoveToFolder(key)"
                                        title="Move here">➜</button>
                            </div>
                            
                            <!-- Children UL for move panel -->
                            <ul x-show="isOpen" x-collapse>
                                <template x-for="childKey in filteredAndSortedChildren" :key="childKey">
                                    <li x-data="folderNode(childKey)" x-show="isVisible">
                                        <div class="folder-item">
                                            <span class="toggle-btn" 
                                                  :class="{ 'empty': !folder.children || folder.children.length === 0 }" 
                                                  @click.stop="toggle()"
                                                  x-text="isOpen ? '▾' : '▸'"></span>
                                            
                                            <span class="folder-link" 
                                                  :title="folder.display_name">
                                                📁 <span x-text="folder.display_name"></span>
                                            </span>
                                            
                                            <button class="move-here-btn" 
                                                    :disabled="key === $store.gallery.currentFolderKey"
                                                    @click.stop="confirmMoveToFolder(key)"
                                                    title="Move here">➜</button>
                                        </div>
                                        
                                        <!-- Third level for move panel -->
                                        <ul x-show="isOpen" x-collapse>
                                            <template x-for="grandchildKey in filteredAndSortedChildren" :key="grandchildKey">
                                                <li x-data="folderNode(grandchildKey)" x-show="isVisible">
                                                    <div class="folder-item">
                                                        <span class="toggle-btn" 
                                                              :class="{ 'empty': !folder.children || folder.children.length === 0 }" 
                                                              @click.stop="toggle()"
                                                              x-text="isOpen ? '▾' : '▸'"></span>
                                                        
                                                        <span class="folder-link" 
                                                              :title="folder.display_name">
                                                            📁 <span x-text="folder.display_name"></span>
                                                        </span>
                                                        
                                                        <button class="move-here-btn" 
                                                                :disabled="key === $store.gallery.currentFolderKey"
                                                                @click.stop="confirmMoveToFolder(key)"
                                                                title="Move here">➜</button>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </li>
                                </template>
                            </ul>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
        <button @click="hideDropZone()">❌ Cancel</button>
    </div>
    <div id="selection-bar" x-show="selectedFiles.length > 0" :class="{ 'visible': selectedFiles.length > 0 }">
        <span x-text="`📊 ${selectedFiles.length} file${selectedFiles.length !== 1 ? 's' : ''} selected`"></span>
        <div class="actions-grid">
            <button @click="moveSelected()">📁 Move</button>
            <button @click="favoriteSelected(true)">⭐ Add</button>
            <button @click="favoriteSelected(false)">☆ Remove</button>
            <button @click="deleteSelected()" class="delete-btn">🗑️ Delete</button>
            <button @click="selectAll()">✅ All</button>
            <button @click="selectedFiles = []">❌ None</button>
        </div>
    </div>
    <div id="lightbox-overlay" x-show="isLightboxOpen" @click.self="closeLightbox()" @keydown.arrow-left.window="navigateLightbox(-1)" @keydown.arrow-right.window="navigateLightbox(1)" @keydown.delete.window.prevent="deleteFromLightbox()" x-transition:enter="transition ease-out duration-400" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-400" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div id="lightbox-header">
            <div id="lightbox-title" x-text="currentLightboxFile ? `${currentLightboxFile.name} (${Math.round(currentZoom * 100)}%)` : ''"></div>
            <div id="lightbox-toolbar">
                <button @click="zoomLightbox(-0.2)" title="Zoom Out">-</button>
                <button @click="zoomLightbox(0.2)" title="Zoom In">+</button>
                <a :href="currentLightboxFile ? `/galleryout/download/${currentLightboxFile.id}` : '#'" title="Download File">💾</a>
                <button @click="renameFileFromLightbox()" title="Rename File">✏️</button>
                <button x-show="currentLightboxFile && currentLightboxFile.has_workflow" @click="showNodeSummary(currentLightboxFile.id)" title="Node Summary">📝</button>
                <a x-show="currentLightboxFile && currentLightboxFile.has_workflow" :href="currentLightboxFile ? `/galleryout/workflow/${currentLightboxFile.id}` : '#'" class="workflow-btn" title="Download Workflow">⚙️</a>
                <button @click="deleteFromLightbox()" title="Delete File">🗑️</button>
                <a :href="currentLightboxFile ? `/galleryout/file/${currentLightboxFile.id}` : '#'" target="_blank" title="Open in New Tab">↗️</a>
                <button @click="closeLightbox()" title="Close">×</button>
            </div>
        </div>
        <!-- Sampler Details Panel -->
        <div class="lightbox-sampler-panel" 
             x-show="currentLightboxFile && currentLightboxFile.has_workflow" 
             style="display: none;"
             x-transition>
            
            <button @click="toggleSamplerPanel()" class="sampler-toggle-btn" :class="{ 'expanded': samplerPanelExpanded }">
                <span class="toggle-icon" style="transition: transform 0.3s;" :style="samplerPanelExpanded && { transform: 'rotate(180deg)' }">▼</span>
                <span class="toggle-text" x-text="samplerPanelExpanded ? 'Hide Sampler Details' : 'Show Sampler Details'"></span>
                <span class="sampler-badge" x-text="samplerCount" x-show="samplerCount > 0"></span>
            </button>

            <div class="sampler-content" :class="{ 'expanded': samplerPanelExpanded }">
                <!-- Loading State -->
                <div class="sampler-loader" x-show="samplerPanelLoading" x-cloak>Loading sampler data...</div>

                <!-- Error State -->
                <div class="sampler-error" x-show="samplerError" x-text="samplerError" x-cloak></div>

                <!-- Content State -->
                <div x-show="!samplerPanelLoading && !samplerError" x-cloak>
                    <template x-for="(sampler, index) in samplerData" :key="index">
                        <div class="sampler-item">
                            <div class="sampler-header">Sampler <span x-text="index + 1"></span></div>
                            <div class="sampler-grid">
                                <!-- Sampler Fields: Rendered conditionally -->
                                <template x-if="sampler.sampler_name">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Sampler:</span>
                                        <span class="sampler-field-value" x-text="sampler.sampler_name"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.scheduler">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Scheduler:</span>
                                        <span class="sampler-field-value" x-text="sampler.scheduler"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.steps != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Steps:</span>
                                        <span class="sampler-field-value" x-text="sampler.steps"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.cfg != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">CFG Scale:</span>
                                        <span class="sampler-field-value" x-text="sampler.cfg"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.denoise != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Denoise:</span>
                                        <span class="sampler-field-value" x-text="sampler.denoise"></span>
                                    </div>
                                </template>
                                <template x-if="sampler.seed != null">
                                    <div class="sampler-field">
                                        <span class="sampler-field-label">Seed:</span>
                                        <span class="sampler-field-value" x-text="sampler.seed"></span>
                                    </div>
                                </template>
                            </div>

                            <!-- Prompts: Rendered conditionally -->
                            <template x-if="sampler.positive_prompt">
                                <div class="sampler-prompts">
                                    <div class="sampler-prompt-label">Positive Prompt:</div>
                                    <div class="sampler-prompt-text" x-text="sampler.positive_prompt"></div>
                                </div>
                            </template>
                            <template x-if="sampler.negative_prompt">
                                <div class="sampler-prompts">
                                    <div class="sampler-prompt-label">Negative Prompt:</div>
                                    <div class="sampler-prompt-text" x-text="sampler.negative_prompt"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <div id="lightbox-content">
            <div id="lightbox-media" @wheel.prevent="zoomLightbox($event.deltaY < 0 ? 0.1 : -0.1)">
                <!-- Declarative media rendering based on file type -->
                <template x-if="currentLightboxFile?.type === 'audio'">
                    <audio :src="`/galleryout/file/${currentLightboxFile.id}`"
                           controls autoplay
                           :style="`transform: scale(${currentZoom})`"></audio>
                </template>
                
                <template x-if="currentLightboxFile && ['image', 'animated_image'].includes(currentLightboxFile.type)">
                    <img :src="`/galleryout/file/${currentLightboxFile.id}`"
                         :alt="currentLightboxFile?.name || ''"
                         :style="`transform: scale(${currentZoom})`"></img>
                </template>
                
                <template x-if="currentLightboxFile?.type === 'video'">
                    <video :src="`/galleryout/file/${currentLightboxFile.id}`"
                           controls autoplay loop
                           :style="`transform: scale(${currentZoom})`"></video>
                </template>
                
                <template x-if="currentLightboxFile && !['audio', 'image', 'animated_image', 'video'].includes(currentLightboxFile.type)">
                    <div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:4rem;color:var(--text-muted);">📄</div>
                </template>
            </div>
        </div>
        <button @click="navigateLightbox(-1)" class="lightbox-nav" style="left: 30px;">‹</button>
        <button @click="navigateLightbox(1)" class="lightbox-nav" style="right: 30px;">›</button>
    </div>
    <div id="node-summary-overlay" x-show="isSummaryOpen" @click.self="isSummaryOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="node-summary-panel" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <div class="node-summary-header">
                <h2>📝 Node Summary</h2>
                <button class="close-btn" @click="isSummaryOpen = false">×</button>
            </div>
            <div id="node-summary-content" x-html="summaryHtml"></div>
        </div>
    </div>
    <div id="upload-overlay" x-show="isUploadOpen" @click.self="isUploadOpen = false" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div id="upload-panel" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
            <div class="upload-header">
                <h2>Upload Files</h2>
                <p id="upload-destination-text">Upload to: <strong x-text="$store.gallery.folders[$store.gallery.currentFolderKey].display_name"></strong></p>
            </div>
            <div class="upload-body">
                <input type="file" id="upload-file-input" multiple>
                <div id="drop-zone"
                     @dragover.prevent="dragOver"
                     @dragleave="dragLeave"
                     @drop.prevent="dropFiles"
                     :class="{ 'dragover': isDragOver }">
                    <p x-text="isDragOver ? 'Drop files here...' : 'Drag & Drop files here'"></p>
                    <button type="button" id="file-upload-btn" @click="$refs.fileInput.click()">Or select files...</button>
                    <input type="file"
                           id="upload-file-input"
                           multiple
                           x-ref="fileInput"
                           @change="handleFiles($event.target.files)">
                </div>
                <ul id="file-list">
                    <template x-for="(file, index) in filesToUpload" :key="index">
                        <li>
                            <span x-text="file.name"></span>
                            <span class="file-size" x-text="`${(file.size / 1024).toFixed(1)} KB`"></span>
                        </li>
                    </template>
                </ul>
                <div id="upload-progress-container" x-show="uploadProgress > 0"><div id="upload-progress-bar"><div id="upload-progress-fill" :style="`width: ${uploadProgress}%`"></div></div></div>
            </div>
            <div class="upload-footer">
                <button type="button" @click="isUploadOpen = false">Cancel</button>
                <button type="button" id="upload-submit-btn"
                        :disabled="isUploading"
                        :class="{ 'opacity-50': isUploading }"
                        @click="performUpload()"
                        x-text="isUploading ? 'Uploading...' : 'Upload'">Upload</button>
            </div>
        </div>
    </div>
    <div id="sync-overlay" x-show="isSyncing">
        <div id="sync-panel">
            <h3 x-text="syncMessage || 'Scanning...'"></h3>
            <div id="sync-progress-bar">
                <div id="sync-progress-fill" :style="`width: ${syncProgress}%`"></div>
            </div>
        </div>
    </div>
    <div id="loader-overlay" x-show="isPageLoading" x-transition.opacity.duration.400ms>
        <div class="loader"></div>
    </div>
    
    <!-- ============================================= -->
    <!-- PURE ALPINE.JS SCRIPT - NO GLOBALS -->
    <!-- ============================================= -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
    <script>
        // =======================================================================
        //  ALPINE.JS INITIALIZATION - ALL STATE AND LOGIC IN COMPONENTS
        // =======================================================================
        document.addEventListener('alpine:init', () => {
            try {
                // --- CUSTOM X-TOM-SELECT DIRECTIVE ---
                Alpine.directive('tom-select', (el, { expression, modifiers }, { effect, evaluateLater, cleanup }) => {
                    // Validate element has x-model
                    const modelName = el.getAttribute('x-model');
                    if (!modelName) {
                        console.error('[x-tom-select] Directive requires x-model attribute', el);
                        return;
                    }
                    
                    // Default TomSelect settings
                    const defaultSettings = {
                        plugins: [],
                        placeholder: el.getAttribute('placeholder') || 'Select...',
                        allowEmptyOption: true,
                        closeAfterSelect: !el.hasAttribute('multiple')
                    };
                    
                    // Add plugins based on element attributes
                    if (el.hasAttribute('multiple')) {
                        defaultSettings.plugins.push('checkbox_options', 'clear_button', 'remove_button');
                    }
                    
                    // Parse configuration from expression (optional)
                    let additionalConfig = {};
                    if (expression) {
                        try {
                            let getConfig = evaluateLater(expression);
                            getConfig(result => {
                                additionalConfig = result || {};
                            });
                        } catch (error) {
                            console.warn('[x-tom-select] Failed to parse config expression:', error);
                        }
                    }
                    
                    // Merge settings
                    const settings = { ...defaultSettings, ...additionalConfig };
                    
                    // Initialize TomSelect
                    let tomInstance = null;
                    let getModelValue = evaluateLater(modelName);
                    
                    // Use queueMicrotask for immediate but deferred execution
                    // This ensures Alpine has finished its initial pass before we initialize
                    queueMicrotask(() => {
                        try {
                            // Create the TomSelect instance
                            tomInstance = new TomSelect(el, {
                                ...settings,
                                onChange: (value) => {
                                    // Update Alpine state when TomSelect changes
                                    try {
                                        // Format value based on whether it's a multiple select
                                        let formattedValue;
                                        if (el.hasAttribute('multiple')) {
                                            formattedValue = Array.isArray(value) ? value : (value ? [value] : []);
                                        } else {
                                            formattedValue = value || '';
                                        }
                                        
                                        // Use a function to set the value directly
                                        const setValue = evaluateLater(`${modelName} = __value`);
                                        setValue(() => {}, { __value: formattedValue });
                                    } catch (error) {
                                        console.error('[x-tom-select] Error updating Alpine state:', error);
                                    }
                                }
                            });
                            
                            // Watch Alpine state and update TomSelect when it changes
                            if (tomInstance) {
                                effect(() => {
                                    getModelValue(value => {
                                        if (tomInstance) {
                                            try {
                                                // Prevent feedback loop by checking if value actually changed
                                                const currentValue = tomInstance.getValue();
                                                const newValue = value || (el.hasAttribute('multiple') ? [] : '');
                                                
                                                // Deep comparison for arrays, simple comparison for strings
                                                const hasChanged = el.hasAttribute('multiple')
                                                    ? JSON.stringify(currentValue) !== JSON.stringify(newValue)
                                                    : currentValue !== newValue;
                                                
                                                if (hasChanged) {
                                                    tomInstance.setValue(newValue, true); // true = silent (no onChange trigger)
                                                }
                                            } catch (error) {
                                                console.error('[x-tom-select] Error syncing state to TomSelect:', error);
                                            }
                                        }
                                    });
                                });
                            }
                            
                            // Store instance on element for external access
                            el._tomSelect = tomInstance;
                            
                        } catch (error) {
                            console.error('[x-tom-select] Failed to initialize TomSelect:', error, el);
                        }
                    });
                    
                    // Cleanup when element is removed
                    cleanup(() => {
                        if (tomInstance) {
                            try {
                                tomInstance.destroy();
                            } catch (error) {
                                console.warn('[x-tom-select] Error destroying instance:', error);
                            }
                            delete el._tomSelect;
                            tomInstance = null;
                        }
                    });
                });
            } catch (error) {
                console.error('[Alpine] Failed to register x-tom-select directive:', error);
            }

            // --- NOTIFICATIONS STORE ---
            try {
                Alpine.store('notifications', {
                list: [],
                add(message, type = 'info') {
                    const id = Date.now() + Math.random();
                    this.list.push({ id, message, type });
                    setTimeout(() => this.remove(id), 3000);
                },
                remove(id) {
                    this.list = this.list.filter(n => n.id !== id);
                }
            });
            } catch (error) {
                console.error('[Alpine] Failed to initialize notifications store:', error);
            }

            // --- GALLERY STORE (FOR FOLDER TREE) ---
            try {
                Alpine.store('gallery', {
                folders: {{ folders | tojson }},
                currentFolderKey: '{{ current_folder_key }}',
                ancestorKeys: {{ ancestor_keys | tojson }},
                protectedFolderKeys: {{ protected_folder_keys | tojson }},
                folderSearchTerm: '',
                folderSort: { key: 'name', dir: 'asc' },
                expandedFolderKeys: new Set(),
                
                initStore() {
                    const savedSort = localStorage.getItem('gallerySortPreference');
                    if (savedSort) {
                        const parsed = JSON.parse(savedSort);
                        if (parsed.nav) this.folderSort = parsed.nav;
                    }
                    const savedExpanded = localStorage.getItem('galleryFolderState');
                    if (savedExpanded) this.expandedFolderKeys = new Set(JSON.parse(savedExpanded));
                },
                
                saveSortState() {
                    localStorage.setItem('gallerySortPreference', JSON.stringify({ nav: this.folderSort }));
                },
                
                saveExpandedState() {
                    localStorage.setItem('galleryFolderState', JSON.stringify([...this.expandedFolderKeys]));
                }
            });
            } catch (error) {
                console.error('[Alpine] Failed to initialize gallery store:', error);
            }

            // --- FOLDER NODE COMPONENT (RECURSIVE) ---
            try {
                Alpine.data('folderNode', (folderKey) => ({
                key: folderKey,
                isOpen: false,
                
                init() {
                    this.isOpen = this.$store.gallery.ancestorKeys.includes(this.key) ||
                                  this.$store.gallery.expandedFolderKeys.has(this.key);
                },
                
                get folder() {
                    return this.$store.gallery.folders[this.key];
                },
                
                get filteredAndSortedChildren() {
                    if (!this.folder.children || !this.folder.children.length) return [];
                    const searchTerm = this.$store.gallery.folderSearchTerm.toLowerCase();
                    const allFolders = this.$store.gallery.folders;
                    const filtered = this.folder.children.filter(childKey => 
                        allFolders[childKey].display_name.toLowerCase().includes(searchTerm)
                    );
                    const sort = this.$store.gallery.folderSort;
                    return filtered.sort((aKey, bKey) => {
                        const a = allFolders[aKey];
                        const b = allFolders[bKey];
                        const dir = sort.dir === 'asc' ? 1 : -1;
                        return sort.key === 'mtime' 
                            ? (a.mtime - b.mtime) * dir
                            : a.display_name.localeCompare(b.display_name, undefined, { numeric: true }) * dir;
                    });
                },
                
                get isVisible() {
                    const term = this.$store.gallery.folderSearchTerm.toLowerCase();
                    return !term || this.folder.display_name.toLowerCase().includes(term) || 
                           this.hasVisibleChildren(this.key, term);
                },
                
                hasVisibleChildren(key, term) {
                    const folder = this.$store.gallery.folders[key];
                    if (!folder.children || !folder.children.length) return false;
                    return folder.children.some(childKey => {
                        const child = this.$store.gallery.folders[childKey];
                        return child.display_name.toLowerCase().includes(term) || 
                               this.hasVisibleChildren(childKey, term);
                    });
                },
                
                toggle() {
                    this.isOpen = !this.isOpen;
                    if (this.isOpen) this.$store.gallery.expandedFolderKeys.add(this.key);
                    else this.$store.gallery.expandedFolderKeys.delete(this.key);
                    this.$store.gallery.saveExpandedState();
                }
            }));
            } catch (error) {
                console.error('[Alpine] Failed to register folderNode component:', error);
            }
        });

        // =======================================================================
        //  MAIN GALLERY COMPONENT - ALL APPLICATION LOGIC
        // =======================================================================
        function gallery() {
            return {
                // --- SERVER DATA ---
                FILES_PER_PAGE: {{ files_per_page | default(50) }},
                
                // --- FILE STATE ---
                filesOnPage: {{ files | tojson }},
                totalFiles: {{ total_files }},
                currentPage: {{ initial_page | default(1) }},
                isLoadingMore: false,
                
                // --- SELECTION STATE ---
                selectedFiles: [],
                lastSelectedItem: null,
                
                // --- UI STATE ---
                isPageLoading: true,
                isFilterPanelOpen: false,
                isLightboxOpen: false,
                isUploadOpen: false,
                isSummaryOpen: false,
                isDropPanelVisible: false,
                summaryHtml: '',
                
                // --- LIGHTBOX STATE ---
                currentLightboxIndex: -1,
                currentLightboxFile: null,
                currentZoom: 1,
                
                // --- UPLOAD STATE ---
                filesToUpload: [],
                uploadProgress: 0,
                isUploading: false,
                isDragOver: false,
                
                // --- SYNC STATE ---
                isSyncing: false,
                syncProgress: 0,
                syncMessage: '',
                
                // --- SAMPLER PANEL STATE (NEW) ---
                samplerPanelVisible: false,
                samplerPanelExpanded: false,
                samplerPanelLoading: false,
                samplerError: '',
                samplerCount: 0,
                samplerData: [],
                
                // --- FILTER STATE ---
                filters: {
                    search: new URLSearchParams(window.location.search).get('search') || '',
                    favorites: new URLSearchParams(window.location.search).get('favorites') === 'true',
                    extensions: new URLSearchParams(window.location.search).getAll('extension') || [],
                    prefixes: new URLSearchParams(window.location.search).getAll('prefix') || [],
                    model: new URLSearchParams(window.location.search).get('filter_model') || '',
                    sampler: new URLSearchParams(window.location.search).get('filter_sampler') || '',
                    scheduler: new URLSearchParams(window.location.search).get('filter_scheduler') || '',
                    cfg_min: new URLSearchParams(window.location.search).get('filter_cfg_min') || '',
                    cfg_max: new URLSearchParams(window.location.search).get('filter_cfg_max') || '',
                    steps_min: new URLSearchParams(window.location.search).get('filter_steps_min') || '',
                    steps_max: new URLSearchParams(window.location.search).get('filter_steps_max') || '',
                    width_min: new URLSearchParams(window.location.search).get('filter_width_min') || '',
                    width_max: new URLSearchParams(window.location.search).get('filter_width_max') || '',
                    height_min: new URLSearchParams(window.location.search).get('filter_height_min') || '',
                    height_max: new URLSearchParams(window.location.search).get('filter_height_max') || ''
                },
                
                filterOptions: {
                    models: [],
                    samplers: [],
                    schedulers: []
                },
                
                // --- UI STATE ---
                shouldShowBackToTop: false,
                sidebarExpanded: false,
                
                // --- NEW STATE FOR MOBILE SIDEBAR ---
                isMobileView: false,
                isMobileNavCollapsed: false,
                
                // ===================================
                // LIFECYCLE HOOKS
                // ===================================
                init() {
                    console.log('[Alpine] Gallery component initialized - PURE MODE');
                    
                    // Initialize stores
                    Alpine.store('gallery').initStore();
                    
                    // Check initial mobile view state
                    this.checkMobileView();
                    
                    // Hide loader - replaced with Alpine-driven state
                    this.isPageLoading = false;
                    
                    // Setup sidebar
                    this.setupSidebarExpansion();
                    
                    // Initialize after DOM ready
                    this.$nextTick(() => {
                        this.populateWorkflowFilters();
                        this.startSyncProcess(false);
                        this.handleDeepLinking();
                    });
                    
                    // Back to top button state - managed by Alpine
                    this.shouldShowBackToTop = window.scrollY > 300;
                    
                    // Alpine scroll handler using @scroll.window
                    window.addEventListener('scroll', () => {
                        this.shouldShowBackToTop = window.scrollY > 300;
                    });
                },
                
                // ===================================
                // COMPUTED PROPERTIES
                // ===================================
                get activeFilterCount() {
                    let count = 0;
                    
                    // Text search
                    if (this.filters.search && this.filters.search.trim()) count++;
                    
                    // Extensions (multi-select)
                    if (this.filters.extensions && this.filters.extensions.length > 0) count++;
                    
                    // Prefixes (multi-select)
                    if (this.filters.prefixes && this.filters.prefixes.length > 0) count++;
                    
                    // Favorites checkbox
                    if (this.filters.favorites) count++;
                    
                    // Workflow metadata filters
                    if (this.filters.model && this.filters.model.trim()) count++;
                    if (this.filters.sampler && this.filters.sampler.trim()) count++;
                    if (this.filters.scheduler && this.filters.scheduler.trim()) count++;
                    
                    // Range filters
                    if (this.filters.cfg_min && this.filters.cfg_min.toString().trim()) count++;
                    if (this.filters.cfg_max && this.filters.cfg_max.toString().trim()) count++;
                    if (this.filters.steps_min && this.filters.steps_min.toString().trim()) count++;
                    if (this.filters.steps_max && this.filters.steps_max.toString().trim()) count++;
                    if (this.filters.width_min && this.filters.width_min.toString().trim()) count++;
                    if (this.filters.width_max && this.filters.width_max.toString().trim()) count++;
                    if (this.filters.height_min && this.filters.height_min.toString().trim()) count++;
                    if (this.filters.height_max && this.filters.height_max.toString().trim()) count++;
                    
                    return count;
                },
                
                get activeFilterPills() {
                    const pills = [];
                    
                    // Text search
                    if (this.filters.search && this.filters.search.trim()) {
                        pills.push({
                            key: 'search',
                            label: `🔍 Search: "${this.filters.search}"`,
                            action: () => { this.filters.search = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Favorites
                    if (this.filters.favorites) {
                        pills.push({
                            key: 'favorites',
                            label: '⭐ Favorites Only',
                            action: () => { this.filters.favorites = false; this.applyFilters(); }
                        });
                    }
                    
                    // Extensions
                    if (this.filters.extensions && this.filters.extensions.length > 0) {
                        this.filters.extensions.forEach((ext, idx) => {
                            pills.push({
                                key: `ext-${idx}`,
                                label: `📄 ${ext}`,
                                action: () => {
                                    this.filters.extensions = this.filters.extensions.filter(e => e !== ext);
                                    const extSelect = document.getElementById('extension-select');
                                    if (extSelect && extSelect._tomSelect) {
                                        extSelect._tomSelect.removeItem(ext, true);
                                    }
                                    this.applyFilters();
                                }
                            });
                        });
                    }
                    
                    // Prefixes
                    if (this.filters.prefixes && this.filters.prefixes.length > 0) {
                        this.filters.prefixes.forEach((pfx, idx) => {
                            pills.push({
                                key: `pfx-${idx}`,
                                label: `🏷️ ${pfx}`,
                                action: () => {
                                    this.filters.prefixes = this.filters.prefixes.filter(p => p !== pfx);
                                    const pfxSelect = document.getElementById('prefix-select');
                                    if (pfxSelect && pfxSelect._tomSelect) {
                                        pfxSelect._tomSelect.removeItem(pfx, true);
                                    }
                                    this.applyFilters();
                                }
                            });
                        });
                    }
                    
                    // Model
                    if (this.filters.model && this.filters.model.trim()) {
                        pills.push({
                            key: 'model',
                            label: `🤖 Model: ${this.filters.model}`,
                            action: () => { 
                                this.filters.model = ''; 
                                const modelSelect = document.getElementById('model-select');
                                if (modelSelect && modelSelect._tomSelect) {
                                    modelSelect._tomSelect.clear(true);
                                }
                                this.applyFilters(); 
                            }
                        });
                    }
                    
                    // Sampler
                    if (this.filters.sampler && this.filters.sampler.trim()) {
                        pills.push({
                            key: 'sampler',
                            label: `🎲 Sampler: ${this.filters.sampler}`,
                            action: () => { 
                                this.filters.sampler = ''; 
                                const samplerSelect = document.getElementById('sampler-select');
                                if (samplerSelect && samplerSelect._tomSelect) {
                                    samplerSelect._tomSelect.clear(true);
                                }
                                this.applyFilters(); 
                            }
                        });
                    }
                    
                    // Scheduler
                    if (this.filters.scheduler && this.filters.scheduler.trim()) {
                        pills.push({
                            key: 'scheduler',
                            label: `📅 Scheduler: ${this.filters.scheduler}`,
                            action: () => { 
                                this.filters.scheduler = ''; 
                                const schedulerSelect = document.getElementById('scheduler-select');
                                if (schedulerSelect && schedulerSelect._tomSelect) {
                                    schedulerSelect._tomSelect.clear(true);
                                }
                                this.applyFilters(); 
                            }
                        });
                    }
                    
                    // CFG Range
                    if (this.filters.cfg_min && this.filters.cfg_min.toString().trim()) {
                        pills.push({
                            key: 'cfg_min',
                            label: `⚙️ CFG ≥ ${this.filters.cfg_min}`,
                            action: () => { this.filters.cfg_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.cfg_max && this.filters.cfg_max.toString().trim()) {
                        pills.push({
                            key: 'cfg_max',
                            label: `⚙️ CFG ≤ ${this.filters.cfg_max}`,
                            action: () => { this.filters.cfg_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Steps Range
                    if (this.filters.steps_min && this.filters.steps_min.toString().trim()) {
                        pills.push({
                            key: 'steps_min',
                            label: `🔢 Steps ≥ ${this.filters.steps_min}`,
                            action: () => { this.filters.steps_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.steps_max && this.filters.steps_max.toString().trim()) {
                        pills.push({
                            key: 'steps_max',
                            label: `🔢 Steps ≤ ${this.filters.steps_max}`,
                            action: () => { this.filters.steps_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Width Range
                    if (this.filters.width_min && this.filters.width_min.toString().trim()) {
                        pills.push({
                            key: 'width_min',
                            label: `📏 Width ≥ ${this.filters.width_min}`,
                            action: () => { this.filters.width_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.width_max && this.filters.width_max.toString().trim()) {
                        pills.push({
                            key: 'width_max',
                            label: `📏 Width ≤ ${this.filters.width_max}`,
                            action: () => { this.filters.width_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    // Height Range
                    if (this.filters.height_min && this.filters.height_min.toString().trim()) {
                        pills.push({
                            key: 'height_min',
                            label: `📐 Height ≥ ${this.filters.height_min}`,
                            action: () => { this.filters.height_min = ''; this.applyFilters(); }
                        });
                    }
                    if (this.filters.height_max && this.filters.height_max.toString().trim()) {
                        pills.push({
                            key: 'height_max',
                            label: `📐 Height ≤ ${this.filters.height_max}`,
                            action: () => { this.filters.height_max = ''; this.applyFilters(); }
                        });
                    }
                    
                    return pills;
                },
                
                // ===================================
                // KEYBOARD HANDLERS
                // ===================================
                handleEscape() {
                    if (this.isUploadOpen) this.isUploadOpen = false;
                    else if (this.isSummaryOpen) this.isSummaryOpen = false;
                    else if (this.isLightboxOpen) this.closeLightbox();
                    else if (this.isFilterPanelOpen) this.isFilterPanelOpen = false;
                    else if (this.isDropPanelVisible) this.hideDropZone();
                    else if (this.selectedFiles.length > 0) this.selectedFiles = [];
                },
                
                selectAll() {
                    this.selectedFiles = this.filesOnPage.map(f => f.id);
                    this.lastSelectedItem = this.filesOnPage.length > 0 ? 
                        this.filesOnPage[this.filesOnPage.length - 1].id : null;
                },
                
                // ===================================
                // MOBILE VIEW HANDLERS
                // ===================================
                checkMobileView() {
                    this.isMobileView = window.innerWidth <= 1024;
                    if (this.isMobileView && this.isMobileNavCollapsed === false) {
                        // On mobile, default to collapsed state
                        this.isMobileNavCollapsed = true;
                    }
                },
                
                handleResize() {
                    this.checkMobileView();
                },
                
                // ===================================
                // FILE OPERATIONS
                // ===================================
                async loadMore() {
                    if (this.isLoadingMore) return;
                    this.isLoadingMore = true;
                    
                    try {
                        this.currentPage++;
                        // Build query parameters from Alpine state instead of DOM
                        const queryParams = new URLSearchParams();
                        queryParams.set('page', this.currentPage);
                        
                        // Add filter values from Alpine state
                        if (this.filters.search) queryParams.set('search', this.filters.search);
                        if (this.filters.favorites) queryParams.set('favorites', 'true');
                        if (this.filters.model) queryParams.set('filter_model', this.filters.model);
                        if (this.filters.sampler) queryParams.set('filter_sampler', this.filters.sampler);
                        if (this.filters.scheduler) queryParams.set('filter_scheduler', this.filters.scheduler);
                        if (this.filters.cfg_min) queryParams.set('filter_cfg_min', this.filters.cfg_min);
                        if (this.filters.cfg_max) queryParams.set('filter_cfg_max', this.filters.cfg_max);
                        if (this.filters.steps_min) queryParams.set('filter_steps_min', this.filters.steps_min);
                        if (this.filters.steps_max) queryParams.set('filter_steps_max', this.filters.steps_max);
                        if (this.filters.width_min) queryParams.set('filter_width_min', this.filters.width_min);
                        if (this.filters.width_max) queryParams.set('filter_width_max', this.filters.width_max);
                        if (this.filters.height_min) queryParams.set('filter_height_min', this.filters.height_min);
                        if (this.filters.height_max) queryParams.set('filter_height_max', this.filters.height_max);
                        
                        // Handle arrays
                        this.filters.extensions?.forEach(ext => queryParams.append('extension', ext));
                        this.filters.prefixes?.forEach(pfx => queryParams.append('prefix', pfx));
                        
                        const response = await fetch(`/galleryout/load_more?folder_key=${this.$store.gallery.currentFolderKey}&${queryParams}`);
                        const data = await response.json();
                        
                        if (data.files && data.files.length > 0) {
                            this.filesOnPage = [...this.filesOnPage, ...data.files];
                            // Update total count in case it changed (e.g., files deleted)
                            if (data.total !== undefined) {
                                this.totalFiles = data.total;
                            }
                        } else {
                            this.$store.notifications.add('No more files to load.', 'info');
                        }
                    } catch (error) {
                        console.error('Load more error:', error);
                        this.$store.notifications.add('Failed to load more files.', 'error');
                    } finally {
                        this.isLoadingMore = false;
                    }
                },
                
                async toggleFavorite(fileId) {
                    const file = this.filesOnPage.find(f => f.id === fileId);
                    if (!file) return;
                    
                    const originalState = file.is_favorite;
                    file.is_favorite = !file.is_favorite; // Optimistic update
                    
                    try {
                        const response = await fetch(`/galleryout/toggle_favorite/${fileId}`, { method: 'POST' });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.$store.notifications.add(
                                data.is_favorite ? 'Added to favorites!' : 'Removed from favorites!', 
                                'success'
                            );
                        } else {
                            file.is_favorite = originalState;
                            this.$store.notifications.add('Failed to update favorite.', 'error');
                        }
                    } catch (error) {
                        file.is_favorite = originalState;
                        this.$store.notifications.add('Network error updating favorite.', 'error');
                    }
                },
                
                async deleteFile(fileId) {
                    if (!confirm('🗑️ Delete this file? This cannot be undone.')) return;
                    
                    try {
                        const response = await fetch(`/galleryout/delete/${fileId}`, { method: 'POST' });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.filesOnPage = this.filesOnPage.filter(f => f.id !== fileId);
                            this.selectedFiles = this.selectedFiles.filter(id => id !== fileId);
                            this.$store.notifications.add('File deleted!', 'success');
                        } else {
                            throw new Error(data.message || 'Deletion failed');
                        }
                    } catch (error) {
                        this.$store.notifications.add(`Failed to delete: ${error.message}`, 'error');
                    }
                },
                
                // ===================================
                // FILTER OPERATIONS
                // ===================================
                clearAllFilters() {
                    // Reset all filter values
                    this.filters.search = '';
                    this.filters.favorites = false;
                    this.filters.extensions = [];
                    this.filters.prefixes = [];
                    this.filters.model = '';
                    this.filters.sampler = '';
                    this.filters.scheduler = '';
                    this.filters.cfg_min = '';
                    this.filters.cfg_max = '';
                    this.filters.steps_min = '';
                    this.filters.steps_max = '';
                    this.filters.width_min = '';
                    this.filters.width_max = '';
                    this.filters.height_min = '';
                    this.filters.height_max = '';
                    
                    // Clear TomSelect instances via element references
                    const selectIds = ['extension-select', 'prefix-select', 'model-select', 'sampler-select', 'scheduler-select'];
                    selectIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el && el._tomSelect) {
                            el._tomSelect.clear(true);
                        }
                    });
                    
                    // Apply filters (will show all files)
                    this.applyFilters();
                },
                
                async applyFilters() {
                    try {
                        // Build query parameters from filters state
                        const params = new URLSearchParams();
                        
                        // Get current sort params
                        const currentSort = new URLSearchParams(window.location.search);
                        params.set('sort_by', currentSort.get('sort_by') || 'date');
                        params.set('sort_order', currentSort.get('sort_order') || 'desc');
                        
                        // Add filter values
                        if (this.filters.search) params.set('search', this.filters.search);
                        if (this.filters.favorites) params.set('favorites', 'true');
                        
                        // Multi-select arrays
                        if (this.filters.extensions && this.filters.extensions.length > 0) {
                            this.filters.extensions.forEach(ext => params.append('extension', ext));
                        }
                        if (this.filters.prefixes && this.filters.prefixes.length > 0) {
                            this.filters.prefixes.forEach(pfx => params.append('prefix', pfx));
                        }
                        
                        // Workflow metadata
                        if (this.filters.model) params.set('filter_model', this.filters.model);
                        if (this.filters.sampler) params.set('filter_sampler', this.filters.sampler);
                        if (this.filters.scheduler) params.set('filter_scheduler', this.filters.scheduler);
                        
                        // Range filters
                        if (this.filters.cfg_min) params.set('filter_cfg_min', this.filters.cfg_min);
                        if (this.filters.cfg_max) params.set('filter_cfg_max', this.filters.cfg_max);
                        if (this.filters.steps_min) params.set('filter_steps_min', this.filters.steps_min);
                        if (this.filters.steps_max) params.set('filter_steps_max', this.filters.steps_max);
                        if (this.filters.width_min) params.set('filter_width_min', this.filters.width_min);
                        if (this.filters.width_max) params.set('filter_width_max', this.filters.width_max);
                        if (this.filters.height_min) params.set('filter_height_min', this.filters.height_min);
                        if (this.filters.height_max) params.set('filter_height_max', this.filters.height_max);
                        
                        // Update URL without reload
                        const newUrl = `${window.location.pathname}?${params.toString()}`;
                        history.pushState({}, '', newUrl);
                        
                        // Fetch filtered data
                        const response = await fetch(`/galleryout/load_more?folder_key=${this.$store.gallery.currentFolderKey}&${params.toString()}&page=1`);
                        const data = await response.json();
                        
                        if (response.ok && data.files) {
                            // Replace file list with filtered results
                            this.filesOnPage = data.files;
                            this.totalFiles = data.total || data.files.length;
                            this.currentPage = 1;
                            
                            // Close filter panel
                            this.isFilterPanelOpen = false;
                            
                            // Scroll to gallery - Alpine handles this via x-intersect
                            const galleryAnchor = this.$el.querySelector('#gallery-anchor');
                            if (galleryAnchor) galleryAnchor.scrollIntoView({ behavior: 'smooth' });
                            
                            // FIXED: Use totalFiles (complete count) instead of filesOnPage.length (paginated count)
                            this.$store.notifications.add(
                                `Found ${this.totalFiles} file${this.totalFiles !== 1 ? 's' : ''}` + 
                                (this.totalFiles > this.filesOnPage.length ? ` (showing ${this.filesOnPage.length})` : ''), 
                                'success'
                            );
                        } else {
                            throw new Error('Failed to fetch filtered results');
                        }
                    } catch (error) {
                        console.error('Filter application error:', error);
                        this.$store.notifications.add('Failed to apply filters. Try refreshing the page.', 'error');
                    }
                },
                
                // ===================================
                // SELECTION OPERATIONS
                // ===================================
                toggleSelection(event, fileId) {
                    if (event.shiftKey && this.lastSelectedItem) {
                        const lastIndex = this.filesOnPage.findIndex(f => f.id === this.lastSelectedItem);
                        const currentIndex = this.filesOnPage.findIndex(f => f.id === fileId);
                        const [start, end] = [lastIndex, currentIndex].sort((a, b) => a - b);
                        
                        for (let i = start; i <= end; i++) {
                            const id = this.filesOnPage[i].id;
                            if (!this.selectedFiles.includes(id)) this.selectedFiles.push(id);
                        }
                    } else {
                        const index = this.selectedFiles.indexOf(fileId);
                        if (index > -1) this.selectedFiles.splice(index, 1);
                        else this.selectedFiles.push(fileId);
                        this.lastSelectedItem = fileId;
                    }
                },
                
                async deleteSelected() {
                    const count = this.selectedFiles.length;
                    if (count === 0) return;
                    if (!confirm(`🗑️ Delete ${count} file${count !== 1 ? 's' : ''}? This cannot be undone.`)) return;
                    
                    try {
                        const response = await fetch('/galleryout/delete_batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_ids: this.selectedFiles })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success' || data.status === 'partial_success') {
                            this.$store.notifications.add(data.message || 'Files deleted!', 'success');
                            setTimeout(() => window.location.reload(), 1200);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to delete files.', 'error');
                    }
                },
                
                async favoriteSelected(status) {
                    if (this.selectedFiles.length === 0) return;
                    
                    try {
                        const response = await fetch('/galleryout/favorite_batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_ids: this.selectedFiles, status })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success' || data.status === 'partial_success') {
                            this.$store.notifications.add(data.message || 'Favorites updated!', 'success');
                            setTimeout(() => window.location.reload(), 1200);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to update favorites.', 'error');
                    }
                },
                
                moveSelected() {
                    if (this.selectedFiles.length > 0) this.isDropPanelVisible = true;
                },
                
                async confirmMoveToFolder(folderKey) {
                    if (this.selectedFiles.length === 0) {
                        this.$store.notifications.add('No files selected.', 'warning');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/galleryout/move_batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_ids: this.selectedFiles, destination_folder: folderKey })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success' || data.status === 'partial_success') {
                            this.$store.notifications.add(data.message || 'Files moved!', 'success');
                            setTimeout(() => window.location.reload(), 1200);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to move files.', 'error');
                    }
                    
                    this.hideDropZone();
                },
                
                hideDropZone() {
                    this.isDropPanelVisible = false;
                },
                
                dragStart(event, fileId) {
                    if (!this.selectedFiles.includes(fileId)) {
                        this.selectedFiles = [fileId];
                    }
                    
                    // Create drag image - kept imperative as it's a native HTML5 drag API requirement
                    const dragImage = document.createElement('div');
                    dragImage.style.cssText = `position:absolute;top:-100px;background:var(--primary-color);color:white;padding:8px 16px;border-radius:8px;font-weight:600;`;
                    dragImage.textContent = `📦 ${this.selectedFiles.length} file${this.selectedFiles.length !== 1 ? 's' : ''}`;
                    document.body.appendChild(dragImage);
                    event.dataTransfer.setDragImage(dragImage, 0, 0);
                    setTimeout(() => document.body.removeChild(dragImage), 0);
                    
                    event.dataTransfer.setData('text/plain', this.selectedFiles.join(','));
                    this.isDropPanelVisible = true;
                },
                
                // ===================================
                // FOLDER OPERATIONS
                // ===================================
                async handleApiResponse(response, successMessage) {
                    const data = await response.json();
                    if (data.status === 'success' || data.status === 'partial_success') {
                        this.$store.notifications.add(data.message || successMessage, 'success');
                        setTimeout(() => window.location.reload(), 1200);
                    } else {
                        throw new Error(data.message || 'An unknown error occurred.');
                    }
                },
                
                async createFolder() {
                    const folderName = prompt('📁 Enter a name for the new folder:');
                    if (!folderName || !folderName.trim()) return;
                    try {
                        const response = await fetch('/galleryout/create_folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ folder_name: folderName.trim(), parent_key: this.$store.gallery.currentFolderKey })
                        });
                        await this.handleApiResponse(response, 'Folder created.');
                    } catch (error) {
                        this.$store.notifications.add(`Error: ${error.message}`, 'error');
                    }
                },
                
                async renameFolder(folderKey, oldName) {
                    const newName = prompt('✏️ Enter the new name for the folder:', oldName);
                    if (!newName || !newName.trim() || newName.trim() === oldName) return;
                    try {
                        const response = await fetch(`/galleryout/rename_folder/${folderKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_name: newName.trim() })
                        });
                        await this.handleApiResponse(response, 'Folder renamed.');
                    } catch (error) {
                        this.$store.notifications.add(`Error: ${error.message}`, 'error');
                    }
                },
                
                async deleteFolder(folderKey, folderName) {
                    if (!confirm(`🗑️ Delete the folder "${folderName}" and all its contents? This cannot be undone.`)) return;
                    try {
                        const response = await fetch(`/galleryout/delete_folder/${folderKey}`, { method: 'POST' });
                        await this.handleApiResponse(response, 'Folder deleted.');
                    } catch (error) {
                        this.$store.notifications.add(`Error: ${error.message}`, 'error');
                    }
                },
                
                // ===================================
                // LIGHTBOX OPERATIONS
                // ===================================
                openLightbox(fileId) {
                    this.currentLightboxIndex = this.filesOnPage.findIndex(f => f.id === fileId);
                    if (this.currentLightboxIndex === -1) return;
                    
                    this.currentZoom = 1;
                    this.isLightboxOpen = true;
                    this.showItemAtIndex(this.currentLightboxIndex);
                },
                
                closeLightbox() {
                    this.isLightboxOpen = false;
                    this.currentLightboxFile = null;
                    this.currentLightboxIndex = -1;
                    this.currentZoom = 1;
                },
                
                showItemAtIndex(index) {
                    const file = this.filesOnPage[index];
                    if (!file) return;
                    
                    this.currentLightboxFile = file;
                    this.updateLightboxTitle();
                    
                    // Load sampler data if file has workflow
                    if (file.has_workflow) {
                        this.loadAndDisplaySamplers(file.id);
                    }
                },
                
                navigateLightbox(direction) {
                    if (this.filesOnPage.length === 0) return;
                    this.currentLightboxIndex = (this.currentLightboxIndex + direction + this.filesOnPage.length) % this.filesOnPage.length;
                    this.showItemAtIndex(this.currentLightboxIndex);
                },
                
                zoomLightbox(amount) {
                    this.currentZoom = Math.max(0.5, Math.min(3, this.currentZoom + amount));
                    // Alpine will handle the zoom styling via :style binding
                },
                
                updateLightboxTitle() {
                    // Alpine automatically updates the DOM via x-text binding when currentZoom or currentLightboxFile changes
                    // No need for manual DOM manipulation
                },
                
                async loadAndDisplaySamplers(fileId) {
                    this.samplerPanelLoading = true;
                    this.samplerError = '';
                    
                    try {
                        const response = await fetch(`/galleryout/workflow_samplers/${fileId}`);
                        const data = await response.json();
                        
                        if (data.samplers && data.samplers.length > 0) {
                            this.samplerPanelLoading = false;
                            this.samplerPanelVisible = true;
                            this.samplerCount = data.samplers.length;
                            this.renderSamplerDetails(data.samplers);
                        } else {
                            this.samplerPanelLoading = false;
                            this.samplerPanelVisible = false;
                        }
                    } catch (error) {
                        this.samplerPanelLoading = false;
                        this.samplerError = 'Failed to load sampler data';
                        this.samplerPanelVisible = false;
                    }
                },
                
                renderSamplerDetails(samplers) {
                    // Convert sampler data to a format suitable for Alpine x-for rendering
                    // Map all available fields from the backend response
                    this.samplerData = samplers.map((sampler, idx) => ({
                        index: idx + 1,
                        sampler_name: sampler.sampler_name || null,
                        scheduler: sampler.scheduler || null,
                        steps: sampler.steps != null ? sampler.steps : null,
                        cfg: sampler.cfg != null ? sampler.cfg : null,
                        denoise: sampler.denoise != null ? sampler.denoise : null,
                        seed: sampler.seed != null ? sampler.seed : null,
                        positive_prompt: sampler.positive_prompt || null,
                        negative_prompt: sampler.negative_prompt || null
                    }));
                },
                
                toggleSamplerPanel() {
                    this.samplerPanelExpanded = !this.samplerPanelExpanded;
                },
                
                async renameFileFromLightbox() {
                    if (!this.currentLightboxFile) return;
                    
                    const oldName = this.currentLightboxFile.name;
                    const lastDot = oldName.lastIndexOf('.');
                    const baseName = lastDot > -1 ? oldName.substring(0, lastDot) : oldName;
                    const ext = lastDot > -1 ? oldName.substring(lastDot) : '';
                    
                    const newBaseName = prompt('Enter new file name:', baseName);
                    if (!newBaseName || newBaseName.trim() === baseName) return;
                    
                    const newName = newBaseName.trim() + ext;
                    
                    try {
                        const response = await fetch(`/galleryout/rename_file/${this.currentLightboxFile.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_name: newName })
                        });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.$store.notifications.add('File renamed!', 'success');
                            this.currentLightboxFile.name = data.new_name;
                            this.currentLightboxFile.id = data.new_id;
                            this.updateLightboxTitle();
                            this.showItemAtIndex(this.currentLightboxIndex);
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to rename file.', 'error');
                    }
                },
                
                async deleteFromLightbox() {
                    if (!confirm('🗑️ Delete this file? This cannot be undone.')) return;
                    
                    const fileToDelete = this.filesOnPage[this.currentLightboxIndex];
                    
                    try {
                        const response = await fetch(`/galleryout/delete/${fileToDelete.id}`, { method: 'POST' });
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            this.$store.notifications.add('File deleted!', 'success');
                            this.filesOnPage.splice(this.currentLightboxIndex, 1);
                            
                            if (this.filesOnPage.length === 0) {
                                this.closeLightbox();
                            } else {
                                if (this.currentLightboxIndex >= this.filesOnPage.length) {
                                    this.currentLightboxIndex = this.filesOnPage.length - 1;
                                }
                                this.showItemAtIndex(this.currentLightboxIndex);
                            }
                        }
                    } catch (error) {
                        this.$store.notifications.add('Failed to delete file.', 'error');
                    }
                },
                
                // ===================================
                // MODAL OPERATIONS
                // ===================================
                async showNodeSummary(fileId) {
                    this.isSummaryOpen = true;
                    this.summaryHtml = '<div class="loader" style="margin:2rem auto;"></div>';
                    
                    try {
                        const response = await fetch(`/galleryout/node_summary/${fileId}`);
                        const data = await response.json();
                        
                        if (data.status === 'success' && data.summary?.length > 0) {
                            this.summaryHtml = data.summary.map(node => {
                                const paramsHTML = node.params.length > 0
                                    ? node.params.map(p => `<li><strong>${this.escapeHTML(p.name)}:</strong> <code>${this.escapeHTML(p.value)}</code></li>`).join('')
                                    : '<li>No parameters</li>';
                                
                                return `<div class="summary-node-item">
                                            <div class="summary-node-header" style="background-color:${node.color};">${this.escapeHTML(node.type)} <small>(ID: ${node.id})</small></div>
                                            <ul class="summary-node-params">${paramsHTML}</ul>
                                        </div>`;
                            }).join('');
                        } else {
                            this.summaryHtml = '<p>No active nodes found for this workflow.</p>';
                        }
                    } catch (error) {
                        this.summaryHtml = '<p style="color:var(--danger-color);">A network error occurred.</p>';
                    }
                },
                
                // ===================================
                // INITIALIZATION METHODS
                // ===================================
                setupSidebarExpansion() {
                    // Initialize sidebar state from localStorage
                    this.sidebarExpanded = false;
                    
                    try {
                        const savedState = localStorage.getItem('sidebarExpandedState');
                        if (savedState === 'true') {
                            this.sidebarExpanded = true;
                        }
                    } catch (e) {
                        console.warn('Failed to load sidebar state:', e);
                    }
                    
                    // Watch for changes and persist to localStorage
                    this.$watch('sidebarExpanded', (expanded) => {
                        try {
                            localStorage.setItem('sidebarExpandedState', expanded ? 'true' : 'false');
                        } catch (e) {
                            console.warn('Failed to save sidebar state:', e);
                        }
                    });
                    
                    // Setup sidebar toggle button if it exists
                    const toggleBtn = document.getElementById('sidebar-expand-btn');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', () => {
                            this.sidebarExpanded = !this.sidebarExpanded;
                        });
                    }
                },
                
                async populateWorkflowFilters() {
                    try {
                        const response = await fetch('/galleryout/filter_options');
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.status === 'success' && data.options) {
                            // Populate filterOptions state - x-tom-select directive handles the rest
                            this.filterOptions.models = data.options.models || [];
                            this.filterOptions.samplers = data.options.samplers || [];
                            this.filterOptions.schedulers = data.options.schedulers || [];
                        } else {
                            console.warn('[populateWorkflowFilters] Unexpected response format:', data);
                            this.$store.notifications.add('Failed to load filter options', 'warning');
                        }
                    } catch (error) {
                        console.error('[populateWorkflowFilters] Failed to load workflow filter options:', error);
                        this.$store.notifications.add('Error loading filter options', 'error');
                    }
                },
                
                // --- DRAG & DROP METHODS (Declarative Alpine) ---
                dragOver() {
                    this.isDragOver = true;
                },
                
                dragLeave() {
                    this.isDragOver = false;
                },
                
                dropFiles(event) {
                    this.isDragOver = false;
                    this.handleFiles(event.dataTransfer.files);
                },
                
                handleFiles(files) {
                    if (!files || files.length === 0) return;
                    
                    // Simply add files to state - Alpine will handle DOM rendering
                    this.filesToUpload.push(...Array.from(files));
                },
                
                performUpload() {
                    if (!this.filesToUpload || this.filesToUpload.length === 0) {
                        this.$store.notifications.add('Please select files to upload.', 'warning');
                        return;
                    }
                    
                    // Set uploading state - Alpine handles UI updates
                    this.isUploading = true;
                    this.uploadProgress = 0;
                    
                    const formData = new FormData();
                    formData.append('folder_key', this.$store.gallery.currentFolderKey);
                    this.filesToUpload.forEach(file => formData.append('files', file));
                    
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/galleryout/upload', true);
                    
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            this.uploadProgress = Math.round((event.loaded / event.total) * 100);
                        }
                    };
                    
                    xhr.onload = () => {
                        this.isUploading = false; // Reset state on completion
                        
                        if (xhr.status >= 200 && xhr.status < 300) {
                            const response = JSON.parse(xhr.responseText);
                            this.$store.notifications.add(response.message || 'Upload successful!', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            this.$store.notifications.add('Upload failed.', 'error');
                        }
                    };
                    
                    xhr.onerror = () => {
                        this.isUploading = false; // Reset state on error
                        this.$store.notifications.add('An error occurred during upload.', 'error');
                    };
                    
                    xhr.send(formData);
                },
                
                startSyncProcess(isManualRefresh = false) {
                    const eventSource = new EventSource(`/galleryout/sync_status/${this.$store.gallery.currentFolderKey}`);
                    let hasChanges = false;
                    
                    if (isManualRefresh) {
                        // Set initial state for manual sync - Alpine handles DOM updates
                        this.isSyncing = true;
                        this.syncProgress = 0;
                        this.syncMessage = 'Checking for changes...';
                    }
                    
                    const cleanup = (shouldReload = false) => {
                        eventSource.close();
                        if (shouldReload) {
                            setTimeout(() => window.location.reload(), 1200);
                        } else {
                            setTimeout(() => {
                                this.isSyncing = false;
                                this.syncProgress = 0;
                                this.syncMessage = '';
                            }, isManualRefresh ? 1200 : 0);
                        }
                    };
                    
                    eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (!hasChanges && data.status !== 'no_changes') {
                                this.isSyncing = true; // Show overlay on first change
                                hasChanges = true;
                            }
                            
                            if (this.isSyncing) {
                                this.syncMessage = data.message;
                                if (data.total > 0) {
                                    this.syncProgress = Math.round((data.current / data.total) * 100);
                                }
                            }
                            
                            if (data.status === 'no_changes') {
                                if (isManualRefresh) {
                                    this.syncProgress = 100;
                                    this.$store.notifications.add('Folder is up to date.', 'info');
                                }
                                cleanup(false);
                            } else if (data.status === 'reloading') {
                                cleanup(true);
                            } else if (data.error) {
                                cleanup(false);
                            }
                        } catch (e) {
                            cleanup(false);
                        }
                    };
                    
                    eventSource.onerror = () => {
                        eventSource.close();
                        this.isSyncing = false;
                    };
                },
                
                handleDeepLinking() {
                    setTimeout(() => {
                        const hash = window.location.hash;
                        if (hash && hash.startsWith('#file-')) {
                            const fileId = hash.substring(6);
                            const file = this.filesOnPage.find(f => f.id === fileId);
                            
                            if (file) {
                                this.openLightbox(null, fileId);
                            } else {
                                // File not on current page, redirect to its location
                                fetch(`/galleryout/file_location/${fileId}?${new URLSearchParams(window.location.search)}`)
                                    .then(r => r.json())
                                    .then(d => {
                                        if (d.redirect_url) window.location.href = d.redirect_url;
                                    })
                                    .catch(() => this.$store.notifications.add('File not found.', 'error'));
                            }
                        }
                    }, 200);
                },
                
                // ===================================
                // UTILITY METHODS
                // ===================================
                escapeHTML(value) {
                    if (value === null || typeof value === 'undefined') return '<em>null</em>';
                    if (typeof value === 'object') {
                        try {
                            return JSON.stringify(value, null, 2).replace(/[&<>"']/g, m => 
                                ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[m]
                            );
                        } catch (e) {
                            return '[Unserializable Object]';
                        }
                    }
                    return value.toString().replace(/[&<>"']/g, m => 
                        ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[m]
                    );
                },
                
                scrollToTop() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
        }
    </script>
</body>
</html>